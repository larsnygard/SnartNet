import{r as p,c as se,_ as Y,j as t,n as Te,e as Ae,Q as Re,L as O,u as Ue,B as Me,R as Fe,a as V,b as De}from"./vendor-CdL2jA1Q.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let b,_=0,H=null;function q(){return(H===null||H.byteLength===0)&&(H=new Uint8Array(b.memory.buffer)),H}const G=new TextEncoder;"encodeInto"in G||(G.encodeInto=function(a,e){const r=G.encode(a);return e.set(r),{read:a.length,written:r.length}});function N(a,e,r){if(r===void 0){const l=G.encode(a),d=e(l.length,1)>>>0;return q().subarray(d,d+l.length).set(l),_=l.length,d}let s=a.length,n=e(s,1)>>>0;const o=q();let i=0;for(;i<s;i++){const l=a.charCodeAt(i);if(l>127)break;o[n+i]=l}if(i!==s){i!==0&&(a=a.slice(i)),n=r(n,s,s=i+a.length*3,1)>>>0;const l=q().subarray(n+i,n+s),d=G.encodeInto(a,l);i+=d.written,n=r(n,s,i,1)>>>0}return _=i,n}let J=null;function D(){return(J===null||J.buffer.detached===!0||J.buffer.detached===void 0&&J.buffer!==b.memory.buffer)&&(J=new DataView(b.memory.buffer)),J}function K(a){const e=b.__externref_table_alloc();return b.__wbindgen_export_4.set(e,a),e}function M(a,e){try{return a.apply(this,e)}catch(r){const s=K(r);b.__wbindgen_exn_store(s)}}let te=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});te.decode();const Oe=2146435072;let ne=0;function Le(a,e){return ne+=e,ne>=Oe&&(te=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),te.decode(),ne=e),te.decode(q().subarray(a,a+e))}function U(a,e){return a=a>>>0,Le(a,e)}function T(a){return a==null}function oe(a,e){return a=a>>>0,q().subarray(a/1,a/1+e)}function S(a){const e=b.__wbindgen_export_4.get(a);return b.__externref_table_dealloc(a),e}function Be(){const a=b.generate_keypair();if(a[2])throw S(a[1]);return S(a[0])}function $e(a,e){let r,s;try{const i=N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),l=_,d=N(e,b.__wbindgen_malloc,b.__wbindgen_realloc),c=_,g=b.sign_data(i,l,d,c);var n=g[0],o=g[1];if(g[3])throw n=0,o=0,S(g[2]);return r=n,s=o,U(n,o)}finally{b.__wbindgen_free(r,s,1)}}function ze(a,e,r){const s=N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),n=_,o=N(e,b.__wbindgen_malloc,b.__wbindgen_realloc),i=_,l=N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),d=_,c=b.verify_signature_wasm(s,n,o,i,l,d);if(c[2])throw S(c[1]);return c[0]!==0}function We(a,e){const r=e(a.length*4,4)>>>0;for(let s=0;s<a.length;s++){const n=K(a[s]);D().setUint32(r+4*s,n,!0)}return _=a.length,r}function Je(){const a=b.init_core();if(a[1])throw S(a[0])}const pe=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(a=>b.__wbg_snartnetcore_free(a>>>0,1));let ge=class{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,pe.unregister(this),e}free(){const e=this.__destroy_into_raw();b.__wbg_snartnetcore_free(e,0)}constructor(){const e=b.snartnetcore_new();return this.__wbg_ptr=e>>>0,pe.register(this,this.__wbg_ptr,this),this}init(){const e=b.snartnetcore_init(this.__wbg_ptr);if(e[1])throw S(e[0])}create_profile(e,r,s){let n,o;try{const u=N(e,b.__wbindgen_malloc,b.__wbindgen_realloc),h=_;var i=T(r)?0:N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),l=_,d=T(s)?0:N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),c=_;const f=b.snartnetcore_create_profile(this.__wbg_ptr,u,h,i,l,d,c);var g=f[0],m=f[1];if(f[3])throw g=0,m=0,S(f[2]);return n=g,o=m,U(g,m)}finally{b.__wbindgen_free(n,o,1)}}get_current_profile(){const e=b.snartnetcore_get_current_profile(this.__wbg_ptr);if(e[2])throw S(e[1]);return S(e[0])}update_current_profile(e,r){var s=T(e)?0:N(e,b.__wbindgen_malloc,b.__wbindgen_realloc),n=_,o=T(r)?0:N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),i=_;const l=b.snartnetcore_update_current_profile(this.__wbg_ptr,s,n,o,i);if(l[1])throw S(l[0])}create_post(e,r,s){const n=N(e,b.__wbindgen_malloc,b.__wbindgen_realloc),o=_;var i=T(r)?0:We(r,b.__wbindgen_malloc),l=_,d=T(s)?0:N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),c=_;const g=b.snartnetcore_create_post(this.__wbg_ptr,n,o,i,l,d,c);if(g[2])throw S(g[1]);return S(g[0])}create_message(e,r){const s=N(e,b.__wbindgen_malloc,b.__wbindgen_realloc),n=_,o=N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),i=_,l=b.snartnetcore_create_message(this.__wbg_ptr,s,n,o,i);if(l[2])throw S(l[1]);return S(l[0])}get_public_key(){let e,r;try{const o=b.snartnetcore_get_public_key(this.__wbg_ptr);var s=o[0],n=o[1];if(o[3])throw s=0,n=0,S(o[2]);return e=s,r=n,U(s,n)}finally{b.__wbindgen_free(e,r,1)}}get_fingerprint(){let e,r;try{const o=b.snartnetcore_get_fingerprint(this.__wbg_ptr);var s=o[0],n=o[1];if(o[3])throw s=0,n=0,S(o[2]);return e=s,r=n,U(s,n)}finally{b.__wbindgen_free(e,r,1)}}has_profile(){return b.snartnetcore_has_profile(this.__wbg_ptr)!==0}};Symbol.dispose&&(ge.prototype[Symbol.dispose]=ge.prototype.free);const Ke=new Set(["basic","cors","default"]);async function Ve(a,e){if(typeof Response=="function"&&a instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(a,e)}catch(s){if(a.ok&&Ke.has(a.type)&&a.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const r=await a.arrayBuffer();return await WebAssembly.instantiate(r,e)}else{const r=await WebAssembly.instantiate(a,e);return r instanceof WebAssembly.Instance?{instance:r,module:a}:r}}function Qe(){const a={};return a.wbg={},a.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,r){const s=String(r),n=N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),o=_;D().setInt32(e+4,o,!0),D().setInt32(e+0,n,!0)},a.wbg.__wbg_call_13410aac570ffff7=function(){return M(function(e,r){return e.call(r)},arguments)},a.wbg.__wbg_call_a5400b25a865cfd8=function(){return M(function(e,r,s){return e.call(r,s)},arguments)},a.wbg.__wbg_crypto_574e78ad8b13b65f=function(e){return e.crypto},a.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,r){let s,n;try{s=e,n=r,console.error(U(e,r))}finally{b.__wbindgen_free(s,n,1)}},a.wbg.__wbg_getItem_9fc74b31b896f95a=function(){return M(function(e,r,s,n){const o=r.getItem(U(s,n));var i=T(o)?0:N(o,b.__wbindgen_malloc,b.__wbindgen_realloc),l=_;D().setInt32(e+4,l,!0),D().setInt32(e+0,i,!0)},arguments)},a.wbg.__wbg_getRandomValues_38a1ff1ea09f6cc7=function(){return M(function(e,r){globalThis.crypto.getRandomValues(oe(e,r))},arguments)},a.wbg.__wbg_getRandomValues_b8f5dbd5f3995a9e=function(){return M(function(e,r){e.getRandomValues(r)},arguments)},a.wbg.__wbg_getTime_6bb3f64e0f18f817=function(e){return e.getTime()},a.wbg.__wbg_instanceof_Window_12d20d558ef92592=function(e){let r;try{r=e instanceof Window}catch{r=!1}return r},a.wbg.__wbg_length_6bb7e81f9d7713e4=function(e){return e.length},a.wbg.__wbg_localStorage_9330af8bf39365ba=function(){return M(function(e){const r=e.localStorage;return T(r)?0:K(r)},arguments)},a.wbg.__wbg_log_6c7b5f4f00b8ce3f=function(e){console.log(e)},a.wbg.__wbg_msCrypto_a61aeb35a24c1329=function(e){return e.msCrypto},a.wbg.__wbg_new0_b0a0a38c201e6df5=function(){return new Date},a.wbg.__wbg_new_19c25a3f2fa63a02=function(){return new Object},a.wbg.__wbg_new_1f3a344cf3123716=function(){return new Array},a.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},a.wbg.__wbg_newnoargs_254190557c45b4ec=function(e,r){return new Function(U(e,r))},a.wbg.__wbg_newwithlength_a167dcc7aaa3ba77=function(e){return new Uint8Array(e>>>0)},a.wbg.__wbg_node_905d3e251edff8a2=function(e){return e.node},a.wbg.__wbg_process_dc0fbacc7c1c06f7=function(e){return e.process},a.wbg.__wbg_prototypesetcall_3d4a26c1ed734349=function(e,r,s){Uint8Array.prototype.set.call(oe(e,r),s)},a.wbg.__wbg_randomFillSync_ac0988aba3254290=function(){return M(function(e,r){e.randomFillSync(r)},arguments)},a.wbg.__wbg_removeItem_487c5a070c7adaf7=function(){return M(function(e,r,s){e.removeItem(U(r,s))},arguments)},a.wbg.__wbg_require_60cc747a6bc5215a=function(){return M(function(){return module.require},arguments)},a.wbg.__wbg_setItem_7add5eb06a28b38f=function(){return M(function(e,r,s,n,o){e.setItem(U(r,s),U(n,o))},arguments)},a.wbg.__wbg_set_3f1d0b984ed272ed=function(e,r,s){e[r]=s},a.wbg.__wbg_set_90f6c0f7bd8c0415=function(e,r,s){e[r>>>0]=s},a.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,r){const s=r.stack,n=N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),o=_;D().setInt32(e+4,o,!0),D().setInt32(e+0,n,!0)},a.wbg.__wbg_static_accessor_GLOBAL_8921f820c2ce3f12=function(){const e=typeof globalThis>"u"?null:globalThis;return T(e)?0:K(e)},a.wbg.__wbg_static_accessor_GLOBAL_THIS_f0a4409105898184=function(){const e=typeof globalThis>"u"?null:globalThis;return T(e)?0:K(e)},a.wbg.__wbg_static_accessor_SELF_995b214ae681ff99=function(){const e=typeof self>"u"?null:self;return T(e)?0:K(e)},a.wbg.__wbg_static_accessor_WINDOW_cde3890479c675ea=function(){const e=typeof window>"u"?null:window;return T(e)?0:K(e)},a.wbg.__wbg_subarray_70fd07feefe14294=function(e,r,s){return e.subarray(r>>>0,s>>>0)},a.wbg.__wbg_versions_c01dfd4722a88165=function(e){return e.versions},a.wbg.__wbg_wbindgenisfunction_8cee7dce3725ae74=function(e){return typeof e=="function"},a.wbg.__wbg_wbindgenisobject_307a53c6bd97fbf8=function(e){const r=e;return typeof r=="object"&&r!==null},a.wbg.__wbg_wbindgenisstring_d4fa939789f003b0=function(e){return typeof e=="string"},a.wbg.__wbg_wbindgenisundefined_c4b71d073b92f3c5=function(e){return e===void 0},a.wbg.__wbg_wbindgenstringget_0f16a6ddddef376f=function(e,r){const s=r,n=typeof s=="string"?s:void 0;var o=T(n)?0:N(n,b.__wbindgen_malloc,b.__wbindgen_realloc),i=_;D().setInt32(e+4,i,!0),D().setInt32(e+0,o,!0)},a.wbg.__wbg_wbindgenthrow_451ec1a8469d7eb6=function(e,r){throw new Error(U(e,r))},a.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,r){return U(e,r)},a.wbg.__wbindgen_cast_cb9088102bce6b30=function(e,r){return oe(e,r)},a.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(e){return e},a.wbg.__wbindgen_init_externref_table=function(){const e=b.__wbindgen_export_4,r=e.grow(4);e.set(0,void 0),e.set(r+0,void 0),e.set(r+1,null),e.set(r+2,!0),e.set(r+3,!1)},a}function He(a,e){return b=a.exports,me.__wbindgen_wasm_module=e,J=null,H=null,b.__wbindgen_start(),b}async function me(a){if(b!==void 0)return b;typeof a<"u"&&(Object.getPrototypeOf(a)===Object.prototype?{module_or_path:a}=a:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof a>"u"&&(a=new URL("/net/assets/snartnet_core_bg-CgG932GT.wasm",import.meta.url));const e=Qe();(typeof a=="string"||typeof Request=="function"&&a instanceof Request||typeof URL=="function"&&a instanceof URL)&&(a=fetch(a));const{instance:r,module:s}=await Ve(await a,e);return He(r,s)}class Se{client=null;activeTorrents=new Map;eventCallbacks=[];readyPromise;resolveReady;clientReady=!1;pendingSeeds=[];stats={torrents:0,downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0,peers:0};constructor(){this.readyPromise=new Promise(e=>{this.resolveReady=e}),this.initializeClient()}async initializeClient(){if(typeof window>"u")return;let e=0;const r=10,s=["wss://tracker.webtorrent.dev","wss://tracker.openwebtorrent.com","udp://tracker.openbittorrent.com:6969","udp://tracker.openbittorrent.com:80","udp://tracker.coppersurfer.tk:6969","udp://9.rarbg.to:2710","udp://tracker.leechers-paradise.org:6969"],n=()=>{e++;const o=window.WebTorrent;if(!o||typeof o!="function")if(e<r){console.warn(`[TorrentService] WebTorrent not available yet (attempt ${e}), retrying...`),setTimeout(n,500);return}else{const i=new Error("WebTorrent not available after retries");console.error("[TorrentService] ",i),this.emitEvent({type:"error",error:i.message});return}try{if(this.client=new o({announce:s,announceList:[s],dht:!0,webSeeds:!1}),typeof this.client.setMaxListeners=="function")this.client.setMaxListeners(30);else if(this.client&&this.client._events&&typeof this.client._events=="object")try{this.client.constructor?.prototype?.setMaxListeners?.(30)}catch{}this.clientReady=!0,this.client.on("error",l=>{console.error("[TorrentService] Client error:",l),this.emitEvent({type:"error",error:l.message})}),this.client.on("torrent",l=>{console.log("[TorrentService] Torrent added:",{name:l.name,infoHash:l.infoHash}),this.activeTorrents.set(l.infoHash,l),this.emitEvent({type:"torrent-added",torrent:l}),this.updateStats()}),console.log("[TorrentService] WebTorrent client initialized successfully"),this.resolveReady();const i=[...this.pendingSeeds];this.pendingSeeds=[],i.forEach(l=>{try{l()}catch(d){console.error("[TorrentService] Pending seed failed:",d)}})}catch(i){console.error("[TorrentService] Failed to initialize:",i),this.emitEvent({type:"error",error:String(i)})}};n()}emitEvent(e){this.eventCallbacks.forEach(r=>{try{r(e)}catch(s){console.error("Error in event callback:",s)}})}updateStats(){if(this.client)try{this.stats={torrents:this.client.torrents.length,downloadSpeed:this.client.downloadSpeed||0,uploadSpeed:this.client.uploadSpeed||0,downloaded:this.client.downloaded||0,uploaded:this.client.uploaded||0,peers:this.client.torrents.reduce((e,r)=>e+(r.numPeers||0),0)}}catch(e){console.error("Error updating stats:",e)}}async seedProfile(e){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized. Are you in a browser environment?");try{const r=JSON.stringify(e,null,2),s=`${e.username}_profile.json`,o=new TextEncoder().encode(r),i=new File([o],s,{type:"application/json; charset=utf-8"});return new Promise((l,d)=>{const c=setTimeout(()=>{d(new Error("Seeding timeout"))},1e4);try{console.log("Seeding profile file:",{fileName:s,fileSize:i.size,fileType:i.type,profileDataLength:r.length});const g=["wss://tracker.webtorrent.dev","wss://tracker.openwebtorrent.com","udp://tracker.openbittorrent.com:6969","udp://tracker.openbittorrent.com:80"],m=this.client.seed([i],{announce:g,announceList:[g]},u=>{clearTimeout(c),console.log("Profile seeded successfully:",{magnetURI:u.magnetURI,infoHash:u.infoHash,numPeers:u.numPeers}),this.emitEvent({type:"seeding-started",profile:e,magnetURI:u.magnetURI}),l(u.magnetURI)});m.on("error",u=>{clearTimeout(c),this.emitEvent({type:"error",error:u.message}),d(u)}),m.on("warning",u=>{u.message&&u.message.includes("tracker")&&console.warn("[TorrentService] Profile tracker warning (expected):",u.message)}),m.on("wire",u=>{this.emitEvent({type:"peer-connected",peerId:u.peerId||"unknown"})}),m.on("upload",()=>{this.emitEvent({type:"upload-progress",uploadSpeed:m.uploadSpeed||0}),this.updateStats()})}catch(g){clearTimeout(c),d(g)}})}catch(r){throw console.error("Error seeding profile:",r),r}}ensureReadyAction(e){this.clientReady?e():(console.log("[TorrentService] Client not ready, queuing action"),this.pendingSeeds.push(e))}async seedPost(e){if(await this.readyPromise,!this.client||!this.clientReady)throw new Error("WebTorrent client not ready for seeding");const r=performance.now();console.log("[TorrentService] Seeding post start",{author:e.author,hasImages:!!e.images?.length,signed:!!e.signature});const s=JSON.stringify(e,null,2),n=`post_${Date.now()}.json`,o=new TextEncoder().encode(s),i=new File([o],n,{type:"application/json; charset=utf-8"});return new Promise((l,d)=>{let c=!1,g=!1;const m=()=>{try{const u=["wss://tracker.webtorrent.dev","wss://tracker.openwebtorrent.com","udp://tracker.openbittorrent.com:6969","udp://tracker.openbittorrent.com:80"],h=this.client.seed([i],{announce:u,announceList:[u]},f=>{c=!0;const x=(performance.now()-r).toFixed(0);console.log("[TorrentService] Post torrent ready",{infoHash:f.infoHash,magnet:f.magnetURI,durationMs:x,numPeers:f.numPeers}),this.emitEvent({type:"seeding-started",post:e,magnetURI:f.magnetURI}),l(f.magnetURI)});h.on("error",f=>{c?console.warn("[TorrentService] Torrent error after ready (non-fatal):",f):(console.error("[TorrentService] Torrent error before ready:",f),d(f))}),h.on("warning",f=>{!g&&f.message&&f.message.includes("tracker")&&(console.warn("[TorrentService] Tracker warning (expected, trying alternatives):",f.message),g=!0)}),h.on("wire",f=>{this.emitEvent({type:"peer-connected",peerId:f.peerId||"unknown"})}),h.on("peer",f=>{console.log("[TorrentService] Peer connected for post torrent:",f.id||"unknown")})}catch(u){console.error("[TorrentService] Seed action failed synchronously:",u),d(u)}};this.ensureReadyAction(m),setTimeout(()=>{c||d(new Error("Seeding post timed out"))},15e3)})}async seedPostIndex(e,r,s){if(await this.readyPromise,!this.client||!this.clientReady)throw new Error("WebTorrent client not ready for seeding index");const n=s?.chunkSize||200,o=e.slice().sort((c,g)=>new Date(g.createdAt).getTime()-new Date(c.createdAt).getTime()).slice(0,n),i={version:1,author:r,generatedAt:new Date().toISOString(),posts:o.map(c=>({id:c.id,magnetUri:c.magnetUri||"",author:c.author,createdAt:c.createdAt,tags:c.tags})),next:s?.previousHeadMagnet||null,count:o.length},l=JSON.stringify(i,null,2),d=new File([new TextEncoder().encode(l)],`post_index_${Date.now()}.json`,{type:"application/json; charset=utf-8"});return new Promise((c,g)=>{try{const m=["wss://tracker.webtorrent.dev","wss://tracker.openwebtorrent.com","udp://tracker.openbittorrent.com:6969","udp://tracker.openbittorrent.com:80"],u=this.client.seed([d],{announce:m,announceList:[m]},h=>{console.log("[TorrentService] Post index seeded successfully:",{magnetURI:h.magnetURI,count:i.count,numPeers:h.numPeers}),this.emitEvent({type:"post-index-seeded",magnetURI:h.magnetURI,count:i.count}),c({magnetURI:h.magnetURI,count:i.count})});u.on("error",h=>{console.error("[TorrentService] Post index torrent error:",h),g(h)}),u.on("warning",h=>{h.message&&h.message.includes("tracker")&&console.warn("[TorrentService] Post index tracker warning (expected):",h.message)})}catch(m){console.error("[TorrentService] Failed to seed post index:",m),g(m)}})}async downloadPostIndexChain(e,r={}){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized");const s=r.maxPosts??500,n=r.maxChunks??20;let o=null;if(r.since)o=new Date(r.since).getTime();else if(r.monthsLookback){const m=new Date;m.setMonth(m.getMonth()-r.monthsLookback),o=m.getTime()}const i=[];let l=e,d=0,c=!1,g=null;for(;l&&d<n&&i.length<s;){if(r.signal?.aborted)throw new Error("Aborted");const{indexData:m,next:u}=await this.downloadSingleIndex(l);d++,this.emitEvent({type:"post-index-downloaded",magnetURI:l,count:m.count});for(const h of m.posts){if(i.length>=s){c=!0;break}if(o){const f=new Date(h.createdAt).getTime();if(isNaN(f))continue;if(f<o){c=!0;break}}i.push(h)}if(c)break;l=u,g=u}return{entries:i,truncated:c,chunksFetched:d,nextPointer:g}}async downloadSingleIndex(e){return new Promise((r,s)=>{try{const n=this.client.add(e,()=>{}),o=setTimeout(()=>s(new Error("Index download timeout")),2e4);n.on("done",()=>{clearTimeout(o);const i=n.files.find(l=>l.name&&l.name.startsWith("post_index_"));if(!i)return s(new Error("Index file not found in torrent"));i.getBuffer((l,d)=>{if(l)return s(l);try{let c;d instanceof ArrayBuffer?c=new TextDecoder("utf-8").decode(new Uint8Array(d)):d&&typeof d.toString=="function"?c=d.toString("utf8"):c=String(d);const g=JSON.parse(c);if(g.version!==1)return s(new Error("Unsupported index version"));r({indexData:g,next:g.next||null})}catch(c){s(c)}})}),n.on("error",i=>s(i))}catch(n){s(n)}})}async downloadProfile(e){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized. Are you in a browser environment?");try{return new Promise((r,s)=>{const n=setTimeout(()=>{s(new Error("Download timeout - no peers found"))},3e4);try{const o=this.client.add(e,i=>{console.log("Started downloading torrent:",i.name||"unnamed")});o.on("done",()=>{clearTimeout(n);const i=o.files.find(l=>l.name&&l.name.endsWith("_profile.json"));if(i)i.getBuffer((l,d)=>{if(l){this.emitEvent({type:"error",error:l.message}),s(l);return}try{let c;if(d instanceof ArrayBuffer){const m=new Uint8Array(d);c=new TextDecoder("utf-8",{fatal:!1}).decode(m)}else d&&typeof d.toString=="function"?c=d.toString("utf8"):c=String(d);const g=JSON.parse(c);this.emitEvent({type:"profile-downloaded",profile:g}),r(g)}catch(c){console.error("Profile parsing error:",c),console.error("Buffer type:",typeof d),console.error("Buffer constructor:",d?.constructor?.name),this.emitEvent({type:"error",error:`Failed to parse profile data: ${c instanceof Error?c.message:"Unknown error"}`}),s(c)}});else{const l="Profile file not found in torrent";this.emitEvent({type:"error",error:l}),s(new Error(l))}}),o.on("download",()=>{this.emitEvent({type:"download-progress",progress:o.progress||0,downloadSpeed:o.downloadSpeed||0}),this.updateStats()}),o.on("error",i=>{clearTimeout(n),this.emitEvent({type:"error",error:i.message}),s(i)})}catch(o){clearTimeout(n),s(o)}})}catch(r){throw console.error("Error downloading profile:",r),r}}async downloadPost(e){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized");return new Promise((r,s)=>{try{const n=this.client.add(e,()=>{}),o=setTimeout(()=>s(new Error("Post download timeout")),2e4);n.on("done",()=>{clearTimeout(o);const i=n.files.find(l=>l.name&&l.name.startsWith("post_")&&l.name.endsWith(".json"));if(!i)return s(new Error("Post JSON file not found in torrent"));i.getBuffer((l,d)=>{if(l)return s(l);try{let c;d instanceof ArrayBuffer?c=new TextDecoder("utf-8").decode(new Uint8Array(d)):d&&typeof d.toString=="function"?c=d.toString("utf8"):c=String(d);const g=JSON.parse(c);r(g)}catch(c){s(c)}})}),n.on("error",i=>s(i))}catch(n){s(n)}})}getStats(){return this.updateStats(),{...this.stats}}getActiveTorrents(){if(!this.client)return[];try{return this.client.torrents.map(e=>({infoHash:e.infoHash||"",name:e.name||"Unnamed Torrent",magnetURI:e.magnetURI||"",progress:e.progress||0,downloadSpeed:e.downloadSpeed||0,uploadSpeed:e.uploadSpeed||0,numPeers:e.numPeers||0,downloaded:e.downloaded||0,uploaded:e.uploaded||0}))}catch(e){return console.error("Error getting active torrents:",e),[]}}onEvent(e){return this.eventCallbacks.push(e),()=>{const r=this.eventCallbacks.indexOf(e);r>-1&&this.eventCallbacks.splice(r,1)}}stopSeeding(e){if(!this.client)return!1;try{const r=this.client.get(e);return r?(this.client.remove(r),this.activeTorrents.delete(e),this.updateStats(),!0):!1}catch(r){return console.error("Error stopping torrent seeding:",r),!1}}destroy(){try{this.client&&typeof this.client.destroy=="function"&&this.client.destroy()}catch(e){console.error("Error destroying torrent client:",e)}}}let X=null;function E(){return X||(X=new Se,typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("beforeunload",()=>{try{X?.destroy()}catch{}})),X}const qe=Object.freeze(Object.defineProperty({__proto__:null,TorrentService:Se,getTorrentService:E},Symbol.toStringTag,{value:"Module"}));function W(a){return a?{id:a.id,username:a.username,displayName:a.display_name||a.displayName||void 0,bio:a.bio||void 0,avatarHash:a.avatar_hash||a.avatarHash||void 0,publicKey:a.public_key||a.publicKey,fingerprint:a.fingerprint,createdAt:typeof a.created_at=="string"?a.created_at:a.createdAt,updatedAt:typeof a.updated_at=="string"?a.updated_at:a.updatedAt,version:a.version||1,magnetUri:a.magnet_uri||a.magnetUri||void 0,schemaVersion:1}:null}class Ge{wasmCore;eventCallbacks=new Set;capabilities=null;constructor(e){this.wasmCore=e}async init(){try{await this.wasmCore.init(),console.log("[SnartNetCore] WASM core initialized")}catch(e){throw console.error("[SnartNetCore] Init error:",e),e}}async getCapabilities(){if(this.capabilities)return this.capabilities;let e={profileJsonApi:!1,postJsonApi:!1,messageJsonApi:!1,version:"0"};const r=this.wasmCore.get_capabilities;if(typeof r=="function")try{const s=r.call(this.wasmCore);if(s){let n=s;if(typeof s=="string")try{n=JSON.parse(s)}catch{}e={profileJsonApi:!!(n.profileJsonApi||n.profile_json_api),postJsonApi:!!(n.postJsonApi||n.post_json_api),messageJsonApi:!!(n.messageJsonApi||n.message_json_api),version:n.version?String(n.version):"0"}}}catch(s){console.warn("[Core] capability probe failed, using defaults",s)}return this.capabilities=e,e}async createProfile(e,r,s){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.create_profile_json){const o=JSON.stringify({username:e,displayName:r||null,bio:s||null}),i=this.wasmCore.create_profile_json(o),l=typeof i=="string"?JSON.parse(i):i,d=l.profile||l.profileJson||l,c=W(d);return c&&this.emitEvent({type:"ProfileLoaded",profile:c}),l.magnetUri||d.magnetUri||""}try{const o=this.wasmCore.create_profile(e,r||void 0,s||void 0),i=this.wasmCore.get_current_profile(),l=W(i);return l&&this.emitEvent({type:"ProfileLoaded",profile:l}),o}catch(o){const i=String(o?.message||o);console.error("[Core] legacy create_profile failed:",o);const l=this.wasmCore.create_profile_json;if(l)try{const d=JSON.stringify({username:e,displayName:r||null,bio:s||null}),c=l(d),g=typeof c=="string"?JSON.parse(c):c,m=g.profile||g.profileJson||g,u=W(m);return u&&this.emitEvent({type:"ProfileLoaded",profile:u}),g.magnetUri||m.magnetUri||""}catch(d){console.error("[Core] JSON fallback also failed:",d)}if(/memory access out of bounds/i.test(i)){console.warn("[Core] Detected possible corrupted WASM state; clearing persisted key/profile entries");try{localStorage.removeItem("snartnet_keypair"),localStorage.removeItem("snartnet_current_profile")}catch{}}throw o}}async getCurrentProfile(){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.get_current_profile_json){const s=this.wasmCore.get_current_profile_json();if(!s)return null;const n=typeof s=="string"?JSON.parse(s):s,o=n.profile||n.profileJson||n;return W(o)}const r=this.wasmCore.get_current_profile();return W(r)}async updateProfile(e,r){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.update_profile_json){const i=JSON.stringify({displayName:e||null,bio:r||null}),l=this.wasmCore.update_profile_json(i),d=typeof l=="string"?JSON.parse(l):l,c=d.profile||d.profileJson||d,g=W(c);g&&this.emitEvent({type:"ProfileUpdated",profile:g});return}await this.wasmCore.update_current_profile(e||void 0,r||void 0);const n=this.wasmCore.get_current_profile(),o=W(n);o&&this.emitEvent({type:"ProfileUpdated",profile:o})}async getPublicKey(){try{return this.wasmCore.get_public_key()}catch(e){throw console.error("[SnartNetCore] Get public key error:",e),e}}async getFingerprint(){try{return this.wasmCore.get_fingerprint()}catch(e){throw console.error("[SnartNetCore] Get fingerprint error:",e),e}}async createPost(e,r,s){try{const n=this.wasmCore.create_post(e,r||null,s||null);return console.log("[SnartNetCore] Post created:",n),this.emitEvent({type:"PostAdded",post:n}),n}catch(n){throw console.error("[SnartNetCore] Create post error:",n),n}}async createMessage(e,r){try{const s=this.wasmCore.create_message(e,r);return console.log("[SnartNetCore] Message created:",s),this.emitEvent({type:"MessageReceived",message:s}),s}catch(s){throw console.error("[SnartNetCore] Create message error:",s),s}}hasProfile(){return this.wasmCore.has_profile()}subscribeToEvents(e){return this.eventCallbacks.add(e),()=>this.eventCallbacks.delete(e)}emitEvent(e){this.eventCallbacks.forEach(r=>{try{r(e)}catch(s){console.error("[SnartNetCore] Error in event callback:",s)}})}async seedCurrentProfile(){try{const e=this.wasmCore.get_current_profile();if(!e)throw new Error("No current profile to seed");console.log("[SnartNetCore] Profile data type:",typeof e),console.log("[SnartNetCore] Profile data:",e);let r;typeof e=="object"&&e!==null?r=JSON.parse(JSON.stringify(e)):r=e,console.log("[SnartNetCore] Clean profile:",r);const s=E();try{const o=r.username||r.id;if(o){const i=localStorage.getItem(`profile-picture-${o}`),l=localStorage.getItem(`profile-picture-thumb-${o}`);i&&(r.profilePicture=i),l&&(r.profilePictureThumbnail=l);const d=localStorage.getItem(`profile-extended-${o}`);if(d)try{const c=JSON.parse(d);c&&typeof c=="object"&&(c.location&&(r.location=c.location),c.website&&(r.website=c.website),c.avatar&&(r.avatar=c.avatar))}catch{}}}catch(o){console.warn("[SnartNetCore] Failed merging extended profile data",o)}if(!r.postIndexMagnetUri&&!r.post_index_magnet)try{const o=await s.seedPostIndex([],r.username||r.id||"unknown",{});r.postIndexMagnetUri=o.magnetURI}catch(o){console.warn("[SnartNetCore] Failed to seed empty post index",o)}const n=await s.seedProfile(r);return console.log("[SnartNetCore] Profile seeding started:",n),n}catch(e){throw console.error("[SnartNetCore] Failed to seed profile:",e),e}}async downloadProfileFromMagnet(e){try{const s=await E().downloadProfile(e);return console.log("[SnartNetCore] Profile downloaded:",s),s}catch(r){throw console.error("[SnartNetCore] Failed to download profile:",r),r}}getTorrentStats(){return E().getStats()}getActiveTorrents(){return E().getActiveTorrents()}async stopSeeding(e){E().stopSeeding(e)}validateProfile(e){if(!e||typeof e!="object")return!1;for(const r of["id","username","publicKey","fingerprint","createdAt","updatedAt"])if(!(r in e))return!1;return!0}validatePost(e){return!!e&&typeof e=="object"&&"id"in e&&"author"in e}}let ee=null;async function L(){if(!ee)try{await me(),await Je();const a=new ge;ee=new Ge(a),await ee.init(),console.log("[Core] Initialized successfully")}catch(a){throw console.error("[Core] Initialization failed:",a),a}return ee}function Pe(){const[a,e]=p.useState(null),[r,s]=p.useState(!0);return p.useEffect(()=>{L().then(n=>{e(n),s(!1)}).catch(n=>{console.error("Failed to initialize core:",n),s(!1)})},[]),{core:a,loading:r}}const Ye=Object.freeze(Object.defineProperty({__proto__:null,getCore:L,useCore:Pe},Symbol.toStringTag,{value:"Module"})),xe="snartnet:profile:seed-enabled",A=se(a=>({currentProfile:null,profiles:new Map,loading:!1,error:null,seedProfileEnabled:(()=>{const e=localStorage.getItem(xe);return e===null?!0:e==="true"})(),setCurrentProfile:e=>a({currentProfile:e}),addProfile:e=>a(r=>{const s=new Map(r.profiles);return s.set(e.username,e),{profiles:s}}),updateProfile:(e,r)=>a(s=>{const n=new Map(s.profiles),o=n.get(e);o&&n.set(e,{...o,...r});let i=s.currentProfile;return s.currentProfile?.username===e&&(i={...s.currentProfile,...r}),{profiles:n,currentProfile:i}}),updateProfilePicture:(e,r,s)=>a(n=>{const o={profilePicture:r,profilePictureThumbnail:s||r,updatedAt:new Date().toISOString()},i=new Map(n.profiles),l=i.get(e);l&&i.set(e,{...l,...o});let d=n.currentProfile;return n.currentProfile?.username===e&&(d={...n.currentProfile,...o},localStorage.setItem(`profile-picture-${e}`,r),s&&localStorage.setItem(`profile-picture-thumb-${e}`,s)),d&&L().then(c=>{c.seedCurrentProfile().catch(g=>console.warn("Reseed after picture update failed",g))}).catch(()=>{}),{profiles:i,currentProfile:d}}),setSeedProfileEnabled:e=>a(()=>{try{localStorage.setItem(xe,String(e))}catch{}return{seedProfileEnabled:e}}),setLoading:e=>a({loading:e}),setError:e=>a({error:e}),clearError:()=>a({error:null})})),Ze=Object.freeze(Object.defineProperty({__proto__:null,useProfileStore:A},Symbol.toStringTag,{value:"Module"})),ie="snartnet:ed25519:keypair:v1";function fe(){try{return typeof window<"u"&&!!window.crypto?.subtle&&window.crypto.subtle!==void 0}catch{return!1}}function ue(a){return btoa(String.fromCharCode(...a))}function re(a){const e=atob(a),r=e.length,s=new ArrayBuffer(r),n=new Uint8Array(s);for(let o=0;o<r;o++)n[o]=e.charCodeAt(o);return s}function Xe(a){return new Uint8Array(re(a))}async function et(){const a=localStorage.getItem(ie);if(a)try{return JSON.parse(a)}catch{}if(fe()&&window.crypto.subtle.generateKey)try{const s=await window.crypto.subtle.generateKey({name:"Ed25519",namedCurve:"Ed25519"},!0,["sign","verify"]),n=new Uint8Array(await window.crypto.subtle.exportKey("raw",s.publicKey)),o=new Uint8Array(await window.crypto.subtle.exportKey("pkcs8",s.privateKey)),i={publicKey:ue(n),secretKey:ue(o)};return localStorage.setItem(ie,JSON.stringify(i)),i}catch(s){console.warn("WebCrypto Ed25519 generateKey failed; falling back to WASM",s)}await he();const e=Be();let r;if(typeof e=="string"?r=JSON.parse(e):r=e,!r?.publicKey||!r?.secretKey)throw new Error("WASM generate_keypair returned unexpected format");return localStorage.setItem(ie,JSON.stringify(r)),r}let be=!1;async function he(){if(!be)try{await me(),be=!0}catch(a){throw console.error("Failed to initialize WASM core",a),a}}function Ce(a){const e={},r=["version","kind","authorPublicKey","createdAt","body","attachments","parentId","replyTo"];for(const s of r){const n=a[s];n!=null&&!(Array.isArray(n)&&n.length===0)&&(e[s]=n)}return JSON.stringify(e)}async function ye(a){const e=await et(),r=Ce({...a,authorPublicKey:e.publicKey});if(fe())try{const n=re(e.secretKey),o=await window.crypto.subtle.importKey("pkcs8",n,{name:"Ed25519",namedCurve:"Ed25519"},!1,["sign"]),i=await window.crypto.subtle.sign({name:"Ed25519"},o,new TextEncoder().encode(r)),l=ue(new Uint8Array(i));return{...a,authorPublicKey:e.publicKey,signature:l,version:a.version}}catch(n){console.warn("WebCrypto sign failed; falling back to WASM",n)}await he();const s=$e(JSON.stringify(e),r);return{...a,authorPublicKey:e.publicKey,signature:s,version:a.version}}async function we(a){const{signature:e,authorPublicKey:r,...s}=a,n=Ce({...s,authorPublicKey:r});if(fe())try{const o=re(r),i=await window.crypto.subtle.importKey("raw",o,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]);return{ok:await window.crypto.subtle.verify({name:"Ed25519"},i,re(e),new TextEncoder().encode(n))}}catch(o){console.warn("WebCrypto verify failed; fallback to WASM",o)}await he();try{const o=ze(n,e,r);return{ok:o,error:o?void 0:"invalid-signature"}}catch(o){return{ok:!1,error:o?.message||"verify-error"}}}function le(a){const e=Xe(a);return"fpr-"+Array.from(e.slice(0,6)).map(r=>r.toString(16).padStart(2,"0")).join("")}const ve=a=>{switch(a){case"ring-of-trust":return{canMessage:!0,canSeeFullProfile:!0,canShareContacts:!0,canRecoverKeys:!0};case"friend":return{canMessage:!0,canSeeFullProfile:!0,canShareContacts:!0,canRecoverKeys:!1};case"acquaintance":return{canMessage:!0,canSeeFullProfile:!1,canShareContacts:!1,canRecoverKeys:!1};case"group-member":return{canMessage:!0,canSeeFullProfile:!1,canShareContacts:!1,canRecoverKeys:!1}}},ke=(a,e)=>`contact_${btoa(a+e).slice(0,16)}`,$=se((a,e)=>({contacts:[],loadContacts:()=>{try{const r=localStorage.getItem("snartnet-contacts");if(r){let s=JSON.parse(r);s=s.map(n=>({...n,id:n.id||ke(n.username,n.magnetUri)})),a({contacts:s}),localStorage.setItem("snartnet-contacts",JSON.stringify(s))}}catch(r){console.error("Failed to load contacts:",r)}},addContact:r=>{const s=e().contacts,n={...r,id:ke(r.username,r.magnetUri),addedDate:new Date().toISOString(),permissions:ve(r.relationship)},o=s.findIndex(i=>i.id===n.id);if(o>=0){const i=[...s];i[o]={...i[o],...n},a({contacts:i}),localStorage.setItem("snartnet-contacts",JSON.stringify(i))}else{const i=[...s,n];a({contacts:i}),localStorage.setItem("snartnet-contacts",JSON.stringify(i))}},addContactFromMagnet:async(r,s="friend")=>{try{const n=`pending_${Math.random().toString(36).slice(2)}`,o={id:n,username:"loading…",displayName:"Loading profile…",relationship:s,trustLevel:s==="ring-of-trust"?8:5,addedDate:new Date().toISOString(),magnetUri:r,permissions:ve(s)},i=e().contacts;a({contacts:[...i,o]});const{getTorrentService:l}=await Y(async()=>{const{getTorrentService:x}=await Promise.resolve().then(()=>qe);return{getTorrentService:x}},void 0),c=await l().downloadProfile(r);if(!c)return a({contacts:e().contacts.map(x=>x.id===n?{...x,username:"unknown",displayName:"Profile unavailable"}:x)}),null;const g=c.username||"unknown",m=c.displayName||g,u=c.avatar||c.profilePicture||void 0,h={username:g,displayName:m,relationship:s,trustLevel:s==="ring-of-trust"?8:5,magnetUri:r,avatar:u,notes:"",postIndexMagnetUri:c.postIndexMagnetUri||c.post_index_magnet||void 0,syncMaxPosts:100,syncMonthsLookback:6};a({contacts:e().contacts.filter(x=>x.id!==n)}),e().addContact(h);const f=e().contacts.find(x=>x.username===g&&x.magnetUri===r);if(f&&h.postIndexMagnetUri){const{usePostStore:x}=await Y(async()=>{const{usePostStore:y}=await Promise.resolve().then(()=>tt);return{usePostStore:y}},void 0);try{await x.getState().syncPostsForContact(f.id,{maxPosts:h.syncMaxPosts||50,monthsLookback:h.syncMonthsLookback||6}),console.log("[ContactStore] Auto-synced posts for new contact:",g)}catch(y){console.warn("[ContactStore] Failed to auto-sync posts for new contact:",y)}}return f||null}catch(n){return console.error("addContactFromMagnet failed",n),a({contacts:e().contacts.filter(o=>!o.id.startsWith("pending_"))}),null}},removeContact:r=>{const n=e().contacts.filter(o=>o.id!==r);a({contacts:n}),localStorage.setItem("snartnet-contacts",JSON.stringify(n))},updateContact:(r,s)=>{const o=e().contacts.map(i=>i.id===r?{...i,...s}:i);a({contacts:o}),localStorage.setItem("snartnet-contacts",JSON.stringify(o))},getContactsByRelationship:r=>e().contacts.filter(s=>s.relationship===r),getContact:r=>e().contacts.find(s=>s.id===r)}));function ce(a){return a?{id:a.id||a.postId||Math.random().toString(36).slice(2),author:a.author||a.author_fingerprint||a.fingerprint||"unknown",authorDisplayName:a.authorDisplayName||a.author_display_name||a.displayName,authorAvatar:a.authorAvatar||a.author_avatar,content:a.content||"",images:a.images,magnetUri:a.magnetUri||a.magnet_uri,createdAt:a.createdAt||a.created_at||new Date().toISOString(),updatedAt:a.updatedAt||a.updated_at,tags:a.tags,version:a.version||1,schemaVersion:1,authorPublicKey:a.authorPublicKey||a.author_public_key,signature:a.signature,signatureVerified:a.signatureVerified||a.signature_verified,signatureError:a.signatureError||a.signature_error,fingerprint:a.fingerprint}:null}const P=se(a=>({posts:[],loading:!1,error:null,addPost:async e=>{const r=new Date().toISOString();let s,n;try{const l=await ye({version:1,kind:"post",body:e.content,createdAt:r,attachments:e.images?.map(d=>d.id)});s=l.signature,n=l.authorPublicKey}catch(l){console.warn("Signing post failed; proceeding unsigned",l)}const o={...e,id:Math.random().toString(36).slice(2),createdAt:r,signature:s,authorPublicKey:n,fingerprint:n?le(n):void 0,signatureVerified:!!s},i=ce(o);a(l=>({posts:[i,...l.posts].sort((d,c)=>new Date(c.createdAt).getTime()-new Date(d.createdAt).getTime())}));try{const d=await E().seedPost({...i});a(c=>({posts:c.posts.map(g=>g.id===i.id?{...g,magnetUri:d,seedProgress:100,isSeeding:!1}:g)}))}catch(l){console.error("Failed to seed post:",l),a(d=>({posts:d.posts.map(c=>c.id===i.id?{...c,isSeeding:!1,seedProgress:0,seedError:l instanceof Error?l.message:"Failed to seed"}:c)}))}},removePost:e=>{a(r=>({posts:r.posts.filter(s=>s.id!==e)}))},updatePost:(e,r)=>{a(s=>({posts:s.posts.map(n=>n.id===e?{...n,...r}:n)}))},updateSeedingStatus:(e,r,s)=>{a(n=>({posts:n.posts.map(o=>o.id===e?{...o,isSeeding:r,seedProgress:s}:o)}))},loadPostsFromContacts:async()=>{const r=$.getState().contacts.filter(d=>!!d.postIndexMagnetUri);if(r.length===0){a({loading:!1});return}a({loading:!0});const s=2,n=[...r],o=[],i=new Set,l=()=>{if(n.length===0)return;const d=n.shift();i.add(d.id);const c=(async()=>{try{await P.getState().syncPostsForContact(d.id,{maxPosts:d.syncMaxPosts,monthsLookback:d.syncMonthsLookback})}catch(g){console.warn("Sync failed for contact",d.id,g)}})().finally(()=>{const g=o.indexOf(c);g>=0&&o.splice(g,1),n.length>0?l():o.length===0&&a({loading:!1})});o.push(c),o.length<s&&n.length>0&&l()};for(let d=0;d<s&&n.length>0;d++)l()},setLoading:e=>a({loading:e}),setError:e=>a({error:e}),clearError:()=>a({error:null}),syncPostsForContact:async(e,r)=>{const n=$.getState().contacts.find(o=>o.id===e);if(!(!n||!n.postIndexMagnetUri)){a({loading:!0});try{const i=await E().downloadPostIndexChain(n.postIndexMagnetUri,{maxPosts:r?.maxPosts??n.syncMaxPosts??100,monthsLookback:r?.monthsLookback??n.syncMonthsLookback}),l=new Set(P.getState().posts.map(u=>u.id)),d=i.entries.filter(u=>u.magnetUri&&!l.has(u.id)),c=3,g=[...d],m=[];for(;g.length>0;){const u=g.splice(0,c);await Promise.all(u.map(async h=>{try{const f=await E().downloadPost(h.magnetUri);if(f&&typeof f=="object"){let x=f;try{if(f.signature&&f.authorPublicKey){const{ok:y,error:v}=await we({...f,version:f.version||1,kind:"post"});x.signatureVerified=y,x.signatureError=y?void 0:v||"invalid-signature",x.fingerprint=f.authorPublicKey?le(f.authorPublicKey):f.fingerprint}else x.signatureVerified=!1,x.signatureError="missing-signature"}catch(y){x.signatureVerified=!1,x.signatureError=y?.message||"verify-failed"}m.push(ce(x))}else m.push({id:h.id,author:h.author,content:`(Unavailable content) @${h.author}`,createdAt:h.createdAt,magnetUri:h.magnetUri,images:[]})}catch{m.push({id:h.id,author:h.author,content:`(Failed to fetch) @${h.author}`,createdAt:h.createdAt,magnetUri:h.magnetUri,images:[]})}}))}m.length?a(u=>({posts:[...u.posts,...m].sort((h,f)=>new Date(f.createdAt).getTime()-new Date(h.createdAt).getTime()),loading:!1})):a({loading:!1})}catch(o){a({loading:!1,error:o instanceof Error?o.message:"Failed to sync posts"})}}},fetchPostFromMagnet:async e=>{try{const r=await E().downloadPost(e);if(!r)return null;let s=r;try{if(r.signature&&r.authorPublicKey){const{ok:o,error:i}=await we({...r,version:r.version||1,kind:"post"});s.signatureVerified=o,s.signatureError=o?void 0:i||"invalid-signature",s.fingerprint=r.authorPublicKey?le(r.authorPublicKey):r.fingerprint}else s.signatureVerified=!1,s.signatureError="missing-signature"}catch(o){s.signatureVerified=!1,s.signatureError=o?.message||"verify-failed"}const n=ce(s);return n?(a(o=>o.posts.some(l=>l.id===n.id)?{posts:o.posts.map(l=>l.id===n.id?{...l,...n}:l)}:{posts:[n,...o.posts].sort((l,d)=>new Date(d.createdAt).getTime()-new Date(l.createdAt).getTime())}),n):null}catch(r){return console.error("Failed to download post",r),null}},editPost:async(e,r)=>{const n=P.getState().posts.find(d=>d.id===e);if(!n)return;const o=new Date().toISOString();let i,l;try{const d=await ye({version:1,kind:"post",body:r,createdAt:n.createdAt,updatedAt:o,attachments:n.images?.map(c=>c.id)});i=d.signature,l=d.authorPublicKey}catch(d){console.warn("Re-signing edited post failed; proceeding unsigned",d)}a(d=>({posts:d.posts.map(c=>c.id===e?{...c,content:r,updatedAt:o,signature:i,authorPublicKey:l,signatureVerified:!!i,isSeeding:!0}:c)}));try{const c=await E().seedPost({...n,content:r,updatedAt:o,signature:i,authorPublicKey:l});a(g=>({posts:g.posts.map(m=>m.id===e?{...m,magnetUri:c,isSeeding:!1,seedProgress:100}:m)}))}catch(d){console.error("Failed to reseed edited post",d),a(c=>({posts:c.posts.map(g=>g.id===e?{...g,isSeeding:!1,seedError:"Edit reseed failed"}:g)}))}await P.getState().regenerateAuthorIndex(n.author)},regenerateAuthorIndex:async e=>{try{const r=P.getState().posts.filter(c=>c.author===e&&c.magnetUri),s=E(),n=await Y(()=>Promise.resolve().then(()=>Ze),void 0),{useProfileStore:o}=n,i=o.getState().currentProfile,l=i?.postIndexMagnetUri||null,d=await s.seedPostIndex(r,e,{previousHeadMagnet:l});if(i&&i.username===e){o.getState().updateProfile(e,{postIndexMagnetUri:d.magnetURI});try{(await Y(async()=>{const{getCore:c}=await Promise.resolve().then(()=>Ye);return{getCore:c}},void 0)).getCore().then(c=>c.seedCurrentProfile())}catch{}}}catch(r){console.warn("Failed to regenerate post index",r)}},deletePost:async e=>{const s=P.getState().posts.find(n=>n.id===e);s&&(P.getState().removePost(e),await P.getState().regenerateAuthorIndex(s.author))}})),tt=Object.freeze(Object.defineProperty({__proto__:null,usePostStore:P},Symbol.toStringTag,{value:"Module"}));class I{static PROFILE_SIZE=200;static THUMBNAIL_SIZE=64;static MAX_FILE_SIZE=2*1024*1024;static SUPPORTED_FORMATS=["image/jpeg","image/png","image/webp"];static OUTPUT_FORMAT="image/jpeg";static OUTPUT_QUALITY=.85;static async processProfilePicture(e){this.validateFile(e);const r=await this.loadImage(e),s=this.calculateSquareCrop(r.width,r.height);return await this.resizeAndCompress(r,s,this.PROFILE_SIZE)}static async createThumbnail(e){const r=await this.loadImageFromDataUrl(e.dataUrl),s={x:0,y:0,width:r.width,height:r.height};return this.resizeAndCompress(r,s,this.THUMBNAIL_SIZE)}static async processWithCrop(e,r){this.validateFile(e);const s=await this.loadImage(e);return this.resizeAndCompress(s,r,this.PROFILE_SIZE)}static validateFile(e){if(!this.SUPPORTED_FORMATS.includes(e.type))throw new Error(`Unsupported file format. Please use: ${this.SUPPORTED_FORMATS.join(", ")}`);if(e.size>this.MAX_FILE_SIZE)throw new Error(`File too large. Maximum size: ${Math.round(this.MAX_FILE_SIZE/1024/1024)}MB`)}static loadImage(e){return new Promise((r,s)=>{const n=new Image,o=URL.createObjectURL(e);n.onload=()=>{URL.revokeObjectURL(o),r(n)},n.onerror=()=>{URL.revokeObjectURL(o),s(new Error("Failed to load image"))},n.src=o})}static loadImageFromDataUrl(e){return new Promise((r,s)=>{const n=new Image;n.onload=()=>r(n),n.onerror=()=>s(new Error("Failed to load image from data URL")),n.src=e})}static calculateSquareCrop(e,r){const s=Math.min(e,r),n=(e-s)/2,o=(r-s)/2;return{x:n,y:o,width:s,height:s}}static async resizeAndCompress(e,r,s){const n=document.createElement("canvas"),o=n.getContext("2d");if(!o)throw new Error("Canvas context not available");n.width=s,n.height=s,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(e,r.x,r.y,r.width,r.height,0,0,s,s);const i=await new Promise((d,c)=>{n.toBlob(g=>{g?d(g):c(new Error("Failed to create blob"))},this.OUTPUT_FORMAT,this.OUTPUT_QUALITY)});return{dataUrl:n.toDataURL(this.OUTPUT_FORMAT,this.OUTPUT_QUALITY),blob:i,width:s,height:s,size:i.size,format:this.OUTPUT_FORMAT}}static async blobToBase64(e){return new Promise((r,s)=>{const n=new FileReader;n.onload=()=>{const i=n.result.split(",")[1];r(i)},n.onerror=()=>s(new Error("Failed to convert blob to base64")),n.readAsDataURL(e)})}static base64ToDataUrl(e,r=this.OUTPUT_FORMAT){return`data:${r};base64,${e}`}static formatFileSize(e){if(e===0)return"0 B";const r=1024,s=["B","KB","MB"],n=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,n)).toFixed(1))+" "+s[n]}static validateImageDimensions(e,r){if(e<100||r<100)throw new Error("Image too small. Minimum size: 100x100px");if(e>4e3||r>4e3)throw new Error("Image too large. Maximum size: 4000x4000px")}static generateAvatarInitials(e){return e.split(" ").map(r=>r.charAt(0).toUpperCase()).join("").substring(0,2)}static generateAvatarGradient(e){let r=0;for(let o=0;o<e.length;o++){const i=e.charCodeAt(o);r=(r<<5)-r+i,r=r&r}const s=Math.abs(r%360),n=(s+60)%360;return`linear-gradient(135deg, hsl(${s}, 70%, 50%), hsl(${n}, 70%, 70%))`}}async function rt(a,e){return a.type.startsWith("image/")?new Promise((r,s)=>{const n=new FileReader;n.onload=o=>{const i=o.target?.result;i?r({id:`${a.name}-${a.lastModified}`,data:i,filename:a.name,size:a.size,mimeType:a.type}):s(new Error("Failed to read file data."))},n.onerror=o=>{s(o)},n.readAsDataURL(a)}):(console.warn(`File is not an image: ${a.name}`),null)}function at(){const[a,e]=p.useState(""),[r,s]=p.useState([]),[n,o]=p.useState(!1),{currentProfile:i}=A(),l=P(u=>u.addPost),d=p.useRef(null),c=async u=>{if(u.target.files){const h=Array.from(u.target.files);try{const f=await Promise.all(h.map(x=>rt(x,"post-image")));s(x=>[...x,...f.filter(y=>y!==null)])}catch(f){console.error("Error processing images:",f)}}},g=u=>{s(h=>h.filter(f=>f.id!==u))},m=async u=>{if(u.preventDefault(),!(!a.trim()&&r.length===0||!i)){o(!0);try{const h=i.publicKey||i.username;await l({author:h,authorDisplayName:i.displayName||i.username,authorAvatar:i.avatar,content:a,images:r}),console.log("Post created and seeding process initiated."),e(""),s([])}catch(h){console.error("Failed to create post:",h)}finally{o(!1)}}};return i?t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white mb-4",children:"Create New Post"}),t.jsxs("form",{onSubmit:m,className:"space-y-4",children:[t.jsx("textarea",{value:a,onChange:u=>e(u.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"What's happening on the swarm?",disabled:n}),r.length>0&&t.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4",children:r.map(u=>t.jsxs("div",{className:"relative group",children:[t.jsx("img",{src:u.data,alt:"Post attachment",className:"w-full h-24 object-cover rounded-md"}),t.jsx("button",{type:"button",onClick:()=>g(u.id),className:"absolute top-1 right-1 bg-black/50 text-white rounded-full p-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity","aria-label":"Remove image",children:"✕"})]},u.id))}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("button",{type:"button",onClick:()=>d.current?.click(),className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700","aria-label":"Add image",disabled:n,children:t.jsx("svg",{className:"w-6 h-6 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),t.jsx("input",{type:"file",ref:d,onChange:c,className:"hidden",accept:"image/*",multiple:!0,disabled:n,"aria-label":"File uploader"}),t.jsx("span",{className:"text-sm text-gray-500",children:"Posts are seeded as torrents"})]}),t.jsx("button",{type:"submit",disabled:n||!a.trim()&&r.length===0,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:n?"🌱 Seeding...":"🌱 Seed Post"})]})]})]}):t.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6",children:t.jsx("p",{className:"text-yellow-700 dark:text-yellow-300",children:"You need to create a profile before you can make posts."})})}const st=()=>{const{posts:a,loading:e,loadPostsFromContacts:r}=P(),{loadContacts:s,contacts:n}=$(),{currentProfile:o}=A();p.useEffect(()=>{s(),r()},[s,r]);const i=p.useMemo(()=>{const d=new Set;return o&&(o.publicKey&&d.add(o.publicKey),d.add(o.username)),n.forEach(c=>{(c.relationship==="friend"||c.relationship==="ring-of-trust")&&d.add(c.username)}),d},[n,o]),l=p.useMemo(()=>i.size===0?a:a.filter(d=>i.has(d.author)||d.authorDisplayName&&i.has(d.authorDisplayName)),[a,i]);return e?t.jsxs("div",{className:"flex items-center justify-center py-8",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),t.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading timeline..."})]}):t.jsx("div",{className:"space-y-6",children:l.length===0?t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"text-6xl mb-4",children:"🌱"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No posts yet"}),t.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Add some friends or seed a post to see activity here."})]}):l.map(d=>t.jsx(nt,{post:d},d.id))})},nt=({post:a})=>t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6",children:[t.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold",children:a.authorAvatar?t.jsx("img",{src:I.base64ToDataUrl(a.authorAvatar),alt:a.author,className:"w-10 h-10 rounded-full object-cover"}):a.author.charAt(0).toUpperCase()}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:a.authorDisplayName||a.author}),t.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["@",a.author]}),a.signatureVerified?t.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700",title:`Signature verified${a.fingerprint?` • ${a.fingerprint}`:""}`,children:"✅ ver"}):t.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700",title:a.signatureError==="missing-signature"?"No signature present":`Signature invalid: ${a.signatureError||"unknown"}`,children:"⚠️ unverified"})]}),t.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400",children:[t.jsx("span",{children:ot(a.createdAt)}),a.isSeeding&&t.jsxs("span",{className:"flex items-center text-green-600 dark:text-green-400",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-1"}),"Seeding"]}),a.magnetUri&&t.jsx("span",{className:"flex items-center text-blue-600 dark:text-blue-400",children:"🧲 Torrent"})]})]})]}),a.content&&t.jsx("div",{className:"mb-4",children:t.jsx("p",{className:"text-gray-900 dark:text-gray-100 whitespace-pre-line",children:a.content})}),a.images&&a.images.length>0&&t.jsx("div",{className:`mb-4 grid gap-2 ${a.images.length===1?"grid-cols-1":(a.images.length===2||a.images.length===3,"grid-cols-2")}`,children:a.images.map((e,r)=>t.jsx("div",{className:`${a.images.length===3&&r===0?"col-span-2":""}`,children:t.jsx("img",{src:I.base64ToDataUrl(e.data),alt:e.filename,className:"w-full h-64 object-cover rounded-lg border border-gray-200 dark:border-gray-600 cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{window.open(I.base64ToDataUrl(e.data),"_blank")}})},e.id))}),a.tags&&a.tags.length>0&&t.jsx("div",{className:"mb-4",children:t.jsx("div",{className:"flex flex-wrap gap-2",children:a.tags.map(e=>t.jsxs("span",{className:"px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full",children:["#",e]},e))})}),t.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700",children:[t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})}),t.jsx("span",{className:"text-sm",children:"Like"})]}),t.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),t.jsx("span",{className:"text-sm",children:"Reply"})]}),t.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"})}),t.jsx("span",{className:"text-sm",children:"Share"})]})]}),a.magnetUri&&t.jsx("button",{onClick:()=>navigator.clipboard.writeText(a.magnetUri),className:"text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",title:"Copy magnet link",children:"🧲 Copy Magnet"})]})]}),ot=a=>{const e=new Date(a),s=Math.floor((new Date().getTime()-e.getTime())/1e3);return s<60?"just now":s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<604800?`${Math.floor(s/86400)}d ago`:e.toLocaleDateString()},it=()=>{const{core:a,loading:e}=Pe(),{currentProfile:r}=A(),[s,n]=p.useState(!0);return p.useEffect(()=>{a&&n(!1)},[a]),e||s?t.jsx("div",{className:"flex items-center justify-center min-h-64",children:t.jsx("div",{className:"text-gray-600 dark:text-gray-300",children:"Loading SnartNet..."})}):t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-4",children:"SnartNet"}),t.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-300 mb-8",children:"Decentralized social media, powered by swarms."}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[t.jsxs("div",{className:"lg:col-span-2",children:[r&&t.jsx(at,{}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[t.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[t.jsx("span",{children:"Timeline"}),t.jsx("span",{className:"ml-2 text-sm text-gray-500 dark:text-gray-400",children:"(Torrent-seeded posts)"})]}),t.jsx(st,{})]})]}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[t.jsx("h2",{className:"text-xl font-semibold mb-4",children:"How It Works"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-4",children:"Every post is a torrent seed! Your content is distributed across the swarm, making it censorship-resistant and decentralized."}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-gray-500",children:"🌱 Posts are seeded as torrents"}),t.jsx("p",{className:"text-sm text-gray-500",children:"📷 Images included in torrent files"}),t.jsx("p",{className:"text-sm text-gray-500",children:"🔐 Content cryptographically signed"}),t.jsx("p",{className:"text-sm text-gray-500",children:"🤝 Shared through your Ring of Trust"})]})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[t.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Features"}),t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),t.jsx("span",{children:"Profile pictures & posts"})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),t.jsx("span",{children:"Image upload & processing"})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),t.jsx("span",{children:"Post torrent seeding"})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),t.jsx("span",{children:"Chronological timeline"})]}),t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-yellow-500 rounded-full mr-2"}),t.jsx("span",{children:"P2P post sharing (WIP)"})]})]})]})]})]})]})};function _e(){const[a,e]=p.useState(""),[r,s]=p.useState(""),[n,o]=p.useState(""),[i,l]=p.useState(!1),[d,c]=p.useState(null),[g,m]=p.useState(null),{setCurrentProfile:u,setLoading:h,setError:f}=A(),x=async y=>{if(y.preventDefault(),!a.trim()){c("Username is required");return}l(!0),c(null),m(null),f(null),h(!0);try{console.log("[CreateProfile] Starting profile creation...");const v=await L();console.log("[CreateProfile] Core initialized");const w=await v.createProfile(a.trim(),r.trim()||void 0,n.trim()||void 0);console.log("[CreateProfile] Profile created with magnet URI:",w);const R=await v.getCurrentProfile();if(console.log("[CreateProfile] Retrieved profile:",R),R)u(R),m(`Profile created successfully! Magnet URI: ${w}`),e(""),s(""),o(""),console.log("[CreateProfile] Profile creation completed successfully");else throw new Error("Failed to retrieve created profile")}catch(v){console.error("[CreateProfile] Error creating profile:",v);const w=v instanceof Error?v.message:"Failed to create profile";c(w),f(w)}finally{l(!1),h(!1)}};return t.jsx("div",{className:"max-w-md mx-auto",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Create Your Profile"}),t.jsxs("form",{onSubmit:x,className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username *"}),t.jsx("input",{type:"text",id:"username",value:a,onChange:y=>e(y.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter your username",disabled:i,required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"displayName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Display Name"}),t.jsx("input",{type:"text",id:"displayName",value:r,onChange:y=>s(y.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Your display name (optional)",disabled:i})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"bio",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Bio"}),t.jsx("textarea",{id:"bio",value:n,onChange:y=>o(y.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Tell us about yourself (optional)",disabled:i})]}),d&&t.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md",children:t.jsx("p",{className:"text-red-700 dark:text-red-300 text-sm",children:d})}),g&&t.jsx("div",{className:"p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md",children:t.jsx("p",{className:"text-green-700 dark:text-green-300 text-sm",children:g})}),t.jsx("button",{type:"submit",disabled:i||!a.trim(),className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:cursor-not-allowed",children:i?t.jsxs("span",{className:"flex items-center justify-center",children:[t.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Creating Profile..."]}):"Create Profile"})]}),t.jsxs("div",{className:"mt-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[t.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white mb-2",children:"🔐 What happens when you create a profile?"}),t.jsxs("ul",{className:"text-xs text-gray-600 dark:text-gray-400 space-y-1",children:[t.jsx("li",{children:"• A new Ed25519 cryptographic key pair is generated"}),t.jsx("li",{children:"• Your profile is signed with your private key"}),t.jsx("li",{children:"• A magnet URI is created for peer-to-peer sharing"}),t.jsx("li",{children:"• Your private keys stay in your browser (never uploaded)"})]})]})]})})}const lt=({profilePicture:a,username:e="User",size:r="md",className:s="",showOnlineStatus:n=!1,isOnline:o=!1,alt:i})=>{const l={xs:"w-6 h-6",sm:"w-8 h-8",md:"w-12 h-12",lg:"w-16 h-16",xl:"w-24 h-24"},d={xs:"w-1.5 h-1.5 bottom-0 right-0",sm:"w-2 h-2 bottom-0 right-0",md:"w-3 h-3 bottom-0.5 right-0.5",lg:"w-4 h-4 bottom-1 right-1",xl:"w-6 h-6 bottom-1 right-1"},c=m=>m.split(" ").map(u=>u.charAt(0).toUpperCase()).slice(0,2).join(""),g=a?t.jsx("img",{src:I.base64ToDataUrl(a),alt:i||`${e}'s avatar`,className:`${l[r]} rounded-full object-cover ${s}`}):t.jsx("div",{className:`${l[r]} rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold ${s}`,title:e,children:t.jsx("span",{className:`${r==="xs"?"text-xs":r==="sm"?"text-sm":r==="md"?"text-base":r==="lg"?"text-lg":"text-xl"}`,children:c(e)})});return t.jsxs("div",{className:"relative inline-block",children:[g,n&&t.jsx("div",{className:`absolute ${d[r]} ${o?"bg-green-400":"bg-gray-400"} border-2 border-white dark:border-gray-800 rounded-full`})]})},ct=({onClose:a,onSuccess:e})=>{const{currentProfile:r,updateProfilePicture:s}=A(),n=p.useRef(null),[o,i]=p.useState(!1),[l,d]=p.useState(!1),[c,g]=p.useState(null),[m,u]=p.useState(null),[h,f]=p.useState(""),[x,y]=p.useState(0),v=()=>{g(null),u(null),f(""),y(0),n.current&&(n.current.value="")},w=p.useCallback(async j=>{const F=j[0];if(F)try{d(!0),f("📤 Processing image..."),y(25);const C=await I.processProfilePicture(F);y(75),await I.createThumbnail(C),y(90),u(C),g(C.dataUrl),f(`✅ Image processed successfully! Size: ${I.formatFileSize(C.size)}`),y(100),console.log("Image processed:",{originalSize:F.size,processedSize:C.size,dimensions:`${C.width}x${C.height}`,format:C.format})}catch(C){console.error("Image processing error:",C),f(`❌ Error: ${C instanceof Error?C.message:"Unknown error"}`),v()}finally{d(!1)}},[]),R=j=>{const F=j.target.files;F&&F.length>0&&w(F)},Z=p.useCallback(j=>{j.preventDefault(),j.stopPropagation(),i(!1),j.dataTransfer.files&&j.dataTransfer.files.length>0&&w(j.dataTransfer.files)},[w]),k=p.useCallback(j=>{j.preventDefault(),j.stopPropagation(),j.type==="dragenter"||j.type==="dragover"?i(!0):j.type==="dragleave"&&i(!1)},[]),B=async()=>{if(!m||!r){f("❌ No image to save or no current profile");return}try{d(!0),f("💾 Saving profile picture...");const j=await I.blobToBase64(m.blob),F=await I.createThumbnail(m),C=await I.blobToBase64(F.blob);s(r.username,j,C),f("✅ Profile picture saved successfully!"),e&&e(m.dataUrl),setTimeout(()=>{a&&a()},1500)}catch(j){console.error("Save error:",j),f(`❌ Failed to save: ${j instanceof Error?j.message:"Unknown error"}`)}finally{d(!1)}},z=()=>{r&&confirm("Remove your profile picture?")&&(s(r.username,"",""),localStorage.removeItem(`profile-picture-${r.username}`),localStorage.removeItem(`profile-picture-thumb-${r.username}`),f("✅ Profile picture removed"),e&&e(""),setTimeout(()=>{a&&a()},1e3))},Ie=()=>x>=100?"w-full":x>=90?"w-11/12":x>=75?"w-3/4":x>=50?"w-1/2":x>=25?"w-1/4":"w-0";return t.jsxs("div",{className:"max-w-md mx-auto p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Profile Picture"}),a&&t.jsx("button",{onClick:a,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:"✕"})]}),!c&&t.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${o?"border-blue-400 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500"}`,onDragEnter:k,onDragLeave:k,onDragOver:k,onDrop:Z,children:[t.jsx("div",{className:"text-4xl mb-4",children:"📷"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Drag and drop an image here, or click to select"}),t.jsx("button",{onClick:()=>n.current?.click(),disabled:l,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"Choose Image"}),t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:R,className:"hidden","aria-label":"Select profile picture file",title:"Select profile picture file"}),t.jsxs("div",{className:"mt-4 text-xs text-gray-500 dark:text-gray-400",children:[t.jsx("p",{children:"Supported: JPEG, PNG, WebP"}),t.jsx("p",{children:"Max size: 2MB • Auto-cropped to square"})]})]}),c&&t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"flex justify-center",children:t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:c,alt:"Profile preview",className:"w-32 h-32 rounded-full object-cover border-4 border-gray-200 dark:border-gray-600"}),l&&t.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})})]})}),m&&t.jsxs("div",{className:"text-center text-sm text-gray-600 dark:text-gray-400",children:[t.jsxs("p",{children:["Size: ",I.formatFileSize(m.size)]}),t.jsxs("p",{children:["Dimensions: ",m.width,"×",m.height,"px"]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:B,disabled:l||!m,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:l?"💾 Saving...":"💾 Save"}),t.jsx("button",{onClick:v,disabled:l,className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"🔄 Try Again"})]})]}),l&&x>0&&t.jsx("div",{className:"mt-4",children:t.jsx("div",{className:"bg-gray-200 dark:bg-gray-700 rounded-full h-2",children:t.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${Ie()}`})})}),r?.profilePicture&&!c&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[t.jsx("div",{className:"flex items-center justify-center mb-4",children:t.jsx("img",{src:I.base64ToDataUrl(r.profilePicture),alt:"Current profile",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600"})}),t.jsx("button",{onClick:z,className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"🗑️ Remove Current Picture"})]}),h&&t.jsx("div",{className:`mt-4 p-3 rounded-lg text-sm ${h.startsWith("✅")?"bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200":h.startsWith("❌")?"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200":"bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200"}`,children:h})]})},dt=()=>{const{currentProfile:a}=A(),{posts:e,addPost:r,deletePost:s,editPost:n}=P(),[o,i]=p.useState(""),[l,d]=p.useState(!1),[c,g]=p.useState(null),[m,u]=p.useState(""),h=p.useMemo(()=>a?e.filter(x=>x.author===a.username).sort((x,y)=>new Date(y.createdAt).getTime()-new Date(x.createdAt).getTime()):[],[e,a]);if(!a)return null;const f=async x=>{if(x.preventDefault(),!!o.trim()){d(!0);try{await r({author:a.username,authorDisplayName:a.displayName,content:o.trim(),images:[]}),i("")}finally{d(!1)}}};return t.jsxs("div",{className:"w-full max-w-xl mx-auto mt-8",children:[t.jsxs("form",{onSubmit:f,className:"mb-6 flex flex-col gap-2",children:[t.jsx("textarea",{className:"w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-vertical",rows:3,placeholder:"What's on your mind?",value:o,onChange:x=>i(x.target.value),disabled:l}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:o.length>0&&`${o.length} chars`}),t.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",disabled:l||!o.trim(),children:l?"Posting...":"Post"})]})]}),t.jsx("div",{className:"space-y-4",children:h.length>0?h.map(x=>t.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative",children:[t.jsx("p",{className:"text-gray-900 dark:text-gray-100 mb-2 whitespace-pre-line",children:x.content}),t.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 flex flex-wrap gap-2 justify-between items-center",children:[t.jsx("span",{children:new Date(x.createdAt).toLocaleString()}),t.jsxs("div",{className:"flex items-center gap-2",children:[x.signature&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold "+(x.signatureVerified?"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"),title:x.signatureVerified?`Signature verified${x.fingerprint?" ("+x.fingerprint+")":""}`:`Signature invalid: ${x.signatureError||"unknown"}`,children:x.signatureVerified?"Verified":"Invalid"}),t.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs",onClick:()=>{g(x.id),u(x.content)},title:"Edit post",children:"✏️"}),t.jsx("button",{className:"text-red-500 hover:text-red-700 text-xs",onClick:()=>s(x.id),title:"Delete post",children:"🗑️"})]})]}),c===x.id&&t.jsxs("div",{className:"mt-2 space-y-2",children:[t.jsx("textarea",{className:"w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm",value:m,onChange:y=>u(y.target.value),placeholder:"Edit your post",title:"Edit post content"}),t.jsxs("div",{className:"flex gap-2 justify-end",children:[t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600",onClick:()=>{g(null),u("")},children:"Cancel"}),t.jsx("button",{className:"px-3 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white",disabled:!m.trim(),onClick:async()=>{await n(x.id,m.trim()),g(null),u("")},children:"Save"})]})]})]},x.id)):t.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400",children:"No posts yet."})})]})},gt=()=>{const{currentProfile:a}=A(),[e,r]=p.useState(!1);return a?t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col items-center",children:[t.jsxs("div",{className:"mb-4 relative",children:[t.jsx(lt,{profilePicture:a.profilePicture,username:a.username,size:"xl"}),t.jsx("button",{className:"absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 shadow-lg border-2 border-white dark:border-gray-800",onClick:()=>r(!0),title:"Change profile picture",children:t.jsx("span",{role:"img","aria-label":"Edit",children:"✏️"})})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:a.displayName||a.username}),t.jsxs("p",{className:"text-gray-500 dark:text-gray-300 mb-2",children:["@",a.username]}),a.bio&&t.jsx("p",{className:"text-gray-700 dark:text-gray-200 mb-2 max-w-xl mx-auto",children:a.bio})]}),e&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-lg p-4 relative w-full max-w-lg",children:[t.jsx("button",{className:"absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",onClick:()=>r(!1),title:"Close",children:"✕"}),t.jsx(ct,{onClose:()=>r(!1)})]})}),t.jsx("div",{className:"w-full mt-8",children:t.jsx(dt,{})})]}):t.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center",children:t.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:"No profile loaded."})})},ut=({onCancel:a})=>{const{currentProfile:e,setCurrentProfile:r}=A(),[s,n]=p.useState({username:e?.username||"",displayName:e?.displayName||"",bio:e?.bio||"",location:e?.location||"",website:e?.website||"",avatar:e?.avatar||""}),[o,i]=p.useState({}),[l,d]=p.useState(!1),c=()=>{const u={};return s.website&&!s.website.match(/^https?:\/\/.+/)&&(u.website="Website must be a valid URL (http:// or https://)"),i(u),Object.keys(u).length===0},g=async()=>{if(c()){d(!0);try{(await L()).updateProfile(s.displayName,s.bio);const h={location:s.location,website:s.website,avatar:s.avatar,updatedAt:new Date().toISOString()};localStorage.setItem(`profile-extended-${s.username}`,JSON.stringify(h));const f={...e,username:s.username,displayName:s.displayName,bio:s.bio,location:s.location,website:s.website,avatar:s.avatar,updatedAt:new Date().toISOString()};r(f),a()}catch(u){console.error("Failed to update profile:",u),i({general:"Failed to update profile. Please try again."})}finally{d(!1)}}},m=(u,h)=>{n(f=>({...f,[u]:h})),o[u]&&i(f=>({...f,[u]:""}))};return t.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-white dark:bg-gray-800",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Edit Profile"}),o.general&&t.jsx("div",{className:"text-red-600 text-sm",children:o.general}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username (cannot be changed)"}),t.jsx("input",{type:"text",value:s.username,readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Enter username"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Display Name"}),t.jsx("input",{type:"text",value:s.displayName,onChange:u=>m("displayName",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Enter display name"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Bio"}),t.jsx("textarea",{value:s.bio,onChange:u=>m("bio",u.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Tell us about yourself"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Location"}),t.jsx("input",{type:"text",value:s.location,onChange:u=>m("location",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Enter your location"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Website"}),t.jsx("input",{type:"url",value:s.website,onChange:u=>m("website",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"https://example.com"}),o.website&&t.jsx("div",{className:"text-red-600 text-sm mt-1",children:o.website})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Avatar URL"}),t.jsx("input",{type:"url",value:s.avatar,onChange:u=>m("avatar",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"https://example.com/avatar.jpg"})]}),t.jsxs("div",{className:"flex gap-2 pt-4",children:[t.jsx("button",{onClick:g,disabled:l,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md disabled:opacity-50",children:l?"Saving...":"Save Changes"}),t.jsx("button",{onClick:a,disabled:l,className:"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md",children:"Cancel"})]})]})};function mt({progress:a,className:e=""}){const r=Math.max(0,Math.min(100,a*100)),s=()=>r===0?"w-0":r>=100?"w-full":r>=75?"w-3/4":r>=50?"w-1/2":r>=25?"w-1/4":"w-1/12";return t.jsx("div",{className:`w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 overflow-hidden ${e}`,children:t.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${s()}`})})}function ft(){const[a,e]=p.useState({torrents:0,downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0,peers:0}),[r,s]=p.useState([]),[n,o]=p.useState([]),[i,l]=p.useState(!1);p.useEffect(()=>{let c;const m=(()=>{try{const u=E();l(!0);const h=u.onEvent(f=>{const x=new Date().toLocaleTimeString();switch(f.type){case"seeding-started":"profile"in f&&f.profile?o(y=>[`[${x}] ✅ Started seeding profile: ${f.profile.username}`,...y.slice(0,9)]):"post"in f&&f.post&&o(y=>[`[${x}] ✅ Started seeding post by: ${f.post.authorDisplayName||"anonymous"}`,...y.slice(0,9)]);break;case"peer-connected":o(y=>[`[${x}] 🔗 Peer connected: ${f.peerId}`,...y.slice(0,9)]);break;case"upload-progress":Math.random()<.1&&o(y=>[`[${x}] ⬆️ Upload: ${d(f.uploadSpeed)}/s`,...y.slice(0,9)]);break;case"profile-downloaded":f.profile&&o(y=>[`[${x}] ⬇️ Downloaded profile: ${f.profile.username}`,...y.slice(0,9)]);break;case"download-progress":Math.random()<.1&&o(y=>[`[${x}] ⬇️ Progress: ${(f.progress*100).toFixed(1)}%`,...y.slice(0,9)]);break;case"error":o(y=>[`[${x}] ❌ Error: ${f.error}`,...y.slice(0,9)]);break}});return c=setInterval(()=>{e(u.getStats()),s(u.getActiveTorrents())},2e3),e(u.getStats()),s(u.getActiveTorrents()),h}catch(u){console.error("Failed to initialize torrent service:",u),l(!1),o(h=>[`Failed to initialize WebTorrent: ${u}`,...h.slice(0,9)])}})();return()=>{c&&clearInterval(c),m&&m()}},[]);const d=c=>{if(c===0)return"0 B";const g=1024,m=["B","KB","MB","GB"],u=Math.floor(Math.log(c)/Math.log(g));return parseFloat((c/Math.pow(g,u)).toFixed(1))+" "+m[u]};return t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"WebTorrent Client"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:`w-3 h-3 rounded-full ${i?"bg-green-500":"bg-red-500"}`}),t.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:i?"Connected":"Disconnected"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-6",children:[t.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3",children:[t.jsx("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:a.torrents}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Active Torrents"})]}),t.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-3",children:[t.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:a.peers}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Connected Peers"})]}),t.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3",children:[t.jsxs("div",{className:"text-lg font-bold text-purple-600 dark:text-purple-400",children:["⬆️ ",d(a.uploadSpeed),"/s"]}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Upload Speed"})]}),t.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3",children:[t.jsxs("div",{className:"text-lg font-bold text-orange-600 dark:text-orange-400",children:["⬇️ ",d(a.downloadSpeed),"/s"]}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Download Speed"})]}),t.jsxs("div",{className:"bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-3",children:[t.jsx("div",{className:"text-lg font-bold text-indigo-600 dark:text-indigo-400",children:d(a.uploaded)}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Uploaded"})]}),t.jsxs("div",{className:"bg-pink-50 dark:bg-pink-900/20 rounded-lg p-3",children:[t.jsx("div",{className:"text-lg font-bold text-pink-600 dark:text-pink-400",children:d(a.downloaded)}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Downloaded"})]})]}),r.length>0&&t.jsxs("div",{className:"mb-6",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Active Torrents"}),t.jsx("div",{className:"space-y-2",children:r.map(c=>t.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("div",{className:"font-medium text-gray-900 dark:text-white truncate",children:c.name||"Unnamed Torrent"}),t.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[(c.progress*100).toFixed(1),"%"]})]}),t.jsx(mt,{progress:c.progress,className:"mb-2"}),t.jsxs("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[t.jsxs("span",{children:["Peers: ",c.numPeers]}),t.jsxs("span",{children:["⬆️ ",d(c.uploadSpeed),"/s ⬇️ ",d(c.downloadSpeed),"/s"]})]})]},c.infoHash))})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Recent Activity"}),t.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4 h-48 overflow-y-auto",children:n.length>0?t.jsx("div",{className:"space-y-1",children:n.map((c,g)=>t.jsx("div",{className:"text-sm font-mono text-gray-700 dark:text-gray-300",children:c},g))}):t.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400 mt-16",children:"No activity yet. Start seeding a profile to see torrent activity!"})})]})]})}class de{static BACKUP_VERSION="1.0.0";static FILE_EXTENSION=".snartnet-backup";static async createBackup(e=!0){try{const s=await(await L()).getCurrentProfile();if(!s)throw new Error("No current profile to backup");const n=localStorage.getItem("snartnet_keypair");if(!n)throw new Error("No keypair found for backup");const o=localStorage.getItem(`profile-extended-${s.username}`);let i=null;if(e){const d=localStorage.getItem("snartnet-contacts");i=d?JSON.parse(d):[]}const l={version:this.BACKUP_VERSION,timestamp:new Date().toISOString(),profile:s,keypair:JSON.parse(n),extendedData:o?JSON.parse(o):null,contacts:i,metadata:{username:s.username,fingerprint:s.fingerprint||"unknown",backupId:this.generateBackupId()}};return console.log("Backup created successfully:",{username:l.metadata.username,timestamp:l.timestamp,includesContacts:!!l.contacts}),l}catch(r){throw console.error("Failed to create backup:",r),new Error(`Backup creation failed: ${r instanceof Error?r.message:"Unknown error"}`)}}static async downloadBackup(e=!0,r){try{const s=await this.createBackup(e);let n=s;r&&(n=await this.encryptBackup(s,r));const o=JSON.stringify(n,null,2),i=new Blob([o],{type:"application/json"}),l=URL.createObjectURL(i),d=document.createElement("a");d.href=l,d.download=`${s.metadata.username}_backup_${this.formatDateForFilename(s.timestamp)}${this.FILE_EXTENSION}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l),console.log("Backup downloaded successfully")}catch(s){throw console.error("Failed to download backup:",s),s}}static async restoreFromBackup(e,r){try{let s;r&&e.encrypted?s=await this.decryptBackup(e,r):s=e,this.validateBackup(s),console.log("Restoring backup:",{version:s.version,username:s.metadata.username,timestamp:s.timestamp}),localStorage.removeItem("snartnet_keypair"),localStorage.removeItem("snartnet_current_profile"),localStorage.removeItem("snartnet-contacts"),localStorage.setItem("snartnet_keypair",JSON.stringify(s.keypair)),localStorage.setItem("snartnet_current_profile",JSON.stringify({profile:s.profile,signature:s.keypair?.signature||"restored"})),s.extendedData&&s.metadata.username&&localStorage.setItem(`profile-extended-${s.metadata.username}`,JSON.stringify(s.extendedData)),s.contacts&&localStorage.setItem("snartnet-contacts",JSON.stringify(s.contacts)),console.log("Backup restored successfully"),window.location.reload()}catch(s){throw console.error("Failed to restore backup:",s),new Error(`Restore failed: ${s instanceof Error?s.message:"Unknown error"}`)}}static async restoreFromFile(e,r){try{if(!e.name.endsWith(this.FILE_EXTENSION)&&!e.name.endsWith(".json"))throw new Error("Invalid backup file format. Please select a .snartnet-backup or .json file.");const s=await this.readFileContent(e),n=JSON.parse(s);await this.restoreFromBackup(n,r)}catch(s){throw console.error("Failed to restore from file:",s),s}}static async encryptBackup(e,r){const s=JSON.stringify(e),n=btoa(unescape(encodeURIComponent(s)));return{encrypted:!0,version:e.version,data:n,hint:`Backup for ${e.metadata.username}`,timestamp:e.timestamp}}static async decryptBackup(e,r){try{const s=decodeURIComponent(escape(atob(e.data)));return JSON.parse(s)}catch{throw new Error("Invalid password or corrupted backup file")}}static validateBackup(e){if(!e||typeof e!="object")throw new Error("Invalid backup format");if(!e.version||!e.timestamp||!e.profile||!e.keypair)throw new Error("Incomplete backup data");if(!e.metadata||!e.metadata.username)throw new Error("Missing backup metadata");e.version!==this.BACKUP_VERSION&&console.warn("Backup version mismatch:",e.version,"vs",this.BACKUP_VERSION)}static readFileContent(e){return new Promise((r,s)=>{const n=new FileReader;n.onload=o=>{o.target?.result?r(o.target.result):s(new Error("Failed to read file"))},n.onerror=()=>{s(new Error("File reading error"))},n.readAsText(e)})}static generateBackupId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}static formatDateForFilename(e){return new Date(e).toISOString().split("T")[0].replace(/-/g,"")}static async getBackupInfo(e,r){try{const s=await this.readFileContent(e);let n=JSON.parse(s);return n.encrypted&&r&&(n=await this.decryptBackup(n,r)),{username:n.metadata?.username||"Unknown",timestamp:n.timestamp||"Unknown",version:n.version||"Unknown",hasContacts:Array.isArray(n.contacts)&&n.contacts.length>0,fingerprint:n.metadata?.fingerprint||"Unknown"}}catch(s){throw new Error("Failed to read backup info: "+(s instanceof Error?s.message:"Unknown error"))}}}const ht=({onClose:a})=>{const{currentProfile:e}=A(),r=p.useRef(null),[s,n]=p.useState("backup"),[o,i]=p.useState(!0),[l,d]=p.useState(!1),[c,g]=p.useState(""),[m,u]=p.useState(!1),[h,f]=p.useState(""),[x,y]=p.useState(null),v=async()=>{if(!e){f("❌ No profile to backup");return}if(l&&!c.trim()){f("❌ Password is required");return}try{u(!0),f("📦 Creating backup..."),await de.downloadBackup(o,l?c:void 0),f("✅ Backup downloaded successfully!")}catch(k){console.error("Backup failed:",k),f(`❌ Backup failed: ${k instanceof Error?k.message:"Unknown error"}`)}finally{u(!1)}},w=async k=>{const B=k.target.files?.[0];if(B)try{u(!0),f("📄 Reading backup file...");const z=await de.getBackupInfo(B,l?c:void 0);y(z),f("📋 Backup file loaded. Review info below and click Restore.")}catch(z){console.error("Failed to read backup:",z),f(`❌ Failed to read backup: ${z instanceof Error?z.message:"Unknown error"}`),y(null)}finally{u(!1)}},R=async()=>{const k=r.current?.files?.[0];if(!k){f("❌ Please select a backup file");return}if(l&&!c.trim()){f("❌ Password is required");return}if(confirm("⚠️ This will replace your current profile and data. Are you sure?"))try{u(!0),f("🔄 Restoring backup..."),await de.restoreFromFile(k,l?c:void 0),f("✅ Backup restored successfully! Page will reload...")}catch(B){console.error("Restore failed:",B),f(`❌ Restore failed: ${B instanceof Error?B.message:"Unknown error"}`)}finally{u(!1)}},Z=()=>{g(""),f(""),y(null),r.current&&(r.current.value="")};return t.jsxs("div",{className:"max-w-2xl mx-auto p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Profile Backup & Restore"}),a&&t.jsx("button",{onClick:a,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:"✕"})]}),t.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-6",children:t.jsxs("nav",{className:"flex space-x-8",children:[t.jsx("button",{onClick:()=>{n("backup"),Z()},className:`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${s==="backup"?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400"}`,children:"📦 Backup"}),t.jsx("button",{onClick:()=>{n("restore"),Z()},className:`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${s==="restore"?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400"}`,children:"🔄 Restore"})]})}),s==="backup"&&t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4",children:[t.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"📋 What gets backed up:"}),t.jsxs("ul",{className:"text-sm text-blue-800 dark:text-blue-200 space-y-1",children:[t.jsx("li",{children:"• Your profile information and cryptographic keys"}),t.jsx("li",{children:"• Extended profile data (avatar, location, website)"}),t.jsx("li",{children:"• Your contacts and relationships (optional)"}),t.jsx("li",{children:"• All necessary data to restore your identity"})]})]}),e?t.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[t.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Current Profile:"}),t.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:[t.jsx("strong",{children:"Username:"})," ",e.username,t.jsx("br",{}),t.jsx("strong",{children:"Display Name:"})," ",e.displayName||"Not set",t.jsx("br",{}),t.jsx("strong",{children:"Public Key:"})," ",e.publicKey?.slice(0,16)+"..."||"Unknown"]})]}):t.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4",children:t.jsx("p",{className:"text-yellow-800 dark:text-yellow-200",children:"⚠️ No profile found to backup. Please create a profile first."})}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("label",{className:"flex items-center",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:k=>i(k.target.checked),className:"mr-2"}),t.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Include contacts and relationships in backup"})]}),t.jsxs("label",{className:"flex items-center",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:k=>d(k.target.checked),className:"mr-2"}),t.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Password protect backup (recommended)"})]}),l&&t.jsx("input",{type:"password",value:c,onChange:k=>g(k.target.value),placeholder:"Enter backup password",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),t.jsx("button",{onClick:v,disabled:m||!e,className:"w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:m?"📦 Creating Backup...":"💾 Download Backup"})]}),s==="restore"&&t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4",children:[t.jsx("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-100 mb-2",children:"⚠️ Important Warning:"}),t.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"Restoring a backup will completely replace your current profile, keys, and data. Make sure to backup your current profile first if you want to keep it."})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select Backup File:"}),t.jsx("input",{ref:r,type:"file",accept:".snartnet-backup,.json",onChange:w,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"}),t.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Accepts .snartnet-backup and .json files"})]}),t.jsxs("label",{className:"flex items-center",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:k=>d(k.target.checked),className:"mr-2"}),t.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Backup is password protected"})]}),l&&t.jsx("input",{type:"password",value:c,onChange:k=>g(k.target.value),placeholder:"Enter backup password",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),x&&t.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[t.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Backup Information:"}),t.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300 space-y-1",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Username:"})," ",x.username]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Created:"})," ",new Date(x.timestamp).toLocaleString()]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Version:"})," ",x.version]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Fingerprint:"})," ",x.fingerprint]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Includes Contacts:"})," ",x.hasContacts?"Yes":"No"]})]})]}),t.jsx("button",{onClick:R,disabled:m||!x,className:"w-full px-4 py-3 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:m?"🔄 Restoring...":"🔄 Restore Backup"})]}),h&&t.jsx("div",{className:`mt-6 p-4 rounded-lg ${h.startsWith("✅")?"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700":h.startsWith("❌")?"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700":h.startsWith("⚠️")?"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700":"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700"}`,children:t.jsx("p",{className:`text-sm font-medium ${h.startsWith("✅")?"text-green-800 dark:text-green-200":h.startsWith("❌")?"text-red-800 dark:text-red-200":h.startsWith("⚠️")?"text-yellow-800 dark:text-yellow-200":"text-blue-800 dark:text-blue-200"}`,children:h})})]})},pt=()=>{const{currentProfile:a,loading:e,seedProfileEnabled:r,setSeedProfileEnabled:s}=A(),[n,o]=p.useState(!1),[i,l]=p.useState(!1),[d,c]=p.useState(""),[g,m]=p.useState(!1);async function u(){if(!(!a||!r))try{c("Seeding profile...");const f=await(await L()).seedCurrentProfile();c(`Seeding ✓ (${f.slice(0,40)}...)`)}catch(h){c(`Seeding failed: ${h?.message||"error"}`)}}return a&&r&&d===""&&u(),t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Profile Management"}),t.jsxs("div",{className:"flex gap-4 items-center",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer select-none",children:[t.jsx("input",{type:"checkbox",className:"rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500",checked:r,onChange:h=>{s(h.target.checked),h.target.checked&&u()}}),t.jsx("span",{children:"Seed my profile (auto)"}),d&&t.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:d})]}),a&&!n&&!i&&!g&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>l(!0),className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors",children:"💾 Backup & Restore"}),t.jsx("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors",children:"Create New Profile"}),t.jsx("button",{onClick:()=>m(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"Edit Profile"})]})]})]}),e&&t.jsxs("div",{className:"flex items-center justify-center py-8",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),t.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading profile..."})]}),!e&&t.jsxs("div",{className:"space-y-8",children:[i&&t.jsx("div",{children:t.jsx(ht,{onClose:()=>l(!1)})}),n&&!i&&!g&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Create New Profile"}),t.jsx("button",{onClick:()=>o(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕ Cancel"})]}),t.jsx(_e,{})]}),!i&&!g&&t.jsxs(t.Fragment,{children:[a?t.jsx("div",{children:!n&&t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-4",children:"Current Profile"}),t.jsx(gt,{})]})}):!n&&t.jsx(_e,{}),t.jsx(ft,{})]}),g&&a&&!i&&!n&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Edit Profile"}),t.jsx("button",{onClick:()=>m(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕ Close"})]}),t.jsx(ut,{onCancel:()=>m(!1)})]})]})]})},Ee=[];class xt{listeners=[];started=!1;name="in-memory-msg";async start(){this.started=!0}async publish(e){setTimeout(()=>this.listeners.forEach(r=>r(e)),0)}onMessage(e){this.listeners.push(e)}isStarted(){return this.started}}let Q=null;async function bt(){return Q||(Q=new xt,Q.onMessage(a=>Ee.forEach(e=>e(a))),await Q.start()),Q}async function yt(a){await(await bt()).publish(a)}function wt(a){Ee.push(a)}const ae=se(a=>({threads:{},async sendMessage(e,r){const s={id:Te(),sender:"me",recipient:e,content:r,timestamp:new Date().toISOString(),status:"pending"};a(n=>({threads:{...n.threads,[e]:{contactId:e,messages:[...n.threads[e]?.messages||[],s]}}}));try{await yt(s),a(n=>({threads:{...n.threads,[e]:{contactId:e,messages:n.threads[e].messages.map(o=>o.id===s.id?{...o,status:"sent"}:o)}}}))}catch{a(o=>({threads:{...o.threads,[e]:{contactId:e,messages:o.threads[e].messages.map(i=>i.id===s.id?{...i,status:"failed"}:i)}}}))}},receiveMessage(e,r){a(s=>({threads:{...s.threads,[e]:{contactId:e,messages:[...s.threads[e]?.messages||[],r]}}}))},loadMessages(){},setMessages(e,r){a(s=>({threads:{...s.threads,[e]:{contactId:e,messages:r}}}))}}));wt(a=>{ae.getState().receiveMessage(a.sender,a)});const vt=({contactId:a})=>{const{contacts:e}=$(),r=ae(c=>c.threads[a]),s=ae(c=>c.sendMessage),[n,o]=p.useState(""),i=p.useRef(null),l=e.find(c=>c.id===a),d=async c=>{c.preventDefault(),n.trim()&&(await s(a,n.trim()),o(""),i.current?.focus())};return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsx("div",{className:"flex items-center border-b px-4 py-2 bg-gray-100 dark:bg-gray-800",children:t.jsx("span",{className:"font-semibold text-lg text-gray-800 dark:text-gray-100",children:l?.displayName||l?.username})}),t.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2 bg-white dark:bg-gray-900",children:r?.messages.map(c=>t.jsx("div",{className:`flex ${c.sender==="me"?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`max-w-xs px-3 py-2 rounded-lg shadow text-sm ${c.sender==="me"?"bg-blue-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100"}`,children:[t.jsx("div",{children:c.content}),t.jsxs("div",{className:"text-[10px] mt-1 text-right opacity-60",children:[new Date(c.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),c.status==="pending"&&t.jsx("span",{className:"ml-1",children:"⏳"}),c.status==="failed"&&t.jsx("span",{className:"ml-1 text-red-500",children:"⚠️"})]})]})},c.id))}),t.jsxs("form",{onSubmit:d,className:"flex gap-2 p-4 border-t bg-gray-50 dark:bg-gray-800",children:[t.jsx("input",{ref:i,type:"text",className:"flex-1 px-3 py-2 rounded border bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100",placeholder:"Type a message...",value:n,onChange:c=>o(c.target.value)}),t.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Send"})]})]})},kt=()=>{const{contacts:a}=$(),[e,r]=p.useState(null),s=ae(o=>o.threads),n=e?s[e]:null;return t.jsxs("div",{className:"flex h-[80vh] border rounded-lg overflow-hidden bg-white dark:bg-gray-900",children:[t.jsxs("div",{className:"w-64 border-r bg-gray-50 dark:bg-gray-800 p-4 overflow-y-auto",children:[t.jsx("h2",{className:"font-bold mb-4 text-gray-700 dark:text-gray-200",children:"Messages"}),t.jsx("ul",{children:a.map(o=>t.jsx("li",{children:t.jsx("button",{className:`w-full text-left px-2 py-2 rounded hover:bg-blue-100 dark:hover:bg-blue-900 ${e===o.id?"bg-blue-100 dark:bg-blue-900":""}`,onClick:()=>r(o.id),children:t.jsx("span",{className:"font-medium",children:o.displayName||o.username})})},o.id||o.username))})]}),t.jsx("div",{className:"flex-1 flex flex-col",children:n?t.jsx(vt,{contactId:n.contactId}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:"Select a contact to start chatting"})})]})},_t=({onContactAdded:a})=>{const[e,r]=p.useState(!1),[s,n]=p.useState(!1),[o,i]=p.useState(""),[l,d]=p.useState(""),c=p.useRef(null),g=p.useRef(null),{currentProfile:m}=A(),{addContactFromMagnet:u}=$();p.useEffect(()=>{(async()=>{if(e&&m){let v=m.magnetUri;if(!v&&m.username)try{v=await(await L()).seedCurrentProfile(),console.log("[QRCodeManager] Generated magnet URI for QR code:",v)}catch(w){console.error("[QRCodeManager] Failed to generate magnet URI:",w);return}if(v){const w={username:m.username,displayName:m.displayName||m.username,magnetUri:v,type:"snartnet-profile"};Re.toDataURL(JSON.stringify(w),{width:256,margin:2,color:{dark:"#000000",light:"#ffffff"}}).then(i).catch(console.error)}}})()},[e,m]),p.useEffect(()=>{if(s&&c.current)return g.current=new Ae(c.current,y=>{d(y.data),h(y.data)},{highlightScanRegion:!0,highlightCodeOutline:!0}),g.current.start().catch(console.error),()=>{g.current&&(g.current.stop(),g.current.destroy(),g.current=null)}},[s]);const h=async y=>{try{const v=JSON.parse(y);if(v.type==="snartnet-profile"&&v.magnetUri){const w=await u(v.magnetUri,"friend");w?(d(`Added ${v.username} as a friend!`),a?.(w),n(!1)):d("Failed to add contact - profile may be invalid")}else if(y.startsWith("magnet:")){const w=await u(y,"friend");w?(d("Added contact from magnet URI!"),a?.(w),n(!1)):d("Failed to add contact from magnet URI")}else d("Invalid QR code - not a SnartNet profile or magnet link")}catch{if(y.startsWith("magnet:")){const w=await u(y,"friend");w?(d("Added contact from magnet URI!"),a?.(w),n(!1)):d("Failed to add contact from magnet URI")}else d("Invalid QR code format")}},f=()=>{r(!1),i("")},x=()=>{n(!1),d(""),g.current&&(g.current.stop(),g.current.destroy(),g.current=null)};return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex gap-4",children:[t.jsx("button",{onClick:()=>r(!0),disabled:!m?.username,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors flex items-center gap-2",children:"📱 Show My QR Code"}),t.jsx("button",{onClick:()=>n(!0),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center gap-2",children:"📷 Scan QR Code"})]}),e&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"My Profile QR Code"}),t.jsx("button",{onClick:f,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕"})]}),o?t.jsxs("div",{className:"text-center",children:[t.jsx("img",{src:o,alt:"Profile QR Code",className:"mx-auto mb-4 border rounded"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Share this QR code to let others add you as a friend"})]}):t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),t.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Generating QR code..."})]})]})}),s&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Scan QR Code"}),t.jsx("button",{onClick:x,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕"})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsx("video",{ref:c,className:"w-full rounded border aspect-square"}),l&&t.jsx("div",{className:`p-3 rounded text-sm ${l.includes("Added")||l.includes("success")?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"}`,children:l}),t.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Point your camera at a SnartNet profile QR code or magnet link QR code"})]})]})})]})},jt=[{id:"all",label:"All",icon:"🌐"},{id:"friend",label:"Friends",icon:"👥"},{id:"ring-of-trust",label:"Ring of Trust",icon:"🛡️"},{id:"acquaintance",label:"Acquaintances",icon:"🤝"},{id:"group-member",label:"Groups",icon:"🏠"}],Nt=()=>{const{loadContacts:a,contacts:e,addContactFromMagnet:r,removeContact:s}=$(),{loadPostsFromContacts:n}=P(),[o,i]=p.useState("all"),[l,d]=p.useState(""),[c,g]=p.useState(!1),[m,u]=p.useState("friend"),[h,f]=p.useState(null),x=async()=>{await a(),setTimeout(()=>n(),100)};p.useEffect(()=>{a()},[a]);const y=e.filter(w=>o==="all"?!0:w.relationship===o),v=async w=>{if(w.preventDefault(),f(null),!!l.trim()){g(!0);try{await r(l.trim(),m)?(d(""),setTimeout(()=>n(),100)):f("Failed to load profile from magnet (no peers or invalid data)")}catch(R){f(R?.message||"Failed to add contact")}finally{g(!1)}}};return t.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[t.jsxs("div",{className:"mb-8",children:[t.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Friends & Contacts"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Manage your network. Add new contacts with QR codes or magnet links."})]})}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Quick Connect"}),t.jsx(_t,{onContactAdded:x})]}),t.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 p-4",children:[t.jsx("h3",{className:"text-md font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Or add via Magnet Link"}),t.jsxs("form",{onSubmit:v,className:"flex flex-col sm:flex-row gap-2 w-full md:w-auto",children:[t.jsx("input",{type:"text",value:l,onChange:w=>d(w.target.value),placeholder:"magnet:?xt=... (profile)",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm",disabled:c}),t.jsxs("select",{value:m,onChange:w=>u(w.target.value),className:"px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm",disabled:c,"aria-label":"Relationship type",children:[t.jsx("option",{value:"friend",children:"Friend"}),t.jsx("option",{value:"ring-of-trust",children:"Ring of Trust"}),t.jsx("option",{value:"acquaintance",children:"Acquaintance"}),t.jsx("option",{value:"group-member",children:"Group Member"})]}),t.jsx("button",{type:"submit",disabled:c||!l.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-md text-sm",children:c?"Adding…":"Add"})]})]})]}),h&&t.jsx("div",{className:"mb-4 p-3 rounded bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 text-sm",children:h}),t.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto",children:t.jsx("nav",{className:"flex space-x-6 min-w-max",children:jt.map(w=>t.jsxs("button",{onClick:()=>i(w.id),className:`py-2 px-1 border-b-2 text-sm font-medium transition-colors flex items-center gap-1 ${o===w.id?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"}`,children:[t.jsx("span",{children:w.icon}),w.label,t.jsx("span",{className:"ml-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-full px-2 py-0.5 text-[10px]",children:w.id==="all"?e.length:e.filter(R=>R.relationship===w.id).length})]},w.id))})}),t.jsx("div",{className:"space-y-4",children:y.length===0?t.jsxs("div",{className:"text-center py-16 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg",children:[t.jsx("div",{className:"text-5xl mb-4",children:"📭"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-2 text-sm",children:"No contacts in this category yet."}),t.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:"Add one with a profile magnet link above."})]}):y.map(w=>t.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center gap-4",children:[t.jsx(O,{to:`/contact/${w.id}`,className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold overflow-hidden focus:ring-2 focus:ring-blue-500",children:w.avatar?t.jsx("img",{src:w.avatar,alt:w.displayName,className:"w-12 h-12 rounded-full object-cover"}):w.displayName.charAt(0).toUpperCase()}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs(O,{to:`/contact/${w.id}`,className:"flex flex-wrap items-center gap-2 group",children:[t.jsx("span",{className:"font-medium text-gray-900 dark:text-white truncate group-hover:underline",children:w.displayName}),t.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:["@",w.username]}),t.jsx(St,{rel:w.relationship}),w.postIndexMagnetUri&&t.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300",children:"posts"})]}),t.jsxs("div",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:["Trust ",w.trustLevel,"/10 • Added ",new Date(w.addedDate).toLocaleDateString()]})]}),t.jsx("button",{onClick:()=>s(w.id),className:"text-xs px-3 py-1 bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 rounded",children:"Remove"})]},w.id))})]})},St=({rel:a})=>{const e={friend:"bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300","ring-of-trust":"bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300",acquaintance:"bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300","group-member":"bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300"};return t.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium ${e[a]}`,children:a.replace("-"," ")})},Pt=()=>{const{id:a}=Ue(),{contacts:e,loadContacts:r}=$(),{posts:s,loadPostsFromContacts:n}=P(),o=P(u=>u.syncPostsForContact),[i,l]=p.useState(!1),[d,c]=p.useState("");p.useEffect(()=>{r()},[r]),p.useEffect(()=>{n()},[n]);const g=e.find(u=>u.id===a),m=p.useMemo(()=>g?s.filter(u=>u.author===g.username).sort((u,h)=>new Date(h.createdAt).getTime()-new Date(u.createdAt).getTime()).slice(0,50):[],[s,g]);return g?t.jsxs("div",{className:"max-w-4xl mx-auto p-6 space-y-8",children:[t.jsxs("div",{className:"flex items-start gap-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow",children:[t.jsx("div",{className:"w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-semibold overflow-hidden",children:g.avatar?t.jsx("img",{src:g.avatar,alt:g.displayName,className:"w-24 h-24 object-cover"}):g.displayName.charAt(0).toUpperCase()}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:g.displayName}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm mb-2",children:[t.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["@",g.username]}),g.postIndexMagnetUri&&t.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300",children:"posts"}),t.jsxs("span",{className:"text-[10px] px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200",children:["Trust ",g.trustLevel,"/10"]}),t.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300",children:g.relationship})]}),t.jsxs("div",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Added ",new Date(g.addedDate).toLocaleDateString()," • ",g.magnetUri.slice(0,42),"…"]}),g.notes&&g.notes.trim()&&t.jsx("p",{className:"mt-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line",children:g.notes})]}),t.jsxs("div",{className:"flex flex-col gap-2 items-end",children:[g.postIndexMagnetUri&&t.jsx("span",{className:"text-xs text-green-600 dark:text-green-400",children:"Index ready"}),t.jsx("button",{disabled:i||!g.postIndexMagnetUri,onClick:async()=>{if(!g.postIndexMagnetUri)return;l(!0),c("Syncing…");const u=performance.now();try{await o(g.id,{maxPosts:g.syncMaxPosts,monthsLookback:g.syncMonthsLookback});const h=(performance.now()-u)/1e3;c(`Synced in ${h.toFixed(1)}s`)}catch(h){c(h?.message||"Sync failed")}finally{l(!1),setTimeout(()=>c(""),5e3)}},className:"px-3 py-1.5 text-xs rounded bg-blue-600 disabled:bg-gray-400 hover:bg-blue-700 text-white font-medium shadow",children:i?"Syncing…":"Sync Contact"}),d&&t.jsx("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:d})]})]}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4",children:"Recent Posts"}),m.length===0?t.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 text-center",children:"No posts downloaded yet. Sync will populate as posts arrive."}):t.jsx("div",{className:"space-y-4",children:m.map(u=>t.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[t.jsx("div",{className:"flex items-center justify-between mb-2",children:t.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[t.jsx("span",{children:new Date(u.createdAt).toLocaleString()}),u.signatureVerified?t.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700",children:"ver"}):t.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-semibold bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700",title:u.signatureError||"unverified",children:"unv"}),u.magnetUri&&t.jsx("button",{onClick:()=>navigator.clipboard.writeText(u.magnetUri),className:"text-blue-600 dark:text-blue-400 hover:underline",children:"🧲"})]})}),t.jsx("p",{className:"text-sm text-gray-900 dark:text-gray-100 whitespace-pre-line mb-2",children:u.content}),u.images&&u.images.length>0&&t.jsx("div",{className:"grid gap-2 grid-cols-2",children:u.images.map(h=>t.jsx("img",{src:I.base64ToDataUrl(h.data),className:"w-full h-40 object-cover rounded",alt:h.filename},h.id))})]},u.id))})]}),t.jsx("div",{className:"text-center pt-8",children:t.jsx(O,{to:"/network",className:"text-sm text-blue-600 dark:text-blue-400 hover:underline",children:"← Back to Network"})})]}):t.jsx("div",{className:"max-w-4xl mx-auto p-6",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center",children:[t.jsx("h1",{className:"text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Contact not found"}),t.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"The contact you are looking for does not exist or has been removed."}),t.jsx(O,{to:"/network",className:"text-blue-600 dark:text-blue-400 hover:underline text-sm",children:"Back to Network"})]})})},Ct=()=>t.jsx("div",{className:"sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/75 dark:supports-[backdrop-filter]:bg-gray-900/75 bg-white/90 dark:bg-gray-800/90 border-b border-gray-200 dark:border-gray-700 shadow-sm",children:t.jsxs("nav",{children:[t.jsx("div",{className:"container mx-auto px-4",children:t.jsxs("div",{className:"flex justify-between items-center h-16",children:[t.jsx(O,{to:"/",className:"text-xl font-bold text-gray-900 dark:text-white",children:"SnartNet"}),t.jsxs("div",{className:"flex space-x-4 items-center",children:[t.jsx(O,{to:"/",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Home"}),t.jsx(O,{to:"/profile",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Profile"}),t.jsx(O,{to:"/network",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Network"}),t.jsx(O,{to:"/messages",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Messages"})]})]})}),t.jsx("div",{className:"bg-red-600/90 text-white text-center text-xs py-1 tracking-wide font-medium",children:"Development version – expect things to break & data to reset"})]})}),Et=()=>{const[a,e]=p.useState({transport:"initializing",peers:0,received:0,published:0}),[r,s]=p.useState(!1);return p.useEffect(()=>{const n=setInterval(()=>{const o=window,i=o.snartnetLibp2p,l=o.__sn_head_sig_cache?.length||0;o.lastPublishedHeadUpdate&&!o.__sn_head_published_count&&(o.__sn_head_published_count=1);const d=o.__sn_head_published_count||0;e({transport:i?"libp2p":"in-memory",peers:i?.getPeers?i.getPeers().length:i?.getConnections?i.getConnections().length:0,received:l,published:d})},2e3);return()=>clearInterval(n)},[]),t.jsxs("div",{className:"fixed bottom-1 right-1 text-[11px] bg-black/70 text-white px-2 py-1 rounded shadow z-50 select-none",children:[t.jsxs("div",{className:"flex gap-2 items-center cursor-pointer",onClick:()=>s(n=>!n),children:[t.jsxs("span",{children:["Push: ",a.transport]}),t.jsxs("span",{children:["| Peers: ",a.peers]}),t.jsxs("span",{children:["| Rx: ",a.received]}),t.jsxs("span",{children:["| Tx: ",a.published]}),t.jsx("span",{children:r?"▾":"▸"})]}),r&&t.jsxs("div",{className:"mt-1 max-w-[260px] leading-tight space-y-0.5",children:[t.jsxs("div",{children:["Transport: ",a.transport]}),t.jsxs("div",{children:["Peers: ",a.peers]}),t.jsxs("div",{children:["Head Updates Received (unique sigs): ",a.received]}),t.jsxs("div",{children:["Head Updates Published: ",a.published]}),t.jsx("div",{className:"opacity-60",children:"Click to collapse"})]})]})},It="0.1.0",je="5f59bc1094cc",Tt="dht",Ne="2025-09-27T08:44:03.466Z",At=({children:a})=>t.jsxs("div",{className:"min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900",children:[t.jsx(Ct,{}),t.jsx("main",{className:"container mx-auto px-4 py-8 flex-1 w-full",children:a}),t.jsxs("footer",{className:"border-t border-gray-200 dark:border-gray-700 py-4 text-center text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 flex flex-col sm:flex-row gap-1 sm:gap-2 items-center justify-center",children:[t.jsxs("span",{children:["SnartNet v",It,""]}),t.jsx("span",{className:"hidden sm:inline",children:"•"}),t.jsxs("span",{className:"font-mono",title:`Full commit: ${je}`,children:["commit ",je.slice(0,7)]}),t.jsx("span",{className:"hidden sm:inline",children:"•"}),t.jsxs("span",{children:["branch ",Tt]}),t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"hidden sm:inline",children:"•"}),t.jsxs("span",{title:Ne,children:["built ",new Date(Ne).toLocaleString()]})]})]}),t.jsx(Et,{})]});function Rt(){const{setCurrentProfile:a,setLoading:e,setError:r}=A();p.useEffect(()=>{let s=!0;return(async()=>{try{e(!0),r(null),console.log("[useInitializeCore] Initializing core...");const o=await L();if(console.log("[useInitializeCore] Core initialized successfully"),console.log("[useInitializeCore] Initializing torrent service..."),E(),console.log("[useInitializeCore] Torrent service initialized."),o.hasProfile()){console.log("[useInitializeCore] Found existing profile, loading...");const i=await o.getCurrentProfile();i&&s&&(console.log("[useInitializeCore] Loaded existing profile:",i),a(i))}else console.log("[useInitializeCore] No existing profile found")}catch(o){if(console.error("[useInitializeCore] Failed to initialize core:",o),s){const i=o instanceof Error?o.message:"Failed to initialize";r(i)}}finally{s&&e(!1)}})(),()=>{s=!1}},[a,e,r])}function Ut(){return Rt(),t.jsx(Me,{basename:"/net",children:t.jsx(At,{children:t.jsxs(Fe,{children:[t.jsx(V,{path:"/",element:t.jsx(it,{})}),t.jsx(V,{path:"/profile/:id?",element:t.jsx(pt,{})}),t.jsx(V,{path:"/network",element:t.jsx(Nt,{})}),t.jsx(V,{path:"/contact/:id",element:t.jsx(Pt,{})}),t.jsx(V,{path:"/messages/:id?",element:t.jsx(kt,{})})]})})})}function Mt(a={}){const{immediate:e=!1,onNeedRefresh:r,onOfflineReady:s,onRegistered:n,onRegisteredSW:o,onRegisterError:i}=a;let l,d;const c=async(m=!0)=>{await d};async function g(){if("serviceWorker"in navigator){if(l=await Y(async()=>{const{Workbox:m}=await import("./vendor-CdL2jA1Q.js").then(u=>u.w);return{Workbox:m}},[]).then(({Workbox:m})=>new m("/net/sw.js",{scope:"/net/",type:"classic"})).catch(m=>{i?.(m)}),!l)return;l.addEventListener("activated",m=>{(m.isUpdate||m.isExternal)&&window.location.reload()}),l.addEventListener("installed",m=>{m.isUpdate||s?.()}),l.register({immediate:e}).then(m=>{o?o("/net/sw.js",m):n?.(m)}).catch(m=>{i?.(m)})}}return d=g(),c}const Ft=Mt({immediate:!0,onNeedRefresh(){Ft(!0)},onOfflineReady(){},onRegisteredSW(a,e){e&&typeof e.update=="function"?setInterval(()=>{e.update()},1800*1e3):navigator.serviceWorker.controller&&fetch(a).catch(()=>{})}});De.createRoot(document.getElementById("root")).render(t.jsx(p.StrictMode,{children:t.jsx(Ut,{})}));
//# sourceMappingURL=index-CI8SdRMj.js.map
