import{r as h,c as de,j as e,L as D,u as Se,B as Pe,R as Ce,a as J,b as Ee}from"./vendor-DX1wVttl.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let b,k=0,q=null;function H(){return(q===null||q.byteLength===0)&&(q=new Uint8Array(b.memory.buffer)),q}const Y=new TextEncoder;"encodeInto"in Y||(Y.encodeInto=function(a,t){const r=Y.encode(a);return t.set(r),{read:a.length,written:r.length}});function N(a,t,r){if(r===void 0){const c=Y.encode(a),l=t(c.length,1)>>>0;return H().subarray(l,l+c.length).set(c),k=c.length,l}let s=a.length,n=t(s,1)>>>0;const o=H();let i=0;for(;i<s;i++){const c=a.charCodeAt(i);if(c>127)break;o[n+i]=c}if(i!==s){i!==0&&(a=a.slice(i)),n=r(n,s,s=i+a.length*3,1)>>>0;const c=H().subarray(n+i,n+s),l=Y.encodeInto(a,c);i+=l.written,n=r(n,s,i,1)>>>0}return k=i,n}let W=null;function L(){return(W===null||W.buffer.detached===!0||W.buffer.detached===void 0&&W.buffer!==b.memory.buffer)&&(W=new DataView(b.memory.buffer)),W}function K(a){const t=b.__externref_table_alloc();return b.__wbindgen_export_4.set(t,a),t}function F(a,t){try{return a.apply(this,t)}catch(r){const s=K(r);b.__wbindgen_exn_store(s)}}let Z=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});Z.decode();const Ie=2146435072;let te=0;function Te(a,t){return te+=t,te>=Ie&&(Z=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),Z.decode(),te=t),Z.decode(H().subarray(a,a+t))}function R(a,t){return a=a>>>0,Te(a,t)}function A(a){return a==null}function re(a,t){return a=a>>>0,H().subarray(a/1,a/1+t)}function S(a){const t=b.__wbindgen_export_4.get(a);return b.__externref_table_dealloc(a),t}function Ae(){const a=b.generate_keypair();if(a[2])throw S(a[1]);return S(a[0])}function Ue(a,t){let r,s;try{const i=N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),c=k,l=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),d=k,g=b.sign_data(i,c,l,d);var n=g[0],o=g[1];if(g[3])throw n=0,o=0,S(g[2]);return r=n,s=o,R(n,o)}finally{b.__wbindgen_free(r,s,1)}}function Re(a,t,r){const s=N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),n=k,o=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),i=k,c=N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),l=k,d=b.verify_signature_wasm(s,n,o,i,c,l);if(d[2])throw S(d[1]);return d[0]!==0}function Fe(a,t){const r=t(a.length*4,4)>>>0;for(let s=0;s<a.length;s++){const n=K(a[s]);L().setUint32(r+4*s,n,!0)}return k=a.length,r}function De(){const a=b.init_core();if(a[1])throw S(a[0])}const fe=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(a=>b.__wbg_snartnetcore_free(a>>>0,1));let le=class{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,fe.unregister(this),t}free(){const t=this.__destroy_into_raw();b.__wbg_snartnetcore_free(t,0)}constructor(){const t=b.snartnetcore_new();return this.__wbg_ptr=t>>>0,fe.register(this,this.__wbg_ptr,this),this}init(){const t=b.snartnetcore_init(this.__wbg_ptr);if(t[1])throw S(t[0])}create_profile(t,r,s){let n,o;try{const u=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),x=k;var i=A(r)?0:N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),c=k,l=A(s)?0:N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),d=k;const f=b.snartnetcore_create_profile(this.__wbg_ptr,u,x,i,c,l,d);var g=f[0],m=f[1];if(f[3])throw g=0,m=0,S(f[2]);return n=g,o=m,R(g,m)}finally{b.__wbindgen_free(n,o,1)}}get_current_profile(){const t=b.snartnetcore_get_current_profile(this.__wbg_ptr);if(t[2])throw S(t[1]);return S(t[0])}update_current_profile(t,r){var s=A(t)?0:N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),n=k,o=A(r)?0:N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),i=k;const c=b.snartnetcore_update_current_profile(this.__wbg_ptr,s,n,o,i);if(c[1])throw S(c[0])}create_post(t,r,s){const n=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),o=k;var i=A(r)?0:Fe(r,b.__wbindgen_malloc),c=k,l=A(s)?0:N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),d=k;const g=b.snartnetcore_create_post(this.__wbg_ptr,n,o,i,c,l,d);if(g[2])throw S(g[1]);return S(g[0])}create_message(t,r){const s=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),n=k,o=N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),i=k,c=b.snartnetcore_create_message(this.__wbg_ptr,s,n,o,i);if(c[2])throw S(c[1]);return S(c[0])}get_public_key(){let t,r;try{const o=b.snartnetcore_get_public_key(this.__wbg_ptr);var s=o[0],n=o[1];if(o[3])throw s=0,n=0,S(o[2]);return t=s,r=n,R(s,n)}finally{b.__wbindgen_free(t,r,1)}}get_fingerprint(){let t,r;try{const o=b.snartnetcore_get_fingerprint(this.__wbg_ptr);var s=o[0],n=o[1];if(o[3])throw s=0,n=0,S(o[2]);return t=s,r=n,R(s,n)}finally{b.__wbindgen_free(t,r,1)}}has_profile(){return b.snartnetcore_has_profile(this.__wbg_ptr)!==0}};Symbol.dispose&&(le.prototype[Symbol.dispose]=le.prototype.free);const Me=new Set(["basic","cors","default"]);async function Oe(a,t){if(typeof Response=="function"&&a instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(a,t)}catch(s){if(a.ok&&Me.has(a.type)&&a.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const r=await a.arrayBuffer();return await WebAssembly.instantiate(r,t)}else{const r=await WebAssembly.instantiate(a,t);return r instanceof WebAssembly.Instance?{instance:r,module:a}:r}}function Le(){const a={};return a.wbg={},a.wbg.__wbg_String_8f0eb39a4a4c2f66=function(t,r){const s=String(r),n=N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),o=k;L().setInt32(t+4*1,o,!0),L().setInt32(t+4*0,n,!0)},a.wbg.__wbg_call_13410aac570ffff7=function(){return F(function(t,r){return t.call(r)},arguments)},a.wbg.__wbg_call_a5400b25a865cfd8=function(){return F(function(t,r,s){return t.call(r,s)},arguments)},a.wbg.__wbg_crypto_574e78ad8b13b65f=function(t){return t.crypto},a.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,r){let s,n;try{s=t,n=r,console.error(R(t,r))}finally{b.__wbindgen_free(s,n,1)}},a.wbg.__wbg_getItem_9fc74b31b896f95a=function(){return F(function(t,r,s,n){const o=r.getItem(R(s,n));var i=A(o)?0:N(o,b.__wbindgen_malloc,b.__wbindgen_realloc),c=k;L().setInt32(t+4*1,c,!0),L().setInt32(t+4*0,i,!0)},arguments)},a.wbg.__wbg_getRandomValues_38a1ff1ea09f6cc7=function(){return F(function(t,r){globalThis.crypto.getRandomValues(re(t,r))},arguments)},a.wbg.__wbg_getRandomValues_b8f5dbd5f3995a9e=function(){return F(function(t,r){t.getRandomValues(r)},arguments)},a.wbg.__wbg_getTime_6bb3f64e0f18f817=function(t){return t.getTime()},a.wbg.__wbg_instanceof_Window_12d20d558ef92592=function(t){let r;try{r=t instanceof Window}catch{r=!1}return r},a.wbg.__wbg_length_6bb7e81f9d7713e4=function(t){return t.length},a.wbg.__wbg_localStorage_9330af8bf39365ba=function(){return F(function(t){const r=t.localStorage;return A(r)?0:K(r)},arguments)},a.wbg.__wbg_log_6c7b5f4f00b8ce3f=function(t){console.log(t)},a.wbg.__wbg_msCrypto_a61aeb35a24c1329=function(t){return t.msCrypto},a.wbg.__wbg_new0_b0a0a38c201e6df5=function(){return new Date},a.wbg.__wbg_new_19c25a3f2fa63a02=function(){return new Object},a.wbg.__wbg_new_1f3a344cf3123716=function(){return new Array},a.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},a.wbg.__wbg_newnoargs_254190557c45b4ec=function(t,r){return new Function(R(t,r))},a.wbg.__wbg_newwithlength_a167dcc7aaa3ba77=function(t){return new Uint8Array(t>>>0)},a.wbg.__wbg_node_905d3e251edff8a2=function(t){return t.node},a.wbg.__wbg_process_dc0fbacc7c1c06f7=function(t){return t.process},a.wbg.__wbg_prototypesetcall_3d4a26c1ed734349=function(t,r,s){Uint8Array.prototype.set.call(re(t,r),s)},a.wbg.__wbg_randomFillSync_ac0988aba3254290=function(){return F(function(t,r){t.randomFillSync(r)},arguments)},a.wbg.__wbg_removeItem_487c5a070c7adaf7=function(){return F(function(t,r,s){t.removeItem(R(r,s))},arguments)},a.wbg.__wbg_require_60cc747a6bc5215a=function(){return F(function(){return module.require},arguments)},a.wbg.__wbg_setItem_7add5eb06a28b38f=function(){return F(function(t,r,s,n,o){t.setItem(R(r,s),R(n,o))},arguments)},a.wbg.__wbg_set_3f1d0b984ed272ed=function(t,r,s){t[r]=s},a.wbg.__wbg_set_90f6c0f7bd8c0415=function(t,r,s){t[r>>>0]=s},a.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,r){const s=r.stack,n=N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),o=k;L().setInt32(t+4*1,o,!0),L().setInt32(t+4*0,n,!0)},a.wbg.__wbg_static_accessor_GLOBAL_8921f820c2ce3f12=function(){const t=typeof globalThis>"u"?null:globalThis;return A(t)?0:K(t)},a.wbg.__wbg_static_accessor_GLOBAL_THIS_f0a4409105898184=function(){const t=typeof globalThis>"u"?null:globalThis;return A(t)?0:K(t)},a.wbg.__wbg_static_accessor_SELF_995b214ae681ff99=function(){const t=typeof self>"u"?null:self;return A(t)?0:K(t)},a.wbg.__wbg_static_accessor_WINDOW_cde3890479c675ea=function(){const t=typeof window>"u"?null:window;return A(t)?0:K(t)},a.wbg.__wbg_subarray_70fd07feefe14294=function(t,r,s){return t.subarray(r>>>0,s>>>0)},a.wbg.__wbg_versions_c01dfd4722a88165=function(t){return t.versions},a.wbg.__wbg_wbindgenisfunction_8cee7dce3725ae74=function(t){return typeof t=="function"},a.wbg.__wbg_wbindgenisobject_307a53c6bd97fbf8=function(t){const r=t;return typeof r=="object"&&r!==null},a.wbg.__wbg_wbindgenisstring_d4fa939789f003b0=function(t){return typeof t=="string"},a.wbg.__wbg_wbindgenisundefined_c4b71d073b92f3c5=function(t){return t===void 0},a.wbg.__wbg_wbindgenstringget_0f16a6ddddef376f=function(t,r){const s=r,n=typeof s=="string"?s:void 0;var o=A(n)?0:N(n,b.__wbindgen_malloc,b.__wbindgen_realloc),i=k;L().setInt32(t+4*1,i,!0),L().setInt32(t+4*0,o,!0)},a.wbg.__wbg_wbindgenthrow_451ec1a8469d7eb6=function(t,r){throw new Error(R(t,r))},a.wbg.__wbindgen_cast_2241b6af4c4b2941=function(t,r){return R(t,r)},a.wbg.__wbindgen_cast_cb9088102bce6b30=function(t,r){return re(t,r)},a.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(t){return t},a.wbg.__wbindgen_init_externref_table=function(){const t=b.__wbindgen_export_4,r=t.grow(4);t.set(0,void 0),t.set(r+0,void 0),t.set(r+1,null),t.set(r+2,!0),t.set(r+3,!1)},a}function $e(a,t){return b=a.exports,ge.__wbindgen_wasm_module=t,W=null,q=null,b.__wbindgen_start(),b}async function ge(a){if(b!==void 0)return b;typeof a<"u"&&(Object.getPrototypeOf(a)===Object.prototype?{module_or_path:a}=a:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof a>"u"&&(a=new URL("/net/assets/snartnet_core_bg-CgG932GT.wasm",import.meta.url));const t=Le();(typeof a=="string"||typeof Request=="function"&&a instanceof Request||typeof URL=="function"&&a instanceof URL)&&(a=fetch(a));const{instance:r,module:s}=await Oe(await a,t);return $e(r,s)}class ke{client=null;activeTorrents=new Map;eventCallbacks=[];readyPromise;resolveReady;clientReady=!1;pendingSeeds=[];stats={torrents:0,downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0,peers:0};constructor(){this.readyPromise=new Promise(t=>{this.resolveReady=t}),this.initializeClient()}async initializeClient(){if(typeof window>"u")return;let t=0;const r=10,s=()=>{t++;const n=window.WebTorrent;if(!n||typeof n!="function")if(t<r){console.warn(`[TorrentService] WebTorrent not available yet (attempt ${t}), retrying...`),setTimeout(s,500);return}else{const o=new Error("WebTorrent not available after retries");console.error("[TorrentService] ",o),this.emitEvent({type:"error",error:o.message});return}try{this.client=new n,this.clientReady=!0,this.client.on("error",i=>{console.error("[TorrentService] Client error:",i),this.emitEvent({type:"error",error:i.message})}),this.client.on("torrent",i=>{console.log("[TorrentService] Torrent added:",{name:i.name,infoHash:i.infoHash}),this.activeTorrents.set(i.infoHash,i),this.emitEvent({type:"torrent-added",torrent:i}),this.updateStats()}),console.log("[TorrentService] WebTorrent client initialized successfully"),this.resolveReady();const o=[...this.pendingSeeds];this.pendingSeeds=[],o.forEach(i=>{try{i()}catch(c){console.error("[TorrentService] Pending seed failed:",c)}})}catch(o){console.error("[TorrentService] Failed to initialize:",o),this.emitEvent({type:"error",error:String(o)})}};s()}emitEvent(t){this.eventCallbacks.forEach(r=>{try{r(t)}catch(s){console.error("Error in event callback:",s)}})}updateStats(){if(this.client)try{this.stats={torrents:this.client.torrents.length,downloadSpeed:this.client.downloadSpeed||0,uploadSpeed:this.client.uploadSpeed||0,downloaded:this.client.downloaded||0,uploaded:this.client.uploaded||0,peers:this.client.torrents.reduce((t,r)=>t+(r.numPeers||0),0)}}catch(t){console.error("Error updating stats:",t)}}async seedProfile(t){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized. Are you in a browser environment?");try{const r=JSON.stringify(t,null,2),s=`${t.username}_profile.json`,o=new TextEncoder().encode(r),i=new File([o],s,{type:"application/json; charset=utf-8"});return new Promise((c,l)=>{const d=setTimeout(()=>{l(new Error("Seeding timeout"))},1e4);try{console.log("Seeding profile file:",{fileName:s,fileSize:i.size,fileType:i.type,profileDataLength:r.length});const g=this.client.seed([i],m=>{clearTimeout(d),console.log("Profile seeded successfully:",m.magnetURI),this.emitEvent({type:"seeding-started",profile:t,magnetURI:m.magnetURI}),c(m.magnetURI)});g.on("error",m=>{clearTimeout(d),this.emitEvent({type:"error",error:m.message}),l(m)}),g.on("wire",m=>{this.emitEvent({type:"peer-connected",peerId:m.peerId||"unknown"})}),g.on("upload",()=>{this.emitEvent({type:"upload-progress",uploadSpeed:g.uploadSpeed||0}),this.updateStats()})}catch(g){clearTimeout(d),l(g)}})}catch(r){throw console.error("Error seeding profile:",r),r}}ensureReadyAction(t){this.clientReady?t():(console.log("[TorrentService] Client not ready, queuing action"),this.pendingSeeds.push(t))}async seedPost(t){if(await this.readyPromise,!this.client||!this.clientReady)throw new Error("WebTorrent client not ready for seeding");const r=performance.now();console.log("[TorrentService] Seeding post start",{author:t.author,hasImages:!!t.images?.length,signed:!!t.signature});const s=JSON.stringify(t,null,2),n=`post_${Date.now()}.json`,o=new TextEncoder().encode(s),i=new File([o],n,{type:"application/json; charset=utf-8"});return new Promise((c,l)=>{let d=!1;const g=()=>{try{const m=this.client.seed([i],u=>{d=!0;const x=(performance.now()-r).toFixed(0);console.log("[TorrentService] Post torrent ready",{infoHash:u.infoHash,magnet:u.magnetURI,durationMs:x}),this.emitEvent({type:"seeding-started",post:t,magnetURI:u.magnetURI}),c(u.magnetURI)});m.on("error",u=>{d?console.warn("[TorrentService] Torrent error after ready:",u):(console.error("[TorrentService] Torrent error before ready:",u),l(u))}),m.on("wire",u=>{this.emitEvent({type:"peer-connected",peerId:u.peerId||"unknown"})})}catch(m){console.error("[TorrentService] Seed action failed synchronously:",m),l(m)}};this.ensureReadyAction(g),setTimeout(()=>{d||l(new Error("Seeding post timed out"))},15e3)})}async seedPostIndex(t,r,s){if(await this.readyPromise,!this.client||!this.clientReady)throw new Error("WebTorrent client not ready for seeding index");const n=s?.chunkSize||200,o=t.slice().sort((d,g)=>new Date(g.createdAt).getTime()-new Date(d.createdAt).getTime()).slice(0,n),i={version:1,author:r,generatedAt:new Date().toISOString(),posts:o.map(d=>({id:d.id,magnetUri:d.magnetUri||"",author:d.author,createdAt:d.createdAt,tags:d.tags})),next:s?.previousHeadMagnet||null,count:o.length},c=JSON.stringify(i,null,2),l=new File([new TextEncoder().encode(c)],`post_index_${Date.now()}.json`,{type:"application/json; charset=utf-8"});return new Promise((d,g)=>{try{this.client.seed([l],u=>{this.emitEvent({type:"post-index-seeded",magnetURI:u.magnetURI,count:i.count}),d({magnetURI:u.magnetURI,count:i.count})}).on("error",u=>g(u))}catch(m){g(m)}})}async downloadPostIndexChain(t,r={}){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized");const s=r.maxPosts??500,n=r.maxChunks??20;let o=null;if(r.since)o=new Date(r.since).getTime();else if(r.monthsLookback){const m=new Date;m.setMonth(m.getMonth()-r.monthsLookback),o=m.getTime()}const i=[];let c=t,l=0,d=!1,g=null;for(;c&&l<n&&i.length<s;){if(r.signal?.aborted)throw new Error("Aborted");const{indexData:m,next:u}=await this.downloadSingleIndex(c);l++,this.emitEvent({type:"post-index-downloaded",magnetURI:c,count:m.count});for(const x of m.posts){if(i.length>=s){d=!0;break}if(o){const f=new Date(x.createdAt).getTime();if(isNaN(f))continue;if(f<o){d=!0;break}}i.push(x)}if(d)break;c=u,g=u}return{entries:i,truncated:d,chunksFetched:l,nextPointer:g}}async downloadSingleIndex(t){return new Promise((r,s)=>{try{const n=this.client.add(t,()=>{}),o=setTimeout(()=>s(new Error("Index download timeout")),2e4);n.on("done",()=>{clearTimeout(o);const i=n.files.find(c=>c.name&&c.name.startsWith("post_index_"));if(!i)return s(new Error("Index file not found in torrent"));i.getBuffer((c,l)=>{if(c)return s(c);try{let d;l instanceof ArrayBuffer?d=new TextDecoder("utf-8").decode(new Uint8Array(l)):l&&typeof l.toString=="function"?d=l.toString("utf8"):d=String(l);const g=JSON.parse(d);if(g.version!==1)return s(new Error("Unsupported index version"));r({indexData:g,next:g.next||null})}catch(d){s(d)}})}),n.on("error",i=>s(i))}catch(n){s(n)}})}async downloadProfile(t){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized. Are you in a browser environment?");try{return new Promise((r,s)=>{const n=setTimeout(()=>{s(new Error("Download timeout - no peers found"))},3e4);try{const o=this.client.add(t,i=>{console.log("Started downloading torrent:",i.name||"unnamed")});o.on("done",()=>{clearTimeout(n);const i=o.files.find(c=>c.name&&c.name.endsWith("_profile.json"));if(i)i.getBuffer((c,l)=>{if(c){this.emitEvent({type:"error",error:c.message}),s(c);return}try{let d;if(l instanceof ArrayBuffer){const m=new Uint8Array(l);d=new TextDecoder("utf-8",{fatal:!1}).decode(m)}else l&&typeof l.toString=="function"?d=l.toString("utf8"):d=String(l);const g=JSON.parse(d);this.emitEvent({type:"profile-downloaded",profile:g}),r(g)}catch(d){console.error("Profile parsing error:",d),console.error("Buffer type:",typeof l),console.error("Buffer constructor:",l?.constructor?.name),this.emitEvent({type:"error",error:`Failed to parse profile data: ${d instanceof Error?d.message:"Unknown error"}`}),s(d)}});else{const c="Profile file not found in torrent";this.emitEvent({type:"error",error:c}),s(new Error(c))}}),o.on("download",()=>{this.emitEvent({type:"download-progress",progress:o.progress||0,downloadSpeed:o.downloadSpeed||0}),this.updateStats()}),o.on("error",i=>{clearTimeout(n),this.emitEvent({type:"error",error:i.message}),s(i)})}catch(o){clearTimeout(n),s(o)}})}catch(r){throw console.error("Error downloading profile:",r),r}}async downloadPost(t){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized");return new Promise((r,s)=>{try{const n=this.client.add(t,()=>{}),o=setTimeout(()=>s(new Error("Post download timeout")),2e4);n.on("done",()=>{clearTimeout(o);const i=n.files.find(c=>c.name&&c.name.startsWith("post_")&&c.name.endsWith(".json"));if(!i)return s(new Error("Post JSON file not found in torrent"));i.getBuffer((c,l)=>{if(c)return s(c);try{let d;l instanceof ArrayBuffer?d=new TextDecoder("utf-8").decode(new Uint8Array(l)):l&&typeof l.toString=="function"?d=l.toString("utf8"):d=String(l);const g=JSON.parse(d);r(g)}catch(d){s(d)}})}),n.on("error",i=>s(i))}catch(n){s(n)}})}getStats(){return this.updateStats(),{...this.stats}}getActiveTorrents(){if(!this.client)return[];try{return this.client.torrents.map(t=>({infoHash:t.infoHash||"",name:t.name||"Unnamed Torrent",magnetURI:t.magnetURI||"",progress:t.progress||0,downloadSpeed:t.downloadSpeed||0,uploadSpeed:t.uploadSpeed||0,numPeers:t.numPeers||0,downloaded:t.downloaded||0,uploaded:t.uploaded||0}))}catch(t){return console.error("Error getting active torrents:",t),[]}}onEvent(t){return this.eventCallbacks.push(t),()=>{const r=this.eventCallbacks.indexOf(t);r>-1&&this.eventCallbacks.splice(r,1)}}stopSeeding(t){if(!this.client)return!1;try{const r=this.client.get(t);return r?(this.client.remove(r),this.activeTorrents.delete(t),this.updateStats(),!0):!1}catch(r){return console.error("Error stopping torrent seeding:",r),!1}}destroy(){try{this.client&&typeof this.client.destroy=="function"&&this.client.destroy()}catch(t){console.error("Error destroying torrent client:",t)}}}let ae=null;function C(){return ae||(ae=new ke),ae}const Be=Object.freeze(Object.defineProperty({__proto__:null,TorrentService:ke,getTorrentService:C},Symbol.toStringTag,{value:"Module"}));function z(a){return a?{id:a.id,username:a.username,displayName:a.display_name||a.displayName||void 0,bio:a.bio||void 0,avatarHash:a.avatar_hash||a.avatarHash||void 0,publicKey:a.public_key||a.publicKey,fingerprint:a.fingerprint,createdAt:typeof a.created_at=="string"?a.created_at:a.createdAt,updatedAt:typeof a.updated_at=="string"?a.updated_at:a.updatedAt,version:a.version||1,magnetUri:a.magnet_uri||a.magnetUri||void 0,schemaVersion:1}:null}class ze{wasmCore;eventCallbacks=new Set;capabilities=null;constructor(t){this.wasmCore=t}async init(){try{await this.wasmCore.init(),console.log("[SnartNetCore] WASM core initialized")}catch(t){throw console.error("[SnartNetCore] Init error:",t),t}}async getCapabilities(){if(this.capabilities)return this.capabilities;let t={profileJsonApi:!1,postJsonApi:!1,messageJsonApi:!1,version:"0"};const r=this.wasmCore.get_capabilities;if(typeof r=="function")try{const s=r.call(this.wasmCore);if(s){let n=s;if(typeof s=="string")try{n=JSON.parse(s)}catch{}t={profileJsonApi:!!(n.profileJsonApi||n.profile_json_api),postJsonApi:!!(n.postJsonApi||n.post_json_api),messageJsonApi:!!(n.messageJsonApi||n.message_json_api),version:n.version?String(n.version):"0"}}}catch(s){console.warn("[Core] capability probe failed, using defaults",s)}return this.capabilities=t,t}async createProfile(t,r,s){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.create_profile_json){const o=JSON.stringify({username:t,displayName:r||null,bio:s||null}),i=this.wasmCore.create_profile_json(o),c=typeof i=="string"?JSON.parse(i):i,l=c.profile||c.profileJson||c,d=z(l);return d&&this.emitEvent({type:"ProfileLoaded",profile:d}),c.magnetUri||l.magnetUri||""}try{const o=this.wasmCore.create_profile(t,r||void 0,s||void 0),i=this.wasmCore.get_current_profile(),c=z(i);return c&&this.emitEvent({type:"ProfileLoaded",profile:c}),o}catch(o){const i=String(o?.message||o);console.error("[Core] legacy create_profile failed:",o);const c=this.wasmCore.create_profile_json;if(c)try{const l=JSON.stringify({username:t,displayName:r||null,bio:s||null}),d=c(l),g=typeof d=="string"?JSON.parse(d):d,m=g.profile||g.profileJson||g,u=z(m);return u&&this.emitEvent({type:"ProfileLoaded",profile:u}),g.magnetUri||m.magnetUri||""}catch(l){console.error("[Core] JSON fallback also failed:",l)}if(/memory access out of bounds/i.test(i)){console.warn("[Core] Detected possible corrupted WASM state; clearing persisted key/profile entries");try{localStorage.removeItem("snartnet_keypair"),localStorage.removeItem("snartnet_current_profile")}catch{}}throw o}}async getCurrentProfile(){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.get_current_profile_json){const s=this.wasmCore.get_current_profile_json();if(!s)return null;const n=typeof s=="string"?JSON.parse(s):s,o=n.profile||n.profileJson||n;return z(o)}const r=this.wasmCore.get_current_profile();return z(r)}async updateProfile(t,r){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.update_profile_json){const i=JSON.stringify({displayName:t||null,bio:r||null}),c=this.wasmCore.update_profile_json(i),l=typeof c=="string"?JSON.parse(c):c,d=l.profile||l.profileJson||l,g=z(d);g&&this.emitEvent({type:"ProfileUpdated",profile:g});return}await this.wasmCore.update_current_profile(t||void 0,r||void 0);const n=this.wasmCore.get_current_profile(),o=z(n);o&&this.emitEvent({type:"ProfileUpdated",profile:o})}async getPublicKey(){try{return this.wasmCore.get_public_key()}catch(t){throw console.error("[SnartNetCore] Get public key error:",t),t}}async getFingerprint(){try{return this.wasmCore.get_fingerprint()}catch(t){throw console.error("[SnartNetCore] Get fingerprint error:",t),t}}async createPost(t,r,s){try{const n=this.wasmCore.create_post(t,r||null,s||null);return console.log("[SnartNetCore] Post created:",n),this.emitEvent({type:"PostAdded",post:n}),n}catch(n){throw console.error("[SnartNetCore] Create post error:",n),n}}async createMessage(t,r){try{const s=this.wasmCore.create_message(t,r);return console.log("[SnartNetCore] Message created:",s),this.emitEvent({type:"MessageReceived",message:s}),s}catch(s){throw console.error("[SnartNetCore] Create message error:",s),s}}hasProfile(){return this.wasmCore.has_profile()}subscribeToEvents(t){return this.eventCallbacks.add(t),()=>this.eventCallbacks.delete(t)}emitEvent(t){this.eventCallbacks.forEach(r=>{try{r(t)}catch(s){console.error("[SnartNetCore] Error in event callback:",s)}})}async seedCurrentProfile(){try{const t=this.wasmCore.get_current_profile();if(!t)throw new Error("No current profile to seed");console.log("[SnartNetCore] Profile data type:",typeof t),console.log("[SnartNetCore] Profile data:",t);let r;typeof t=="object"&&t!==null?r=JSON.parse(JSON.stringify(t)):r=t,console.log("[SnartNetCore] Clean profile:",r);const s=C();try{const o=r.username||r.id;if(o){const i=localStorage.getItem(`profile-picture-${o}`),c=localStorage.getItem(`profile-picture-thumb-${o}`);i&&(r.profilePicture=i),c&&(r.profilePictureThumbnail=c);const l=localStorage.getItem(`profile-extended-${o}`);if(l)try{const d=JSON.parse(l);d&&typeof d=="object"&&(d.location&&(r.location=d.location),d.website&&(r.website=d.website),d.avatar&&(r.avatar=d.avatar))}catch{}}}catch(o){console.warn("[SnartNetCore] Failed merging extended profile data",o)}if(!r.postIndexMagnetUri&&!r.post_index_magnet)try{const o=await s.seedPostIndex([],r.username||r.id||"unknown",{});r.postIndexMagnetUri=o.magnetURI}catch(o){console.warn("[SnartNetCore] Failed to seed empty post index",o)}const n=await s.seedProfile(r);return console.log("[SnartNetCore] Profile seeding started:",n),n}catch(t){throw console.error("[SnartNetCore] Failed to seed profile:",t),t}}async downloadProfileFromMagnet(t){try{const s=await C().downloadProfile(t);return console.log("[SnartNetCore] Profile downloaded:",s),s}catch(r){throw console.error("[SnartNetCore] Failed to download profile:",r),r}}getTorrentStats(){return C().getStats()}getActiveTorrents(){return C().getActiveTorrents()}async stopSeeding(t){C().stopSeeding(t)}validateProfile(t){if(!t||typeof t!="object")return!1;for(const r of["id","username","publicKey","fingerprint","createdAt","updatedAt"])if(!(r in t))return!1;return!0}validatePost(t){return!!t&&typeof t=="object"&&"id"in t&&"author"in t}}let X=null;async function M(){if(!X)try{await ge(),await De();const a=new le;X=new ze(a),await X.init(),console.log("[Core] Initialized successfully")}catch(a){throw console.error("[Core] Initialization failed:",a),a}return X}function je(){const[a,t]=h.useState(null),[r,s]=h.useState(!0);return h.useEffect(()=>{M().then(n=>{t(n),s(!1)}).catch(n=>{console.error("Failed to initialize core:",n),s(!1)})},[]),{core:a,loading:r}}const We=Object.freeze(Object.defineProperty({__proto__:null,getCore:M,useCore:je},Symbol.toStringTag,{value:"Module"})),xe="snartnet:profile:seed-enabled",U=de(a=>({currentProfile:null,profiles:new Map,loading:!1,error:null,seedProfileEnabled:(()=>{const t=localStorage.getItem(xe);return t===null?!0:t==="true"})(),setCurrentProfile:t=>a({currentProfile:t}),addProfile:t=>a(r=>{const s=new Map(r.profiles);return s.set(t.username,t),{profiles:s}}),updateProfile:(t,r)=>a(s=>{const n=new Map(s.profiles),o=n.get(t);o&&n.set(t,{...o,...r});let i=s.currentProfile;return s.currentProfile?.username===t&&(i={...s.currentProfile,...r}),{profiles:n,currentProfile:i}}),updateProfilePicture:(t,r,s)=>a(n=>{const o={profilePicture:r,profilePictureThumbnail:s||r,updatedAt:new Date().toISOString()},i=new Map(n.profiles),c=i.get(t);c&&i.set(t,{...c,...o});let l=n.currentProfile;return n.currentProfile?.username===t&&(l={...n.currentProfile,...o},localStorage.setItem(`profile-picture-${t}`,r),s&&localStorage.setItem(`profile-picture-thumb-${t}`,s)),l&&M().then(d=>{d.seedCurrentProfile().catch(g=>console.warn("Reseed after picture update failed",g))}).catch(()=>{}),{profiles:i,currentProfile:l}}),setSeedProfileEnabled:t=>a(()=>{try{localStorage.setItem(xe,String(t))}catch{}return{seedProfileEnabled:t}}),setLoading:t=>a({loading:t}),setError:t=>a({error:t}),clearError:()=>a({error:null})})),Ke=Object.freeze(Object.defineProperty({__proto__:null,useProfileStore:U},Symbol.toStringTag,{value:"Module"})),Je="modulepreload",Ve=function(a){return"/net/"+a},he={},Q=function(t,r,s){let n=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=i?.nonce||i?.getAttribute("nonce");n=Promise.allSettled(r.map(l=>{if(l=Ve(l),l in he)return;he[l]=!0;const d=l.endsWith(".css"),g=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${g}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":Je,d||(m.as="script"),m.crossOrigin="",m.href=l,c&&m.setAttribute("nonce",c),document.head.appendChild(m),d)return new Promise((u,x)=>{m.addEventListener("load",u),m.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return n.then(i=>{for(const c of i||[])c.status==="rejected"&&o(c.reason);return t().catch(o)})},se="snartnet:ed25519:keypair:v1";function ue(){try{return typeof window<"u"&&!!window.crypto?.subtle&&window.crypto.subtle!==void 0}catch{return!1}}function ce(a){return btoa(String.fromCharCode(...a))}function ee(a){const t=atob(a),r=t.length,s=new ArrayBuffer(r),n=new Uint8Array(s);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return s}function qe(a){return new Uint8Array(ee(a))}async function He(){const a=localStorage.getItem(se);if(a)try{return JSON.parse(a)}catch{}if(ue()&&window.crypto.subtle.generateKey)try{const s=await window.crypto.subtle.generateKey({name:"Ed25519",namedCurve:"Ed25519"},!0,["sign","verify"]),n=new Uint8Array(await window.crypto.subtle.exportKey("raw",s.publicKey)),o=new Uint8Array(await window.crypto.subtle.exportKey("pkcs8",s.privateKey)),i={publicKey:ce(n),secretKey:ce(o)};return localStorage.setItem(se,JSON.stringify(i)),i}catch(s){console.warn("WebCrypto Ed25519 generateKey failed; falling back to WASM",s)}await me();const t=Ae();let r;if(typeof t=="string"?r=JSON.parse(t):r=t,!r?.publicKey||!r?.secretKey)throw new Error("WASM generate_keypair returned unexpected format");return localStorage.setItem(se,JSON.stringify(r)),r}let pe=!1;async function me(){if(!pe)try{await ge(),pe=!0}catch(a){throw console.error("Failed to initialize WASM core",a),a}}function _e(a){const t={},r=["version","kind","authorPublicKey","createdAt","body","attachments","parentId","replyTo"];for(const s of r){const n=a[s];n!=null&&!(Array.isArray(n)&&n.length===0)&&(t[s]=n)}return JSON.stringify(t)}async function be(a){const t=await He(),r=_e({...a,authorPublicKey:t.publicKey});if(ue())try{const n=ee(t.secretKey),o=await window.crypto.subtle.importKey("pkcs8",n,{name:"Ed25519",namedCurve:"Ed25519"},!1,["sign"]),i=await window.crypto.subtle.sign({name:"Ed25519"},o,new TextEncoder().encode(r)),c=ce(new Uint8Array(i));return{...a,authorPublicKey:t.publicKey,signature:c,version:a.version}}catch(n){console.warn("WebCrypto sign failed; falling back to WASM",n)}await me();const s=Ue(JSON.stringify(t),r);return{...a,authorPublicKey:t.publicKey,signature:s,version:a.version}}async function ye(a){const{signature:t,authorPublicKey:r,...s}=a,n=_e({...s,authorPublicKey:r});if(ue())try{const o=ee(r),i=await window.crypto.subtle.importKey("raw",o,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]);return{ok:await window.crypto.subtle.verify({name:"Ed25519"},i,ee(t),new TextEncoder().encode(n))}}catch(o){console.warn("WebCrypto verify failed; fallback to WASM",o)}await me();try{const o=Re(n,t,r);return{ok:o,error:o?void 0:"invalid-signature"}}catch(o){return{ok:!1,error:o?.message||"verify-error"}}}function ne(a){const t=qe(a);return"fpr-"+Array.from(t.slice(0,6)).map(r=>r.toString(16).padStart(2,"0")).join("")}const we=a=>{switch(a){case"ring-of-trust":return{canMessage:!0,canSeeFullProfile:!0,canShareContacts:!0,canRecoverKeys:!0};case"friend":return{canMessage:!0,canSeeFullProfile:!0,canShareContacts:!0,canRecoverKeys:!1};case"acquaintance":return{canMessage:!0,canSeeFullProfile:!1,canShareContacts:!1,canRecoverKeys:!1};case"group-member":return{canMessage:!0,canSeeFullProfile:!1,canShareContacts:!1,canRecoverKeys:!1}}},Ye=(a,t)=>`contact_${btoa(a+t).slice(0,16)}`,V=de((a,t)=>({contacts:[],loadContacts:()=>{try{const r=localStorage.getItem("snartnet-contacts");if(r){const s=JSON.parse(r);a({contacts:s})}}catch(r){console.error("Failed to load contacts:",r)}},addContact:r=>{const s=t().contacts,n={...r,id:Ye(r.username,r.magnetUri),addedDate:new Date().toISOString(),permissions:we(r.relationship)},o=s.findIndex(i=>i.id===n.id);if(o>=0){const i=[...s];i[o]={...i[o],...n},a({contacts:i}),localStorage.setItem("snartnet-contacts",JSON.stringify(i))}else{const i=[...s,n];a({contacts:i}),localStorage.setItem("snartnet-contacts",JSON.stringify(i))}},addContactFromMagnet:async(r,s="friend")=>{try{const n=`pending_${Math.random().toString(36).slice(2)}`,o={id:n,username:"loading…",displayName:"Loading profile…",relationship:s,trustLevel:s==="ring-of-trust"?8:5,addedDate:new Date().toISOString(),magnetUri:r,permissions:we(s)},i=t().contacts;a({contacts:[...i,o]});const{getTorrentService:c}=await Q(async()=>{const{getTorrentService:f}=await Promise.resolve().then(()=>Be);return{getTorrentService:f}},void 0),d=await c().downloadProfile(r);if(!d)return a({contacts:t().contacts.map(f=>f.id===n?{...f,username:"unknown",displayName:"Profile unavailable"}:f)}),null;const g=d.username||"unknown",m=d.displayName||g,u=d.avatar||d.profilePicture||void 0,x={username:g,displayName:m,relationship:s,trustLevel:s==="ring-of-trust"?8:5,magnetUri:r,avatar:u,notes:"",postIndexMagnetUri:d.postIndexMagnetUri||d.post_index_magnet||void 0,syncMaxPosts:100,syncMonthsLookback:6};return a({contacts:t().contacts.filter(f=>f.id!==n)}),t().addContact(x),t().contacts.find(f=>f.username===g&&f.magnetUri===r)||null}catch(n){return console.error("addContactFromMagnet failed",n),a({contacts:t().contacts.filter(o=>!o.id.startsWith("pending_"))}),null}},removeContact:r=>{const n=t().contacts.filter(o=>o.id!==r);a({contacts:n}),localStorage.setItem("snartnet-contacts",JSON.stringify(n))},updateContact:(r,s)=>{const o=t().contacts.map(i=>i.id===r?{...i,...s}:i);a({contacts:o}),localStorage.setItem("snartnet-contacts",JSON.stringify(o))},getContactsByRelationship:r=>t().contacts.filter(s=>s.relationship===r),getContact:r=>t().contacts.find(s=>s.id===r)}));function oe(a){return a?{id:a.id||a.postId||Math.random().toString(36).slice(2),author:a.author||a.author_fingerprint||a.fingerprint||"unknown",authorDisplayName:a.authorDisplayName||a.author_display_name||a.displayName,authorAvatar:a.authorAvatar||a.author_avatar,content:a.content||"",images:a.images,magnetUri:a.magnetUri||a.magnet_uri,createdAt:a.createdAt||a.created_at||new Date().toISOString(),updatedAt:a.updatedAt||a.updated_at,tags:a.tags,version:a.version||1,schemaVersion:1,authorPublicKey:a.authorPublicKey||a.author_public_key,signature:a.signature,signatureVerified:a.signatureVerified||a.signature_verified,signatureError:a.signatureError||a.signature_error,fingerprint:a.fingerprint}:null}const I=de(a=>({posts:[],loading:!1,error:null,addPost:async t=>{const r=new Date().toISOString();let s,n;try{const c=await be({version:1,kind:"post",body:t.content,createdAt:r,attachments:t.images?.map(l=>l.id)});s=c.signature,n=c.authorPublicKey}catch(c){console.warn("Signing post failed; proceeding unsigned",c)}const o={...t,id:Math.random().toString(36).slice(2),createdAt:r,signature:s,authorPublicKey:n,fingerprint:n?ne(n):void 0,signatureVerified:!!s},i=oe(o);a(c=>({posts:[i,...c.posts].sort((l,d)=>new Date(d.createdAt).getTime()-new Date(l.createdAt).getTime())}));try{const l=await C().seedPost({...i});a(d=>({posts:d.posts.map(g=>g.id===i.id?{...g,magnetUri:l,seedProgress:100,isSeeding:!1}:g)}))}catch(c){console.error("Failed to seed post:",c),a(l=>({posts:l.posts.map(d=>d.id===i.id?{...d,isSeeding:!1,seedProgress:0,seedError:c instanceof Error?c.message:"Failed to seed"}:d)}))}},removePost:t=>{a(r=>({posts:r.posts.filter(s=>s.id!==t)}))},updatePost:(t,r)=>{a(s=>({posts:s.posts.map(n=>n.id===t?{...n,...r}:n)}))},updateSeedingStatus:(t,r,s)=>{a(n=>({posts:n.posts.map(o=>o.id===t?{...o,isSeeding:r,seedProgress:s}:o)}))},loadPostsFromContacts:async()=>{const r=V.getState().contacts.filter(l=>!!l.postIndexMagnetUri);if(r.length===0){a({loading:!1});return}a({loading:!0});const s=2,n=[...r],o=[],i=new Set,c=()=>{if(n.length===0)return;const l=n.shift();i.add(l.id);const d=(async()=>{try{await I.getState().syncPostsForContact(l.id,{maxPosts:l.syncMaxPosts,monthsLookback:l.syncMonthsLookback})}catch(g){console.warn("Sync failed for contact",l.id,g)}})().finally(()=>{const g=o.indexOf(d);g>=0&&o.splice(g,1),n.length>0?c():o.length===0&&a({loading:!1})});o.push(d),o.length<s&&n.length>0&&c()};for(let l=0;l<s&&n.length>0;l++)c()},setLoading:t=>a({loading:t}),setError:t=>a({error:t}),clearError:()=>a({error:null}),syncPostsForContact:async(t,r)=>{const n=V.getState().contacts.find(o=>o.id===t);if(!(!n||!n.postIndexMagnetUri)){a({loading:!0});try{const i=await C().downloadPostIndexChain(n.postIndexMagnetUri,{maxPosts:r?.maxPosts??n.syncMaxPosts??100,monthsLookback:r?.monthsLookback??n.syncMonthsLookback}),c=new Set(I.getState().posts.map(u=>u.id)),l=i.entries.filter(u=>u.magnetUri&&!c.has(u.id)),d=3,g=[...l],m=[];for(;g.length>0;){const u=g.splice(0,d);await Promise.all(u.map(async x=>{try{const f=await C().downloadPost(x.magnetUri);if(f&&typeof f=="object"){let y=f;try{if(f.signature&&f.authorPublicKey){const{ok:p,error:j}=await ye({...f,version:f.version||1,kind:"post"});y.signatureVerified=p,y.signatureError=p?void 0:j||"invalid-signature",y.fingerprint=f.authorPublicKey?ne(f.authorPublicKey):f.fingerprint}else y.signatureVerified=!1,y.signatureError="missing-signature"}catch(p){y.signatureVerified=!1,y.signatureError=p?.message||"verify-failed"}m.push(oe(y))}else m.push({id:x.id,author:x.author,content:`(Unavailable content) @${x.author}`,createdAt:x.createdAt,magnetUri:x.magnetUri,images:[]})}catch{m.push({id:x.id,author:x.author,content:`(Failed to fetch) @${x.author}`,createdAt:x.createdAt,magnetUri:x.magnetUri,images:[]})}}))}m.length?a(u=>({posts:[...u.posts,...m].sort((x,f)=>new Date(f.createdAt).getTime()-new Date(x.createdAt).getTime()),loading:!1})):a({loading:!1})}catch(o){a({loading:!1,error:o instanceof Error?o.message:"Failed to sync posts"})}}},fetchPostFromMagnet:async t=>{try{const r=await C().downloadPost(t);if(!r)return null;let s=r;try{if(r.signature&&r.authorPublicKey){const{ok:o,error:i}=await ye({...r,version:r.version||1,kind:"post"});s.signatureVerified=o,s.signatureError=o?void 0:i||"invalid-signature",s.fingerprint=r.authorPublicKey?ne(r.authorPublicKey):r.fingerprint}else s.signatureVerified=!1,s.signatureError="missing-signature"}catch(o){s.signatureVerified=!1,s.signatureError=o?.message||"verify-failed"}const n=oe(s);return n?(a(o=>o.posts.some(c=>c.id===n.id)?{posts:o.posts.map(c=>c.id===n.id?{...c,...n}:c)}:{posts:[n,...o.posts].sort((c,l)=>new Date(l.createdAt).getTime()-new Date(c.createdAt).getTime())}),n):null}catch(r){return console.error("Failed to download post",r),null}},editPost:async(t,r)=>{const n=I.getState().posts.find(l=>l.id===t);if(!n)return;const o=new Date().toISOString();let i,c;try{const l=await be({version:1,kind:"post",body:r,createdAt:n.createdAt,updatedAt:o,attachments:n.images?.map(d=>d.id)});i=l.signature,c=l.authorPublicKey}catch(l){console.warn("Re-signing edited post failed; proceeding unsigned",l)}a(l=>({posts:l.posts.map(d=>d.id===t?{...d,content:r,updatedAt:o,signature:i,authorPublicKey:c,signatureVerified:!!i,isSeeding:!0}:d)}));try{const d=await C().seedPost({...n,content:r,updatedAt:o,signature:i,authorPublicKey:c});a(g=>({posts:g.posts.map(m=>m.id===t?{...m,magnetUri:d,isSeeding:!1,seedProgress:100}:m)}))}catch(l){console.error("Failed to reseed edited post",l),a(d=>({posts:d.posts.map(g=>g.id===t?{...g,isSeeding:!1,seedError:"Edit reseed failed"}:g)}))}await I.getState().regenerateAuthorIndex(n.author)},regenerateAuthorIndex:async t=>{try{const r=I.getState().posts.filter(d=>d.author===t&&d.magnetUri),s=C(),n=await Q(()=>Promise.resolve().then(()=>Ke),void 0),{useProfileStore:o}=n,i=o.getState().currentProfile,c=i?.postIndexMagnetUri||null,l=await s.seedPostIndex(r,t,{previousHeadMagnet:c});if(i&&i.username===t){o.getState().updateProfile(t,{postIndexMagnetUri:l.magnetURI});try{(await Q(async()=>{const{getCore:d}=await Promise.resolve().then(()=>We);return{getCore:d}},void 0)).getCore().then(d=>d.seedCurrentProfile())}catch{}}}catch(r){console.warn("Failed to regenerate post index",r)}},deletePost:async t=>{const s=I.getState().posts.find(n=>n.id===t);s&&(I.getState().removePost(t),await I.getState().regenerateAuthorIndex(s.author))}}));class T{static PROFILE_SIZE=200;static THUMBNAIL_SIZE=64;static MAX_FILE_SIZE=2*1024*1024;static SUPPORTED_FORMATS=["image/jpeg","image/png","image/webp"];static OUTPUT_FORMAT="image/jpeg";static OUTPUT_QUALITY=.85;static async processProfilePicture(t){this.validateFile(t);const r=await this.loadImage(t),s=this.calculateSquareCrop(r.width,r.height);return await this.resizeAndCompress(r,s,this.PROFILE_SIZE)}static async createThumbnail(t){const r=await this.loadImageFromDataUrl(t.dataUrl),s={x:0,y:0,width:r.width,height:r.height};return this.resizeAndCompress(r,s,this.THUMBNAIL_SIZE)}static async processWithCrop(t,r){this.validateFile(t);const s=await this.loadImage(t);return this.resizeAndCompress(s,r,this.PROFILE_SIZE)}static validateFile(t){if(!this.SUPPORTED_FORMATS.includes(t.type))throw new Error(`Unsupported file format. Please use: ${this.SUPPORTED_FORMATS.join(", ")}`);if(t.size>this.MAX_FILE_SIZE)throw new Error(`File too large. Maximum size: ${Math.round(this.MAX_FILE_SIZE/1024/1024)}MB`)}static loadImage(t){return new Promise((r,s)=>{const n=new Image,o=URL.createObjectURL(t);n.onload=()=>{URL.revokeObjectURL(o),r(n)},n.onerror=()=>{URL.revokeObjectURL(o),s(new Error("Failed to load image"))},n.src=o})}static loadImageFromDataUrl(t){return new Promise((r,s)=>{const n=new Image;n.onload=()=>r(n),n.onerror=()=>s(new Error("Failed to load image from data URL")),n.src=t})}static calculateSquareCrop(t,r){const s=Math.min(t,r),n=(t-s)/2,o=(r-s)/2;return{x:n,y:o,width:s,height:s}}static async resizeAndCompress(t,r,s){const n=document.createElement("canvas"),o=n.getContext("2d");if(!o)throw new Error("Canvas context not available");n.width=s,n.height=s,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(t,r.x,r.y,r.width,r.height,0,0,s,s);const i=await new Promise((l,d)=>{n.toBlob(g=>{g?l(g):d(new Error("Failed to create blob"))},this.OUTPUT_FORMAT,this.OUTPUT_QUALITY)});return{dataUrl:n.toDataURL(this.OUTPUT_FORMAT,this.OUTPUT_QUALITY),blob:i,width:s,height:s,size:i.size,format:this.OUTPUT_FORMAT}}static async blobToBase64(t){return new Promise((r,s)=>{const n=new FileReader;n.onload=()=>{const i=n.result.split(",")[1];r(i)},n.onerror=()=>s(new Error("Failed to convert blob to base64")),n.readAsDataURL(t)})}static base64ToDataUrl(t,r=this.OUTPUT_FORMAT){return`data:${r};base64,${t}`}static formatFileSize(t){if(t===0)return"0 B";const r=1024,s=["B","KB","MB"],n=Math.floor(Math.log(t)/Math.log(r));return parseFloat((t/Math.pow(r,n)).toFixed(1))+" "+s[n]}static validateImageDimensions(t,r){if(t<100||r<100)throw new Error("Image too small. Minimum size: 100x100px");if(t>4e3||r>4e3)throw new Error("Image too large. Maximum size: 4000x4000px")}static generateAvatarInitials(t){return t.split(" ").map(r=>r.charAt(0).toUpperCase()).join("").substring(0,2)}static generateAvatarGradient(t){let r=0;for(let o=0;o<t.length;o++){const i=t.charCodeAt(o);r=(r<<5)-r+i,r=r&r}const s=Math.abs(r%360),n=(s+60)%360;return`linear-gradient(135deg, hsl(${s}, 70%, 50%), hsl(${n}, 70%, 70%))`}}async function Ge(a,t){return a.type.startsWith("image/")?new Promise((r,s)=>{const n=new FileReader;n.onload=o=>{const i=o.target?.result;i?r({id:`${a.name}-${a.lastModified}`,data:i,filename:a.name,size:a.size,mimeType:a.type}):s(new Error("Failed to read file data."))},n.onerror=o=>{s(o)},n.readAsDataURL(a)}):(console.warn(`File is not an image: ${a.name}`),null)}function Xe(){const[a,t]=h.useState(""),[r,s]=h.useState([]),[n,o]=h.useState(!1),{currentProfile:i}=U(),c=I(u=>u.addPost),l=h.useRef(null),d=async u=>{if(u.target.files){const x=Array.from(u.target.files);try{const f=await Promise.all(x.map(y=>Ge(y,"post-image")));s(y=>[...y,...f.filter(p=>p!==null)])}catch(f){console.error("Error processing images:",f)}}},g=u=>{s(x=>x.filter(f=>f.id!==u))},m=async u=>{if(u.preventDefault(),!(!a.trim()&&r.length===0||!i)){o(!0);try{const x=i.publicKey||i.username;await c({author:x,authorDisplayName:i.displayName||i.username,authorAvatar:i.avatar,content:a,images:r}),console.log("Post created and seeding process initiated."),t(""),s([])}catch(x){console.error("Failed to create post:",x)}finally{o(!1)}}};return i?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white mb-4",children:"Create New Post"}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsx("textarea",{value:a,onChange:u=>t(u.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"What's happening on the swarm?",disabled:n}),r.length>0&&e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4",children:r.map(u=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:u.data,alt:"Post attachment",className:"w-full h-24 object-cover rounded-md"}),e.jsx("button",{type:"button",onClick:()=>g(u.id),className:"absolute top-1 right-1 bg-black/50 text-white rounded-full p-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity","aria-label":"Remove image",children:"✕"})]},u.id))}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>l.current?.click(),className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700","aria-label":"Add image",disabled:n,children:e.jsx("svg",{className:"w-6 h-6 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),e.jsx("input",{type:"file",ref:l,onChange:d,className:"hidden",accept:"image/*",multiple:!0,disabled:n,"aria-label":"File uploader"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Posts are seeded as torrents"})]}),e.jsx("button",{type:"submit",disabled:n||!a.trim()&&r.length===0,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:n?"🌱 Seeding...":"🌱 Seed Post"})]})]})]}):e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-yellow-700 dark:text-yellow-300",children:"You need to create a profile before you can make posts."})})}const Ze=()=>{const{posts:a,loading:t,loadPostsFromContacts:r}=I(),{loadContacts:s,contacts:n}=V(),{currentProfile:o}=U();h.useEffect(()=>{s(),r()},[s,r]);const i=h.useMemo(()=>{const l=new Set;return o&&(o.publicKey&&l.add(o.publicKey),l.add(o.username)),n.forEach(d=>{(d.relationship==="friend"||d.relationship==="ring-of-trust")&&l.add(d.username)}),l},[n,o]),c=h.useMemo(()=>i.size===0?a:a.filter(l=>i.has(l.author)||l.authorDisplayName&&i.has(l.authorDisplayName)),[a,i]);return t?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading timeline..."})]}):e.jsx("div",{className:"space-y-6",children:c.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🌱"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No posts yet"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Add some friends or seed a post to see activity here."})]}):c.map(l=>e.jsx(Qe,{post:l},l.id))})},Qe=({post:a})=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold",children:a.authorAvatar?e.jsx("img",{src:T.base64ToDataUrl(a.authorAvatar),alt:a.author,className:"w-10 h-10 rounded-full object-cover"}):a.author.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:a.authorDisplayName||a.author}),e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["@",a.author]}),a.signatureVerified?e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700",title:`Signature verified${a.fingerprint?` • ${a.fingerprint}`:""}`,children:"✅ ver"}):e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700",title:a.signatureError==="missing-signature"?"No signature present":`Signature invalid: ${a.signatureError||"unknown"}`,children:"⚠️ unverified"})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:et(a.createdAt)}),a.isSeeding&&e.jsxs("span",{className:"flex items-center text-green-600 dark:text-green-400",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-1"}),"Seeding"]}),a.magnetUri&&e.jsx("span",{className:"flex items-center text-blue-600 dark:text-blue-400",children:"🧲 Torrent"})]})]})]}),a.content&&e.jsx("div",{className:"mb-4",children:e.jsx("p",{className:"text-gray-900 dark:text-gray-100 whitespace-pre-line",children:a.content})}),a.images&&a.images.length>0&&e.jsx("div",{className:`mb-4 grid gap-2 ${a.images.length===1?"grid-cols-1":(a.images.length===2||a.images.length===3,"grid-cols-2")}`,children:a.images.map((t,r)=>e.jsx("div",{className:`${a.images.length===3&&r===0?"col-span-2":""}`,children:e.jsx("img",{src:T.base64ToDataUrl(t.data),alt:t.filename,className:"w-full h-64 object-cover rounded-lg border border-gray-200 dark:border-gray-600 cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{window.open(T.base64ToDataUrl(t.data),"_blank")}})},t.id))}),a.tags&&a.tags.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:a.tags.map(t=>e.jsxs("span",{className:"px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full",children:["#",t]},t))})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})}),e.jsx("span",{className:"text-sm",children:"Like"})]}),e.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("span",{className:"text-sm",children:"Reply"})]}),e.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"})}),e.jsx("span",{className:"text-sm",children:"Share"})]})]}),a.magnetUri&&e.jsx("button",{onClick:()=>navigator.clipboard.writeText(a.magnetUri),className:"text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",title:"Copy magnet link",children:"🧲 Copy Magnet"})]})]}),et=a=>{const t=new Date(a),s=Math.floor((new Date().getTime()-t.getTime())/1e3);return s<60?"just now":s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<604800?`${Math.floor(s/86400)}d ago`:t.toLocaleDateString()},tt=()=>{const{core:a,loading:t}=je(),{currentProfile:r}=U(),[s,n]=h.useState(!0);return h.useEffect(()=>{a&&n(!1)},[a]),t||s?e.jsx("div",{className:"flex items-center justify-center min-h-64",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-300",children:"Loading SnartNet..."})}):e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-4",children:"SnartNet"}),e.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-300 mb-8",children:"Decentralized social media, powered by swarms."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2",children:[r&&e.jsx(Xe,{}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx("span",{children:"Timeline"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500 dark:text-gray-400",children:"(Torrent-seeded posts)"})]}),e.jsx(Ze,{})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"How It Works"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-4",children:"Every post is a torrent seed! Your content is distributed across the swarm, making it censorship-resistant and decentralized."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"🌱 Posts are seeded as torrents"}),e.jsx("p",{className:"text-sm text-gray-500",children:"📷 Images included in torrent files"}),e.jsx("p",{className:"text-sm text-gray-500",children:"🔐 Content cryptographically signed"}),e.jsx("p",{className:"text-sm text-gray-500",children:"🤝 Shared through your Ring of Trust"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Features"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Profile pictures & posts"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Image upload & processing"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Post torrent seeding"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Chronological timeline"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-yellow-500 rounded-full mr-2"}),e.jsx("span",{children:"P2P post sharing (WIP)"})]})]})]})]})]})]})};function ve(){const[a,t]=h.useState(""),[r,s]=h.useState(""),[n,o]=h.useState(""),[i,c]=h.useState(!1),[l,d]=h.useState(null),[g,m]=h.useState(null),{setCurrentProfile:u,setLoading:x,setError:f}=U(),y=async p=>{if(p.preventDefault(),!a.trim()){d("Username is required");return}c(!0),d(null),m(null),f(null),x(!0);try{console.log("[CreateProfile] Starting profile creation...");const j=await M();console.log("[CreateProfile] Core initialized");const w=await j.createProfile(a.trim(),r.trim()||void 0,n.trim()||void 0);console.log("[CreateProfile] Profile created with magnet URI:",w);const E=await j.getCurrentProfile();if(console.log("[CreateProfile] Retrieved profile:",E),E)u(E),m(`Profile created successfully! Magnet URI: ${w}`),t(""),s(""),o(""),console.log("[CreateProfile] Profile creation completed successfully");else throw new Error("Failed to retrieve created profile")}catch(j){console.error("[CreateProfile] Error creating profile:",j);const w=j instanceof Error?j.message:"Failed to create profile";d(w),f(w)}finally{c(!1),x(!1)}};return e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Create Your Profile"}),e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username *"}),e.jsx("input",{type:"text",id:"username",value:a,onChange:p=>t(p.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter your username",disabled:i,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"displayName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Display Name"}),e.jsx("input",{type:"text",id:"displayName",value:r,onChange:p=>s(p.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Your display name (optional)",disabled:i})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Bio"}),e.jsx("textarea",{id:"bio",value:n,onChange:p=>o(p.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Tell us about yourself (optional)",disabled:i})]}),l&&e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md",children:e.jsx("p",{className:"text-red-700 dark:text-red-300 text-sm",children:l})}),g&&e.jsx("div",{className:"p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md",children:e.jsx("p",{className:"text-green-700 dark:text-green-300 text-sm",children:g})}),e.jsx("button",{type:"submit",disabled:i||!a.trim(),className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:cursor-not-allowed",children:i?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Creating Profile..."]}):"Create Profile"})]}),e.jsxs("div",{className:"mt-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white mb-2",children:"🔐 What happens when you create a profile?"}),e.jsxs("ul",{className:"text-xs text-gray-600 dark:text-gray-400 space-y-1",children:[e.jsx("li",{children:"• A new Ed25519 cryptographic key pair is generated"}),e.jsx("li",{children:"• Your profile is signed with your private key"}),e.jsx("li",{children:"• A magnet URI is created for peer-to-peer sharing"}),e.jsx("li",{children:"• Your private keys stay in your browser (never uploaded)"})]})]})]})})}const rt=({profilePicture:a,username:t="User",size:r="md",className:s="",showOnlineStatus:n=!1,isOnline:o=!1,alt:i})=>{const c={xs:"w-6 h-6",sm:"w-8 h-8",md:"w-12 h-12",lg:"w-16 h-16",xl:"w-24 h-24"},l={xs:"w-1.5 h-1.5 bottom-0 right-0",sm:"w-2 h-2 bottom-0 right-0",md:"w-3 h-3 bottom-0.5 right-0.5",lg:"w-4 h-4 bottom-1 right-1",xl:"w-6 h-6 bottom-1 right-1"},d=m=>m.split(" ").map(u=>u.charAt(0).toUpperCase()).slice(0,2).join(""),g=a?e.jsx("img",{src:T.base64ToDataUrl(a),alt:i||`${t}'s avatar`,className:`${c[r]} rounded-full object-cover ${s}`}):e.jsx("div",{className:`${c[r]} rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold ${s}`,title:t,children:e.jsx("span",{className:`${r==="xs"?"text-xs":r==="sm"?"text-sm":r==="md"?"text-base":r==="lg"?"text-lg":"text-xl"}`,children:d(t)})});return e.jsxs("div",{className:"relative inline-block",children:[g,n&&e.jsx("div",{className:`absolute ${l[r]} ${o?"bg-green-400":"bg-gray-400"} border-2 border-white dark:border-gray-800 rounded-full`})]})},at=({onClose:a,onSuccess:t})=>{const{currentProfile:r,updateProfilePicture:s}=U(),n=h.useRef(null),[o,i]=h.useState(!1),[c,l]=h.useState(!1),[d,g]=h.useState(null),[m,u]=h.useState(null),[x,f]=h.useState(""),[y,p]=h.useState(0),j=()=>{g(null),u(null),f(""),p(0),n.current&&(n.current.value="")},w=h.useCallback(async _=>{const O=_[0];if(O)try{l(!0),f("📤 Processing image..."),p(25);const P=await T.processProfilePicture(O);p(75),await T.createThumbnail(P),p(90),u(P),g(P.dataUrl),f(`✅ Image processed successfully! Size: ${T.formatFileSize(P.size)}`),p(100),console.log("Image processed:",{originalSize:O.size,processedSize:P.size,dimensions:`${P.width}x${P.height}`,format:P.format})}catch(P){console.error("Image processing error:",P),f(`❌ Error: ${P instanceof Error?P.message:"Unknown error"}`),j()}finally{l(!1)}},[]),E=_=>{const O=_.target.files;O&&O.length>0&&w(O)},G=h.useCallback(_=>{_.preventDefault(),_.stopPropagation(),i(!1),_.dataTransfer.files&&_.dataTransfer.files.length>0&&w(_.dataTransfer.files)},[w]),v=h.useCallback(_=>{_.preventDefault(),_.stopPropagation(),_.type==="dragenter"||_.type==="dragover"?i(!0):_.type==="dragleave"&&i(!1)},[]),$=async()=>{if(!m||!r){f("❌ No image to save or no current profile");return}try{l(!0),f("💾 Saving profile picture...");const _=await T.blobToBase64(m.blob),O=await T.createThumbnail(m),P=await T.blobToBase64(O.blob);s(r.username,_,P),f("✅ Profile picture saved successfully!"),t&&t(m.dataUrl),setTimeout(()=>{a&&a()},1500)}catch(_){console.error("Save error:",_),f(`❌ Failed to save: ${_ instanceof Error?_.message:"Unknown error"}`)}finally{l(!1)}},B=()=>{r&&confirm("Remove your profile picture?")&&(s(r.username,"",""),localStorage.removeItem(`profile-picture-${r.username}`),localStorage.removeItem(`profile-picture-thumb-${r.username}`),f("✅ Profile picture removed"),t&&t(""),setTimeout(()=>{a&&a()},1e3))},Ne=()=>y>=100?"w-full":y>=90?"w-11/12":y>=75?"w-3/4":y>=50?"w-1/2":y>=25?"w-1/4":"w-0";return e.jsxs("div",{className:"max-w-md mx-auto p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Profile Picture"}),a&&e.jsx("button",{onClick:a,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:"✕"})]}),!d&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${o?"border-blue-400 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500"}`,onDragEnter:v,onDragLeave:v,onDragOver:v,onDrop:G,children:[e.jsx("div",{className:"text-4xl mb-4",children:"📷"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Drag and drop an image here, or click to select"}),e.jsx("button",{onClick:()=>n.current?.click(),disabled:c,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"Choose Image"}),e.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:E,className:"hidden","aria-label":"Select profile picture file",title:"Select profile picture file"}),e.jsxs("div",{className:"mt-4 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"Supported: JPEG, PNG, WebP"}),e.jsx("p",{children:"Max size: 2MB • Auto-cropped to square"})]})]}),d&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:d,alt:"Profile preview",className:"w-32 h-32 rounded-full object-cover border-4 border-gray-200 dark:border-gray-600"}),c&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})})]})}),m&&e.jsxs("div",{className:"text-center text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("p",{children:["Size: ",T.formatFileSize(m.size)]}),e.jsxs("p",{children:["Dimensions: ",m.width,"×",m.height,"px"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:$,disabled:c||!m,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:c?"💾 Saving...":"💾 Save"}),e.jsx("button",{onClick:j,disabled:c,className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"🔄 Try Again"})]})]}),c&&y>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"bg-gray-200 dark:bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${Ne()}`})})}),r?.profilePicture&&!d&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("img",{src:T.base64ToDataUrl(r.profilePicture),alt:"Current profile",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600"})}),e.jsx("button",{onClick:B,className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"🗑️ Remove Current Picture"})]}),x&&e.jsx("div",{className:`mt-4 p-3 rounded-lg text-sm ${x.startsWith("✅")?"bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200":x.startsWith("❌")?"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200":"bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200"}`,children:x})]})},st=()=>{const{currentProfile:a}=U(),{posts:t,addPost:r,deletePost:s,editPost:n}=I(),[o,i]=h.useState(""),[c,l]=h.useState(!1),[d,g]=h.useState(null),[m,u]=h.useState(""),x=h.useMemo(()=>a?t.filter(y=>y.author===a.username).sort((y,p)=>new Date(p.createdAt).getTime()-new Date(y.createdAt).getTime()):[],[t,a]);if(!a)return null;const f=async y=>{if(y.preventDefault(),!!o.trim()){l(!0);try{await r({author:a.username,authorDisplayName:a.displayName,content:o.trim(),images:[]}),i("")}finally{l(!1)}}};return e.jsxs("div",{className:"w-full max-w-xl mx-auto mt-8",children:[e.jsxs("form",{onSubmit:f,className:"mb-6 flex flex-col gap-2",children:[e.jsx("textarea",{className:"w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-vertical",rows:3,placeholder:"What's on your mind?",value:o,onChange:y=>i(y.target.value),disabled:c}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:o.length>0&&`${o.length} chars`}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",disabled:c||!o.trim(),children:c?"Posting...":"Post"})]})]}),e.jsx("div",{className:"space-y-4",children:x.length>0?x.map(y=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative",children:[e.jsx("p",{className:"text-gray-900 dark:text-gray-100 mb-2 whitespace-pre-line",children:y.content}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("span",{children:new Date(y.createdAt).toLocaleString()}),e.jsxs("div",{className:"flex items-center gap-2",children:[y.signature&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold "+(y.signatureVerified?"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"),title:y.signatureVerified?`Signature verified${y.fingerprint?" ("+y.fingerprint+")":""}`:`Signature invalid: ${y.signatureError||"unknown"}`,children:y.signatureVerified?"Verified":"Invalid"}),e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs",onClick:()=>{g(y.id),u(y.content)},title:"Edit post",children:"✏️"}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xs",onClick:()=>s(y.id),title:"Delete post",children:"🗑️"})]})]}),d===y.id&&e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsx("textarea",{className:"w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm",value:m,onChange:p=>u(p.target.value),placeholder:"Edit your post",title:"Edit post content"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600",onClick:()=>{g(null),u("")},children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white",disabled:!m.trim(),onClick:async()=>{await n(y.id,m.trim()),g(null),u("")},children:"Save"})]})]})]},y.id)):e.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400",children:"No posts yet."})})]})},nt=()=>{const{currentProfile:a}=U(),[t,r]=h.useState(!1);return a?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col items-center",children:[e.jsxs("div",{className:"mb-4 relative",children:[e.jsx(rt,{profilePicture:a.profilePicture,username:a.username,size:"xl"}),e.jsx("button",{className:"absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 shadow-lg border-2 border-white dark:border-gray-800",onClick:()=>r(!0),title:"Change profile picture",children:e.jsx("span",{role:"img","aria-label":"Edit",children:"✏️"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:a.displayName||a.username}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-300 mb-2",children:["@",a.username]}),a.bio&&e.jsx("p",{className:"text-gray-700 dark:text-gray-200 mb-2 max-w-xl mx-auto",children:a.bio})]}),t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-lg p-4 relative w-full max-w-lg",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",onClick:()=>r(!1),title:"Close",children:"✕"}),e.jsx(at,{onClose:()=>r(!1)})]})}),e.jsx("div",{className:"w-full mt-8",children:e.jsx(st,{})})]}):e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center",children:e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:"No profile loaded."})})},ot=({onCancel:a})=>{const{currentProfile:t,setCurrentProfile:r}=U(),[s,n]=h.useState({username:t?.username||"",displayName:t?.displayName||"",bio:t?.bio||"",location:t?.location||"",website:t?.website||"",avatar:t?.avatar||""}),[o,i]=h.useState({}),[c,l]=h.useState(!1),d=()=>{const u={};return s.website&&!s.website.match(/^https?:\/\/.+/)&&(u.website="Website must be a valid URL (http:// or https://)"),i(u),Object.keys(u).length===0},g=async()=>{if(d()){l(!0);try{(await M()).updateProfile(s.displayName,s.bio);const x={location:s.location,website:s.website,avatar:s.avatar,updatedAt:new Date().toISOString()};localStorage.setItem(`profile-extended-${s.username}`,JSON.stringify(x));const f={...t,username:s.username,displayName:s.displayName,bio:s.bio,location:s.location,website:s.website,avatar:s.avatar,updatedAt:new Date().toISOString()};r(f),a()}catch(u){console.error("Failed to update profile:",u),i({general:"Failed to update profile. Please try again."})}finally{l(!1)}}},m=(u,x)=>{n(f=>({...f,[u]:x})),o[u]&&i(f=>({...f,[u]:""}))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-white dark:bg-gray-800",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Edit Profile"}),o.general&&e.jsx("div",{className:"text-red-600 text-sm",children:o.general}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username (cannot be changed)"}),e.jsx("input",{type:"text",value:s.username,readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Enter username"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Display Name"}),e.jsx("input",{type:"text",value:s.displayName,onChange:u=>m("displayName",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Enter display name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Bio"}),e.jsx("textarea",{value:s.bio,onChange:u=>m("bio",u.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Tell us about yourself"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Location"}),e.jsx("input",{type:"text",value:s.location,onChange:u=>m("location",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Enter your location"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Website"}),e.jsx("input",{type:"url",value:s.website,onChange:u=>m("website",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"https://example.com"}),o.website&&e.jsx("div",{className:"text-red-600 text-sm mt-1",children:o.website})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Avatar URL"}),e.jsx("input",{type:"url",value:s.avatar,onChange:u=>m("avatar",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"https://example.com/avatar.jpg"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx("button",{onClick:g,disabled:c,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md disabled:opacity-50",children:c?"Saving...":"Save Changes"}),e.jsx("button",{onClick:a,disabled:c,className:"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md",children:"Cancel"})]})]})};function it({progress:a,className:t=""}){const r=Math.max(0,Math.min(100,a*100)),s=()=>r===0?"w-0":r>=100?"w-full":r>=75?"w-3/4":r>=50?"w-1/2":r>=25?"w-1/4":"w-1/12";return e.jsx("div",{className:`w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 overflow-hidden ${t}`,children:e.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${s()}`})})}function lt(){const[a,t]=h.useState({torrents:0,downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0,peers:0}),[r,s]=h.useState([]),[n,o]=h.useState([]),[i,c]=h.useState(!1);h.useEffect(()=>{let d;const m=(()=>{try{const u=C();c(!0);const x=u.onEvent(f=>{const y=new Date().toLocaleTimeString();switch(f.type){case"seeding-started":"profile"in f&&f.profile?o(p=>[`[${y}] ✅ Started seeding profile: ${f.profile.username}`,...p.slice(0,9)]):"post"in f&&f.post&&o(p=>[`[${y}] ✅ Started seeding post by: ${f.post.authorDisplayName||"anonymous"}`,...p.slice(0,9)]);break;case"peer-connected":o(p=>[`[${y}] 🔗 Peer connected: ${f.peerId}`,...p.slice(0,9)]);break;case"upload-progress":Math.random()<.1&&o(p=>[`[${y}] ⬆️ Upload: ${l(f.uploadSpeed)}/s`,...p.slice(0,9)]);break;case"profile-downloaded":f.profile&&o(p=>[`[${y}] ⬇️ Downloaded profile: ${f.profile.username}`,...p.slice(0,9)]);break;case"download-progress":Math.random()<.1&&o(p=>[`[${y}] ⬇️ Progress: ${(f.progress*100).toFixed(1)}%`,...p.slice(0,9)]);break;case"error":o(p=>[`[${y}] ❌ Error: ${f.error}`,...p.slice(0,9)]);break}});return d=setInterval(()=>{t(u.getStats()),s(u.getActiveTorrents())},2e3),t(u.getStats()),s(u.getActiveTorrents()),x}catch(u){console.error("Failed to initialize torrent service:",u),c(!1),o(x=>[`Failed to initialize WebTorrent: ${u}`,...x.slice(0,9)])}})();return()=>{d&&clearInterval(d),m&&m()}},[]);const l=d=>{if(d===0)return"0 B";const g=1024,m=["B","KB","MB","GB"],u=Math.floor(Math.log(d)/Math.log(g));return parseFloat((d/Math.pow(g,u)).toFixed(1))+" "+m[u]};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"WebTorrent Client"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${i?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:i?"Connected":"Disconnected"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:a.torrents}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Active Torrents"})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:a.peers}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Connected Peers"})]}),e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3",children:[e.jsxs("div",{className:"text-lg font-bold text-purple-600 dark:text-purple-400",children:["⬆️ ",l(a.uploadSpeed),"/s"]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Upload Speed"})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3",children:[e.jsxs("div",{className:"text-lg font-bold text-orange-600 dark:text-orange-400",children:["⬇️ ",l(a.downloadSpeed),"/s"]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Download Speed"})]}),e.jsxs("div",{className:"bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-lg font-bold text-indigo-600 dark:text-indigo-400",children:l(a.uploaded)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Uploaded"})]}),e.jsxs("div",{className:"bg-pink-50 dark:bg-pink-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-lg font-bold text-pink-600 dark:text-pink-400",children:l(a.downloaded)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Downloaded"})]})]}),r.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Active Torrents"}),e.jsx("div",{className:"space-y-2",children:r.map(d=>e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white truncate",children:d.name||"Unnamed Torrent"}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[(d.progress*100).toFixed(1),"%"]})]}),e.jsx(it,{progress:d.progress,className:"mb-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:["Peers: ",d.numPeers]}),e.jsxs("span",{children:["⬆️ ",l(d.uploadSpeed),"/s ⬇️ ",l(d.downloadSpeed),"/s"]})]})]},d.infoHash))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Recent Activity"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4 h-48 overflow-y-auto",children:n.length>0?e.jsx("div",{className:"space-y-1",children:n.map((d,g)=>e.jsx("div",{className:"text-sm font-mono text-gray-700 dark:text-gray-300",children:d},g))}):e.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400 mt-16",children:"No activity yet. Start seeding a profile to see torrent activity!"})})]})]})}class ie{static BACKUP_VERSION="1.0.0";static FILE_EXTENSION=".snartnet-backup";static async createBackup(t=!0){try{const s=await(await M()).getCurrentProfile();if(!s)throw new Error("No current profile to backup");const n=localStorage.getItem("snartnet_keypair");if(!n)throw new Error("No keypair found for backup");const o=localStorage.getItem(`profile-extended-${s.username}`);let i=null;if(t){const l=localStorage.getItem("snartnet-contacts");i=l?JSON.parse(l):[]}const c={version:this.BACKUP_VERSION,timestamp:new Date().toISOString(),profile:s,keypair:JSON.parse(n),extendedData:o?JSON.parse(o):null,contacts:i,metadata:{username:s.username,fingerprint:s.fingerprint||"unknown",backupId:this.generateBackupId()}};return console.log("Backup created successfully:",{username:c.metadata.username,timestamp:c.timestamp,includesContacts:!!c.contacts}),c}catch(r){throw console.error("Failed to create backup:",r),new Error(`Backup creation failed: ${r instanceof Error?r.message:"Unknown error"}`)}}static async downloadBackup(t=!0,r){try{const s=await this.createBackup(t);let n=s;r&&(n=await this.encryptBackup(s,r));const o=JSON.stringify(n,null,2),i=new Blob([o],{type:"application/json"}),c=URL.createObjectURL(i),l=document.createElement("a");l.href=c,l.download=`${s.metadata.username}_backup_${this.formatDateForFilename(s.timestamp)}${this.FILE_EXTENSION}`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(c),console.log("Backup downloaded successfully")}catch(s){throw console.error("Failed to download backup:",s),s}}static async restoreFromBackup(t,r){try{let s;r&&t.encrypted?s=await this.decryptBackup(t,r):s=t,this.validateBackup(s),console.log("Restoring backup:",{version:s.version,username:s.metadata.username,timestamp:s.timestamp}),localStorage.removeItem("snartnet_keypair"),localStorage.removeItem("snartnet_current_profile"),localStorage.removeItem("snartnet-contacts"),localStorage.setItem("snartnet_keypair",JSON.stringify(s.keypair)),localStorage.setItem("snartnet_current_profile",JSON.stringify({profile:s.profile,signature:s.keypair?.signature||"restored"})),s.extendedData&&s.metadata.username&&localStorage.setItem(`profile-extended-${s.metadata.username}`,JSON.stringify(s.extendedData)),s.contacts&&localStorage.setItem("snartnet-contacts",JSON.stringify(s.contacts)),console.log("Backup restored successfully"),window.location.reload()}catch(s){throw console.error("Failed to restore backup:",s),new Error(`Restore failed: ${s instanceof Error?s.message:"Unknown error"}`)}}static async restoreFromFile(t,r){try{if(!t.name.endsWith(this.FILE_EXTENSION)&&!t.name.endsWith(".json"))throw new Error("Invalid backup file format. Please select a .snartnet-backup or .json file.");const s=await this.readFileContent(t),n=JSON.parse(s);await this.restoreFromBackup(n,r)}catch(s){throw console.error("Failed to restore from file:",s),s}}static async encryptBackup(t,r){const s=JSON.stringify(t),n=btoa(unescape(encodeURIComponent(s)));return{encrypted:!0,version:t.version,data:n,hint:`Backup for ${t.metadata.username}`,timestamp:t.timestamp}}static async decryptBackup(t,r){try{const s=decodeURIComponent(escape(atob(t.data)));return JSON.parse(s)}catch{throw new Error("Invalid password or corrupted backup file")}}static validateBackup(t){if(!t||typeof t!="object")throw new Error("Invalid backup format");if(!t.version||!t.timestamp||!t.profile||!t.keypair)throw new Error("Incomplete backup data");if(!t.metadata||!t.metadata.username)throw new Error("Missing backup metadata");t.version!==this.BACKUP_VERSION&&console.warn("Backup version mismatch:",t.version,"vs",this.BACKUP_VERSION)}static readFileContent(t){return new Promise((r,s)=>{const n=new FileReader;n.onload=o=>{o.target?.result?r(o.target.result):s(new Error("Failed to read file"))},n.onerror=()=>{s(new Error("File reading error"))},n.readAsText(t)})}static generateBackupId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}static formatDateForFilename(t){return new Date(t).toISOString().split("T")[0].replace(/-/g,"")}static async getBackupInfo(t,r){try{const s=await this.readFileContent(t);let n=JSON.parse(s);return n.encrypted&&r&&(n=await this.decryptBackup(n,r)),{username:n.metadata?.username||"Unknown",timestamp:n.timestamp||"Unknown",version:n.version||"Unknown",hasContacts:Array.isArray(n.contacts)&&n.contacts.length>0,fingerprint:n.metadata?.fingerprint||"Unknown"}}catch(s){throw new Error("Failed to read backup info: "+(s instanceof Error?s.message:"Unknown error"))}}}const ct=({onClose:a})=>{const{currentProfile:t}=U(),r=h.useRef(null),[s,n]=h.useState("backup"),[o,i]=h.useState(!0),[c,l]=h.useState(!1),[d,g]=h.useState(""),[m,u]=h.useState(!1),[x,f]=h.useState(""),[y,p]=h.useState(null),j=async()=>{if(!t){f("❌ No profile to backup");return}if(c&&!d.trim()){f("❌ Password is required");return}try{u(!0),f("📦 Creating backup..."),await ie.downloadBackup(o,c?d:void 0),f("✅ Backup downloaded successfully!")}catch(v){console.error("Backup failed:",v),f(`❌ Backup failed: ${v instanceof Error?v.message:"Unknown error"}`)}finally{u(!1)}},w=async v=>{const $=v.target.files?.[0];if($)try{u(!0),f("📄 Reading backup file...");const B=await ie.getBackupInfo($,c?d:void 0);p(B),f("📋 Backup file loaded. Review info below and click Restore.")}catch(B){console.error("Failed to read backup:",B),f(`❌ Failed to read backup: ${B instanceof Error?B.message:"Unknown error"}`),p(null)}finally{u(!1)}},E=async()=>{const v=r.current?.files?.[0];if(!v){f("❌ Please select a backup file");return}if(c&&!d.trim()){f("❌ Password is required");return}if(confirm("⚠️ This will replace your current profile and data. Are you sure?"))try{u(!0),f("🔄 Restoring backup..."),await ie.restoreFromFile(v,c?d:void 0),f("✅ Backup restored successfully! Page will reload...")}catch($){console.error("Restore failed:",$),f(`❌ Restore failed: ${$ instanceof Error?$.message:"Unknown error"}`)}finally{u(!1)}},G=()=>{g(""),f(""),p(null),r.current&&(r.current.value="")};return e.jsxs("div",{className:"max-w-2xl mx-auto p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Profile Backup & Restore"}),a&&e.jsx("button",{onClick:a,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:"✕"})]}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-6",children:e.jsxs("nav",{className:"flex space-x-8",children:[e.jsx("button",{onClick:()=>{n("backup"),G()},className:`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${s==="backup"?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400"}`,children:"📦 Backup"}),e.jsx("button",{onClick:()=>{n("restore"),G()},className:`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${s==="restore"?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400"}`,children:"🔄 Restore"})]})}),s==="backup"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"📋 What gets backed up:"}),e.jsxs("ul",{className:"text-sm text-blue-800 dark:text-blue-200 space-y-1",children:[e.jsx("li",{children:"• Your profile information and cryptographic keys"}),e.jsx("li",{children:"• Extended profile data (avatar, location, website)"}),e.jsx("li",{children:"• Your contacts and relationships (optional)"}),e.jsx("li",{children:"• All necessary data to restore your identity"})]})]}),t?e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Current Profile:"}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:[e.jsx("strong",{children:"Username:"})," ",t.username,e.jsx("br",{}),e.jsx("strong",{children:"Display Name:"})," ",t.displayName||"Not set",e.jsx("br",{}),e.jsx("strong",{children:"Public Key:"})," ",t.publicKey?.slice(0,16)+"..."||"Unknown"]})]}):e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4",children:e.jsx("p",{className:"text-yellow-800 dark:text-yellow-200",children:"⚠️ No profile found to backup. Please create a profile first."})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:v=>i(v.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Include contacts and relationships in backup"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:v=>l(v.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Password protect backup (recommended)"})]}),c&&e.jsx("input",{type:"password",value:d,onChange:v=>g(v.target.value),placeholder:"Enter backup password",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),e.jsx("button",{onClick:j,disabled:m||!t,className:"w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:m?"📦 Creating Backup...":"💾 Download Backup"})]}),s==="restore"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-100 mb-2",children:"⚠️ Important Warning:"}),e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"Restoring a backup will completely replace your current profile, keys, and data. Make sure to backup your current profile first if you want to keep it."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select Backup File:"}),e.jsx("input",{ref:r,type:"file",accept:".snartnet-backup,.json",onChange:w,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Accepts .snartnet-backup and .json files"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:v=>l(v.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Backup is password protected"})]}),c&&e.jsx("input",{type:"password",value:d,onChange:v=>g(v.target.value),placeholder:"Enter backup password",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),y&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Backup Information:"}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Username:"})," ",y.username]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Created:"})," ",new Date(y.timestamp).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Version:"})," ",y.version]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fingerprint:"})," ",y.fingerprint]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Includes Contacts:"})," ",y.hasContacts?"Yes":"No"]})]})]}),e.jsx("button",{onClick:E,disabled:m||!y,className:"w-full px-4 py-3 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:m?"🔄 Restoring...":"🔄 Restore Backup"})]}),x&&e.jsx("div",{className:`mt-6 p-4 rounded-lg ${x.startsWith("✅")?"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700":x.startsWith("❌")?"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700":x.startsWith("⚠️")?"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700":"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700"}`,children:e.jsx("p",{className:`text-sm font-medium ${x.startsWith("✅")?"text-green-800 dark:text-green-200":x.startsWith("❌")?"text-red-800 dark:text-red-200":x.startsWith("⚠️")?"text-yellow-800 dark:text-yellow-200":"text-blue-800 dark:text-blue-200"}`,children:x})})]})},dt=()=>{const{currentProfile:a,loading:t,seedProfileEnabled:r,setSeedProfileEnabled:s}=U(),[n,o]=h.useState(!1),[i,c]=h.useState(!1),[l,d]=h.useState(""),[g,m]=h.useState(!1);async function u(){if(!(!a||!r))try{d("Seeding profile...");const f=await(await M()).seedCurrentProfile();d(`Seeding ✓ (${f.slice(0,40)}...)`)}catch(x){d(`Seeding failed: ${x?.message||"error"}`)}}return a&&r&&l===""&&u(),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Profile Management"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500",checked:r,onChange:x=>{s(x.target.checked),x.target.checked&&u()}}),e.jsx("span",{children:"Seed my profile (auto)"}),l&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:l})]}),a&&!n&&!i&&!g&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>c(!0),className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors",children:"💾 Backup & Restore"}),e.jsx("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors",children:"Create New Profile"}),e.jsx("button",{onClick:()=>m(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"Edit Profile"})]})]})]}),t&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading profile..."})]}),!t&&e.jsxs("div",{className:"space-y-8",children:[i&&e.jsx("div",{children:e.jsx(ct,{onClose:()=>c(!1)})}),n&&!i&&!g&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Create New Profile"}),e.jsx("button",{onClick:()=>o(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕ Cancel"})]}),e.jsx(ve,{})]}),!i&&!g&&e.jsxs(e.Fragment,{children:[a?e.jsx("div",{children:!n&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-4",children:"Current Profile"}),e.jsx(nt,{})]})}):!n&&e.jsx(ve,{}),e.jsx(lt,{})]}),g&&a&&!i&&!n&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Edit Profile"}),e.jsx("button",{onClick:()=>m(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕ Close"})]}),e.jsx(ot,{onCancel:()=>m(!1)})]})]})]})},gt=()=>e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-4",children:"Messages"}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Encrypted messaging features coming soon..."})})]});function ut({onProfileDownloaded:a}){const{currentProfile:t}=U(),[r,s]=h.useState(""),[n,o]=h.useState(!1),[i,c]=h.useState(""),[l,d]=h.useState(""),[g,m]=h.useState(!1),[u,x]=h.useState(!1),f=async()=>{if(!t){c("No profile to seed");return}try{m(!0),c("Starting to seed your profile...");const E=await(await M()).seedCurrentProfile();d(E),c("✅ Profile is now seeding! Share the magnet link with friends."),x(!0)}catch(w){console.error("Error seeding profile:",w),c(`❌ Failed to seed profile: ${w}`)}finally{m(!1)}},y=async()=>{if(!r.trim()){c("Please enter a magnet link");return}if(!r.startsWith("magnet:?")){c("Invalid magnet link format");return}try{o(!0),c("Connecting to peers and downloading profile...");const E=await(await M()).downloadProfileFromMagnet(r.trim());E?(c(`✅ Successfully downloaded profile: ${E.username}`),s(""),a&&a(E)):c("❌ Failed to download profile - no data received")}catch(w){console.error("Error downloading profile:",w),c(`❌ Download failed: ${w}`)}finally{o(!1)}},p=async()=>{if(l)try{await navigator.clipboard.writeText(l),c("✅ Magnet link copied to clipboard!"),setTimeout(()=>c(""),3e3)}catch(w){console.error("Failed to copy magnet link:",w),c("Failed to copy magnet link")}},j=async()=>{if(l&&"share"in navigator)try{await navigator.share({title:`${t?.username}'s SnartNet Profile`,text:"Connect with me on SnartNet! Download my profile using this magnet link:",url:l})}catch(w){console.log("Share cancelled or failed:",w)}};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Connect with Friends"}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Share Your Profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Start seeding your profile so friends can download it via P2P torrent network."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:f,disabled:!t||g,className:"px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:g?"Starting Seed...":"🌱 Start Seeding Profile"}),l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:p,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"📋 Copy Magnet Link"}),"share"in navigator&&e.jsx("button",{onClick:j,className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors",children:"📱 Share"})]})]}),l&&e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white mb-2",children:"Your Magnet Link:"}),e.jsx("code",{className:"text-xs text-gray-600 dark:text-gray-400 break-all font-mono",children:l})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Download Friend's Profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Enter a magnet link from a friend to download their profile via P2P."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"magnet-input",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Magnet Link"}),e.jsx("textarea",{id:"magnet-input",value:r,onChange:w=>s(w.target.value),placeholder:"magnet:?xt=urn:btih:...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:3})]}),e.jsx("button",{onClick:y,disabled:!r.trim()||n,className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:n?"⬇️ Downloading...":"⬇️ Download Profile"})]})]}),i&&e.jsx("div",{className:`p-4 rounded-lg ${i.includes("✅")?"bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200":i.includes("❌")?"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200":"bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200"}`,children:e.jsx("p",{className:"text-sm font-medium",children:i})}),u&&l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"🎉 Profile Successfully Seeding!"}),e.jsx("button",{onClick:()=>x(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"✕"})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Your profile is now available on the P2P network. Share this magnet link with friends:"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-4",children:e.jsx("code",{className:"text-xs text-gray-600 dark:text-gray-400 break-all font-mono",children:l})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:p,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"📋 Copy"}),"share"in navigator&&e.jsx("button",{onClick:j,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors",children:"📱 Share"})]})]})})]})}function mt(){const[a,t]=h.useState([]),{addContact:r,getContact:s}=V();h.useEffect(()=>{const l=localStorage.getItem("snartnet-discovered-profiles");if(l)try{t(JSON.parse(l))}catch(d){console.error("Failed to load discovered profiles:",d)}},[]),h.useEffect(()=>{localStorage.setItem("snartnet-discovered-profiles",JSON.stringify(a))},[a]);const n=l=>{const d=a.findIndex(m=>m.publicKey===l.publicKey),g={id:l.publicKey.slice(0,8),username:l.username,displayName:l.displayName||l.username,bio:l.bio,publicKey:l.publicKey,avatar:l.avatar,downloadedAt:new Date().toISOString(),magnetURI:l.magnetURI};if(d>=0){const m=[...a];m[d]={...m[d],...g},t(m)}else t(m=>[g,...m])},o=l=>{t(d=>d.filter(g=>g.publicKey!==l))},i=(l,d="friend")=>{const g=`contact_${btoa(l.username+(l.magnetURI||"")).slice(0,16)}`;if(s(g)){alert(`${l.username} is already in your contacts!`);return}r({username:l.username,displayName:l.displayName,relationship:d,trustLevel:d==="friend"?7:5,magnetUri:l.magnetURI||"",avatar:l.avatar,notes:`Added from discovery on ${new Date().toLocaleDateString()}`}),alert(`${l.username} has been added to your ${d}s!`)},c=l=>new Date(l).toLocaleDateString()+" "+new Date(l).toLocaleTimeString();return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Discover Friends"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Share your profile and download friends' profiles using magnet links."})]}),e.jsx(ut,{onProfileDownloaded:n}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex justify-between items-center mb-6",children:e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Downloaded Friends (",a.length,")"]})}),a.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"👥"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No friends discovered yet"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Use the magnet link manager above to download friends' profiles from the P2P network."})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:a.map(l=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:border-blue-300 dark:hover:border-blue-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[l.avatar?e.jsx("img",{src:l.avatar,alt:`${l.username}'s avatar`,className:"w-10 h-10 rounded-full"}):e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold",children:l.username.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:l.displayName}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:["@",l.username]})]})]}),e.jsx("button",{onClick:()=>o(l.publicKey),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1",title:"Remove profile",children:"🗑️"})]}),l.bio&&e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2",children:l.bio}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-3",children:[e.jsxs("p",{children:["Downloaded: ",c(l.downloadedAt)]}),e.jsxs("p",{className:"font-mono",children:["ID: ",l.id]})]}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("button",{onClick:()=>i(l,"friend"),className:"flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors",children:"➕ Add Friend"}),e.jsx("button",{onClick:()=>i(l,"acquaintance"),className:"flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:"🤝 Add Acquaintance"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors",children:"💬 Message"}),e.jsx("button",{className:"flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors",children:"👤 View Profile"})]})]},l.publicKey))})]})]})}const ft=[{id:"all",label:"All",icon:"🌐"},{id:"friend",label:"Friends",icon:"👥"},{id:"ring-of-trust",label:"Ring of Trust",icon:"🛡️"},{id:"acquaintance",label:"Acquaintances",icon:"🤝"},{id:"group-member",label:"Groups",icon:"🏠"}],xt=()=>{const{loadContacts:a,contacts:t,addContactFromMagnet:r,removeContact:s}=V(),[n,o]=h.useState("all"),[i,c]=h.useState(""),[l,d]=h.useState(!1),[g,m]=h.useState("friend"),[u,x]=h.useState(null);h.useEffect(()=>{a()},[a]);const f=t.filter(p=>n==="all"?!0:p.relationship===n),y=async p=>{if(p.preventDefault(),x(null),!!i.trim()){d(!0);try{await r(i.trim(),g)?c(""):x("Failed to load profile from magnet (no peers or invalid data)")}catch(j){x(j?.message||"Failed to add contact")}finally{d(!1)}}};return e.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Friends & Contacts"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Manage your network. Add new contacts with just their profile magnet link."})]}),e.jsxs("form",{onSubmit:y,className:"flex flex-col sm:flex-row gap-2 w-full md:w-auto",children:[e.jsx("input",{type:"text",value:i,onChange:p=>c(p.target.value),placeholder:"magnet:?xt=... (profile)",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm",disabled:l}),e.jsxs("select",{value:g,onChange:p=>m(p.target.value),className:"px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm",disabled:l,"aria-label":"Relationship type",children:[e.jsx("option",{value:"friend",children:"Friend"}),e.jsx("option",{value:"ring-of-trust",children:"Ring of Trust"}),e.jsx("option",{value:"acquaintance",children:"Acquaintance"}),e.jsx("option",{value:"group-member",children:"Group Member"})]}),e.jsx("button",{type:"submit",disabled:l||!i.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-md text-sm",children:l?"Adding…":"Add"})]})]}),u&&e.jsx("div",{className:"mb-4 p-3 rounded bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 text-sm",children:u}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto",children:e.jsx("nav",{className:"flex space-x-6 min-w-max",children:ft.map(p=>e.jsxs("button",{onClick:()=>o(p.id),className:`py-2 px-1 border-b-2 text-sm font-medium transition-colors flex items-center gap-1 ${n===p.id?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"}`,children:[e.jsx("span",{children:p.icon}),p.label,e.jsx("span",{className:"ml-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-full px-2 py-0.5 text-[10px]",children:p.id==="all"?t.length:t.filter(j=>j.relationship===p.id).length})]},p.id))})}),e.jsx("div",{className:"space-y-4",children:f.length===0?e.jsxs("div",{className:"text-center py-16 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg",children:[e.jsx("div",{className:"text-5xl mb-4",children:"📭"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-2 text-sm",children:"No contacts in this category yet."}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:"Add one with a profile magnet link above."})]}):f.map(p=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center gap-4",children:[e.jsx(D,{to:`/contact/${p.id}`,className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold overflow-hidden focus:ring-2 focus:ring-blue-500",children:p.avatar?e.jsx("img",{src:p.avatar,alt:p.displayName,className:"w-12 h-12 rounded-full object-cover"}):p.displayName.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(D,{to:`/contact/${p.id}`,className:"flex flex-wrap items-center gap-2 group",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white truncate group-hover:underline",children:p.displayName}),e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:["@",p.username]}),e.jsx(ht,{rel:p.relationship}),p.postIndexMagnetUri&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300",children:"posts"})]}),e.jsxs("div",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:["Trust ",p.trustLevel,"/10 • Added ",new Date(p.addedDate).toLocaleDateString()]})]}),e.jsx("button",{onClick:()=>s(p.id),className:"text-xs px-3 py-1 bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 rounded",children:"Remove"})]},p.id))})]})},ht=({rel:a})=>{const t={friend:"bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300","ring-of-trust":"bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300",acquaintance:"bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300","group-member":"bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300"};return e.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium ${t[a]}`,children:a.replace("-"," ")})},pt=()=>{const{id:a}=Se(),{contacts:t,loadContacts:r}=V(),{posts:s,loadPostsFromContacts:n}=I(),o=I(u=>u.syncPostsForContact),[i,c]=h.useState(!1),[l,d]=h.useState("");h.useEffect(()=>{r()},[r]),h.useEffect(()=>{n()},[n]);const g=t.find(u=>u.id===a),m=h.useMemo(()=>g?s.filter(u=>u.author===g.username).sort((u,x)=>new Date(x.createdAt).getTime()-new Date(u.createdAt).getTime()).slice(0,50):[],[s,g]);return g?e.jsxs("div",{className:"max-w-4xl mx-auto p-6 space-y-8",children:[e.jsxs("div",{className:"flex items-start gap-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow",children:[e.jsx("div",{className:"w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-semibold overflow-hidden",children:g.avatar?e.jsx("img",{src:g.avatar,alt:g.displayName,className:"w-24 h-24 object-cover"}):g.displayName.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:g.displayName}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm mb-2",children:[e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["@",g.username]}),g.postIndexMagnetUri&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300",children:"posts"}),e.jsxs("span",{className:"text-[10px] px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200",children:["Trust ",g.trustLevel,"/10"]}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300",children:g.relationship})]}),e.jsxs("div",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Added ",new Date(g.addedDate).toLocaleDateString()," • ",g.magnetUri.slice(0,42),"…"]}),g.notes&&g.notes.trim()&&e.jsx("p",{className:"mt-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line",children:g.notes})]}),e.jsxs("div",{className:"flex flex-col gap-2 items-end",children:[g.postIndexMagnetUri&&e.jsx("span",{className:"text-xs text-green-600 dark:text-green-400",children:"Index ready"}),e.jsx("button",{disabled:i||!g.postIndexMagnetUri,onClick:async()=>{if(!g.postIndexMagnetUri)return;c(!0),d("Syncing…");const u=performance.now();try{await o(g.id,{maxPosts:g.syncMaxPosts,monthsLookback:g.syncMonthsLookback});const x=(performance.now()-u)/1e3;d(`Synced in ${x.toFixed(1)}s`)}catch(x){d(x?.message||"Sync failed")}finally{c(!1),setTimeout(()=>d(""),5e3)}},className:"px-3 py-1.5 text-xs rounded bg-blue-600 disabled:bg-gray-400 hover:bg-blue-700 text-white font-medium shadow",children:i?"Syncing…":"Sync Contact"}),l&&e.jsx("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:l})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4",children:"Recent Posts"}),m.length===0?e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 text-center",children:"No posts downloaded yet. Sync will populate as posts arrive."}):e.jsx("div",{className:"space-y-4",children:m.map(u=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:new Date(u.createdAt).toLocaleString()}),u.signatureVerified?e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700",children:"ver"}):e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-semibold bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700",title:u.signatureError||"unverified",children:"unv"}),u.magnetUri&&e.jsx("button",{onClick:()=>navigator.clipboard.writeText(u.magnetUri),className:"text-blue-600 dark:text-blue-400 hover:underline",children:"🧲"})]})}),e.jsx("p",{className:"text-sm text-gray-900 dark:text-gray-100 whitespace-pre-line mb-2",children:u.content}),u.images&&u.images.length>0&&e.jsx("div",{className:"grid gap-2 grid-cols-2",children:u.images.map(x=>e.jsx("img",{src:T.base64ToDataUrl(x.data),className:"w-full h-40 object-cover rounded",alt:x.filename},x.id))})]},u.id))})]}),e.jsx("div",{className:"text-center pt-8",children:e.jsx(D,{to:"/network",className:"text-sm text-blue-600 dark:text-blue-400 hover:underline",children:"← Back to Network"})})]}):e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center",children:[e.jsx("h1",{className:"text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Contact not found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"The contact you are looking for does not exist or has been removed."}),e.jsx(D,{to:"/network",className:"text-blue-600 dark:text-blue-400 hover:underline text-sm",children:"Back to Network"})]})})},bt=()=>e.jsx("div",{className:"sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/75 dark:supports-[backdrop-filter]:bg-gray-900/75 bg-white/90 dark:bg-gray-800/90 border-b border-gray-200 dark:border-gray-700 shadow-sm",children:e.jsxs("nav",{children:[e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"flex justify-between items-center h-16",children:[e.jsx(D,{to:"/",className:"text-xl font-bold text-gray-900 dark:text-white",children:"SnartNet"}),e.jsxs("div",{className:"flex space-x-4 items-center",children:[e.jsx(D,{to:"/",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Home"}),e.jsx(D,{to:"/profile",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Profile"}),e.jsx(D,{to:"/discover",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Discover"}),e.jsx(D,{to:"/network",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Network"}),e.jsx(D,{to:"/messages",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Messages"})]})]})}),e.jsx("div",{className:"bg-red-600/90 text-white text-center text-xs py-1 tracking-wide font-medium",children:"Development version – expect things to break & data to reset"})]})}),yt=()=>{const[a,t]=h.useState({transport:"initializing",peers:0,received:0,published:0}),[r,s]=h.useState(!1);return h.useEffect(()=>{const n=setInterval(()=>{const o=window,i=o.snartnetLibp2p,c=o.__sn_head_sig_cache?.length||0;o.lastPublishedHeadUpdate&&!o.__sn_head_published_count&&(o.__sn_head_published_count=1);const l=o.__sn_head_published_count||0;t({transport:i?"libp2p":"in-memory",peers:i?.getPeers?i.getPeers().length:i?.getConnections?i.getConnections().length:0,received:c,published:l})},2e3);return()=>clearInterval(n)},[]),e.jsxs("div",{className:"fixed bottom-1 right-1 text-[11px] bg-black/70 text-white px-2 py-1 rounded shadow z-50 select-none",children:[e.jsxs("div",{className:"flex gap-2 items-center cursor-pointer",onClick:()=>s(n=>!n),children:[e.jsxs("span",{children:["Push: ",a.transport]}),e.jsxs("span",{children:["| Peers: ",a.peers]}),e.jsxs("span",{children:["| Rx: ",a.received]}),e.jsxs("span",{children:["| Tx: ",a.published]}),e.jsx("span",{children:r?"▾":"▸"})]}),r&&e.jsxs("div",{className:"mt-1 max-w-[260px] leading-tight space-y-0.5",children:[e.jsxs("div",{children:["Transport: ",a.transport]}),e.jsxs("div",{children:["Peers: ",a.peers]}),e.jsxs("div",{children:["Head Updates Received (unique sigs): ",a.received]}),e.jsxs("div",{children:["Head Updates Published: ",a.published]}),e.jsx("div",{className:"opacity-60",children:"Click to collapse"})]})]})},wt="0.1.0",vt=({children:a})=>e.jsxs("div",{className:"min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900",children:[e.jsx(bt,{}),e.jsx("main",{className:"container mx-auto px-4 py-8 flex-1 w-full",children:a}),e.jsxs("footer",{className:"border-t border-gray-200 dark:border-gray-700 py-4 text-center text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:["SnartNet v",wt]}),e.jsx("span",{className:"mx-2",children:"•"}),e.jsx("span",{children:"Development build"})]}),e.jsx(yt,{})]});function kt(){const{setCurrentProfile:a,setLoading:t,setError:r}=U();h.useEffect(()=>{let s=!0;return(async()=>{try{t(!0),r(null),console.log("[useInitializeCore] Initializing core...");const o=await M();if(console.log("[useInitializeCore] Core initialized successfully"),console.log("[useInitializeCore] Initializing torrent service..."),C(),console.log("[useInitializeCore] Torrent service initialized."),o.hasProfile()){console.log("[useInitializeCore] Found existing profile, loading...");const i=await o.getCurrentProfile();i&&s&&(console.log("[useInitializeCore] Loaded existing profile:",i),a(i))}else console.log("[useInitializeCore] No existing profile found")}catch(o){if(console.error("[useInitializeCore] Failed to initialize core:",o),s){const i=o instanceof Error?o.message:"Failed to initialize";r(i)}}finally{s&&t(!1)}})(),()=>{s=!1}},[a,t,r])}function jt(){return kt(),e.jsx(Pe,{basename:"/net",children:e.jsx(vt,{children:e.jsxs(Ce,{children:[e.jsx(J,{path:"/",element:e.jsx(tt,{})}),e.jsx(J,{path:"/profile/:id?",element:e.jsx(dt,{})}),e.jsx(J,{path:"/discover",element:e.jsx(mt,{})}),e.jsx(J,{path:"/network",element:e.jsx(xt,{})}),e.jsx(J,{path:"/contact/:id",element:e.jsx(pt,{})}),e.jsx(J,{path:"/messages/:id?",element:e.jsx(gt,{})})]})})})}function _t(a={}){const{immediate:t=!1,onNeedRefresh:r,onOfflineReady:s,onRegistered:n,onRegisteredSW:o,onRegisterError:i}=a;let c,l;const d=async(m=!0)=>{await l};async function g(){if("serviceWorker"in navigator){if(c=await Q(async()=>{const{Workbox:m}=await import("./vendor-DX1wVttl.js").then(u=>u.w);return{Workbox:m}},[]).then(({Workbox:m})=>new m("/net/sw.js",{scope:"/net/",type:"classic"})).catch(m=>{i?.(m)}),!c)return;c.addEventListener("activated",m=>{(m.isUpdate||m.isExternal)&&window.location.reload()}),c.addEventListener("installed",m=>{m.isUpdate||s?.()}),c.register({immediate:t}).then(m=>{o?o("/net/sw.js",m):n?.(m)}).catch(m=>{i?.(m)})}}return l=g(),d}const Nt=_t({immediate:!0,onNeedRefresh(){Nt(!0)},onOfflineReady(){},onRegisteredSW(a,t){t&&typeof t.update=="function"?setInterval(()=>{t.update()},30*60*1e3):navigator.serviceWorker.controller&&fetch(a).catch(()=>{})}});Ee(document.getElementById("root")).render(e.jsx(h.StrictMode,{children:e.jsx(jt,{})}));
//# sourceMappingURL=index-CPumIdK5.js.map
