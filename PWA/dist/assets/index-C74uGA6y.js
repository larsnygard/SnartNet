import{r as p,c as de,j as e,L as D,u as Se,B as Pe,R as Ce,a as J,b as Ee}from"./vendor-DX1wVttl.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let b,k=0,q=null;function H(){return(q===null||q.byteLength===0)&&(q=new Uint8Array(b.memory.buffer)),q}const Y=new TextEncoder;"encodeInto"in Y||(Y.encodeInto=function(s,t){const r=Y.encode(s);return t.set(r),{read:s.length,written:r.length}});function N(s,t,r){if(r===void 0){const c=Y.encode(s),i=t(c.length,1)>>>0;return H().subarray(i,i+c.length).set(c),k=c.length,i}let a=s.length,n=t(a,1)>>>0;const o=H();let l=0;for(;l<a;l++){const c=s.charCodeAt(l);if(c>127)break;o[n+l]=c}if(l!==a){l!==0&&(s=s.slice(l)),n=r(n,a,a=l+s.length*3,1)>>>0;const c=H().subarray(n+l,n+a),i=Y.encodeInto(s,c);l+=i.written,n=r(n,a,l,1)>>>0}return k=l,n}let W=null;function L(){return(W===null||W.buffer.detached===!0||W.buffer.detached===void 0&&W.buffer!==b.memory.buffer)&&(W=new DataView(b.memory.buffer)),W}function K(s){const t=b.__externref_table_alloc();return b.__wbindgen_export_4.set(t,s),t}function R(s,t){try{return s.apply(this,t)}catch(r){const a=K(r);b.__wbindgen_exn_store(a)}}let Z=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});Z.decode();const Ie=2146435072;let te=0;function Te(s,t){return te+=t,te>=Ie&&(Z=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),Z.decode(),te=t),Z.decode(H().subarray(s,s+t))}function F(s,t){return s=s>>>0,Te(s,t)}function A(s){return s==null}function re(s,t){return s=s>>>0,H().subarray(s/1,s/1+t)}function S(s){const t=b.__wbindgen_export_4.get(s);return b.__externref_table_dealloc(s),t}function Ae(){const s=b.generate_keypair();if(s[2])throw S(s[1]);return S(s[0])}function Ue(s,t){let r,a;try{const l=N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),c=k,i=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),d=k,g=b.sign_data(l,c,i,d);var n=g[0],o=g[1];if(g[3])throw n=0,o=0,S(g[2]);return r=n,a=o,F(n,o)}finally{b.__wbindgen_free(r,a,1)}}function Fe(s,t,r){const a=N(s,b.__wbindgen_malloc,b.__wbindgen_realloc),n=k,o=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),l=k,c=N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),i=k,d=b.verify_signature_wasm(a,n,o,l,c,i);if(d[2])throw S(d[1]);return d[0]!==0}function Re(s,t){const r=t(s.length*4,4)>>>0;for(let a=0;a<s.length;a++){const n=K(s[a]);L().setUint32(r+4*a,n,!0)}return k=s.length,r}function De(){const s=b.init_core();if(s[1])throw S(s[0])}const fe=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(s=>b.__wbg_snartnetcore_free(s>>>0,1));let le=class{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,fe.unregister(this),t}free(){const t=this.__destroy_into_raw();b.__wbg_snartnetcore_free(t,0)}constructor(){const t=b.snartnetcore_new();return this.__wbg_ptr=t>>>0,fe.register(this,this.__wbg_ptr,this),this}init(){const t=b.snartnetcore_init(this.__wbg_ptr);if(t[1])throw S(t[0])}create_profile(t,r,a){let n,o;try{const u=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),x=k;var l=A(r)?0:N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),c=k,i=A(a)?0:N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),d=k;const f=b.snartnetcore_create_profile(this.__wbg_ptr,u,x,l,c,i,d);var g=f[0],m=f[1];if(f[3])throw g=0,m=0,S(f[2]);return n=g,o=m,F(g,m)}finally{b.__wbindgen_free(n,o,1)}}get_current_profile(){const t=b.snartnetcore_get_current_profile(this.__wbg_ptr);if(t[2])throw S(t[1]);return S(t[0])}update_current_profile(t,r){var a=A(t)?0:N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),n=k,o=A(r)?0:N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),l=k;const c=b.snartnetcore_update_current_profile(this.__wbg_ptr,a,n,o,l);if(c[1])throw S(c[0])}create_post(t,r,a){const n=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),o=k;var l=A(r)?0:Re(r,b.__wbindgen_malloc),c=k,i=A(a)?0:N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),d=k;const g=b.snartnetcore_create_post(this.__wbg_ptr,n,o,l,c,i,d);if(g[2])throw S(g[1]);return S(g[0])}create_message(t,r){const a=N(t,b.__wbindgen_malloc,b.__wbindgen_realloc),n=k,o=N(r,b.__wbindgen_malloc,b.__wbindgen_realloc),l=k,c=b.snartnetcore_create_message(this.__wbg_ptr,a,n,o,l);if(c[2])throw S(c[1]);return S(c[0])}get_public_key(){let t,r;try{const o=b.snartnetcore_get_public_key(this.__wbg_ptr);var a=o[0],n=o[1];if(o[3])throw a=0,n=0,S(o[2]);return t=a,r=n,F(a,n)}finally{b.__wbindgen_free(t,r,1)}}get_fingerprint(){let t,r;try{const o=b.snartnetcore_get_fingerprint(this.__wbg_ptr);var a=o[0],n=o[1];if(o[3])throw a=0,n=0,S(o[2]);return t=a,r=n,F(a,n)}finally{b.__wbindgen_free(t,r,1)}}has_profile(){return b.snartnetcore_has_profile(this.__wbg_ptr)!==0}};Symbol.dispose&&(le.prototype[Symbol.dispose]=le.prototype.free);const Me=new Set(["basic","cors","default"]);async function Oe(s,t){if(typeof Response=="function"&&s instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(s,t)}catch(a){if(s.ok&&Me.has(s.type)&&s.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",a);else throw a}const r=await s.arrayBuffer();return await WebAssembly.instantiate(r,t)}else{const r=await WebAssembly.instantiate(s,t);return r instanceof WebAssembly.Instance?{instance:r,module:s}:r}}function Le(){const s={};return s.wbg={},s.wbg.__wbg_String_8f0eb39a4a4c2f66=function(t,r){const a=String(r),n=N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),o=k;L().setInt32(t+4*1,o,!0),L().setInt32(t+4*0,n,!0)},s.wbg.__wbg_call_13410aac570ffff7=function(){return R(function(t,r){return t.call(r)},arguments)},s.wbg.__wbg_call_a5400b25a865cfd8=function(){return R(function(t,r,a){return t.call(r,a)},arguments)},s.wbg.__wbg_crypto_574e78ad8b13b65f=function(t){return t.crypto},s.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,r){let a,n;try{a=t,n=r,console.error(F(t,r))}finally{b.__wbindgen_free(a,n,1)}},s.wbg.__wbg_getItem_9fc74b31b896f95a=function(){return R(function(t,r,a,n){const o=r.getItem(F(a,n));var l=A(o)?0:N(o,b.__wbindgen_malloc,b.__wbindgen_realloc),c=k;L().setInt32(t+4*1,c,!0),L().setInt32(t+4*0,l,!0)},arguments)},s.wbg.__wbg_getRandomValues_38a1ff1ea09f6cc7=function(){return R(function(t,r){globalThis.crypto.getRandomValues(re(t,r))},arguments)},s.wbg.__wbg_getRandomValues_b8f5dbd5f3995a9e=function(){return R(function(t,r){t.getRandomValues(r)},arguments)},s.wbg.__wbg_getTime_6bb3f64e0f18f817=function(t){return t.getTime()},s.wbg.__wbg_instanceof_Window_12d20d558ef92592=function(t){let r;try{r=t instanceof Window}catch{r=!1}return r},s.wbg.__wbg_length_6bb7e81f9d7713e4=function(t){return t.length},s.wbg.__wbg_localStorage_9330af8bf39365ba=function(){return R(function(t){const r=t.localStorage;return A(r)?0:K(r)},arguments)},s.wbg.__wbg_log_6c7b5f4f00b8ce3f=function(t){console.log(t)},s.wbg.__wbg_msCrypto_a61aeb35a24c1329=function(t){return t.msCrypto},s.wbg.__wbg_new0_b0a0a38c201e6df5=function(){return new Date},s.wbg.__wbg_new_19c25a3f2fa63a02=function(){return new Object},s.wbg.__wbg_new_1f3a344cf3123716=function(){return new Array},s.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},s.wbg.__wbg_newnoargs_254190557c45b4ec=function(t,r){return new Function(F(t,r))},s.wbg.__wbg_newwithlength_a167dcc7aaa3ba77=function(t){return new Uint8Array(t>>>0)},s.wbg.__wbg_node_905d3e251edff8a2=function(t){return t.node},s.wbg.__wbg_process_dc0fbacc7c1c06f7=function(t){return t.process},s.wbg.__wbg_prototypesetcall_3d4a26c1ed734349=function(t,r,a){Uint8Array.prototype.set.call(re(t,r),a)},s.wbg.__wbg_randomFillSync_ac0988aba3254290=function(){return R(function(t,r){t.randomFillSync(r)},arguments)},s.wbg.__wbg_removeItem_487c5a070c7adaf7=function(){return R(function(t,r,a){t.removeItem(F(r,a))},arguments)},s.wbg.__wbg_require_60cc747a6bc5215a=function(){return R(function(){return module.require},arguments)},s.wbg.__wbg_setItem_7add5eb06a28b38f=function(){return R(function(t,r,a,n,o){t.setItem(F(r,a),F(n,o))},arguments)},s.wbg.__wbg_set_3f1d0b984ed272ed=function(t,r,a){t[r]=a},s.wbg.__wbg_set_90f6c0f7bd8c0415=function(t,r,a){t[r>>>0]=a},s.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,r){const a=r.stack,n=N(a,b.__wbindgen_malloc,b.__wbindgen_realloc),o=k;L().setInt32(t+4*1,o,!0),L().setInt32(t+4*0,n,!0)},s.wbg.__wbg_static_accessor_GLOBAL_8921f820c2ce3f12=function(){const t=typeof globalThis>"u"?null:globalThis;return A(t)?0:K(t)},s.wbg.__wbg_static_accessor_GLOBAL_THIS_f0a4409105898184=function(){const t=typeof globalThis>"u"?null:globalThis;return A(t)?0:K(t)},s.wbg.__wbg_static_accessor_SELF_995b214ae681ff99=function(){const t=typeof self>"u"?null:self;return A(t)?0:K(t)},s.wbg.__wbg_static_accessor_WINDOW_cde3890479c675ea=function(){const t=typeof window>"u"?null:window;return A(t)?0:K(t)},s.wbg.__wbg_subarray_70fd07feefe14294=function(t,r,a){return t.subarray(r>>>0,a>>>0)},s.wbg.__wbg_versions_c01dfd4722a88165=function(t){return t.versions},s.wbg.__wbg_wbindgenisfunction_8cee7dce3725ae74=function(t){return typeof t=="function"},s.wbg.__wbg_wbindgenisobject_307a53c6bd97fbf8=function(t){const r=t;return typeof r=="object"&&r!==null},s.wbg.__wbg_wbindgenisstring_d4fa939789f003b0=function(t){return typeof t=="string"},s.wbg.__wbg_wbindgenisundefined_c4b71d073b92f3c5=function(t){return t===void 0},s.wbg.__wbg_wbindgenstringget_0f16a6ddddef376f=function(t,r){const a=r,n=typeof a=="string"?a:void 0;var o=A(n)?0:N(n,b.__wbindgen_malloc,b.__wbindgen_realloc),l=k;L().setInt32(t+4*1,l,!0),L().setInt32(t+4*0,o,!0)},s.wbg.__wbg_wbindgenthrow_451ec1a8469d7eb6=function(t,r){throw new Error(F(t,r))},s.wbg.__wbindgen_cast_2241b6af4c4b2941=function(t,r){return F(t,r)},s.wbg.__wbindgen_cast_cb9088102bce6b30=function(t,r){return re(t,r)},s.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(t){return t},s.wbg.__wbindgen_init_externref_table=function(){const t=b.__wbindgen_export_4,r=t.grow(4);t.set(0,void 0),t.set(r+0,void 0),t.set(r+1,null),t.set(r+2,!0),t.set(r+3,!1)},s}function $e(s,t){return b=s.exports,ge.__wbindgen_wasm_module=t,W=null,q=null,b.__wbindgen_start(),b}async function ge(s){if(b!==void 0)return b;typeof s<"u"&&(Object.getPrototypeOf(s)===Object.prototype?{module_or_path:s}=s:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof s>"u"&&(s=new URL("/net/assets/snartnet_core_bg-CgG932GT.wasm",import.meta.url));const t=Le();(typeof s=="string"||typeof Request=="function"&&s instanceof Request||typeof URL=="function"&&s instanceof URL)&&(s=fetch(s));const{instance:r,module:a}=await Oe(await s,t);return $e(r,a)}class ke{client=null;activeTorrents=new Map;eventCallbacks=[];readyPromise;resolveReady;clientReady=!1;pendingSeeds=[];stats={torrents:0,downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0,peers:0};constructor(){this.readyPromise=new Promise(t=>{this.resolveReady=t}),this.initializeClient()}async initializeClient(){if(typeof window>"u")return;let t=0;const r=10,a=()=>{t++;const n=window.WebTorrent;if(!n||typeof n!="function")if(t<r){console.warn(`[TorrentService] WebTorrent not available yet (attempt ${t}), retrying...`),setTimeout(a,500);return}else{const o=new Error("WebTorrent not available after retries");console.error("[TorrentService] ",o),this.emitEvent({type:"error",error:o.message});return}try{this.client=new n,this.clientReady=!0,this.client.on("error",l=>{console.error("[TorrentService] Client error:",l),this.emitEvent({type:"error",error:l.message})}),this.client.on("torrent",l=>{console.log("[TorrentService] Torrent added:",{name:l.name,infoHash:l.infoHash}),this.activeTorrents.set(l.infoHash,l),this.emitEvent({type:"torrent-added",torrent:l}),this.updateStats()}),console.log("[TorrentService] WebTorrent client initialized successfully"),this.resolveReady();const o=[...this.pendingSeeds];this.pendingSeeds=[],o.forEach(l=>{try{l()}catch(c){console.error("[TorrentService] Pending seed failed:",c)}})}catch(o){console.error("[TorrentService] Failed to initialize:",o),this.emitEvent({type:"error",error:String(o)})}};a()}emitEvent(t){this.eventCallbacks.forEach(r=>{try{r(t)}catch(a){console.error("Error in event callback:",a)}})}updateStats(){if(this.client)try{this.stats={torrents:this.client.torrents.length,downloadSpeed:this.client.downloadSpeed||0,uploadSpeed:this.client.uploadSpeed||0,downloaded:this.client.downloaded||0,uploaded:this.client.uploaded||0,peers:this.client.torrents.reduce((t,r)=>t+(r.numPeers||0),0)}}catch(t){console.error("Error updating stats:",t)}}async seedProfile(t){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized. Are you in a browser environment?");try{const r=JSON.stringify(t,null,2),a=`${t.username}_profile.json`,o=new TextEncoder().encode(r),l=new File([o],a,{type:"application/json; charset=utf-8"});return new Promise((c,i)=>{const d=setTimeout(()=>{i(new Error("Seeding timeout"))},1e4);try{console.log("Seeding profile file:",{fileName:a,fileSize:l.size,fileType:l.type,profileDataLength:r.length});const g=this.client.seed([l],m=>{clearTimeout(d),console.log("Profile seeded successfully:",m.magnetURI),this.emitEvent({type:"seeding-started",profile:t,magnetURI:m.magnetURI}),c(m.magnetURI)});g.on("error",m=>{clearTimeout(d),this.emitEvent({type:"error",error:m.message}),i(m)}),g.on("wire",m=>{this.emitEvent({type:"peer-connected",peerId:m.peerId||"unknown"})}),g.on("upload",()=>{this.emitEvent({type:"upload-progress",uploadSpeed:g.uploadSpeed||0}),this.updateStats()})}catch(g){clearTimeout(d),i(g)}})}catch(r){throw console.error("Error seeding profile:",r),r}}ensureReadyAction(t){this.clientReady?t():(console.log("[TorrentService] Client not ready, queuing action"),this.pendingSeeds.push(t))}async seedPost(t){if(await this.readyPromise,!this.client||!this.clientReady)throw new Error("WebTorrent client not ready for seeding");const r=performance.now();console.log("[TorrentService] Seeding post start",{author:t.author,hasImages:!!t.images?.length,signed:!!t.signature});const a=JSON.stringify(t,null,2),n=`post_${Date.now()}.json`,o=new TextEncoder().encode(a),l=new File([o],n,{type:"application/json; charset=utf-8"});return new Promise((c,i)=>{let d=!1;const g=()=>{try{const m=this.client.seed([l],u=>{d=!0;const x=(performance.now()-r).toFixed(0);console.log("[TorrentService] Post torrent ready",{infoHash:u.infoHash,magnet:u.magnetURI,durationMs:x}),this.emitEvent({type:"seeding-started",post:t,magnetURI:u.magnetURI}),c(u.magnetURI)});m.on("error",u=>{d?console.warn("[TorrentService] Torrent error after ready:",u):(console.error("[TorrentService] Torrent error before ready:",u),i(u))}),m.on("wire",u=>{this.emitEvent({type:"peer-connected",peerId:u.peerId||"unknown"})})}catch(m){console.error("[TorrentService] Seed action failed synchronously:",m),i(m)}};this.ensureReadyAction(g),setTimeout(()=>{d||i(new Error("Seeding post timed out"))},15e3)})}async seedPostIndex(t,r,a){if(await this.readyPromise,!this.client||!this.clientReady)throw new Error("WebTorrent client not ready for seeding index");const n=a?.chunkSize||200,o=t.slice().sort((d,g)=>new Date(g.createdAt).getTime()-new Date(d.createdAt).getTime()).slice(0,n),l={version:1,author:r,generatedAt:new Date().toISOString(),posts:o.map(d=>({id:d.id,magnetUri:d.magnetUri||"",author:d.author,createdAt:d.createdAt,tags:d.tags})),next:a?.previousHeadMagnet||null,count:o.length},c=JSON.stringify(l,null,2),i=new File([new TextEncoder().encode(c)],`post_index_${Date.now()}.json`,{type:"application/json; charset=utf-8"});return new Promise((d,g)=>{try{this.client.seed([i],u=>{this.emitEvent({type:"post-index-seeded",magnetURI:u.magnetURI,count:l.count}),d({magnetURI:u.magnetURI,count:l.count})}).on("error",u=>g(u))}catch(m){g(m)}})}async downloadPostIndexChain(t,r={}){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized");const a=r.maxPosts??500,n=r.maxChunks??20;let o=null;if(r.since)o=new Date(r.since).getTime();else if(r.monthsLookback){const m=new Date;m.setMonth(m.getMonth()-r.monthsLookback),o=m.getTime()}const l=[];let c=t,i=0,d=!1,g=null;for(;c&&i<n&&l.length<a;){if(r.signal?.aborted)throw new Error("Aborted");const{indexData:m,next:u}=await this.downloadSingleIndex(c);i++,this.emitEvent({type:"post-index-downloaded",magnetURI:c,count:m.count});for(const x of m.posts){if(l.length>=a){d=!0;break}if(o){const f=new Date(x.createdAt).getTime();if(isNaN(f))continue;if(f<o){d=!0;break}}l.push(x)}if(d)break;c=u,g=u}return{entries:l,truncated:d,chunksFetched:i,nextPointer:g}}async downloadSingleIndex(t){return new Promise((r,a)=>{try{const n=this.client.add(t,()=>{}),o=setTimeout(()=>a(new Error("Index download timeout")),2e4);n.on("done",()=>{clearTimeout(o);const l=n.files.find(c=>c.name&&c.name.startsWith("post_index_"));if(!l)return a(new Error("Index file not found in torrent"));l.getBuffer((c,i)=>{if(c)return a(c);try{let d;i instanceof ArrayBuffer?d=new TextDecoder("utf-8").decode(new Uint8Array(i)):i&&typeof i.toString=="function"?d=i.toString("utf8"):d=String(i);const g=JSON.parse(d);if(g.version!==1)return a(new Error("Unsupported index version"));r({indexData:g,next:g.next||null})}catch(d){a(d)}})}),n.on("error",l=>a(l))}catch(n){a(n)}})}async downloadProfile(t){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized. Are you in a browser environment?");try{return new Promise((r,a)=>{const n=setTimeout(()=>{a(new Error("Download timeout - no peers found"))},3e4);try{const o=this.client.add(t,l=>{console.log("Started downloading torrent:",l.name||"unnamed")});o.on("done",()=>{clearTimeout(n);const l=o.files.find(c=>c.name&&c.name.endsWith("_profile.json"));if(l)l.getBuffer((c,i)=>{if(c){this.emitEvent({type:"error",error:c.message}),a(c);return}try{let d;if(i instanceof ArrayBuffer){const m=new Uint8Array(i);d=new TextDecoder("utf-8",{fatal:!1}).decode(m)}else i&&typeof i.toString=="function"?d=i.toString("utf8"):d=String(i);const g=JSON.parse(d);this.emitEvent({type:"profile-downloaded",profile:g}),r(g)}catch(d){console.error("Profile parsing error:",d),console.error("Buffer type:",typeof i),console.error("Buffer constructor:",i?.constructor?.name),this.emitEvent({type:"error",error:`Failed to parse profile data: ${d instanceof Error?d.message:"Unknown error"}`}),a(d)}});else{const c="Profile file not found in torrent";this.emitEvent({type:"error",error:c}),a(new Error(c))}}),o.on("download",()=>{this.emitEvent({type:"download-progress",progress:o.progress||0,downloadSpeed:o.downloadSpeed||0}),this.updateStats()}),o.on("error",l=>{clearTimeout(n),this.emitEvent({type:"error",error:l.message}),a(l)})}catch(o){clearTimeout(n),a(o)}})}catch(r){throw console.error("Error downloading profile:",r),r}}async downloadPost(t){if(await this.readyPromise,!this.client)throw new Error("WebTorrent client not initialized");return new Promise((r,a)=>{try{const n=this.client.add(t,()=>{}),o=setTimeout(()=>a(new Error("Post download timeout")),2e4);n.on("done",()=>{clearTimeout(o);const l=n.files.find(c=>c.name&&c.name.startsWith("post_")&&c.name.endsWith(".json"));if(!l)return a(new Error("Post JSON file not found in torrent"));l.getBuffer((c,i)=>{if(c)return a(c);try{let d;i instanceof ArrayBuffer?d=new TextDecoder("utf-8").decode(new Uint8Array(i)):i&&typeof i.toString=="function"?d=i.toString("utf8"):d=String(i);const g=JSON.parse(d);r(g)}catch(d){a(d)}})}),n.on("error",l=>a(l))}catch(n){a(n)}})}getStats(){return this.updateStats(),{...this.stats}}getActiveTorrents(){if(!this.client)return[];try{return this.client.torrents.map(t=>({infoHash:t.infoHash||"",name:t.name||"Unnamed Torrent",magnetURI:t.magnetURI||"",progress:t.progress||0,downloadSpeed:t.downloadSpeed||0,uploadSpeed:t.uploadSpeed||0,numPeers:t.numPeers||0,downloaded:t.downloaded||0,uploaded:t.uploaded||0}))}catch(t){return console.error("Error getting active torrents:",t),[]}}onEvent(t){return this.eventCallbacks.push(t),()=>{const r=this.eventCallbacks.indexOf(t);r>-1&&this.eventCallbacks.splice(r,1)}}stopSeeding(t){if(!this.client)return!1;try{const r=this.client.get(t);return r?(this.client.remove(r),this.activeTorrents.delete(t),this.updateStats(),!0):!1}catch(r){return console.error("Error stopping torrent seeding:",r),!1}}destroy(){try{this.client&&typeof this.client.destroy=="function"&&this.client.destroy()}catch(t){console.error("Error destroying torrent client:",t)}}}let ae=null;function C(){return ae||(ae=new ke),ae}const Be=Object.freeze(Object.defineProperty({__proto__:null,TorrentService:ke,getTorrentService:C},Symbol.toStringTag,{value:"Module"}));function z(s){return s?{id:s.id,username:s.username,displayName:s.display_name||s.displayName||void 0,bio:s.bio||void 0,avatarHash:s.avatar_hash||s.avatarHash||void 0,publicKey:s.public_key||s.publicKey,fingerprint:s.fingerprint,createdAt:typeof s.created_at=="string"?s.created_at:s.createdAt,updatedAt:typeof s.updated_at=="string"?s.updated_at:s.updatedAt,version:s.version||1,magnetUri:s.magnet_uri||s.magnetUri||void 0,schemaVersion:1}:null}class ze{wasmCore;eventCallbacks=new Set;capabilities=null;constructor(t){this.wasmCore=t}async init(){try{await this.wasmCore.init(),console.log("[SnartNetCore] WASM core initialized")}catch(t){throw console.error("[SnartNetCore] Init error:",t),t}}async getCapabilities(){if(this.capabilities)return this.capabilities;let t={profileJsonApi:!1,postJsonApi:!1,messageJsonApi:!1,version:"0"};const r=this.wasmCore.get_capabilities;if(typeof r=="function")try{const a=r.call(this.wasmCore);if(a){let n=a;if(typeof a=="string")try{n=JSON.parse(a)}catch{}t={profileJsonApi:!!(n.profileJsonApi||n.profile_json_api),postJsonApi:!!(n.postJsonApi||n.post_json_api),messageJsonApi:!!(n.messageJsonApi||n.message_json_api),version:n.version?String(n.version):"0"}}}catch(a){console.warn("[Core] capability probe failed, using defaults",a)}return this.capabilities=t,t}async createProfile(t,r,a){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.create_profile_json){const o=JSON.stringify({username:t,displayName:r||null,bio:a||null}),l=this.wasmCore.create_profile_json(o),c=typeof l=="string"?JSON.parse(l):l,i=c.profile||c.profileJson||c,d=z(i);return d&&this.emitEvent({type:"ProfileLoaded",profile:d}),c.magnetUri||i.magnetUri||""}try{const o=this.wasmCore.create_profile(t,r||void 0,a||void 0),l=this.wasmCore.get_current_profile(),c=z(l);return c&&this.emitEvent({type:"ProfileLoaded",profile:c}),o}catch(o){const l=String(o?.message||o);console.error("[Core] legacy create_profile failed:",o);const c=this.wasmCore.create_profile_json;if(c)try{const i=JSON.stringify({username:t,displayName:r||null,bio:a||null}),d=c(i),g=typeof d=="string"?JSON.parse(d):d,m=g.profile||g.profileJson||g,u=z(m);return u&&this.emitEvent({type:"ProfileLoaded",profile:u}),g.magnetUri||m.magnetUri||""}catch(i){console.error("[Core] JSON fallback also failed:",i)}if(/memory access out of bounds/i.test(l)){console.warn("[Core] Detected possible corrupted WASM state; clearing persisted key/profile entries");try{localStorage.removeItem("snartnet_keypair"),localStorage.removeItem("snartnet_current_profile")}catch{}}throw o}}async getCurrentProfile(){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.get_current_profile_json){const a=this.wasmCore.get_current_profile_json();if(!a)return null;const n=typeof a=="string"?JSON.parse(a):a,o=n.profile||n.profileJson||n;return z(o)}const r=this.wasmCore.get_current_profile();return z(r)}async updateProfile(t,r){if((await this.getCapabilities()).profileJsonApi&&this.wasmCore.update_profile_json){const l=JSON.stringify({displayName:t||null,bio:r||null}),c=this.wasmCore.update_profile_json(l),i=typeof c=="string"?JSON.parse(c):c,d=i.profile||i.profileJson||i,g=z(d);g&&this.emitEvent({type:"ProfileUpdated",profile:g});return}await this.wasmCore.update_current_profile(t||void 0,r||void 0);const n=this.wasmCore.get_current_profile(),o=z(n);o&&this.emitEvent({type:"ProfileUpdated",profile:o})}async getPublicKey(){try{return this.wasmCore.get_public_key()}catch(t){throw console.error("[SnartNetCore] Get public key error:",t),t}}async getFingerprint(){try{return this.wasmCore.get_fingerprint()}catch(t){throw console.error("[SnartNetCore] Get fingerprint error:",t),t}}async createPost(t,r,a){try{const n=this.wasmCore.create_post(t,r||null,a||null);return console.log("[SnartNetCore] Post created:",n),this.emitEvent({type:"PostAdded",post:n}),n}catch(n){throw console.error("[SnartNetCore] Create post error:",n),n}}async createMessage(t,r){try{const a=this.wasmCore.create_message(t,r);return console.log("[SnartNetCore] Message created:",a),this.emitEvent({type:"MessageReceived",message:a}),a}catch(a){throw console.error("[SnartNetCore] Create message error:",a),a}}hasProfile(){return this.wasmCore.has_profile()}subscribeToEvents(t){return this.eventCallbacks.add(t),()=>this.eventCallbacks.delete(t)}emitEvent(t){this.eventCallbacks.forEach(r=>{try{r(t)}catch(a){console.error("[SnartNetCore] Error in event callback:",a)}})}async seedCurrentProfile(){try{const t=this.wasmCore.get_current_profile();if(!t)throw new Error("No current profile to seed");console.log("[SnartNetCore] Profile data type:",typeof t),console.log("[SnartNetCore] Profile data:",t);let r;typeof t=="object"&&t!==null?r=JSON.parse(JSON.stringify(t)):r=t,console.log("[SnartNetCore] Clean profile:",r);const a=C();try{const o=r.username||r.id;if(o){const l=localStorage.getItem(`profile-picture-${o}`),c=localStorage.getItem(`profile-picture-thumb-${o}`);l&&(r.profilePicture=l),c&&(r.profilePictureThumbnail=c);const i=localStorage.getItem(`profile-extended-${o}`);if(i)try{const d=JSON.parse(i);d&&typeof d=="object"&&(d.location&&(r.location=d.location),d.website&&(r.website=d.website),d.avatar&&(r.avatar=d.avatar))}catch{}}}catch(o){console.warn("[SnartNetCore] Failed merging extended profile data",o)}if(!r.postIndexMagnetUri&&!r.post_index_magnet)try{const o=await a.seedPostIndex([],r.username||r.id||"unknown",{});r.postIndexMagnetUri=o.magnetURI}catch(o){console.warn("[SnartNetCore] Failed to seed empty post index",o)}const n=await a.seedProfile(r);return console.log("[SnartNetCore] Profile seeding started:",n),n}catch(t){throw console.error("[SnartNetCore] Failed to seed profile:",t),t}}async downloadProfileFromMagnet(t){try{const a=await C().downloadProfile(t);return console.log("[SnartNetCore] Profile downloaded:",a),a}catch(r){throw console.error("[SnartNetCore] Failed to download profile:",r),r}}getTorrentStats(){return C().getStats()}getActiveTorrents(){return C().getActiveTorrents()}async stopSeeding(t){C().stopSeeding(t)}validateProfile(t){if(!t||typeof t!="object")return!1;for(const r of["id","username","publicKey","fingerprint","createdAt","updatedAt"])if(!(r in t))return!1;return!0}validatePost(t){return!!t&&typeof t=="object"&&"id"in t&&"author"in t}}let X=null;async function M(){if(!X)try{await ge(),await De();const s=new le;X=new ze(s),await X.init(),console.log("[Core] Initialized successfully")}catch(s){throw console.error("[Core] Initialization failed:",s),s}return X}function je(){const[s,t]=p.useState(null),[r,a]=p.useState(!0);return p.useEffect(()=>{M().then(n=>{t(n),a(!1)}).catch(n=>{console.error("Failed to initialize core:",n),a(!1)})},[]),{core:s,loading:r}}const We=Object.freeze(Object.defineProperty({__proto__:null,getCore:M,useCore:je},Symbol.toStringTag,{value:"Module"})),xe="snartnet:profile:seed-enabled",U=de(s=>({currentProfile:null,profiles:new Map,loading:!1,error:null,seedProfileEnabled:(()=>{const t=localStorage.getItem(xe);return t===null?!0:t==="true"})(),setCurrentProfile:t=>s({currentProfile:t}),addProfile:t=>s(r=>{const a=new Map(r.profiles);return a.set(t.username,t),{profiles:a}}),updateProfile:(t,r)=>s(a=>{const n=new Map(a.profiles),o=n.get(t);o&&n.set(t,{...o,...r});let l=a.currentProfile;return a.currentProfile?.username===t&&(l={...a.currentProfile,...r}),{profiles:n,currentProfile:l}}),updateProfilePicture:(t,r,a)=>s(n=>{const o={profilePicture:r,profilePictureThumbnail:a||r,updatedAt:new Date().toISOString()},l=new Map(n.profiles),c=l.get(t);c&&l.set(t,{...c,...o});let i=n.currentProfile;return n.currentProfile?.username===t&&(i={...n.currentProfile,...o},localStorage.setItem(`profile-picture-${t}`,r),a&&localStorage.setItem(`profile-picture-thumb-${t}`,a)),i&&M().then(d=>{d.seedCurrentProfile().catch(g=>console.warn("Reseed after picture update failed",g))}).catch(()=>{}),{profiles:l,currentProfile:i}}),setSeedProfileEnabled:t=>s(()=>{try{localStorage.setItem(xe,String(t))}catch{}return{seedProfileEnabled:t}}),setLoading:t=>s({loading:t}),setError:t=>s({error:t}),clearError:()=>s({error:null})})),Ke=Object.freeze(Object.defineProperty({__proto__:null,useProfileStore:U},Symbol.toStringTag,{value:"Module"})),Je="modulepreload",Ve=function(s){return"/net/"+s},he={},Q=function(t,r,a){let n=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=l?.nonce||l?.getAttribute("nonce");n=Promise.allSettled(r.map(i=>{if(i=Ve(i),i in he)return;he[i]=!0;const d=i.endsWith(".css"),g=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${g}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":Je,d||(m.as="script"),m.crossOrigin="",m.href=i,c&&m.setAttribute("nonce",c),document.head.appendChild(m),d)return new Promise((u,x)=>{m.addEventListener("load",u),m.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${i}`)))})}))}function o(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return n.then(l=>{for(const c of l||[])c.status==="rejected"&&o(c.reason);return t().catch(o)})},se="snartnet:ed25519:keypair:v1";function ue(){try{return typeof window<"u"&&!!window.crypto?.subtle&&window.crypto.subtle!==void 0}catch{return!1}}function ce(s){return btoa(String.fromCharCode(...s))}function ee(s){const t=atob(s),r=t.length,a=new ArrayBuffer(r),n=new Uint8Array(a);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return a}function qe(s){return new Uint8Array(ee(s))}async function He(){const s=localStorage.getItem(se);if(s)try{return JSON.parse(s)}catch{}if(ue()&&window.crypto.subtle.generateKey)try{const a=await window.crypto.subtle.generateKey({name:"Ed25519",namedCurve:"Ed25519"},!0,["sign","verify"]),n=new Uint8Array(await window.crypto.subtle.exportKey("raw",a.publicKey)),o=new Uint8Array(await window.crypto.subtle.exportKey("pkcs8",a.privateKey)),l={publicKey:ce(n),secretKey:ce(o)};return localStorage.setItem(se,JSON.stringify(l)),l}catch(a){console.warn("WebCrypto Ed25519 generateKey failed; falling back to WASM",a)}await me();const t=Ae();let r;if(typeof t=="string"?r=JSON.parse(t):r=t,!r?.publicKey||!r?.secretKey)throw new Error("WASM generate_keypair returned unexpected format");return localStorage.setItem(se,JSON.stringify(r)),r}let pe=!1;async function me(){if(!pe)try{await ge(),pe=!0}catch(s){throw console.error("Failed to initialize WASM core",s),s}}function _e(s){const t={},r=["version","kind","authorPublicKey","createdAt","body","attachments","parentId","replyTo"];for(const a of r){const n=s[a];n!=null&&!(Array.isArray(n)&&n.length===0)&&(t[a]=n)}return JSON.stringify(t)}async function be(s){const t=await He(),r=_e({...s,authorPublicKey:t.publicKey});if(ue())try{const n=ee(t.secretKey),o=await window.crypto.subtle.importKey("pkcs8",n,{name:"Ed25519",namedCurve:"Ed25519"},!1,["sign"]),l=await window.crypto.subtle.sign({name:"Ed25519"},o,new TextEncoder().encode(r)),c=ce(new Uint8Array(l));return{...s,authorPublicKey:t.publicKey,signature:c,version:s.version}}catch(n){console.warn("WebCrypto sign failed; falling back to WASM",n)}await me();const a=Ue(JSON.stringify(t),r);return{...s,authorPublicKey:t.publicKey,signature:a,version:s.version}}async function ye(s){const{signature:t,authorPublicKey:r,...a}=s,n=_e({...a,authorPublicKey:r});if(ue())try{const o=ee(r),l=await window.crypto.subtle.importKey("raw",o,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]);return{ok:await window.crypto.subtle.verify({name:"Ed25519"},l,ee(t),new TextEncoder().encode(n))}}catch(o){console.warn("WebCrypto verify failed; fallback to WASM",o)}await me();try{const o=Fe(n,t,r);return{ok:o,error:o?void 0:"invalid-signature"}}catch(o){return{ok:!1,error:o?.message||"verify-error"}}}function ne(s){const t=qe(s);return"fpr-"+Array.from(t.slice(0,6)).map(r=>r.toString(16).padStart(2,"0")).join("")}const we=s=>{switch(s){case"ring-of-trust":return{canMessage:!0,canSeeFullProfile:!0,canShareContacts:!0,canRecoverKeys:!0};case"friend":return{canMessage:!0,canSeeFullProfile:!0,canShareContacts:!0,canRecoverKeys:!1};case"acquaintance":return{canMessage:!0,canSeeFullProfile:!1,canShareContacts:!1,canRecoverKeys:!1};case"group-member":return{canMessage:!0,canSeeFullProfile:!1,canShareContacts:!1,canRecoverKeys:!1}}},Ye=(s,t)=>`contact_${btoa(s+t).slice(0,16)}`,V=de((s,t)=>({contacts:[],loadContacts:()=>{try{const r=localStorage.getItem("snartnet-contacts");if(r){const a=JSON.parse(r);s({contacts:a})}}catch(r){console.error("Failed to load contacts:",r)}},addContact:r=>{const a=t().contacts,n={...r,id:Ye(r.username,r.magnetUri),addedDate:new Date().toISOString(),permissions:we(r.relationship)},o=a.findIndex(l=>l.id===n.id);if(o>=0){const l=[...a];l[o]={...l[o],...n},s({contacts:l}),localStorage.setItem("snartnet-contacts",JSON.stringify(l))}else{const l=[...a,n];s({contacts:l}),localStorage.setItem("snartnet-contacts",JSON.stringify(l))}},addContactFromMagnet:async(r,a="friend")=>{try{const n=`pending_${Math.random().toString(36).slice(2)}`,o={id:n,username:"loadingâ€¦",displayName:"Loading profileâ€¦",relationship:a,trustLevel:a==="ring-of-trust"?8:5,addedDate:new Date().toISOString(),magnetUri:r,permissions:we(a)},l=t().contacts;s({contacts:[...l,o]});const{getTorrentService:c}=await Q(async()=>{const{getTorrentService:f}=await Promise.resolve().then(()=>Be);return{getTorrentService:f}},void 0),d=await c().downloadProfile(r);if(!d)return s({contacts:t().contacts.map(f=>f.id===n?{...f,username:"unknown",displayName:"Profile unavailable"}:f)}),null;const g=d.username||"unknown",m=d.displayName||g,u=d.avatar||d.profilePicture||void 0,x={username:g,displayName:m,relationship:a,trustLevel:a==="ring-of-trust"?8:5,magnetUri:r,avatar:u,notes:"",postIndexMagnetUri:d.postIndexMagnetUri||d.post_index_magnet||void 0,syncMaxPosts:100,syncMonthsLookback:6};return s({contacts:t().contacts.filter(f=>f.id!==n)}),t().addContact(x),t().contacts.find(f=>f.username===g&&f.magnetUri===r)||null}catch(n){return console.error("addContactFromMagnet failed",n),s({contacts:t().contacts.filter(o=>!o.id.startsWith("pending_"))}),null}},removeContact:r=>{const n=t().contacts.filter(o=>o.id!==r);s({contacts:n}),localStorage.setItem("snartnet-contacts",JSON.stringify(n))},updateContact:(r,a)=>{const o=t().contacts.map(l=>l.id===r?{...l,...a}:l);s({contacts:o}),localStorage.setItem("snartnet-contacts",JSON.stringify(o))},getContactsByRelationship:r=>t().contacts.filter(a=>a.relationship===r),getContact:r=>t().contacts.find(a=>a.id===r)}));function oe(s){return s?{id:s.id||s.postId||Math.random().toString(36).slice(2),author:s.author||s.author_fingerprint||s.fingerprint||"unknown",authorDisplayName:s.authorDisplayName||s.author_display_name||s.displayName,authorAvatar:s.authorAvatar||s.author_avatar,content:s.content||"",images:s.images,magnetUri:s.magnetUri||s.magnet_uri,createdAt:s.createdAt||s.created_at||new Date().toISOString(),updatedAt:s.updatedAt||s.updated_at,tags:s.tags,version:s.version||1,schemaVersion:1,authorPublicKey:s.authorPublicKey||s.author_public_key,signature:s.signature,signatureVerified:s.signatureVerified||s.signature_verified,signatureError:s.signatureError||s.signature_error,fingerprint:s.fingerprint}:null}const I=de(s=>({posts:[],loading:!1,error:null,addPost:async t=>{const r=new Date().toISOString();let a,n;try{const c=await be({version:1,kind:"post",body:t.content,createdAt:r,attachments:t.images?.map(i=>i.id)});a=c.signature,n=c.authorPublicKey}catch(c){console.warn("Signing post failed; proceeding unsigned",c)}const o={...t,id:Math.random().toString(36).slice(2),createdAt:r,signature:a,authorPublicKey:n,fingerprint:n?ne(n):void 0,signatureVerified:!!a},l=oe(o);s(c=>({posts:[l,...c.posts].sort((i,d)=>new Date(d.createdAt).getTime()-new Date(i.createdAt).getTime())}));try{const i=await C().seedPost({...l});s(d=>({posts:d.posts.map(g=>g.id===l.id?{...g,magnetUri:i,seedProgress:100,isSeeding:!1}:g)}))}catch(c){console.error("Failed to seed post:",c),s(i=>({posts:i.posts.map(d=>d.id===l.id?{...d,isSeeding:!1,seedProgress:0,seedError:c instanceof Error?c.message:"Failed to seed"}:d)}))}},removePost:t=>{s(r=>({posts:r.posts.filter(a=>a.id!==t)}))},updatePost:(t,r)=>{s(a=>({posts:a.posts.map(n=>n.id===t?{...n,...r}:n)}))},updateSeedingStatus:(t,r,a)=>{s(n=>({posts:n.posts.map(o=>o.id===t?{...o,isSeeding:r,seedProgress:a}:o)}))},loadPostsFromContacts:async()=>{const r=V.getState().contacts.filter(i=>!!i.postIndexMagnetUri);if(r.length===0){s({loading:!1});return}s({loading:!0});const a=2,n=[...r],o=[],l=new Set,c=()=>{if(n.length===0)return;const i=n.shift();l.add(i.id);const d=(async()=>{try{await I.getState().syncPostsForContact(i.id,{maxPosts:i.syncMaxPosts,monthsLookback:i.syncMonthsLookback})}catch(g){console.warn("Sync failed for contact",i.id,g)}})().finally(()=>{const g=o.indexOf(d);g>=0&&o.splice(g,1),n.length>0?c():o.length===0&&s({loading:!1})});o.push(d),o.length<a&&n.length>0&&c()};for(let i=0;i<a&&n.length>0;i++)c()},setLoading:t=>s({loading:t}),setError:t=>s({error:t}),clearError:()=>s({error:null}),syncPostsForContact:async(t,r)=>{const n=V.getState().contacts.find(o=>o.id===t);if(!(!n||!n.postIndexMagnetUri)){s({loading:!0});try{const l=await C().downloadPostIndexChain(n.postIndexMagnetUri,{maxPosts:r?.maxPosts??n.syncMaxPosts??100,monthsLookback:r?.monthsLookback??n.syncMonthsLookback}),c=new Set(I.getState().posts.map(u=>u.id)),i=l.entries.filter(u=>u.magnetUri&&!c.has(u.id)),d=3,g=[...i],m=[];for(;g.length>0;){const u=g.splice(0,d);await Promise.all(u.map(async x=>{try{const f=await C().downloadPost(x.magnetUri);if(f&&typeof f=="object"){let y=f;try{if(f.signature&&f.authorPublicKey){const{ok:h,error:j}=await ye({...f,version:f.version||1,kind:"post"});y.signatureVerified=h,y.signatureError=h?void 0:j||"invalid-signature",y.fingerprint=f.authorPublicKey?ne(f.authorPublicKey):f.fingerprint}else y.signatureVerified=!1,y.signatureError="missing-signature"}catch(h){y.signatureVerified=!1,y.signatureError=h?.message||"verify-failed"}m.push(oe(y))}else m.push({id:x.id,author:x.author,content:`(Unavailable content) @${x.author}`,createdAt:x.createdAt,magnetUri:x.magnetUri,images:[]})}catch{m.push({id:x.id,author:x.author,content:`(Failed to fetch) @${x.author}`,createdAt:x.createdAt,magnetUri:x.magnetUri,images:[]})}}))}m.length?s(u=>({posts:[...u.posts,...m].sort((x,f)=>new Date(f.createdAt).getTime()-new Date(x.createdAt).getTime()),loading:!1})):s({loading:!1})}catch(o){s({loading:!1,error:o instanceof Error?o.message:"Failed to sync posts"})}}},fetchPostFromMagnet:async t=>{try{const r=await C().downloadPost(t);if(!r)return null;let a=r;try{if(r.signature&&r.authorPublicKey){const{ok:o,error:l}=await ye({...r,version:r.version||1,kind:"post"});a.signatureVerified=o,a.signatureError=o?void 0:l||"invalid-signature",a.fingerprint=r.authorPublicKey?ne(r.authorPublicKey):r.fingerprint}else a.signatureVerified=!1,a.signatureError="missing-signature"}catch(o){a.signatureVerified=!1,a.signatureError=o?.message||"verify-failed"}const n=oe(a);return n?(s(o=>o.posts.some(c=>c.id===n.id)?{posts:o.posts.map(c=>c.id===n.id?{...c,...n}:c)}:{posts:[n,...o.posts].sort((c,i)=>new Date(i.createdAt).getTime()-new Date(c.createdAt).getTime())}),n):null}catch(r){return console.error("Failed to download post",r),null}},editPost:async(t,r)=>{const n=I.getState().posts.find(i=>i.id===t);if(!n)return;const o=new Date().toISOString();let l,c;try{const i=await be({version:1,kind:"post",body:r,createdAt:n.createdAt,updatedAt:o,attachments:n.images?.map(d=>d.id)});l=i.signature,c=i.authorPublicKey}catch(i){console.warn("Re-signing edited post failed; proceeding unsigned",i)}s(i=>({posts:i.posts.map(d=>d.id===t?{...d,content:r,updatedAt:o,signature:l,authorPublicKey:c,signatureVerified:!!l,isSeeding:!0}:d)}));try{const d=await C().seedPost({...n,content:r,updatedAt:o,signature:l,authorPublicKey:c});s(g=>({posts:g.posts.map(m=>m.id===t?{...m,magnetUri:d,isSeeding:!1,seedProgress:100}:m)}))}catch(i){console.error("Failed to reseed edited post",i),s(d=>({posts:d.posts.map(g=>g.id===t?{...g,isSeeding:!1,seedError:"Edit reseed failed"}:g)}))}await I.getState().regenerateAuthorIndex(n.author)},regenerateAuthorIndex:async t=>{try{const r=I.getState().posts.filter(d=>d.author===t&&d.magnetUri),a=C(),n=await Q(()=>Promise.resolve().then(()=>Ke),void 0),{useProfileStore:o}=n,l=o.getState().currentProfile,c=l?.postIndexMagnetUri||null,i=await a.seedPostIndex(r,t,{previousHeadMagnet:c});if(l&&l.username===t){o.getState().updateProfile(t,{postIndexMagnetUri:i.magnetURI});try{(await Q(async()=>{const{getCore:d}=await Promise.resolve().then(()=>We);return{getCore:d}},void 0)).getCore().then(d=>d.seedCurrentProfile())}catch{}}}catch(r){console.warn("Failed to regenerate post index",r)}},deletePost:async t=>{const a=I.getState().posts.find(n=>n.id===t);a&&(I.getState().removePost(t),await I.getState().regenerateAuthorIndex(a.author))}}));class T{static PROFILE_SIZE=200;static THUMBNAIL_SIZE=64;static MAX_FILE_SIZE=2*1024*1024;static SUPPORTED_FORMATS=["image/jpeg","image/png","image/webp"];static OUTPUT_FORMAT="image/jpeg";static OUTPUT_QUALITY=.85;static async processProfilePicture(t){this.validateFile(t);const r=await this.loadImage(t),a=this.calculateSquareCrop(r.width,r.height);return await this.resizeAndCompress(r,a,this.PROFILE_SIZE)}static async createThumbnail(t){const r=await this.loadImageFromDataUrl(t.dataUrl),a={x:0,y:0,width:r.width,height:r.height};return this.resizeAndCompress(r,a,this.THUMBNAIL_SIZE)}static async processWithCrop(t,r){this.validateFile(t);const a=await this.loadImage(t);return this.resizeAndCompress(a,r,this.PROFILE_SIZE)}static validateFile(t){if(!this.SUPPORTED_FORMATS.includes(t.type))throw new Error(`Unsupported file format. Please use: ${this.SUPPORTED_FORMATS.join(", ")}`);if(t.size>this.MAX_FILE_SIZE)throw new Error(`File too large. Maximum size: ${Math.round(this.MAX_FILE_SIZE/1024/1024)}MB`)}static loadImage(t){return new Promise((r,a)=>{const n=new Image,o=URL.createObjectURL(t);n.onload=()=>{URL.revokeObjectURL(o),r(n)},n.onerror=()=>{URL.revokeObjectURL(o),a(new Error("Failed to load image"))},n.src=o})}static loadImageFromDataUrl(t){return new Promise((r,a)=>{const n=new Image;n.onload=()=>r(n),n.onerror=()=>a(new Error("Failed to load image from data URL")),n.src=t})}static calculateSquareCrop(t,r){const a=Math.min(t,r),n=(t-a)/2,o=(r-a)/2;return{x:n,y:o,width:a,height:a}}static async resizeAndCompress(t,r,a){const n=document.createElement("canvas"),o=n.getContext("2d");if(!o)throw new Error("Canvas context not available");n.width=a,n.height=a,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(t,r.x,r.y,r.width,r.height,0,0,a,a);const l=await new Promise((i,d)=>{n.toBlob(g=>{g?i(g):d(new Error("Failed to create blob"))},this.OUTPUT_FORMAT,this.OUTPUT_QUALITY)});return{dataUrl:n.toDataURL(this.OUTPUT_FORMAT,this.OUTPUT_QUALITY),blob:l,width:a,height:a,size:l.size,format:this.OUTPUT_FORMAT}}static async blobToBase64(t){return new Promise((r,a)=>{const n=new FileReader;n.onload=()=>{const l=n.result.split(",")[1];r(l)},n.onerror=()=>a(new Error("Failed to convert blob to base64")),n.readAsDataURL(t)})}static base64ToDataUrl(t,r=this.OUTPUT_FORMAT){return`data:${r};base64,${t}`}static formatFileSize(t){if(t===0)return"0 B";const r=1024,a=["B","KB","MB"],n=Math.floor(Math.log(t)/Math.log(r));return parseFloat((t/Math.pow(r,n)).toFixed(1))+" "+a[n]}static validateImageDimensions(t,r){if(t<100||r<100)throw new Error("Image too small. Minimum size: 100x100px");if(t>4e3||r>4e3)throw new Error("Image too large. Maximum size: 4000x4000px")}static generateAvatarInitials(t){return t.split(" ").map(r=>r.charAt(0).toUpperCase()).join("").substring(0,2)}static generateAvatarGradient(t){let r=0;for(let o=0;o<t.length;o++){const l=t.charCodeAt(o);r=(r<<5)-r+l,r=r&r}const a=Math.abs(r%360),n=(a+60)%360;return`linear-gradient(135deg, hsl(${a}, 70%, 50%), hsl(${n}, 70%, 70%))`}}async function Ge(s,t){return s.type.startsWith("image/")?new Promise((r,a)=>{const n=new FileReader;n.onload=o=>{const l=o.target?.result;l?r({id:`${s.name}-${s.lastModified}`,data:l,filename:s.name,size:s.size,mimeType:s.type}):a(new Error("Failed to read file data."))},n.onerror=o=>{a(o)},n.readAsDataURL(s)}):(console.warn(`File is not an image: ${s.name}`),null)}function Xe(){const[s,t]=p.useState(""),[r,a]=p.useState([]),[n,o]=p.useState(!1),{currentProfile:l}=U(),c=I(u=>u.addPost),i=p.useRef(null),d=async u=>{if(u.target.files){const x=Array.from(u.target.files);try{const f=await Promise.all(x.map(y=>Ge(y,"post-image")));a(y=>[...y,...f.filter(h=>h!==null)])}catch(f){console.error("Error processing images:",f)}}},g=u=>{a(x=>x.filter(f=>f.id!==u))},m=async u=>{if(u.preventDefault(),!(!s.trim()&&r.length===0||!l)){o(!0);try{const x=l.publicKey||l.username;await c({author:x,authorDisplayName:l.displayName||l.username,authorAvatar:l.avatar,content:s,images:r}),console.log("Post created and seeding process initiated."),t(""),a([])}catch(x){console.error("Failed to create post:",x)}finally{o(!1)}}};return l?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white mb-4",children:"Create New Post"}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsx("textarea",{value:s,onChange:u=>t(u.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"What's happening on the swarm?",disabled:n}),r.length>0&&e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4",children:r.map(u=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:u.data,alt:"Post attachment",className:"w-full h-24 object-cover rounded-md"}),e.jsx("button",{type:"button",onClick:()=>g(u.id),className:"absolute top-1 right-1 bg-black/50 text-white rounded-full p-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity","aria-label":"Remove image",children:"âœ•"})]},u.id))}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{type:"button",onClick:()=>i.current?.click(),className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700","aria-label":"Add image",disabled:n,children:e.jsx("svg",{className:"w-6 h-6 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),e.jsx("input",{type:"file",ref:i,onChange:d,className:"hidden",accept:"image/*",multiple:!0,disabled:n,"aria-label":"File uploader"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Posts are seeded as torrents"})]}),e.jsx("button",{type:"submit",disabled:n||!s.trim()&&r.length===0,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:n?"ðŸŒ± Seeding...":"ðŸŒ± Seed Post"})]})]})]}):e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-yellow-700 dark:text-yellow-300",children:"You need to create a profile before you can make posts."})})}const Ze=()=>{const{posts:s,loading:t,loadPostsFromContacts:r}=I(),{loadContacts:a,contacts:n}=V(),{currentProfile:o}=U();p.useEffect(()=>{a(),r()},[a,r]);const l=p.useMemo(()=>{const i=new Set;return o&&(o.publicKey&&i.add(o.publicKey),i.add(o.username)),n.forEach(d=>{(d.relationship==="friend"||d.relationship==="ring-of-trust")&&i.add(d.username)}),i},[n,o]),c=p.useMemo(()=>l.size===0?s:s.filter(i=>l.has(i.author)||i.authorDisplayName&&l.has(i.authorDisplayName)),[s,l]);return t?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading timeline..."})]}):e.jsx("div",{className:"space-y-6",children:c.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸŒ±"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No posts yet"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Add some friends or seed a post to see activity here."})]}):c.map(i=>e.jsx(Qe,{post:i},i.id))})},Qe=({post:s})=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold",children:s.authorAvatar?e.jsx("img",{src:T.base64ToDataUrl(s.authorAvatar),alt:s.author,className:"w-10 h-10 rounded-full object-cover"}):s.author.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:s.authorDisplayName||s.author}),e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["@",s.author]}),s.signatureVerified?e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700",title:`Signature verified${s.fingerprint?` â€¢ ${s.fingerprint}`:""}`,children:"âœ… ver"}):e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700",title:s.signatureError==="missing-signature"?"No signature present":`Signature invalid: ${s.signatureError||"unknown"}`,children:"âš ï¸ unverified"})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:et(s.createdAt)}),s.isSeeding&&e.jsxs("span",{className:"flex items-center text-green-600 dark:text-green-400",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-1"}),"Seeding"]}),s.magnetUri&&e.jsx("span",{className:"flex items-center text-blue-600 dark:text-blue-400",children:"ðŸ§² Torrent"})]})]})]}),s.content&&e.jsx("div",{className:"mb-4",children:e.jsx("p",{className:"text-gray-900 dark:text-gray-100 whitespace-pre-line",children:s.content})}),s.images&&s.images.length>0&&e.jsx("div",{className:`mb-4 grid gap-2 ${s.images.length===1?"grid-cols-1":(s.images.length===2||s.images.length===3,"grid-cols-2")}`,children:s.images.map((t,r)=>e.jsx("div",{className:`${s.images.length===3&&r===0?"col-span-2":""}`,children:e.jsx("img",{src:T.base64ToDataUrl(t.data),alt:t.filename,className:"w-full h-64 object-cover rounded-lg border border-gray-200 dark:border-gray-600 cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{window.open(T.base64ToDataUrl(t.data),"_blank")}})},t.id))}),s.tags&&s.tags.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:s.tags.map(t=>e.jsxs("span",{className:"px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full",children:["#",t]},t))})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})}),e.jsx("span",{className:"text-sm",children:"Like"})]}),e.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("span",{className:"text-sm",children:"Reply"})]}),e.jsxs("button",{className:"flex items-center space-x-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"})}),e.jsx("span",{className:"text-sm",children:"Share"})]})]}),s.magnetUri&&e.jsx("button",{onClick:()=>navigator.clipboard.writeText(s.magnetUri),className:"text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",title:"Copy magnet link",children:"ðŸ§² Copy Magnet"})]})]}),et=s=>{const t=new Date(s),a=Math.floor((new Date().getTime()-t.getTime())/1e3);return a<60?"just now":a<3600?`${Math.floor(a/60)}m ago`:a<86400?`${Math.floor(a/3600)}h ago`:a<604800?`${Math.floor(a/86400)}d ago`:t.toLocaleDateString()},tt=()=>{const{core:s,loading:t}=je(),{currentProfile:r}=U(),[a,n]=p.useState(!0);return p.useEffect(()=>{s&&n(!1)},[s]),t||a?e.jsx("div",{className:"flex items-center justify-center min-h-64",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-300",children:"Loading SnartNet..."})}):e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-4",children:"SnartNet"}),e.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-300 mb-8",children:"Decentralized social media, powered by swarms."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2",children:[r&&e.jsx(Xe,{}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-6 flex items-center",children:[e.jsx("span",{children:"Timeline"}),e.jsx("span",{className:"ml-2 text-sm text-gray-500 dark:text-gray-400",children:"(Torrent-seeded posts)"})]}),e.jsx(Ze,{})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"How It Works"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-4",children:"Every post is a torrent seed! Your content is distributed across the swarm, making it censorship-resistant and decentralized."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ðŸŒ± Posts are seeded as torrents"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ðŸ“· Images included in torrent files"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ðŸ” Content cryptographically signed"}),e.jsx("p",{className:"text-sm text-gray-500",children:"ðŸ¤ Shared through your Ring of Trust"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Features"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Profile pictures & posts"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Image upload & processing"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Post torrent seeding"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),e.jsx("span",{children:"Chronological timeline"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"w-2 h-2 bg-yellow-500 rounded-full mr-2"}),e.jsx("span",{children:"P2P post sharing (WIP)"})]})]})]})]})]})]})};function ve(){const[s,t]=p.useState(""),[r,a]=p.useState(""),[n,o]=p.useState(""),[l,c]=p.useState(!1),[i,d]=p.useState(null),[g,m]=p.useState(null),{setCurrentProfile:u,setLoading:x,setError:f}=U(),y=async h=>{if(h.preventDefault(),!s.trim()){d("Username is required");return}c(!0),d(null),m(null),f(null),x(!0);try{console.log("[CreateProfile] Starting profile creation...");const j=await M();console.log("[CreateProfile] Core initialized");const w=await j.createProfile(s.trim(),r.trim()||void 0,n.trim()||void 0);console.log("[CreateProfile] Profile created with magnet URI:",w);const E=await j.getCurrentProfile();if(console.log("[CreateProfile] Retrieved profile:",E),E)u(E),m(`Profile created successfully! Magnet URI: ${w}`),t(""),a(""),o(""),console.log("[CreateProfile] Profile creation completed successfully");else throw new Error("Failed to retrieve created profile")}catch(j){console.error("[CreateProfile] Error creating profile:",j);const w=j instanceof Error?j.message:"Failed to create profile";d(w),f(w)}finally{c(!1),x(!1)}};return e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Create Your Profile"}),e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username *"}),e.jsx("input",{type:"text",id:"username",value:s,onChange:h=>t(h.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter your username",disabled:l,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"displayName",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Display Name"}),e.jsx("input",{type:"text",id:"displayName",value:r,onChange:h=>a(h.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Your display name (optional)",disabled:l})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Bio"}),e.jsx("textarea",{id:"bio",value:n,onChange:h=>o(h.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Tell us about yourself (optional)",disabled:l})]}),i&&e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md",children:e.jsx("p",{className:"text-red-700 dark:text-red-300 text-sm",children:i})}),g&&e.jsx("div",{className:"p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md",children:e.jsx("p",{className:"text-green-700 dark:text-green-300 text-sm",children:g})}),e.jsx("button",{type:"submit",disabled:l||!s.trim(),className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:cursor-not-allowed",children:l?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Creating Profile..."]}):"Create Profile"})]}),e.jsxs("div",{className:"mt-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white mb-2",children:"ðŸ” What happens when you create a profile?"}),e.jsxs("ul",{className:"text-xs text-gray-600 dark:text-gray-400 space-y-1",children:[e.jsx("li",{children:"â€¢ A new Ed25519 cryptographic key pair is generated"}),e.jsx("li",{children:"â€¢ Your profile is signed with your private key"}),e.jsx("li",{children:"â€¢ A magnet URI is created for peer-to-peer sharing"}),e.jsx("li",{children:"â€¢ Your private keys stay in your browser (never uploaded)"})]})]})]})})}const rt=({profilePicture:s,username:t="User",size:r="md",className:a="",showOnlineStatus:n=!1,isOnline:o=!1,alt:l})=>{const c={xs:"w-6 h-6",sm:"w-8 h-8",md:"w-12 h-12",lg:"w-16 h-16",xl:"w-24 h-24"},i={xs:"w-1.5 h-1.5 bottom-0 right-0",sm:"w-2 h-2 bottom-0 right-0",md:"w-3 h-3 bottom-0.5 right-0.5",lg:"w-4 h-4 bottom-1 right-1",xl:"w-6 h-6 bottom-1 right-1"},d=m=>m.split(" ").map(u=>u.charAt(0).toUpperCase()).slice(0,2).join(""),g=s?e.jsx("img",{src:T.base64ToDataUrl(s),alt:l||`${t}'s avatar`,className:`${c[r]} rounded-full object-cover ${a}`}):e.jsx("div",{className:`${c[r]} rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold ${a}`,title:t,children:e.jsx("span",{className:`${r==="xs"?"text-xs":r==="sm"?"text-sm":r==="md"?"text-base":r==="lg"?"text-lg":"text-xl"}`,children:d(t)})});return e.jsxs("div",{className:"relative inline-block",children:[g,n&&e.jsx("div",{className:`absolute ${i[r]} ${o?"bg-green-400":"bg-gray-400"} border-2 border-white dark:border-gray-800 rounded-full`})]})},at=({onClose:s,onSuccess:t})=>{const{currentProfile:r,updateProfilePicture:a}=U(),n=p.useRef(null),[o,l]=p.useState(!1),[c,i]=p.useState(!1),[d,g]=p.useState(null),[m,u]=p.useState(null),[x,f]=p.useState(""),[y,h]=p.useState(0),j=()=>{g(null),u(null),f(""),h(0),n.current&&(n.current.value="")},w=p.useCallback(async _=>{const O=_[0];if(O)try{i(!0),f("ðŸ“¤ Processing image..."),h(25);const P=await T.processProfilePicture(O);h(75),await T.createThumbnail(P),h(90),u(P),g(P.dataUrl),f(`âœ… Image processed successfully! Size: ${T.formatFileSize(P.size)}`),h(100),console.log("Image processed:",{originalSize:O.size,processedSize:P.size,dimensions:`${P.width}x${P.height}`,format:P.format})}catch(P){console.error("Image processing error:",P),f(`âŒ Error: ${P instanceof Error?P.message:"Unknown error"}`),j()}finally{i(!1)}},[]),E=_=>{const O=_.target.files;O&&O.length>0&&w(O)},G=p.useCallback(_=>{_.preventDefault(),_.stopPropagation(),l(!1),_.dataTransfer.files&&_.dataTransfer.files.length>0&&w(_.dataTransfer.files)},[w]),v=p.useCallback(_=>{_.preventDefault(),_.stopPropagation(),_.type==="dragenter"||_.type==="dragover"?l(!0):_.type==="dragleave"&&l(!1)},[]),$=async()=>{if(!m||!r){f("âŒ No image to save or no current profile");return}try{i(!0),f("ðŸ’¾ Saving profile picture...");const _=await T.blobToBase64(m.blob),O=await T.createThumbnail(m),P=await T.blobToBase64(O.blob);a(r.username,_,P),f("âœ… Profile picture saved successfully!"),t&&t(m.dataUrl),setTimeout(()=>{s&&s()},1500)}catch(_){console.error("Save error:",_),f(`âŒ Failed to save: ${_ instanceof Error?_.message:"Unknown error"}`)}finally{i(!1)}},B=()=>{r&&confirm("Remove your profile picture?")&&(a(r.username,"",""),localStorage.removeItem(`profile-picture-${r.username}`),localStorage.removeItem(`profile-picture-thumb-${r.username}`),f("âœ… Profile picture removed"),t&&t(""),setTimeout(()=>{s&&s()},1e3))},Ne=()=>y>=100?"w-full":y>=90?"w-11/12":y>=75?"w-3/4":y>=50?"w-1/2":y>=25?"w-1/4":"w-0";return e.jsxs("div",{className:"max-w-md mx-auto p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Profile Picture"}),s&&e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:"âœ•"})]}),!d&&e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${o?"border-blue-400 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500"}`,onDragEnter:v,onDragLeave:v,onDragOver:v,onDrop:G,children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“·"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Drag and drop an image here, or click to select"}),e.jsx("button",{onClick:()=>n.current?.click(),disabled:c,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"Choose Image"}),e.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:E,className:"hidden","aria-label":"Select profile picture file",title:"Select profile picture file"}),e.jsxs("div",{className:"mt-4 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"Supported: JPEG, PNG, WebP"}),e.jsx("p",{children:"Max size: 2MB â€¢ Auto-cropped to square"})]})]}),d&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:d,alt:"Profile preview",className:"w-32 h-32 rounded-full object-cover border-4 border-gray-200 dark:border-gray-600"}),c&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})})]})}),m&&e.jsxs("div",{className:"text-center text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("p",{children:["Size: ",T.formatFileSize(m.size)]}),e.jsxs("p",{children:["Dimensions: ",m.width,"Ã—",m.height,"px"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:$,disabled:c||!m,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:c?"ðŸ’¾ Saving...":"ðŸ’¾ Save"}),e.jsx("button",{onClick:j,disabled:c,className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-400 text-white rounded-lg transition-colors",children:"ðŸ”„ Try Again"})]})]}),c&&y>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"bg-gray-200 dark:bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${Ne()}`})})}),r?.profilePicture&&!d&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("img",{src:T.base64ToDataUrl(r.profilePicture),alt:"Current profile",className:"w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600"})}),e.jsx("button",{onClick:B,className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"ðŸ—‘ï¸ Remove Current Picture"})]}),x&&e.jsx("div",{className:`mt-4 p-3 rounded-lg text-sm ${x.startsWith("âœ…")?"bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200":x.startsWith("âŒ")?"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200":"bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200"}`,children:x})]})},st=()=>{const{currentProfile:s}=U(),{posts:t,addPost:r,deletePost:a,editPost:n}=I(),[o,l]=p.useState(""),[c,i]=p.useState(!1),[d,g]=p.useState(null),[m,u]=p.useState(""),x=p.useMemo(()=>s?t.filter(y=>y.author===s.username).sort((y,h)=>new Date(h.createdAt).getTime()-new Date(y.createdAt).getTime()):[],[t,s]);if(!s)return null;const f=async y=>{if(y.preventDefault(),!!o.trim()){i(!0);try{await r({author:s.username,authorDisplayName:s.displayName,content:o.trim(),images:[]}),l("")}finally{i(!1)}}};return e.jsxs("div",{className:"w-full max-w-xl mx-auto mt-8",children:[e.jsxs("form",{onSubmit:f,className:"mb-6 flex flex-col gap-2",children:[e.jsx("textarea",{className:"w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-vertical",rows:3,placeholder:"What's on your mind?",value:o,onChange:y=>l(y.target.value),disabled:c}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:o.length>0&&`${o.length} chars`}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",disabled:c||!o.trim(),children:c?"Posting...":"Post"})]})]}),e.jsx("div",{className:"space-y-4",children:x.length>0?x.map(y=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative",children:[e.jsx("p",{className:"text-gray-900 dark:text-gray-100 mb-2 whitespace-pre-line",children:y.content}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("span",{children:new Date(y.createdAt).toLocaleString()}),e.jsxs("div",{className:"flex items-center gap-2",children:[y.signature&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold "+(y.signatureVerified?"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"),title:y.signatureVerified?`Signature verified${y.fingerprint?" ("+y.fingerprint+")":""}`:`Signature invalid: ${y.signatureError||"unknown"}`,children:y.signatureVerified?"Verified":"Invalid"}),e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs",onClick:()=>{g(y.id),u(y.content)},title:"Edit post",children:"âœï¸"}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xs",onClick:()=>a(y.id),title:"Delete post",children:"ðŸ—‘ï¸"})]})]}),d===y.id&&e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsx("textarea",{className:"w-full p-2 border border-gray-300 dark:border-gray-700 rounded bg-white dark:bg-gray-900 text-sm",value:m,onChange:h=>u(h.target.value),placeholder:"Edit your post",title:"Edit post content"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600",onClick:()=>{g(null),u("")},children:"Cancel"}),e.jsx("button",{className:"px-3 py-1 text-xs rounded bg-green-600 hover:bg-green-700 text-white",disabled:!m.trim(),onClick:async()=>{await n(y.id,m.trim()),g(null),u("")},children:"Save"})]})]})]},y.id)):e.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400",children:"No posts yet."})})]})},nt=()=>{const{currentProfile:s}=U(),[t,r]=p.useState(!1);return s?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col items-center",children:[e.jsxs("div",{className:"mb-4 relative",children:[e.jsx(rt,{profilePicture:s.profilePicture,username:s.username,size:"xl"}),e.jsx("button",{className:"absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 shadow-lg border-2 border-white dark:border-gray-800",onClick:()=>r(!0),title:"Change profile picture",children:e.jsx("span",{role:"img","aria-label":"Edit",children:"âœï¸"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:s.displayName||s.username}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-300 mb-2",children:["@",s.username]}),s.bio&&e.jsx("p",{className:"text-gray-700 dark:text-gray-200 mb-2 max-w-xl mx-auto",children:s.bio})]}),t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-lg p-4 relative w-full max-w-lg",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",onClick:()=>r(!1),title:"Close",children:"âœ•"}),e.jsx(at,{onClose:()=>r(!1)})]})}),e.jsx("div",{className:"w-full mt-8",children:e.jsx(st,{})})]}):e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center",children:e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:"No profile loaded."})})},ot=({onCancel:s})=>{const{currentProfile:t,setCurrentProfile:r}=U(),[a,n]=p.useState({username:t?.username||"",displayName:t?.displayName||"",bio:t?.bio||"",location:t?.location||"",website:t?.website||"",avatar:t?.avatar||""}),[o,l]=p.useState({}),[c,i]=p.useState(!1),d=()=>{const u={};return a.website&&!a.website.match(/^https?:\/\/.+/)&&(u.website="Website must be a valid URL (http:// or https://)"),l(u),Object.keys(u).length===0},g=async()=>{if(d()){i(!0);try{(await M()).updateProfile(a.displayName,a.bio);const x={location:a.location,website:a.website,avatar:a.avatar,updatedAt:new Date().toISOString()};localStorage.setItem(`profile-extended-${a.username}`,JSON.stringify(x));const f={...t,username:a.username,displayName:a.displayName,bio:a.bio,location:a.location,website:a.website,avatar:a.avatar,updatedAt:new Date().toISOString()};r(f),s()}catch(u){console.error("Failed to update profile:",u),l({general:"Failed to update profile. Please try again."})}finally{i(!1)}}},m=(u,x)=>{n(f=>({...f,[u]:x})),o[u]&&l(f=>({...f,[u]:""}))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-white dark:bg-gray-800",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Edit Profile"}),o.general&&e.jsx("div",{className:"text-red-600 text-sm",children:o.general}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username (cannot be changed)"}),e.jsx("input",{type:"text",value:a.username,readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Enter username"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Display Name"}),e.jsx("input",{type:"text",value:a.displayName,onChange:u=>m("displayName",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Enter display name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Bio"}),e.jsx("textarea",{value:a.bio,onChange:u=>m("bio",u.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Tell us about yourself"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Location"}),e.jsx("input",{type:"text",value:a.location,onChange:u=>m("location",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"Enter your location"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Website"}),e.jsx("input",{type:"url",value:a.website,onChange:u=>m("website",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"https://example.com"}),o.website&&e.jsx("div",{className:"text-red-600 text-sm mt-1",children:o.website})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Avatar URL"}),e.jsx("input",{type:"url",value:a.avatar,onChange:u=>m("avatar",u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white",placeholder:"https://example.com/avatar.jpg"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx("button",{onClick:g,disabled:c,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md disabled:opacity-50",children:c?"Saving...":"Save Changes"}),e.jsx("button",{onClick:s,disabled:c,className:"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md",children:"Cancel"})]})]})};function it({progress:s,className:t=""}){const r=Math.max(0,Math.min(100,s*100)),a=()=>r===0?"w-0":r>=100?"w-full":r>=75?"w-3/4":r>=50?"w-1/2":r>=25?"w-1/4":"w-1/12";return e.jsx("div",{className:`w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 overflow-hidden ${t}`,children:e.jsx("div",{className:`bg-blue-600 h-2 rounded-full transition-all duration-300 ${a()}`})})}function lt(){const[s,t]=p.useState({torrents:0,downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0,peers:0}),[r,a]=p.useState([]),[n,o]=p.useState([]),[l,c]=p.useState(!1);p.useEffect(()=>{let d;const m=(()=>{try{const u=C();c(!0);const x=u.onEvent(f=>{const y=new Date().toLocaleTimeString();switch(f.type){case"seeding-started":"profile"in f&&f.profile?o(h=>[`[${y}] âœ… Started seeding profile: ${f.profile.username}`,...h.slice(0,9)]):"post"in f&&f.post&&o(h=>[`[${y}] âœ… Started seeding post by: ${f.post.authorDisplayName||"anonymous"}`,...h.slice(0,9)]);break;case"peer-connected":o(h=>[`[${y}] ðŸ”— Peer connected: ${f.peerId}`,...h.slice(0,9)]);break;case"upload-progress":Math.random()<.1&&o(h=>[`[${y}] â¬†ï¸ Upload: ${i(f.uploadSpeed)}/s`,...h.slice(0,9)]);break;case"profile-downloaded":f.profile&&o(h=>[`[${y}] â¬‡ï¸ Downloaded profile: ${f.profile.username}`,...h.slice(0,9)]);break;case"download-progress":Math.random()<.1&&o(h=>[`[${y}] â¬‡ï¸ Progress: ${(f.progress*100).toFixed(1)}%`,...h.slice(0,9)]);break;case"error":o(h=>[`[${y}] âŒ Error: ${f.error}`,...h.slice(0,9)]);break}});return d=setInterval(()=>{t(u.getStats()),a(u.getActiveTorrents())},2e3),t(u.getStats()),a(u.getActiveTorrents()),x}catch(u){console.error("Failed to initialize torrent service:",u),c(!1),o(x=>[`Failed to initialize WebTorrent: ${u}`,...x.slice(0,9)])}})();return()=>{d&&clearInterval(d),m&&m()}},[]);const i=d=>{if(d===0)return"0 B";const g=1024,m=["B","KB","MB","GB"],u=Math.floor(Math.log(d)/Math.log(g));return parseFloat((d/Math.pow(g,u)).toFixed(1))+" "+m[u]};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:"WebTorrent Client"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${l?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:l?"Connected":"Disconnected"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:s.torrents}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Active Torrents"})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:s.peers}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Connected Peers"})]}),e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3",children:[e.jsxs("div",{className:"text-lg font-bold text-purple-600 dark:text-purple-400",children:["â¬†ï¸ ",i(s.uploadSpeed),"/s"]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Upload Speed"})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3",children:[e.jsxs("div",{className:"text-lg font-bold text-orange-600 dark:text-orange-400",children:["â¬‡ï¸ ",i(s.downloadSpeed),"/s"]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Download Speed"})]}),e.jsxs("div",{className:"bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-lg font-bold text-indigo-600 dark:text-indigo-400",children:i(s.uploaded)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Uploaded"})]}),e.jsxs("div",{className:"bg-pink-50 dark:bg-pink-900/20 rounded-lg p-3",children:[e.jsx("div",{className:"text-lg font-bold text-pink-600 dark:text-pink-400",children:i(s.downloaded)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Downloaded"})]})]}),r.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Active Torrents"}),e.jsx("div",{className:"space-y-2",children:r.map(d=>e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white truncate",children:d.name||"Unnamed Torrent"}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[(d.progress*100).toFixed(1),"%"]})]}),e.jsx(it,{progress:d.progress,className:"mb-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:["Peers: ",d.numPeers]}),e.jsxs("span",{children:["â¬†ï¸ ",i(d.uploadSpeed),"/s â¬‡ï¸ ",i(d.downloadSpeed),"/s"]})]})]},d.infoHash))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Recent Activity"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4 h-48 overflow-y-auto",children:n.length>0?e.jsx("div",{className:"space-y-1",children:n.map((d,g)=>e.jsx("div",{className:"text-sm font-mono text-gray-700 dark:text-gray-300",children:d},g))}):e.jsx("div",{className:"text-center text-gray-500 dark:text-gray-400 mt-16",children:"No activity yet. Start seeding a profile to see torrent activity!"})})]})]})}class ie{static BACKUP_VERSION="1.0.0";static FILE_EXTENSION=".snartnet-backup";static async createBackup(t=!0){try{const a=await(await M()).getCurrentProfile();if(!a)throw new Error("No current profile to backup");const n=localStorage.getItem("snartnet_keypair");if(!n)throw new Error("No keypair found for backup");const o=localStorage.getItem(`profile-extended-${a.username}`);let l=null;if(t){const i=localStorage.getItem("snartnet-contacts");l=i?JSON.parse(i):[]}const c={version:this.BACKUP_VERSION,timestamp:new Date().toISOString(),profile:a,keypair:JSON.parse(n),extendedData:o?JSON.parse(o):null,contacts:l,metadata:{username:a.username,fingerprint:a.fingerprint||"unknown",backupId:this.generateBackupId()}};return console.log("Backup created successfully:",{username:c.metadata.username,timestamp:c.timestamp,includesContacts:!!c.contacts}),c}catch(r){throw console.error("Failed to create backup:",r),new Error(`Backup creation failed: ${r instanceof Error?r.message:"Unknown error"}`)}}static async downloadBackup(t=!0,r){try{const a=await this.createBackup(t);let n=a;r&&(n=await this.encryptBackup(a,r));const o=JSON.stringify(n,null,2),l=new Blob([o],{type:"application/json"}),c=URL.createObjectURL(l),i=document.createElement("a");i.href=c,i.download=`${a.metadata.username}_backup_${this.formatDateForFilename(a.timestamp)}${this.FILE_EXTENSION}`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(c),console.log("Backup downloaded successfully")}catch(a){throw console.error("Failed to download backup:",a),a}}static async restoreFromBackup(t,r){try{let a;r&&t.encrypted?a=await this.decryptBackup(t,r):a=t,this.validateBackup(a),console.log("Restoring backup:",{version:a.version,username:a.metadata.username,timestamp:a.timestamp}),localStorage.removeItem("snartnet_keypair"),localStorage.removeItem("snartnet_current_profile"),localStorage.removeItem("snartnet-contacts"),localStorage.setItem("snartnet_keypair",JSON.stringify(a.keypair)),localStorage.setItem("snartnet_current_profile",JSON.stringify({profile:a.profile,signature:a.keypair?.signature||"restored"})),a.extendedData&&a.metadata.username&&localStorage.setItem(`profile-extended-${a.metadata.username}`,JSON.stringify(a.extendedData)),a.contacts&&localStorage.setItem("snartnet-contacts",JSON.stringify(a.contacts)),console.log("Backup restored successfully"),window.location.reload()}catch(a){throw console.error("Failed to restore backup:",a),new Error(`Restore failed: ${a instanceof Error?a.message:"Unknown error"}`)}}static async restoreFromFile(t,r){try{if(!t.name.endsWith(this.FILE_EXTENSION)&&!t.name.endsWith(".json"))throw new Error("Invalid backup file format. Please select a .snartnet-backup or .json file.");const a=await this.readFileContent(t),n=JSON.parse(a);await this.restoreFromBackup(n,r)}catch(a){throw console.error("Failed to restore from file:",a),a}}static async encryptBackup(t,r){const a=JSON.stringify(t),n=btoa(unescape(encodeURIComponent(a)));return{encrypted:!0,version:t.version,data:n,hint:`Backup for ${t.metadata.username}`,timestamp:t.timestamp}}static async decryptBackup(t,r){try{const a=decodeURIComponent(escape(atob(t.data)));return JSON.parse(a)}catch{throw new Error("Invalid password or corrupted backup file")}}static validateBackup(t){if(!t||typeof t!="object")throw new Error("Invalid backup format");if(!t.version||!t.timestamp||!t.profile||!t.keypair)throw new Error("Incomplete backup data");if(!t.metadata||!t.metadata.username)throw new Error("Missing backup metadata");t.version!==this.BACKUP_VERSION&&console.warn("Backup version mismatch:",t.version,"vs",this.BACKUP_VERSION)}static readFileContent(t){return new Promise((r,a)=>{const n=new FileReader;n.onload=o=>{o.target?.result?r(o.target.result):a(new Error("Failed to read file"))},n.onerror=()=>{a(new Error("File reading error"))},n.readAsText(t)})}static generateBackupId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}static formatDateForFilename(t){return new Date(t).toISOString().split("T")[0].replace(/-/g,"")}static async getBackupInfo(t,r){try{const a=await this.readFileContent(t);let n=JSON.parse(a);return n.encrypted&&r&&(n=await this.decryptBackup(n,r)),{username:n.metadata?.username||"Unknown",timestamp:n.timestamp||"Unknown",version:n.version||"Unknown",hasContacts:Array.isArray(n.contacts)&&n.contacts.length>0,fingerprint:n.metadata?.fingerprint||"Unknown"}}catch(a){throw new Error("Failed to read backup info: "+(a instanceof Error?a.message:"Unknown error"))}}}const ct=({onClose:s})=>{const{currentProfile:t}=U(),r=p.useRef(null),[a,n]=p.useState("backup"),[o,l]=p.useState(!0),[c,i]=p.useState(!1),[d,g]=p.useState(""),[m,u]=p.useState(!1),[x,f]=p.useState(""),[y,h]=p.useState(null),j=async()=>{if(!t){f("âŒ No profile to backup");return}if(c&&!d.trim()){f("âŒ Password is required");return}try{u(!0),f("ðŸ“¦ Creating backup..."),await ie.downloadBackup(o,c?d:void 0),f("âœ… Backup downloaded successfully!")}catch(v){console.error("Backup failed:",v),f(`âŒ Backup failed: ${v instanceof Error?v.message:"Unknown error"}`)}finally{u(!1)}},w=async v=>{const $=v.target.files?.[0];if($)try{u(!0),f("ðŸ“„ Reading backup file...");const B=await ie.getBackupInfo($,c?d:void 0);h(B),f("ðŸ“‹ Backup file loaded. Review info below and click Restore.")}catch(B){console.error("Failed to read backup:",B),f(`âŒ Failed to read backup: ${B instanceof Error?B.message:"Unknown error"}`),h(null)}finally{u(!1)}},E=async()=>{const v=r.current?.files?.[0];if(!v){f("âŒ Please select a backup file");return}if(c&&!d.trim()){f("âŒ Password is required");return}if(confirm("âš ï¸ This will replace your current profile and data. Are you sure?"))try{u(!0),f("ðŸ”„ Restoring backup..."),await ie.restoreFromFile(v,c?d:void 0),f("âœ… Backup restored successfully! Page will reload...")}catch($){console.error("Restore failed:",$),f(`âŒ Restore failed: ${$ instanceof Error?$.message:"Unknown error"}`)}finally{u(!1)}},G=()=>{g(""),f(""),h(null),r.current&&(r.current.value="")};return e.jsxs("div",{className:"max-w-2xl mx-auto p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Profile Backup & Restore"}),s&&e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:"âœ•"})]}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-6",children:e.jsxs("nav",{className:"flex space-x-8",children:[e.jsx("button",{onClick:()=>{n("backup"),G()},className:`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${a==="backup"?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400"}`,children:"ðŸ“¦ Backup"}),e.jsx("button",{onClick:()=>{n("restore"),G()},className:`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${a==="restore"?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400"}`,children:"ðŸ”„ Restore"})]})}),a==="backup"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"ðŸ“‹ What gets backed up:"}),e.jsxs("ul",{className:"text-sm text-blue-800 dark:text-blue-200 space-y-1",children:[e.jsx("li",{children:"â€¢ Your profile information and cryptographic keys"}),e.jsx("li",{children:"â€¢ Extended profile data (avatar, location, website)"}),e.jsx("li",{children:"â€¢ Your contacts and relationships (optional)"}),e.jsx("li",{children:"â€¢ All necessary data to restore your identity"})]})]}),t?e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Current Profile:"}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:[e.jsx("strong",{children:"Username:"})," ",t.username,e.jsx("br",{}),e.jsx("strong",{children:"Display Name:"})," ",t.displayName||"Not set",e.jsx("br",{}),e.jsx("strong",{children:"Public Key:"})," ",t.publicKey?.slice(0,16)+"..."||"Unknown"]})]}):e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4",children:e.jsx("p",{className:"text-yellow-800 dark:text-yellow-200",children:"âš ï¸ No profile found to backup. Please create a profile first."})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:v=>l(v.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Include contacts and relationships in backup"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:v=>i(v.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Password protect backup (recommended)"})]}),c&&e.jsx("input",{type:"password",value:d,onChange:v=>g(v.target.value),placeholder:"Enter backup password",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),e.jsx("button",{onClick:j,disabled:m||!t,className:"w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:m?"ðŸ“¦ Creating Backup...":"ðŸ’¾ Download Backup"})]}),a==="restore"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-yellow-900 dark:text-yellow-100 mb-2",children:"âš ï¸ Important Warning:"}),e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"Restoring a backup will completely replace your current profile, keys, and data. Make sure to backup your current profile first if you want to keep it."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select Backup File:"}),e.jsx("input",{ref:r,type:"file",accept:".snartnet-backup,.json",onChange:w,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Accepts .snartnet-backup and .json files"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:v=>i(v.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Backup is password protected"})]}),c&&e.jsx("input",{type:"password",value:d,onChange:v=>g(v.target.value),placeholder:"Enter backup password",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),y&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Backup Information:"}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Username:"})," ",y.username]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Created:"})," ",new Date(y.timestamp).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Version:"})," ",y.version]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fingerprint:"})," ",y.fingerprint]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Includes Contacts:"})," ",y.hasContacts?"Yes":"No"]})]})]}),e.jsx("button",{onClick:E,disabled:m||!y,className:"w-full px-4 py-3 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:m?"ðŸ”„ Restoring...":"ðŸ”„ Restore Backup"})]}),x&&e.jsx("div",{className:`mt-6 p-4 rounded-lg ${x.startsWith("âœ…")?"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700":x.startsWith("âŒ")?"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700":x.startsWith("âš ï¸")?"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700":"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700"}`,children:e.jsx("p",{className:`text-sm font-medium ${x.startsWith("âœ…")?"text-green-800 dark:text-green-200":x.startsWith("âŒ")?"text-red-800 dark:text-red-200":x.startsWith("âš ï¸")?"text-yellow-800 dark:text-yellow-200":"text-blue-800 dark:text-blue-200"}`,children:x})})]})},dt=()=>{const{currentProfile:s,loading:t,seedProfileEnabled:r,setSeedProfileEnabled:a}=U(),[n,o]=p.useState(!1),[l,c]=p.useState(!1),[i,d]=p.useState(""),[g,m]=p.useState(!1);async function u(){if(!(!s||!r))try{d("Seeding profile...");const f=await(await M()).seedCurrentProfile();d(`Seeding âœ“ (${f.slice(0,40)}...)`)}catch(x){d(`Seeding failed: ${x?.message||"error"}`)}}return s&&r&&i===""&&u(),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"Profile Management"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500",checked:r,onChange:x=>{a(x.target.checked),x.target.checked&&u()}}),e.jsx("span",{children:"Seed my profile (auto)"}),i&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:i})]}),s&&!n&&!l&&!g&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>c(!0),className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors",children:"ðŸ’¾ Backup & Restore"}),e.jsx("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors",children:"Create New Profile"}),e.jsx("button",{onClick:()=>m(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"Edit Profile"})]})]})]}),t&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600 dark:text-gray-400",children:"Loading profile..."})]}),!t&&e.jsxs("div",{className:"space-y-8",children:[l&&e.jsx("div",{children:e.jsx(ct,{onClose:()=>c(!1)})}),n&&!l&&!g&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Create New Profile"}),e.jsx("button",{onClick:()=>o(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"âœ• Cancel"})]}),e.jsx(ve,{})]}),!l&&!g&&e.jsxs(e.Fragment,{children:[s?e.jsx("div",{children:!n&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-4",children:"Current Profile"}),e.jsx(nt,{})]})}):!n&&e.jsx(ve,{}),e.jsx(lt,{})]}),g&&s&&!l&&!n&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Edit Profile"}),e.jsx("button",{onClick:()=>m(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"âœ• Close"})]}),e.jsx(ot,{onCancel:()=>m(!1)})]})]})]})},gt=()=>e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-4",children:"Messages"}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Encrypted messaging features coming soon..."})})]});function ut({onProfileDownloaded:s}){const{currentProfile:t}=U(),[r,a]=p.useState(""),[n,o]=p.useState(!1),[l,c]=p.useState(""),[i,d]=p.useState(""),[g,m]=p.useState(!1),[u,x]=p.useState(!1),f=async()=>{if(!t){c("No profile to seed");return}try{m(!0),c("Starting to seed your profile...");const E=await(await M()).seedCurrentProfile();d(E),c("âœ… Profile is now seeding! Share the magnet link with friends."),x(!0)}catch(w){console.error("Error seeding profile:",w),c(`âŒ Failed to seed profile: ${w}`)}finally{m(!1)}},y=async()=>{if(!r.trim()){c("Please enter a magnet link");return}if(!r.startsWith("magnet:?")){c("Invalid magnet link format");return}try{o(!0),c("Connecting to peers and downloading profile...");const E=await(await M()).downloadProfileFromMagnet(r.trim());E?(c(`âœ… Successfully downloaded profile: ${E.username}`),a(""),s&&s(E)):c("âŒ Failed to download profile - no data received")}catch(w){console.error("Error downloading profile:",w),c(`âŒ Download failed: ${w}`)}finally{o(!1)}},h=async()=>{if(i)try{await navigator.clipboard.writeText(i),c("âœ… Magnet link copied to clipboard!"),setTimeout(()=>c(""),3e3)}catch(w){console.error("Failed to copy magnet link:",w),c("Failed to copy magnet link")}},j=async()=>{if(i&&"share"in navigator)try{await navigator.share({title:`${t?.username}'s SnartNet Profile`,text:"Connect with me on SnartNet! Download my profile using this magnet link:",url:i})}catch(w){console.log("Share cancelled or failed:",w)}};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Connect with Friends"}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Share Your Profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Start seeding your profile so friends can download it via P2P torrent network."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:f,disabled:!t||g,className:"px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:g?"Starting Seed...":"ðŸŒ± Start Seeding Profile"}),i&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:h,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"ðŸ“‹ Copy Magnet Link"}),"share"in navigator&&e.jsx("button",{onClick:j,className:"px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors",children:"ðŸ“± Share"})]})]}),i&&e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white mb-2",children:"Your Magnet Link:"}),e.jsx("code",{className:"text-xs text-gray-600 dark:text-gray-400 break-all font-mono",children:i})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Download Friend's Profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Enter a magnet link from a friend to download their profile via P2P."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"magnet-input",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Magnet Link"}),e.jsx("textarea",{id:"magnet-input",value:r,onChange:w=>a(w.target.value),placeholder:"magnet:?xt=urn:btih:...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:3})]}),e.jsx("button",{onClick:y,disabled:!r.trim()||n,className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors",children:n?"â¬‡ï¸ Downloading...":"â¬‡ï¸ Download Profile"})]})]}),l&&e.jsx("div",{className:`p-4 rounded-lg ${l.includes("âœ…")?"bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200":l.includes("âŒ")?"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200":"bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200"}`,children:e.jsx("p",{className:"text-sm font-medium",children:l})}),u&&i&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"ðŸŽ‰ Profile Successfully Seeding!"}),e.jsx("button",{onClick:()=>x(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"âœ•"})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Your profile is now available on the P2P network. Share this magnet link with friends:"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-4",children:e.jsx("code",{className:"text-xs text-gray-600 dark:text-gray-400 break-all font-mono",children:i})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:h,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors",children:"ðŸ“‹ Copy"}),"share"in navigator&&e.jsx("button",{onClick:j,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors",children:"ðŸ“± Share"})]})]})})]})}function mt(){const[s,t]=p.useState([]),{addContact:r,getContact:a}=V();p.useEffect(()=>{const i=localStorage.getItem("snartnet-discovered-profiles");if(i)try{t(JSON.parse(i))}catch(d){console.error("Failed to load discovered profiles:",d)}},[]),p.useEffect(()=>{localStorage.setItem("snartnet-discovered-profiles",JSON.stringify(s))},[s]);const n=i=>{const d=s.findIndex(m=>m.publicKey===i.publicKey),g={id:i.publicKey.slice(0,8),username:i.username,displayName:i.displayName||i.username,bio:i.bio,publicKey:i.publicKey,avatar:i.avatar,downloadedAt:new Date().toISOString(),magnetURI:i.magnetURI};if(d>=0){const m=[...s];m[d]={...m[d],...g},t(m)}else t(m=>[g,...m])},o=i=>{t(d=>d.filter(g=>g.publicKey!==i))},l=(i,d="friend")=>{const g=`contact_${btoa(i.username+(i.magnetURI||"")).slice(0,16)}`;if(a(g)){alert(`${i.username} is already in your contacts!`);return}r({username:i.username,displayName:i.displayName,relationship:d,trustLevel:d==="friend"?7:5,magnetUri:i.magnetURI||"",avatar:i.avatar,notes:`Added from discovery on ${new Date().toLocaleDateString()}`}),alert(`${i.username} has been added to your ${d}s!`)},c=i=>new Date(i).toLocaleDateString()+" "+new Date(i).toLocaleTimeString();return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Discover Friends"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Share your profile and download friends' profiles using magnet links."})]}),e.jsx(ut,{onProfileDownloaded:n}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("div",{className:"flex justify-between items-center mb-6",children:e.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white",children:["Downloaded Friends (",s.length,")"]})}),s.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸ‘¥"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No friends discovered yet"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Use the magnet link manager above to download friends' profiles from the P2P network."})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:s.map(i=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:border-blue-300 dark:hover:border-blue-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[i.avatar?e.jsx("img",{src:i.avatar,alt:`${i.username}'s avatar`,className:"w-10 h-10 rounded-full"}):e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold",children:i.username.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:i.displayName}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:["@",i.username]})]})]}),e.jsx("button",{onClick:()=>o(i.publicKey),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1",title:"Remove profile",children:"ðŸ—‘ï¸"})]}),i.bio&&e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2",children:i.bio}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-3",children:[e.jsxs("p",{children:["Downloaded: ",c(i.downloadedAt)]}),e.jsxs("p",{className:"font-mono",children:["ID: ",i.id]})]}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("button",{onClick:()=>l(i,"friend"),className:"flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors",children:"âž• Add Friend"}),e.jsx("button",{onClick:()=>l(i,"acquaintance"),className:"flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:"ðŸ¤ Add Acquaintance"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors",children:"ðŸ’¬ Message"}),e.jsx("button",{className:"flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors",children:"ðŸ‘¤ View Profile"})]})]},i.publicKey))})]})]})}const ft=[{id:"all",label:"All",icon:"ðŸŒ"},{id:"friend",label:"Friends",icon:"ðŸ‘¥"},{id:"ring-of-trust",label:"Ring of Trust",icon:"ðŸ›¡ï¸"},{id:"acquaintance",label:"Acquaintances",icon:"ðŸ¤"},{id:"group-member",label:"Groups",icon:"ðŸ "}],xt=()=>{const{loadContacts:s,contacts:t,addContactFromMagnet:r,removeContact:a}=V(),[n,o]=p.useState("all"),[l,c]=p.useState(""),[i,d]=p.useState(!1),[g,m]=p.useState("friend"),[u,x]=p.useState(null);p.useEffect(()=>{s()},[s]);const f=t.filter(h=>n==="all"?!0:h.relationship===n),y=async h=>{if(h.preventDefault(),x(null),!!l.trim()){d(!0);try{await r(l.trim(),g)?c(""):x("Failed to load profile from magnet (no peers or invalid data)")}catch(j){x(j?.message||"Failed to add contact")}finally{d(!1)}}};return e.jsxs("div",{className:"max-w-6xl mx-auto p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Friends & Contacts"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Manage your network. Add new contacts with just their profile magnet link."})]}),e.jsxs("form",{onSubmit:y,className:"flex flex-col sm:flex-row gap-2 w-full md:w-auto",children:[e.jsx("input",{type:"text",value:l,onChange:h=>c(h.target.value),placeholder:"magnet:?xt=... (profile)",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm",disabled:i}),e.jsxs("select",{value:g,onChange:h=>m(h.target.value),className:"px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm",disabled:i,"aria-label":"Relationship type",children:[e.jsx("option",{value:"friend",children:"Friend"}),e.jsx("option",{value:"ring-of-trust",children:"Ring of Trust"}),e.jsx("option",{value:"acquaintance",children:"Acquaintance"}),e.jsx("option",{value:"group-member",children:"Group Member"})]}),e.jsx("button",{type:"submit",disabled:i||!l.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-md text-sm",children:i?"Addingâ€¦":"Add"})]})]}),u&&e.jsx("div",{className:"mb-4 p-3 rounded bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 text-sm",children:u}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto",children:e.jsx("nav",{className:"flex space-x-6 min-w-max",children:ft.map(h=>e.jsxs("button",{onClick:()=>o(h.id),className:`py-2 px-1 border-b-2 text-sm font-medium transition-colors flex items-center gap-1 ${n===h.id?"border-blue-500 text-blue-600 dark:text-blue-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"}`,children:[e.jsx("span",{children:h.icon}),h.label,e.jsx("span",{className:"ml-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-full px-2 py-0.5 text-[10px]",children:h.id==="all"?t.length:t.filter(j=>j.relationship===h.id).length})]},h.id))})}),e.jsx("div",{className:"space-y-4",children:f.length===0?e.jsxs("div",{className:"text-center py-16 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg",children:[e.jsx("div",{className:"text-5xl mb-4",children:"ðŸ“­"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-2 text-sm",children:"No contacts in this category yet."}),e.jsx("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:"Add one with a profile magnet link above."})]}):f.map(h=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center gap-4",children:[e.jsx(D,{to:`/contact/${h.id}`,className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold overflow-hidden focus:ring-2 focus:ring-blue-500",children:h.avatar?e.jsx("img",{src:h.avatar,alt:h.displayName,className:"w-12 h-12 rounded-full object-cover"}):h.displayName.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(D,{to:`/contact/${h.id}`,className:"flex flex-wrap items-center gap-2 group",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white truncate group-hover:underline",children:h.displayName}),e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:["@",h.username]}),e.jsx(ht,{rel:h.relationship}),h.postIndexMagnetUri&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300",children:"posts"})]}),e.jsxs("div",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:["Trust ",h.trustLevel,"/10 â€¢ Added ",new Date(h.addedDate).toLocaleDateString()]})]}),e.jsx("button",{onClick:()=>a(h.id),className:"text-xs px-3 py-1 bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 text-red-700 dark:text-red-300 rounded",children:"Remove"})]},h.id))})]})},ht=({rel:s})=>{const t={friend:"bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300","ring-of-trust":"bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300",acquaintance:"bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300","group-member":"bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300"};return e.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-medium ${t[s]}`,children:s.replace("-"," ")})},pt=()=>{const{id:s}=Se(),{contacts:t,loadContacts:r}=V(),{posts:a,loadPostsFromContacts:n}=I(),o=I(u=>u.syncPostsForContact),[l,c]=p.useState(!1),[i,d]=p.useState("");p.useEffect(()=>{r()},[r]),p.useEffect(()=>{n()},[n]);const g=t.find(u=>u.id===s),m=p.useMemo(()=>g?a.filter(u=>u.author===g.username).sort((u,x)=>new Date(x.createdAt).getTime()-new Date(u.createdAt).getTime()).slice(0,50):[],[a,g]);return g?e.jsxs("div",{className:"max-w-4xl mx-auto p-6 space-y-8",children:[e.jsxs("div",{className:"flex items-start gap-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow",children:[e.jsx("div",{className:"w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-semibold overflow-hidden",children:g.avatar?e.jsx("img",{src:g.avatar,alt:g.displayName,className:"w-24 h-24 object-cover"}):g.displayName.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:g.displayName}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm mb-2",children:[e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["@",g.username]}),g.postIndexMagnetUri&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300",children:"posts"}),e.jsxs("span",{className:"text-[10px] px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200",children:["Trust ",g.trustLevel,"/10"]}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300",children:g.relationship})]}),e.jsxs("div",{className:"text-xs text-gray-400 dark:text-gray-500",children:["Added ",new Date(g.addedDate).toLocaleDateString()," â€¢ ",g.magnetUri.slice(0,42),"â€¦"]}),g.notes&&g.notes.trim()&&e.jsx("p",{className:"mt-3 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line",children:g.notes})]}),e.jsxs("div",{className:"flex flex-col gap-2 items-end",children:[g.postIndexMagnetUri&&e.jsx("span",{className:"text-xs text-green-600 dark:text-green-400",children:"Index ready"}),e.jsx("button",{disabled:l||!g.postIndexMagnetUri,onClick:async()=>{if(!g.postIndexMagnetUri)return;c(!0),d("Syncingâ€¦");const u=performance.now();try{await o(g.id,{maxPosts:g.syncMaxPosts,monthsLookback:g.syncMonthsLookback});const x=(performance.now()-u)/1e3;d(`Synced in ${x.toFixed(1)}s`)}catch(x){d(x?.message||"Sync failed")}finally{c(!1),setTimeout(()=>d(""),5e3)}},className:"px-3 py-1.5 text-xs rounded bg-blue-600 disabled:bg-gray-400 hover:bg-blue-700 text-white font-medium shadow",children:l?"Syncingâ€¦":"Sync Contact"}),i&&e.jsx("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:i})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4",children:"Recent Posts"}),m.length===0?e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 text-center",children:"No posts downloaded yet. Sync will populate as posts arrive."}):e.jsx("div",{className:"space-y-4",children:m.map(u=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:new Date(u.createdAt).toLocaleString()}),u.signatureVerified?e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-semibold bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700",children:"ver"}):e.jsx("span",{className:"px-1.5 py-0.5 rounded text-[10px] font-semibold bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700",title:u.signatureError||"unverified",children:"unv"}),u.magnetUri&&e.jsx("button",{onClick:()=>navigator.clipboard.writeText(u.magnetUri),className:"text-blue-600 dark:text-blue-400 hover:underline",children:"ðŸ§²"})]})}),e.jsx("p",{className:"text-sm text-gray-900 dark:text-gray-100 whitespace-pre-line mb-2",children:u.content}),u.images&&u.images.length>0&&e.jsx("div",{className:"grid gap-2 grid-cols-2",children:u.images.map(x=>e.jsx("img",{src:T.base64ToDataUrl(x.data),className:"w-full h-40 object-cover rounded",alt:x.filename},x.id))})]},u.id))})]}),e.jsx("div",{className:"text-center pt-8",children:e.jsx(D,{to:"/network",className:"text-sm text-blue-600 dark:text-blue-400 hover:underline",children:"â† Back to Network"})})]}):e.jsx("div",{className:"max-w-4xl mx-auto p-6",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center",children:[e.jsx("h1",{className:"text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Contact not found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:"The contact you are looking for does not exist or has been removed."}),e.jsx(D,{to:"/network",className:"text-blue-600 dark:text-blue-400 hover:underline text-sm",children:"Back to Network"})]})})},bt=()=>e.jsx("div",{className:"sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/75 dark:supports-[backdrop-filter]:bg-gray-900/75 bg-white/90 dark:bg-gray-800/90 border-b border-gray-200 dark:border-gray-700 shadow-sm",children:e.jsxs("nav",{children:[e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"flex justify-between items-center h-16",children:[e.jsx(D,{to:"/",className:"text-xl font-bold text-gray-900 dark:text-white",children:"SnartNet"}),e.jsxs("div",{className:"flex space-x-4 items-center",children:[e.jsx(D,{to:"/",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Home"}),e.jsx(D,{to:"/profile",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Profile"}),e.jsx(D,{to:"/discover",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Discover"}),e.jsx(D,{to:"/network",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Network"}),e.jsx(D,{to:"/messages",className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white",children:"Messages"})]})]})}),e.jsx("div",{className:"bg-red-600/90 text-white text-center text-xs py-1 tracking-wide font-medium",children:"Development version â€“ expect things to break & data to reset"})]})}),yt="0.1.0",wt=({children:s})=>e.jsxs("div",{className:"min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900",children:[e.jsx(bt,{}),e.jsx("main",{className:"container mx-auto px-4 py-8 flex-1 w-full",children:s}),e.jsxs("footer",{className:"border-t border-gray-200 dark:border-gray-700 py-4 text-center text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:["SnartNet v",yt]}),e.jsx("span",{className:"mx-2",children:"â€¢"}),e.jsx("span",{children:"Development build"})]})]});function vt(){const{setCurrentProfile:s,setLoading:t,setError:r}=U();p.useEffect(()=>{let a=!0;return(async()=>{try{t(!0),r(null),console.log("[useInitializeCore] Initializing core...");const o=await M();if(console.log("[useInitializeCore] Core initialized successfully"),console.log("[useInitializeCore] Initializing torrent service..."),C(),console.log("[useInitializeCore] Torrent service initialized."),o.hasProfile()){console.log("[useInitializeCore] Found existing profile, loading...");const l=await o.getCurrentProfile();l&&a&&(console.log("[useInitializeCore] Loaded existing profile:",l),s(l))}else console.log("[useInitializeCore] No existing profile found")}catch(o){if(console.error("[useInitializeCore] Failed to initialize core:",o),a){const l=o instanceof Error?o.message:"Failed to initialize";r(l)}}finally{a&&t(!1)}})(),()=>{a=!1}},[s,t,r])}function kt(){return vt(),e.jsx(Pe,{basename:"/net",children:e.jsx(wt,{children:e.jsxs(Ce,{children:[e.jsx(J,{path:"/",element:e.jsx(tt,{})}),e.jsx(J,{path:"/profile/:id?",element:e.jsx(dt,{})}),e.jsx(J,{path:"/discover",element:e.jsx(mt,{})}),e.jsx(J,{path:"/network",element:e.jsx(xt,{})}),e.jsx(J,{path:"/contact/:id",element:e.jsx(pt,{})}),e.jsx(J,{path:"/messages/:id?",element:e.jsx(gt,{})})]})})})}function jt(s={}){const{immediate:t=!1,onNeedRefresh:r,onOfflineReady:a,onRegistered:n,onRegisteredSW:o,onRegisterError:l}=s;let c,i;const d=async(m=!0)=>{await i};async function g(){if("serviceWorker"in navigator){if(c=await Q(async()=>{const{Workbox:m}=await import("./vendor-DX1wVttl.js").then(u=>u.w);return{Workbox:m}},[]).then(({Workbox:m})=>new m("/net/sw.js",{scope:"/net/",type:"classic"})).catch(m=>{l?.(m)}),!c)return;c.addEventListener("activated",m=>{(m.isUpdate||m.isExternal)&&window.location.reload()}),c.addEventListener("installed",m=>{m.isUpdate||a?.()}),c.register({immediate:t}).then(m=>{o?o("/net/sw.js",m):n?.(m)}).catch(m=>{l?.(m)})}}return i=g(),d}const _t=jt({immediate:!0,onNeedRefresh(){_t(!0)},onOfflineReady(){},onRegisteredSW(s,t){t&&typeof t.update=="function"?setInterval(()=>{t.update()},30*60*1e3):navigator.serviceWorker.controller&&fetch(s).catch(()=>{})}});Ee(document.getElementById("root")).render(e.jsx(p.StrictMode,{children:e.jsx(kt,{})}));
//# sourceMappingURL=index-C74uGA6y.js.map
