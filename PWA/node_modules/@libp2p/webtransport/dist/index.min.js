(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2PWebtransport = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2PWebtransport=(()=>{var gs=Object.defineProperty;var pf=Object.getOwnPropertyDescriptor;var mf=Object.getOwnPropertyNames;var yf=Object.prototype.hasOwnProperty;var _t=(e,t)=>{for(var r in t)gs(e,r,{get:t[r],enumerable:!0})},gf=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of mf(t))!yf.call(e,s)&&s!==r&&gs(e,s,{get:()=>t[s],enumerable:!(n=pf(t,s))||n.enumerable});return e};var bf=e=>gf(gs({},"__esModule",{value:!0}),e);var fp={};_t(fp,{webTransport:()=>up});var fn=class extends Error{static name="UnexpectedPeerError";constructor(t="Unexpected Peer"){super(t),this.name="UnexpectedPeerError"}},$e=class extends Error{static name="InvalidCryptoExchangeError";constructor(t="Invalid crypto exchange"){super(t),this.name="InvalidCryptoExchangeError"}},et=class extends Error{static name="InvalidParametersError";constructor(t="Invalid parameters"){super(t),this.name="InvalidParametersError"}},We=class extends Error{static name="InvalidPublicKeyError";constructor(t="Invalid public key"){super(t),this.name="InvalidPublicKeyError"}};var ln=class extends Error{static name="MuxerClosedError";constructor(t="The muxer is closed"){super(t),this.name="MuxerClosedError"}},hn=class extends Error{static name="StreamResetError";constructor(t="The stream has been reset"){super(t),this.name="StreamResetError"}};var be=class extends Error{static name="StreamStateError";constructor(t="The stream is in an invalid state"){super(t),this.name="StreamStateError"}},Br=class extends Error{static name="StreamBufferError";constructor(t="The stream buffer was full"){super(t),this.name="StreamBufferError"}};var _r=class extends Error{static name="InvalidMultiaddrError";constructor(t="Invalid multiaddr"){super(t),this.name="InvalidMultiaddrError"}},dn=class extends Error{static name="InvalidCIDError";constructor(t="Invalid CID"){super(t),this.name="InvalidCIDError"}},pn=class extends Error{static name="InvalidMultihashError";constructor(t="Invalid Multihash"){super(t),this.name="InvalidMultihashError"}};var xe=class extends Error{static name="UnsupportedKeyTypeError";constructor(t="Unsupported key type"){super(t),this.name="UnsupportedKeyTypeError"}};var mn=class extends Event{data;constructor(t,r){super("message",r),this.data=t}},Fe=class extends Event{error;local;constructor(t,r,n){super("close",n),this.error=r,this.local=t}},yn=class extends Fe{constructor(t,r){super(!0,t,r)}},gn=class extends Fe{constructor(t,r){super(!1,t,r)}};var bs=Symbol.for("@libp2p/peer-id");var pa=Symbol.for("@libp2p/transport");var da;(function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"})(da||(da={}));var Ge=class extends EventTarget{#t=new Map;constructor(){super()}listenerCount(t){let r=this.#t.get(t);return r==null?0:r.length}addEventListener(t,r,n){super.addEventListener(t,r,n);let s=this.#t.get(t);s==null&&(s=[],this.#t.set(t,s)),s.push({callback:r,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(t,r,n){super.removeEventListener(t.toString(),r??null,n);let s=this.#t.get(t);s!=null&&(s=s.filter(({callback:o})=>o!==r),this.#t.set(t,s))}dispatchEvent(t){let r=super.dispatchEvent(t),n=this.#t.get(t.type);return n==null||(n=n.filter(({once:s})=>!s),this.#t.set(t.type,n)),r}safeDispatchEvent(t,r={}){return this.dispatchEvent(new CustomEvent(t,r))}};var bn=Symbol.for("@libp2p/service-capabilities"),gp=Symbol.for("@libp2p/service-dependencies");var vs={};_t(vs,{base58btc:()=>at,base58flickr:()=>Bf});var zp=new Uint8Array(0);function ma(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}function Wt(e){if(e instanceof Uint8Array&&e.constructor.name==="Uint8Array")return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}function ya(e){return new TextEncoder().encode(e)}function ga(e){return new TextDecoder().decode(e)}function xf(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var s=0;s<e.length;s++){var o=e.charAt(s),i=o.charCodeAt(0);if(r[i]!==255)throw new TypeError(o+" is ambiguous");r[i]=s}var a=e.length,c=e.charAt(0),f=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function l(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var S=0,h=0,b=0,B=d.length;b!==B&&d[b]===0;)b++,S++;for(var w=(B-b)*u+1>>>0,D=new Uint8Array(w);b!==B;){for(var N=d[b],M=0,k=w-1;(N!==0||M<h)&&k!==-1;k--,M++)N+=256*D[k]>>>0,D[k]=N%a>>>0,N=N/a>>>0;if(N!==0)throw new Error("Non-zero carry");h=M,b++}for(var _=w-h;_!==w&&D[_]===0;)_++;for(var v=c.repeat(S);_<w;++_)v+=e.charAt(D[_]);return v}function g(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var S=0;if(d[S]!==" "){for(var h=0,b=0;d[S]===c;)h++,S++;for(var B=(d.length-S)*f+1>>>0,w=new Uint8Array(B);d[S];){var D=r[d.charCodeAt(S)];if(D===255)return;for(var N=0,M=B-1;(D!==0||N<b)&&M!==-1;M--,N++)D+=a*w[M]>>>0,w[M]=D%256>>>0,D=D/256>>>0;if(D!==0)throw new Error("Non-zero carry");b=N,S++}if(d[S]!==" "){for(var k=B-b;k!==B&&w[k]===0;)k++;for(var _=new Uint8Array(h+(B-k)),v=h;k!==B;)_[v++]=w[k++];return _}}}function p(d){var S=g(d);if(S)return S;throw new Error(`Non-${t} character`)}return{encode:l,decodeUnsafe:g,decode:p}}var wf=xf,Ef=wf,xa=Ef;var xs=class{name;prefix;baseEncode;constructor(t,r,n){this.name=t,this.prefix=r,this.baseEncode=n}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},ws=class{name;prefix;baseDecode;prefixCodePoint;constructor(t,r,n){this.name=t,this.prefix=r;let s=r.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return wa(this,t)}},Es=class{decoders;constructor(t){this.decoders=t}or(t){return wa(this,t)}decode(t){let r=t[0],n=this.decoders[r];if(n!=null)return n.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function wa(e,t){return new Es({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}var Ss=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(t,r,n,s){this.name=t,this.prefix=r,this.baseEncode=n,this.baseDecode=s,this.encoder=new xs(t,r,n),this.decoder=new ws(t,r,s)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}};function je({name:e,prefix:t,encode:r,decode:n}){return new Ss(e,t,r,n)}function oe({name:e,prefix:t,alphabet:r}){let{encode:n,decode:s}=xa(r,e);return je({prefix:t,name:e,encode:n,decode:o=>Wt(s(o))})}function Sf(e,t,r,n){let s=e.length;for(;e[s-1]==="=";)--s;let o=new Uint8Array(s*r/8|0),i=0,a=0,c=0;for(let f=0;f<s;++f){let u=t[e[f]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<r|u,i+=r,i>=8&&(i-=8,o[c++]=255&a>>i)}if(i>=r||(255&a<<8-i)!==0)throw new SyntaxError("Unexpected end of data");return o}function vf(e,t,r){let n=t[t.length-1]==="=",s=(1<<r)-1,o="",i=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],i+=8;i>r;)i-=r,o+=t[s&a>>i];if(i!==0&&(o+=t[s&a<<r-i]),n)for(;(o.length*r&7)!==0;)o+="=";return o}function Af(e){let t={};for(let r=0;r<e.length;++r)t[e[r]]=r;return t}function it({name:e,prefix:t,bitsPerChar:r,alphabet:n}){let s=Af(n);return je({prefix:t,name:e,encode(o){return vf(o,n,r)},decode(o){return Sf(o,s,r,e)}})}var at=oe({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Bf=oe({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var As={};_t(As,{base32:()=>ie,base32hex:()=>Cf,base32hexpad:()=>Df,base32hexpadupper:()=>Rf,base32hexupper:()=>Tf,base32pad:()=>Lf,base32padupper:()=>If,base32upper:()=>_f,base32z:()=>Pf});var ie=it({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),_f=it({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Lf=it({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),If=it({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Cf=it({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Tf=it({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Df=it({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Rf=it({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Pf=it({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Bs={};_t(Bs,{base36:()=>Lr,base36upper:()=>Of});var Lr=oe({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Of=oe({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Ft={};_t(Ft,{Digest:()=>we,create:()=>Ot,decode:()=>Xe,equals:()=>Ls,hasCode:()=>Jf});var Uf=va,Ea=128,Kf=127,Nf=~Kf,Mf=Math.pow(2,31);function va(e,t,r){t=t||[],r=r||0;for(var n=r;e>=Mf;)t[r++]=e&255|Ea,e/=128;for(;e&Nf;)t[r++]=e&255|Ea,e>>>=7;return t[r]=e|0,va.bytes=r-n+1,t}var kf=_s,Hf=128,Sa=127;function _s(e,n){var r=0,n=n||0,s=0,o=n,i,a=e.length;do{if(o>=a)throw _s.bytes=0,new RangeError("Could not decode varint");i=e[o++],r+=s<28?(i&Sa)<<s:(i&Sa)*Math.pow(2,s),s+=7}while(i>=Hf);return _s.bytes=o-n,r}var Vf=Math.pow(2,7),qf=Math.pow(2,14),zf=Math.pow(2,21),$f=Math.pow(2,28),Wf=Math.pow(2,35),Ff=Math.pow(2,42),Gf=Math.pow(2,49),jf=Math.pow(2,56),Zf=Math.pow(2,63),Yf=function(e){return e<Vf?1:e<qf?2:e<zf?3:e<$f?4:e<Wf?5:e<Ff?6:e<Gf?7:e<jf?8:e<Zf?9:10},Xf={encode:Uf,decode:kf,encodingLength:Yf},Qf=Xf,Ir=Qf;function Cr(e,t=0){return[Ir.decode(e,t),Ir.decode.bytes]}function Ze(e,t,r=0){return Ir.encode(e,t,r),t}function Ye(e){return Ir.encodingLength(e)}function Ot(e,t){let r=t.byteLength,n=Ye(e),s=n+Ye(r),o=new Uint8Array(s+r);return Ze(e,o,0),Ze(r,o,n),o.set(t,s),new we(e,r,t,o)}function Xe(e){let t=Wt(e),[r,n]=Cr(t),[s,o]=Cr(t.subarray(n)),i=t.subarray(n+o);if(i.byteLength!==s)throw new Error("Incorrect length");return new we(r,s,i,t)}function Ls(e,t){if(e===t)return!0;{let r=t;return e.code===r.code&&e.size===r.size&&r.bytes instanceof Uint8Array&&ma(e.bytes,r.bytes)}}var we=class{code;size;digest;bytes;constructor(t,r,n,s){this.code=t,this.size=r,this.digest=n,this.bytes=s}};function Jf(e,t){return e.code===t}function Aa(e,t){let{bytes:r,version:n}=e;switch(n){case 0:return el(r,Is(e),t??at.encoder);default:return rl(r,Is(e),t??ie.encoder)}}var Ba=new WeakMap;function Is(e){let t=Ba.get(e);if(t==null){let r=new Map;return Ba.set(e,r),r}return t}var lt=class e{code;version;multihash;bytes;"/";constructor(t,r,n,s){this.code=r,this.version=t,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:r}=this;if(t!==Tr)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(r.code!==nl)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return e.createV0(r)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:r}=this.multihash,n=Ot(t,r);return e.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return e.equals(this,t)}static equals(t,r){let n=r;return n!=null&&t.code===n.code&&t.version===n.version&&Ls(t.multihash,n.multihash)}toString(t){return Aa(this,t)}toJSON(){return{"/":Aa(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;let r=t;if(r instanceof e)return r;if(r["/"]!=null&&r["/"]===r.bytes||r.asCID===r){let{version:n,code:s,multihash:o,bytes:i}=r;return new e(n,s,o,i??_a(n,s,o.bytes))}else if(r[sl]===!0){let{version:n,multihash:s,code:o}=r,i=Xe(s);return e.create(n,o,i)}else return null}static create(t,r,n){if(typeof r!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(r!==Tr)throw new Error(`Version 0 CID must use dag-pb (code: ${Tr}) block encoding`);return new e(t,r,n,n.bytes)}case 1:{let s=_a(t,r,n.bytes);return new e(t,r,n,s)}default:throw new Error("Invalid version")}}static createV0(t){return e.create(0,Tr,t)}static createV1(t,r){return e.create(1,t,r)}static decode(t){let[r,n]=e.decodeFirst(t);if(n.length!==0)throw new Error("Incorrect length");return r}static decodeFirst(t){let r=e.inspectBytes(t),n=r.size-r.multihashSize,s=Wt(t.subarray(n,n+r.multihashSize));if(s.byteLength!==r.multihashSize)throw new Error("Incorrect length");let o=s.subarray(r.multihashSize-r.digestSize),i=new we(r.multihashCode,r.digestSize,o,s);return[r.version===0?e.createV0(i):e.createV1(r.codec,i),t.subarray(r.size)]}static inspectBytes(t){let r=0,n=()=>{let[l,g]=Cr(t.subarray(r));return r+=g,l},s=n(),o=Tr;if(s===18?(s=0,r=0):o=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let i=r,a=n(),c=n(),f=r+c,u=f-i;return{version:s,codec:o,multihashCode:a,digestSize:c,multihashSize:u,size:f}}static parse(t,r){let[n,s]=tl(t,r),o=e.decode(s);if(o.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Is(o).set(n,t),o}};function tl(e,t){switch(e[0]){case"Q":{let r=t??at;return[at.prefix,r.decode(`${at.prefix}${e}`)]}case at.prefix:{let r=t??at;return[at.prefix,r.decode(e)]}case ie.prefix:{let r=t??ie;return[ie.prefix,r.decode(e)]}case Lr.prefix:{let r=t??Lr;return[Lr.prefix,r.decode(e)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}}function el(e,t,r){let{prefix:n}=r;if(n!==at.prefix)throw Error(`Cannot string encode V0 in ${r.name} encoding`);let s=t.get(n);if(s==null){let o=r.encode(e).slice(1);return t.set(n,o),o}else return s}function rl(e,t,r){let{prefix:n}=r,s=t.get(n);if(s==null){let o=r.encode(e);return t.set(n,o),o}else return s}var Tr=112,nl=18;function _a(e,t,r){let n=Ye(e),s=n+Ye(t),o=new Uint8Array(s+r.byteLength);return Ze(e,o,0),Ze(t,o,n),o.set(r,s),o}var sl=Symbol.for("@ipld/js-cid/CID");var Cs={};_t(Cs,{identity:()=>Ut});var La=0,ol="identity",Ia=Wt;function il(e,t){if(t?.truncate!=null&&t.truncate!==e.byteLength){if(t.truncate<0||t.truncate>e.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${e.byteLength}`);e=e.subarray(0,t.truncate)}return Ot(La,Ia(e))}var Ut={code:La,name:ol,encode:Ia,digest:il};function ht(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}function dt(e=0){return new Uint8Array(e)}function bt(e=0){return new Uint8Array(e)}function Dt(e,t){t==null&&(t=e.reduce((s,o)=>s+o.length,0));let r=bt(t),n=0;for(let s of e)r.set(s,n),n+=s.length;return r}var Ta=Symbol.for("@achingbrain/uint8arraylist");function Ca(e,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let r=0;for(let n of e){let s=r+n.byteLength;if(t<s)return{buf:n,index:t-r};r=s}throw new RangeError("index is out of bounds")}function wn(e){return!!e?.[Ta]}var Z=class e{bufs;length;[Ta]=!0;constructor(...t){this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let r=0;for(let n of t)if(n instanceof Uint8Array)r+=n.byteLength,this.bufs.push(n);else if(wn(n))r+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=r}prepend(...t){this.prependAll(t)}prependAll(t){let r=0;for(let n of t.reverse())if(n instanceof Uint8Array)r+=n.byteLength,this.bufs.unshift(n);else if(wn(n))r+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=r}get(t){let r=Ca(this.bufs,t);return r.buf[r.index]}set(t,r){let n=Ca(this.bufs,t);n.buf[n.index]=r}write(t,r=0){if(t instanceof Uint8Array)for(let n=0;n<t.length;n++)this.set(r+n,t[n]);else if(wn(t))for(let n=0;n<t.length;n++)this.set(r+n,t.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,r){let{bufs:n,length:s}=this._subList(t,r);return Dt(n,s)}subarray(t,r){let{bufs:n,length:s}=this._subList(t,r);return n.length===1?n[0]:Dt(n,s)}sublist(t,r){let{bufs:n,length:s}=this._subList(t,r),o=new e;return o.length=s,o.bufs=[...n],o}_subList(t,r){if(t=t??0,r=r??this.length,t<0&&(t=this.length+t),r<0&&(r=this.length+r),t<0||r>this.length)throw new RangeError("index is out of bounds");if(t===r)return{bufs:[],length:0};if(t===0&&r===this.length)return{bufs:this.bufs,length:this.length};let n=[],s=0;for(let o=0;o<this.bufs.length;o++){let i=this.bufs[o],a=s,c=a+i.byteLength;if(s=c,t>=c)continue;let f=t>=a&&t<c,u=r>a&&r<=c;if(f&&u){if(t===a&&r===c){n.push(i);break}let l=t-a;n.push(i.subarray(l,l+(r-t)));break}if(f){if(t===0){n.push(i);continue}n.push(i.subarray(t-a));continue}if(u){if(r===c){n.push(i);break}n.push(i.subarray(0,r-a));break}n.push(i)}return{bufs:n,length:r-t}}indexOf(t,r=0){if(!wn(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=t instanceof Uint8Array?t:t.subarray();if(r=Number(r??0),isNaN(r)&&(r=0),r<0&&(r=this.length+r),r<0&&(r=0),t.length===0)return r>this.length?this.length:r;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let o=256,i=new Int32Array(o);for(let l=0;l<o;l++)i[l]=-1;for(let l=0;l<s;l++)i[n[l]]=l;let a=i,c=this.byteLength-n.byteLength,f=n.byteLength-1,u;for(let l=r;l<=c;l+=u){u=0;for(let g=f;g>=0;g--){let p=this.get(l+g);if(n[g]!==p){u=Math.max(1,g-a[p]);break}}if(u===0)return l}return-1}getInt8(t){let r=this.subarray(t,t+1);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt8(0)}setInt8(t,r){let n=bt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,r),this.write(n,t)}getInt16(t,r){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,r)}setInt16(t,r,n){let s=dt(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,r,n),this.write(s,t)}getInt32(t,r){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,r)}setInt32(t,r,n){let s=dt(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,r,n),this.write(s,t)}getBigInt64(t,r){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,r)}setBigInt64(t,r,n){let s=dt(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,r,n),this.write(s,t)}getUint8(t){let r=this.subarray(t,t+1);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint8(0)}setUint8(t,r){let n=bt(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,r),this.write(n,t)}getUint16(t,r){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,r)}setUint16(t,r,n){let s=dt(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,r,n),this.write(s,t)}getUint32(t,r){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,r)}setUint32(t,r,n){let s=dt(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,r,n),this.write(s,t)}getBigUint64(t,r){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,r)}setBigUint64(t,r,n){let s=dt(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,r,n),this.write(s,t)}getFloat32(t,r){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,r)}setFloat32(t,r,n){let s=dt(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,r,n),this.write(s,t)}getFloat64(t,r){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,r)}setFloat64(t,r,n){let s=dt(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,r,n),this.write(s,t)}equals(t){if(t==null||!(t instanceof e)||t.bufs.length!==this.bufs.length)return!1;for(let r=0;r<this.bufs.length;r++)if(!ht(this.bufs[r],t.bufs[r]))return!1;return!0}static fromUint8Arrays(t,r){let n=new e;return n.bufs=t,r==null&&(r=t.reduce((s,o)=>s+o.byteLength,0)),n.length=r,n}};var Ts={};_t(Ts,{base10:()=>cl});var cl=oe({prefix:"9",name:"base10",alphabet:"0123456789"});var Ds={};_t(Ds,{base16:()=>ul,base16upper:()=>fl});var ul=it({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),fl=it({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Rs={};_t(Rs,{base2:()=>ll});var ll=it({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ps={};_t(Ps,{base256emoji:()=>yl});var Da=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),hl=Da.reduce((e,t,r)=>(e[r]=t,e),[]),dl=Da.reduce((e,t,r)=>{let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);return e[n]=r,e},[]);function pl(e){return e.reduce((t,r)=>(t+=hl[r],t),"")}function ml(e){let t=[];for(let r of e){let n=r.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${r}`);let s=dl[n];if(s==null)throw new Error(`Non-base256emoji character: ${r}`);t.push(s)}return new Uint8Array(t)}var yl=je({prefix:"\u{1F680}",name:"base256emoji",encode:pl,decode:ml});var Us={};_t(Us,{base64:()=>gl,base64pad:()=>bl,base64url:()=>Os,base64urlpad:()=>xl});var gl=it({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),bl=it({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Os=it({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),xl=it({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Ks={};_t(Ks,{base8:()=>wl});var wl=it({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Ns={};_t(Ns,{identity:()=>El});var El=je({prefix:"\0",name:"identity",encode:e=>ga(e),decode:e=>ya(e)});var Bm=new TextEncoder,_m=new TextDecoder;var Hs={};_t(Hs,{sha256:()=>Dr,sha512:()=>Bl});var Al=20;function ks({name:e,code:t,encode:r,minDigestLength:n,maxDigestLength:s}){return new Ms(e,t,r,n,s)}var Ms=class{name;code;encode;minDigestLength;maxDigestLength;constructor(t,r,n,s,o){this.name=t,this.code=r,this.encode=n,this.minDigestLength=s??Al,this.maxDigestLength=o}digest(t,r){if(r?.truncate!=null){if(r.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&r.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(t instanceof Uint8Array){let n=this.encode(t);return n instanceof Uint8Array?Ra(n,this.code,r?.truncate):n.then(s=>Ra(s,this.code,r?.truncate))}else throw Error("Unknown type, must be binary type")}};function Ra(e,t,r){if(r!=null&&r!==e.byteLength){if(r>e.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${e.byteLength}`);e=e.subarray(0,r)}return Ot(t,e)}function Oa(e){return async t=>new Uint8Array(await crypto.subtle.digest(e,t))}var Dr=ks({name:"sha2-256",code:18,encode:Oa("SHA-256")}),Bl=ks({name:"sha2-512",code:19,encode:Oa("SHA-512")});var Ee={...Ns,...Rs,...Ks,...Ts,...Ds,...As,...Bs,...vs,...Us,...Ps},Mm={...Hs,...Cs};function Ka(e,t,r,n){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:r},decoder:{decode:n}}}var Ua=Ka("utf8","u",e=>"u"+new TextDecoder("utf8").decode(e),e=>new TextEncoder().encode(e.substring(1))),Vs=Ka("ascii","a",e=>{let t="a";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t},e=>{e=e.substring(1);let t=bt(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}),_l={utf8:Ua,"utf-8":Ua,hex:Ee.base16,latin1:Vs,ascii:Vs,binary:Vs,...Ee},En=_l;function Y(e,t="utf8"){let r=En[t];if(r==null)throw new Error(`Unsupported encoding "${t}"`);return r.decoder.decode(`${r.prefix}${e}`)}function z(e,t="utf8"){let r=En[t];if(r==null)throw new Error(`Unsupported encoding "${t}"`);return r.encoder.encode(e).substring(1)}var Ll=parseInt("11111",2),qs=parseInt("10000000",2),Il=parseInt("01111111",2),Na={0:Rr,1:Rr,2:Cl,3:Rl,4:Pl,5:Dl,6:Tl,16:Rr,22:Rr,48:Rr};function Gt(e,t={offset:0}){let r=e[t.offset]&Ll;if(t.offset++,Na[r]!=null)return Na[r](e,t);throw new Error("No decoder for tag "+r)}function Pr(e,t){let r=0;if((e[t.offset]&qs)===qs){let n=e[t.offset]&Il,s="0x";t.offset++;for(let o=0;o<n;o++,t.offset++)s+=e[t.offset].toString(16).padStart(2,"0");r=parseInt(s,16)}else r=e[t.offset],t.offset++;return r}function Rr(e,t){Pr(e,t);let r=[];for(;!(t.offset>=e.byteLength);){let n=Gt(e,t);if(n===null)break;r.push(n)}return r}function Cl(e,t){let r=Pr(e,t),n=t.offset,s=t.offset+r,o=[];for(let i=n;i<s;i++)i===n&&e[i]===0||o.push(e[i]);return t.offset+=r,Uint8Array.from(o)}function Tl(e,t){let r=Pr(e,t),n=t.offset+r,s=e[t.offset];t.offset++;let o=0,i=0;s<40?(o=0,i=s):s<80?(o=1,i=s-40):(o=2,i=s-80);let a=`${o}.${i}`,c=[];for(;t.offset<n;){let f=e[t.offset];if(t.offset++,c.push(f&127),f<128){c.reverse();let u=0;for(let l=0;l<c.length;l++)u+=c[l]<<l*7;a+=`.${u}`,c=[]}}return a}function Dl(e,t){return t.offset++,null}function Rl(e,t){let r=Pr(e,t),n=e[t.offset];t.offset++;let s=e.subarray(t.offset,t.offset+r-1);if(t.offset+=r,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function Pl(e,t){let r=Pr(e,t),n=e.subarray(t.offset,t.offset+r);return t.offset+=r,n}function Ol(e){let t=e.toString(16);t.length%2===1&&(t="0"+t);let r=new Z;for(let n=0;n<t.length;n+=2)r.append(Uint8Array.from([parseInt(`${t[n]}${t[n+1]}`,16)]));return r}function zs(e){if(e.byteLength<128)return Uint8Array.from([e.byteLength]);let t=Ol(e.byteLength);return new Z(Uint8Array.from([t.byteLength|qs]),t)}function It(e){let t=new Z,r=128;return(e.subarray()[0]&r)===r&&t.append(Uint8Array.from([0])),t.append(e),new Z(Uint8Array.from([2]),zs(t),t)}function Sn(e){let t=Uint8Array.from([0]),r=new Z(t,e);return new Z(Uint8Array.from([3]),zs(r),r)}function ae(e,t=48){let r=new Z;for(let n of e)r.append(n);return new Z(Uint8Array.from([t]),zs(r),r)}async function Ma(e,t,r,n){let s=await crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:e.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let o=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,t,r.subarray());return n?.signal?.throwIfAborted(),o}var Ul=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Kl=Uint8Array.from([6,5,43,129,4,0,34]),Nl=Uint8Array.from([6,5,43,129,4,0,35]),Ml={ext:!0,kty:"EC",crv:"P-256"},kl={ext:!0,kty:"EC",crv:"P-384"},Hl={ext:!0,kty:"EC",crv:"P-521"},$s=32,Ws=48,Fs=66;function Gs(e){let t=Gt(e);return ka(t)}function ka(e){let t=e[1][1][0],r=1,n,s;if(t.byteLength===$s*2+1)return n=z(t.subarray(r,r+$s),"base64url"),s=z(t.subarray(r+$s),"base64url"),new Qe({...Ml,key_ops:["verify"],x:n,y:s});if(t.byteLength===Ws*2+1)return n=z(t.subarray(r,r+Ws),"base64url"),s=z(t.subarray(r+Ws),"base64url"),new Qe({...kl,key_ops:["verify"],x:n,y:s});if(t.byteLength===Fs*2+1)return n=z(t.subarray(r,r+Fs),"base64url"),s=z(t.subarray(r+Fs),"base64url"),new Qe({...Hl,key_ops:["verify"],x:n,y:s});throw new et(`coordinates were wrong length, got ${t.byteLength}, expected 65, 97 or 133`)}function Ha(e){return ae([It(Uint8Array.from([1])),ae([Vl(e.crv)],160),ae([Sn(new Z(Uint8Array.from([4]),Y(e.x??"","base64url"),Y(e.y??"","base64url")))],161)]).subarray()}function Vl(e){if(e==="P-256")return Ul;if(e==="P-384")return Kl;if(e==="P-521")return Nl;throw new et(`Invalid curve ${e}`)}var Qe=class{type="ECDSA";jwk;_raw;constructor(t){this.jwk=t}get raw(){return this._raw==null&&(this._raw=Ha(this.jwk)),this._raw}toMultihash(){return Ut.digest(ce(this))}toCID(){return lt.createV1(114,this.toMultihash())}toString(){return at.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:ht(this.raw,t.raw)}async verify(t,r,n){return Ma(this.jwk,r,t,n)}};function Se(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function Rt(e,t=""){if(!Number.isSafeInteger(e)||e<0){let r=t&&`"${t}" `;throw new Error(`${r}expected integer >= 0, got ${e}`)}}function V(e,t,r=""){let n=Se(e),s=e?.length,o=t!==void 0;if(!n||o&&s!==t){let i=r&&`"${r}" `,a=o?` of length ${t}`:"",c=n?`length=${s}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function ve(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Rt(e.outputLen),Rt(e.blockLen)}function Je(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function qa(e,t){V(e,void 0,"digestInto() output");let r=t.outputLen;if(e.length<r)throw new Error('"digestInto() output" expected to be of length >='+r)}function Kt(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function vn(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Nt(e,t){return e<<32-t|e>>>t}var za=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",ql=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function Zt(e){if(V(e),za)return e.toHex();let t="";for(let r=0;r<e.length;r++)t+=ql[e[r]];return t}var jt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Va(e){if(e>=jt._0&&e<=jt._9)return e-jt._0;if(e>=jt.A&&e<=jt.F)return e-(jt.A-10);if(e>=jt.a&&e<=jt.f)return e-(jt.a-10)}function Yt(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(za)return Uint8Array.fromHex(e);let t=e.length,r=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let n=new Uint8Array(r);for(let s=0,o=0;s<r;s++,o+=2){let i=Va(e.charCodeAt(o)),a=Va(e.charCodeAt(o+1));if(i===void 0||a===void 0){let c=e[o]+e[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}n[s]=i*16+a}return n}function Ct(...e){let t=0;for(let n=0;n<e.length;n++){let s=e[n];V(s),t+=s.length}let r=new Uint8Array(t);for(let n=0,s=0;n<e.length;n++){let o=e[n];r.set(o,s),s+=o.length}return r}function js(e,t={}){let r=(s,o)=>e(o).update(s).digest(),n=e(void 0);return r.outputLen=n.outputLen,r.blockLen=n.blockLen,r.create=s=>e(s),Object.assign(r,t),Object.freeze(r)}function ue(e=32){let t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}var Zs=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});function $a(e,t,r){return e&t^~e&r}function Wa(e,t,r){return e&t^e&r^t&r}var Or=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(t,r,n,s){this.blockLen=t,this.outputLen=r,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(t),this.view=vn(this.buffer)}update(t){Je(this),V(t);let{view:r,buffer:n,blockLen:s}=this,o=t.length;for(let i=0;i<o;){let a=Math.min(s-this.pos,o-i);if(a===s){let c=vn(t);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(t.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(r,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Je(this),qa(t,this),this.finished=!0;let{buffer:r,view:n,blockLen:s,isLE:o}=this,{pos:i}=this;r[i++]=128,Kt(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let l=i;l<s;l++)r[l]=0;n.setBigUint64(s-8,BigInt(this.length*8),o),this.process(n,0);let a=vn(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let f=c/4,u=this.get();if(f>u.length)throw new Error("_sha2: outputLen bigger than state");for(let l=0;l<f;l++)a.setUint32(4*l,u[l],o)}digest(){let{buffer:t,outputLen:r}=this;this.digestInto(t);let n=t.slice(0,r);return this.destroy(),n}_cloneInto(t){t||=new this.constructor,t.set(...this.get());let{blockLen:r,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return t.destroyed=i,t.finished=o,t.length=s,t.pos=a,s%r&&t.buffer.set(n),t}clone(){return this._cloneInto()}},Xt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var xt=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var An=BigInt(4294967295),Fa=BigInt(32);function zl(e,t=!1){return t?{h:Number(e&An),l:Number(e>>Fa&An)}:{h:Number(e>>Fa&An)|0,l:Number(e&An)|0}}function Ga(e,t=!1){let r=e.length,n=new Uint32Array(r),s=new Uint32Array(r);for(let o=0;o<r;o++){let{h:i,l:a}=zl(e[o],t);[n[o],s[o]]=[i,a]}return[n,s]}var Ys=(e,t,r)=>e>>>r,Xs=(e,t,r)=>e<<32-r|t>>>r,Ae=(e,t,r)=>e>>>r|t<<32-r,Be=(e,t,r)=>e<<32-r|t>>>r,Ur=(e,t,r)=>e<<64-r|t>>>r-32,Kr=(e,t,r)=>e>>>r-32|t<<64-r;function kt(e,t,r,n){let s=(t>>>0)+(n>>>0);return{h:e+r+(s/2**32|0)|0,l:s|0}}var ja=(e,t,r)=>(e>>>0)+(t>>>0)+(r>>>0),Za=(e,t,r,n)=>t+r+n+(e/2**32|0)|0,Ya=(e,t,r,n)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0),Xa=(e,t,r,n,s)=>t+r+n+s+(e/2**32|0)|0,Qa=(e,t,r,n,s)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0)+(s>>>0),Ja=(e,t,r,n,s,o)=>t+r+n+s+o+(e/2**32|0)|0;var Wl=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),fe=new Uint32Array(64),Qs=class extends Or{constructor(t){super(64,t,8,!1)}get(){let{A:t,B:r,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[t,r,n,s,o,i,a,c]}set(t,r,n,s,o,i,a,c){this.A=t|0,this.B=r|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(t,r){for(let l=0;l<16;l++,r+=4)fe[l]=t.getUint32(r,!1);for(let l=16;l<64;l++){let g=fe[l-15],p=fe[l-2],d=Nt(g,7)^Nt(g,18)^g>>>3,S=Nt(p,17)^Nt(p,19)^p>>>10;fe[l]=S+fe[l-7]+d+fe[l-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:f,H:u}=this;for(let l=0;l<64;l++){let g=Nt(a,6)^Nt(a,11)^Nt(a,25),p=u+g+$a(a,c,f)+Wl[l]+fe[l]|0,S=(Nt(n,2)^Nt(n,13)^Nt(n,22))+Wa(n,s,o)|0;u=f,f=c,c=a,a=i+p|0,i=o,o=s,s=n,n=p+S|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,f=f+this.G|0,u=u+this.H|0,this.set(n,s,o,i,a,c,f,u)}roundClean(){Kt(fe)}destroy(){this.set(0,0,0,0,0,0,0,0),Kt(this.buffer)}},Js=class extends Qs{A=Xt[0]|0;B=Xt[1]|0;C=Xt[2]|0;D=Xt[3]|0;E=Xt[4]|0;F=Xt[5]|0;G=Xt[6]|0;H=Xt[7]|0;constructor(){super(32)}};var tc=Ga(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))),Fl=tc[0],Gl=tc[1],le=new Uint32Array(80),he=new Uint32Array(80),to=class extends Or{constructor(t){super(128,t,16,!1)}get(){let{Ah:t,Al:r,Bh:n,Bl:s,Ch:o,Cl:i,Dh:a,Dl:c,Eh:f,El:u,Fh:l,Fl:g,Gh:p,Gl:d,Hh:S,Hl:h}=this;return[t,r,n,s,o,i,a,c,f,u,l,g,p,d,S,h]}set(t,r,n,s,o,i,a,c,f,u,l,g,p,d,S,h){this.Ah=t|0,this.Al=r|0,this.Bh=n|0,this.Bl=s|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=f|0,this.El=u|0,this.Fh=l|0,this.Fl=g|0,this.Gh=p|0,this.Gl=d|0,this.Hh=S|0,this.Hl=h|0}process(t,r){for(let w=0;w<16;w++,r+=4)le[w]=t.getUint32(r),he[w]=t.getUint32(r+=4);for(let w=16;w<80;w++){let D=le[w-15]|0,N=he[w-15]|0,M=Ae(D,N,1)^Ae(D,N,8)^Ys(D,N,7),k=Be(D,N,1)^Be(D,N,8)^Xs(D,N,7),_=le[w-2]|0,v=he[w-2]|0,O=Ae(_,v,19)^Ur(_,v,61)^Ys(_,v,6),K=Be(_,v,19)^Kr(_,v,61)^Xs(_,v,6),T=Ya(k,K,he[w-7],he[w-16]),x=Xa(T,M,O,le[w-7],le[w-16]);le[w]=x|0,he[w]=T|0}let{Ah:n,Al:s,Bh:o,Bl:i,Ch:a,Cl:c,Dh:f,Dl:u,Eh:l,El:g,Fh:p,Fl:d,Gh:S,Gl:h,Hh:b,Hl:B}=this;for(let w=0;w<80;w++){let D=Ae(l,g,14)^Ae(l,g,18)^Ur(l,g,41),N=Be(l,g,14)^Be(l,g,18)^Kr(l,g,41),M=l&p^~l&S,k=g&d^~g&h,_=Qa(B,N,k,Gl[w],he[w]),v=Ja(_,b,D,M,Fl[w],le[w]),O=_|0,K=Ae(n,s,28)^Ur(n,s,34)^Ur(n,s,39),T=Be(n,s,28)^Kr(n,s,34)^Kr(n,s,39),x=n&o^n&a^o&a,m=s&i^s&c^i&c;b=S|0,B=h|0,S=p|0,h=d|0,p=l|0,d=g|0,{h:l,l:g}=kt(f|0,u|0,v|0,O|0),f=a|0,u=c|0,a=o|0,c=i|0,o=n|0,i=s|0;let y=ja(O,T,m);n=Za(y,v,K,x),s=y|0}({h:n,l:s}=kt(this.Ah|0,this.Al|0,n|0,s|0)),{h:o,l:i}=kt(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=kt(this.Ch|0,this.Cl|0,a|0,c|0),{h:f,l:u}=kt(this.Dh|0,this.Dl|0,f|0,u|0),{h:l,l:g}=kt(this.Eh|0,this.El|0,l|0,g|0),{h:p,l:d}=kt(this.Fh|0,this.Fl|0,p|0,d|0),{h:S,l:h}=kt(this.Gh|0,this.Gl|0,S|0,h|0),{h:b,l:B}=kt(this.Hh|0,this.Hl|0,b|0,B|0),this.set(n,s,o,i,a,c,f,u,l,g,p,d,S,h,b,B)}roundClean(){Kt(le,he)}destroy(){Kt(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},eo=class extends to{Ah=xt[0]|0;Al=xt[1]|0;Bh=xt[2]|0;Bl=xt[3]|0;Ch=xt[4]|0;Cl=xt[5]|0;Dh=xt[6]|0;Dl=xt[7]|0;Eh=xt[8]|0;El=xt[9]|0;Fh=xt[10]|0;Fl=xt[11]|0;Gh=xt[12]|0;Gl=xt[13]|0;Hh=xt[14]|0;Hl=xt[15]|0;constructor(){super(64)}};var Ht=js(()=>new Js,Zs(1));var ec=js(()=>new eo,Zs(3));var no=BigInt(0),ro=BigInt(1);function Qt(e,t=""){if(typeof e!="boolean"){let r=t&&`"${t}" `;throw new Error(r+"expected boolean, got type="+typeof e)}return e}function rc(e){if(typeof e=="bigint"){if(!Bn(e))throw new Error("positive bigint expected, got "+e)}else Rt(e);return e}function Nr(e){let t=rc(e).toString(16);return t.length&1?"0"+t:t}function nc(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return e===""?no:BigInt("0x"+e)}function tr(e){return nc(Zt(e))}function Vt(e){return nc(Zt(_e(V(e)).reverse()))}function _n(e,t){Rt(t),e=rc(e);let r=Yt(e.toString(16).padStart(t*2,"0"));if(r.length!==t)throw new Error("number too large");return r}function Mr(e,t){return _n(e,t).reverse()}function _e(e){return Uint8Array.from(e)}var Bn=e=>typeof e=="bigint"&&no<=e;function jl(e,t,r){return Bn(e)&&Bn(t)&&Bn(r)&&t<=e&&e<r}function de(e,t,r,n){if(!jl(t,r,n))throw new Error("expected valid "+e+": "+r+" <= n < "+n+", got "+t)}function so(e){let t;for(t=0;e>no;e>>=ro,t+=1);return t}var kr=e=>(ro<<BigInt(e))-ro;function sc(e,t,r){if(Rt(e,"hashLen"),Rt(t,"qByteLen"),typeof r!="function")throw new Error("hmacFn must be a function");let n=h=>new Uint8Array(h),s=Uint8Array.of(),o=Uint8Array.of(0),i=Uint8Array.of(1),a=1e3,c=n(e),f=n(e),u=0,l=()=>{c.fill(1),f.fill(0),u=0},g=(...h)=>r(f,Ct(c,...h)),p=(h=s)=>{f=g(o,h),c=g(),h.length!==0&&(f=g(i,h),c=g())},d=()=>{if(u++>=a)throw new Error("drbg: tried max amount of iterations");let h=0,b=[];for(;h<t;){c=g();let B=c.slice();b.push(B),h+=c.length}return Ct(...b)};return(h,b)=>{l(),p(h);let B;for(;!(B=b(d()));)p();return l(),B}}function qt(e,t={},r={}){if(!e||typeof e!="object")throw new Error("expected valid options object");function n(o,i,a){let c=e[o];if(a&&c===void 0)return;let f=typeof c;if(f!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${f}`)}let s=(o,i)=>Object.entries(o).forEach(([a,c])=>n(a,c,i));s(t,!1),s(r,!0)}function er(e){let t=new WeakMap;return(r,...n)=>{let s=t.get(r);if(s!==void 0)return s;let o=e(r,...n);return t.set(r,o),o}}var Lt=BigInt(0),pt=BigInt(1),Le=BigInt(2),ac=BigInt(3),cc=BigInt(4),uc=BigInt(5),Zl=BigInt(7),fc=BigInt(8),Yl=BigInt(9),lc=BigInt(16);function ot(e,t){let r=e%t;return r>=Lt?r:t+r}function rt(e,t,r){let n=e;for(;t-- >Lt;)n*=n,n%=r;return n}function oc(e,t){if(e===Lt)throw new Error("invert: expected non-zero number");if(t<=Lt)throw new Error("invert: expected positive modulus, got "+t);let r=ot(e,t),n=t,s=Lt,o=pt,i=pt,a=Lt;for(;r!==Lt;){let f=n/r,u=n%r,l=s-i*f,g=o-a*f;n=r,r=u,s=i,o=a,i=l,a=g}if(n!==pt)throw new Error("invert: does not exist");return ot(s,t)}function io(e,t,r){if(!e.eql(e.sqr(t),r))throw new Error("Cannot find square root")}function hc(e,t){let r=(e.ORDER+pt)/cc,n=e.pow(t,r);return io(e,n,t),n}function Xl(e,t){let r=(e.ORDER-uc)/fc,n=e.mul(t,Le),s=e.pow(n,r),o=e.mul(t,s),i=e.mul(e.mul(o,Le),s),a=e.mul(o,e.sub(i,e.ONE));return io(e,a,t),a}function Ql(e){let t=rr(e),r=dc(e),n=r(t,t.neg(t.ONE)),s=r(t,n),o=r(t,t.neg(n)),i=(e+Zl)/lc;return(a,c)=>{let f=a.pow(c,i),u=a.mul(f,n),l=a.mul(f,s),g=a.mul(f,o),p=a.eql(a.sqr(u),c),d=a.eql(a.sqr(l),c);f=a.cmov(f,u,p),u=a.cmov(g,l,d);let S=a.eql(a.sqr(u),c),h=a.cmov(f,u,S);return io(a,h,c),h}}function dc(e){if(e<ac)throw new Error("sqrt is not defined for small field");let t=e-pt,r=0;for(;t%Le===Lt;)t/=Le,r++;let n=Le,s=rr(e);for(;ic(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(r===1)return hc;let o=s.pow(n,t),i=(t+pt)/Le;return function(c,f){if(c.is0(f))return f;if(ic(c,f)!==1)throw new Error("Cannot find square root");let u=r,l=c.mul(c.ONE,o),g=c.pow(f,t),p=c.pow(f,i);for(;!c.eql(g,c.ONE);){if(c.is0(g))return c.ZERO;let d=1,S=c.sqr(g);for(;!c.eql(S,c.ONE);)if(d++,S=c.sqr(S),d===u)throw new Error("Cannot find square root");let h=pt<<BigInt(u-d-1),b=c.pow(l,h);u=d,l=c.sqr(b),g=c.mul(g,l),p=c.mul(p,b)}return p}}function Jl(e){return e%cc===ac?hc:e%fc===uc?Xl:e%lc===Yl?Ql(e):dc(e)}var pc=(e,t)=>(ot(e,t)&pt)===pt,th=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function ao(e){let t={ORDER:"bigint",BYTES:"number",BITS:"number"},r=th.reduce((n,s)=>(n[s]="function",n),t);return qt(e,r),e}function eh(e,t,r){if(r<Lt)throw new Error("invalid exponent, negatives unsupported");if(r===Lt)return e.ONE;if(r===pt)return t;let n=e.ONE,s=t;for(;r>Lt;)r&pt&&(n=e.mul(n,s)),s=e.sqr(s),r>>=pt;return n}function Hr(e,t,r=!1){let n=new Array(t.length).fill(r?e.ZERO:void 0),s=t.reduce((i,a,c)=>e.is0(a)?i:(n[c]=i,e.mul(i,a)),e.ONE),o=e.inv(s);return t.reduceRight((i,a,c)=>e.is0(a)?i:(n[c]=e.mul(i,n[c]),e.mul(i,a)),o),n}function ic(e,t){let r=(e.ORDER-pt)/Le,n=e.pow(t,r),s=e.eql(n,e.ONE),o=e.eql(n,e.ZERO),i=e.eql(n,e.neg(e.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function rh(e,t){t!==void 0&&Rt(t);let r=t!==void 0?t:e.toString(2).length,n=Math.ceil(r/8);return{nBitLength:r,nByteLength:n}}var oo=class{ORDER;BITS;BYTES;isLE;ZERO=Lt;ONE=pt;_lengths;_sqrt;_mod;constructor(t,r={}){if(t<=Lt)throw new Error("invalid field: expected ORDER > 0, got "+t);let n;this.isLE=!1,r!=null&&typeof r=="object"&&(typeof r.BITS=="number"&&(n=r.BITS),typeof r.sqrt=="function"&&(this.sqrt=r.sqrt),typeof r.isLE=="boolean"&&(this.isLE=r.isLE),r.allowedLengths&&(this._lengths=r.allowedLengths?.slice()),typeof r.modFromBytes=="boolean"&&(this._mod=r.modFromBytes));let{nBitLength:s,nByteLength:o}=rh(t,n);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=t,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(t){return ot(t,this.ORDER)}isValid(t){if(typeof t!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof t);return Lt<=t&&t<this.ORDER}is0(t){return t===Lt}isValidNot0(t){return!this.is0(t)&&this.isValid(t)}isOdd(t){return(t&pt)===pt}neg(t){return ot(-t,this.ORDER)}eql(t,r){return t===r}sqr(t){return ot(t*t,this.ORDER)}add(t,r){return ot(t+r,this.ORDER)}sub(t,r){return ot(t-r,this.ORDER)}mul(t,r){return ot(t*r,this.ORDER)}pow(t,r){return eh(this,t,r)}div(t,r){return ot(t*oc(r,this.ORDER),this.ORDER)}sqrN(t){return t*t}addN(t,r){return t+r}subN(t,r){return t-r}mulN(t,r){return t*r}inv(t){return oc(t,this.ORDER)}sqrt(t){return this._sqrt||(this._sqrt=Jl(this.ORDER)),this._sqrt(this,t)}toBytes(t){return this.isLE?Mr(t,this.BYTES):_n(t,this.BYTES)}fromBytes(t,r=!1){V(t);let{_lengths:n,BYTES:s,isLE:o,ORDER:i,_mod:a}=this;if(n){if(!n.includes(t.length)||t.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+t.length);let f=new Uint8Array(s);f.set(t,o?0:f.length-t.length),t=f}if(t.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+t.length);let c=o?Vt(t):tr(t);if(a&&(c=ot(c,i)),!r&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(t){return Hr(this,t)}cmov(t,r,n){return n?r:t}};function rr(e,t={}){return new oo(e,t)}function mc(e){if(typeof e!="bigint")throw new Error("field order must be bigint");let t=e.toString(2).length;return Math.ceil(t/8)}function co(e){let t=mc(e);return t+Math.ceil(t/2)}function uo(e,t,r=!1){V(e);let n=e.length,s=mc(t),o=co(t);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);let i=r?Vt(e):tr(e),a=ot(i,t-pt)+pt;return r?Mr(a,s):_n(a,s)}var nr=BigInt(0),Ie=BigInt(1);function Vr(e,t){let r=t.negate();return e?r:t}function Ce(e,t){let r=Hr(e.Fp,t.map(n=>n.Z));return t.map((n,s)=>e.fromAffine(n.toAffine(r[s])))}function xc(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function fo(e,t){xc(e,t);let r=Math.ceil(t/e)+1,n=2**(e-1),s=2**e,o=kr(e),i=BigInt(e);return{windows:r,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function yc(e,t,r){let{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=r,a=Number(e&s),c=e>>i;a>n&&(a-=o,c+=Ie);let f=t*n,u=f+Math.abs(a)-1,l=a===0,g=a<0,p=t%2!==0;return{nextN:c,offset:u,isZero:l,isNeg:g,isNegF:p,offsetF:f}}var lo=new WeakMap,wc=new WeakMap;function ho(e){return wc.get(e)||1}function gc(e){if(e!==nr)throw new Error("invalid wNAF")}var sr=class{BASE;ZERO;Fn;bits;constructor(t,r){this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=r}_unsafeLadder(t,r,n=this.ZERO){let s=t;for(;r>nr;)r&Ie&&(n=n.add(s)),s=s.double(),r>>=Ie;return n}precomputeWindow(t,r){let{windows:n,windowSize:s}=fo(r,this.bits),o=[],i=t,a=i;for(let c=0;c<n;c++){a=i,o.push(a);for(let f=1;f<s;f++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(t,r,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,i=fo(t,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:f,isZero:u,isNeg:l,isNegF:g,offsetF:p}=yc(n,a,i);n=c,u?o=o.add(Vr(g,r[p])):s=s.add(Vr(l,r[f]))}return gc(n),{p:s,f:o}}wNAFUnsafe(t,r,n,s=this.ZERO){let o=fo(t,this.bits);for(let i=0;i<o.windows&&n!==nr;i++){let{nextN:a,offset:c,isZero:f,isNeg:u}=yc(n,i,o);if(n=a,!f){let l=r[c];s=s.add(u?l.negate():l)}}return gc(n),s}getPrecomputes(t,r,n){let s=lo.get(r);return s||(s=this.precomputeWindow(r,t),t!==1&&(typeof n=="function"&&(s=n(s)),lo.set(r,s))),s}cached(t,r,n){let s=ho(t);return this.wNAF(s,this.getPrecomputes(s,t,n),r)}unsafe(t,r,n,s){let o=ho(t);return o===1?this._unsafeLadder(t,r,s):this.wNAFUnsafe(o,this.getPrecomputes(o,t,n),r,s)}createCache(t,r){xc(r,this.bits),wc.set(t,r),lo.delete(t)}hasCache(t){return ho(t)!==1}};function Ec(e,t,r,n){let s=t,o=e.ZERO,i=e.ZERO;for(;r>nr||n>nr;)r&Ie&&(o=o.add(s)),n&Ie&&(i=i.add(s)),s=s.double(),r>>=Ie,n>>=Ie;return{p1:o,p2:i}}function bc(e,t,r){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return ao(t),t}else return rr(e,{isLE:r})}function Ln(e,t,r={},n){if(n===void 0&&(n=e==="edwards"),!t||typeof t!="object")throw new Error(`expected valid ${e} CURVE object`);for(let c of["p","n","h"]){let f=t[c];if(!(typeof f=="bigint"&&f>nr))throw new Error(`CURVE.${c} must be positive bigint`)}let s=bc(t.p,r.Fp,n),o=bc(t.n,r.Fn,n),a=["Gx","Gy","a",e==="weierstrass"?"b":"d"];for(let c of a)if(!s.isValid(t[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return t=Object.freeze(Object.assign({},t)),{CURVE:t,Fp:s,Fn:o}}function or(e,t){return function(n){let s=e(n);return{secretKey:s,publicKey:t(s)}}}var pe=BigInt(0),mt=BigInt(1),po=BigInt(2),nh=BigInt(8);function sh(e,t,r,n){let s=e.sqr(r),o=e.sqr(n),i=e.add(e.mul(t.a,s),o),a=e.add(e.ONE,e.mul(t.d,e.mul(s,o)));return e.eql(i,a)}function Sc(e,t={}){let r=Ln("edwards",e,t,t.FpFnLE),{Fp:n,Fn:s}=r,o=r.CURVE,{h:i}=o;qt(t,{},{uvRatio:"function"});let a=po<<BigInt(s.BYTES*8)-mt,c=h=>n.create(h),f=t.uvRatio||((h,b)=>{try{return{isValid:!0,value:n.sqrt(n.div(h,b))}}catch{return{isValid:!1,value:pe}}});if(!sh(n,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function u(h,b,B=!1){let w=B?mt:pe;return de("coordinate "+h,b,w,a),b}function l(h){if(!(h instanceof d))throw new Error("EdwardsPoint expected")}let g=er((h,b)=>{let{X:B,Y:w,Z:D}=h,N=h.is0();b==null&&(b=N?nh:n.inv(D));let M=c(B*b),k=c(w*b),_=n.mul(D,b);if(N)return{x:pe,y:mt};if(_!==mt)throw new Error("invZ was invalid");return{x:M,y:k}}),p=er(h=>{let{a:b,d:B}=o;if(h.is0())throw new Error("bad point: ZERO");let{X:w,Y:D,Z:N,T:M}=h,k=c(w*w),_=c(D*D),v=c(N*N),O=c(v*v),K=c(k*b),T=c(v*c(K+_)),x=c(O+c(B*c(k*_)));if(T!==x)throw new Error("bad point: equation left != right (1)");let m=c(w*D),y=c(N*M);if(m!==y)throw new Error("bad point: equation left != right (2)");return!0});class d{static BASE=new d(o.Gx,o.Gy,mt,c(o.Gx*o.Gy));static ZERO=new d(pe,mt,mt,pe);static Fp=n;static Fn=s;X;Y;Z;T;constructor(b,B,w,D){this.X=u("x",b),this.Y=u("y",B),this.Z=u("z",w,!0),this.T=u("t",D),Object.freeze(this)}static CURVE(){return o}static fromAffine(b){if(b instanceof d)throw new Error("extended point not allowed");let{x:B,y:w}=b||{};return u("x",B),u("y",w),new d(B,w,mt,c(B*w))}static fromBytes(b,B=!1){let w=n.BYTES,{a:D,d:N}=o;b=_e(V(b,w,"point")),Qt(B,"zip215");let M=_e(b),k=b[w-1];M[w-1]=k&-129;let _=Vt(M),v=B?a:n.ORDER;de("point.y",_,pe,v);let O=c(_*_),K=c(O-mt),T=c(N*O-D),{isValid:x,value:m}=f(K,T);if(!x)throw new Error("bad point: invalid y coordinate");let y=(m&mt)===mt,A=(k&128)!==0;if(!B&&m===pe&&A)throw new Error("bad point: x=0 and x_0=1");return A!==y&&(m=c(-m)),d.fromAffine({x:m,y:_})}static fromHex(b,B=!1){return d.fromBytes(Yt(b),B)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(b=8,B=!0){return S.createCache(this,b),B||this.multiply(po),this}assertValidity(){p(this)}equals(b){l(b);let{X:B,Y:w,Z:D}=this,{X:N,Y:M,Z:k}=b,_=c(B*k),v=c(N*D),O=c(w*k),K=c(M*D);return _===v&&O===K}is0(){return this.equals(d.ZERO)}negate(){return new d(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:b}=o,{X:B,Y:w,Z:D}=this,N=c(B*B),M=c(w*w),k=c(po*c(D*D)),_=c(b*N),v=B+w,O=c(c(v*v)-N-M),K=_+M,T=K-k,x=_-M,m=c(O*T),y=c(K*x),A=c(O*x),I=c(T*K);return new d(m,y,I,A)}add(b){l(b);let{a:B,d:w}=o,{X:D,Y:N,Z:M,T:k}=this,{X:_,Y:v,Z:O,T:K}=b,T=c(D*_),x=c(N*v),m=c(k*w*K),y=c(M*O),A=c((D+N)*(_+v)-T-x),I=y-m,L=y+m,E=c(x-B*T),C=c(A*I),R=c(L*E),P=c(A*E),F=c(I*L);return new d(C,R,F,P)}subtract(b){return this.add(b.negate())}multiply(b){if(!s.isValidNot0(b))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:B,f:w}=S.cached(this,b,D=>Ce(d,D));return Ce(d,[B,w])[0]}multiplyUnsafe(b,B=d.ZERO){if(!s.isValid(b))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return b===pe?d.ZERO:this.is0()||b===mt?this:S.unsafe(this,b,w=>Ce(d,w),B)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return S.unsafe(this,o.n).is0()}toAffine(b){return g(this,b)}clearCofactor(){return i===mt?this:this.multiplyUnsafe(i)}toBytes(){let{x:b,y:B}=this.toAffine(),w=n.toBytes(B);return w[w.length-1]|=b&mt?128:0,w}toHex(){return Zt(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let S=new sr(d,s.BITS);return d.BASE.precompute(8),d}function vc(e,t,r={}){if(typeof t!="function")throw new Error('"hash" function param is required');qt(r,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=r,{BASE:s,Fp:o,Fn:i}=e,a=r.randomBytes||ue,c=r.adjustScalarBytes||(_=>_),f=r.domain||((_,v,O)=>{if(Qt(O,"phflag"),v.length||O)throw new Error("Contexts/pre-hash are not supported");return _});function u(_){return i.create(Vt(_))}function l(_){let v=w.secretKey;V(_,w.secretKey,"secretKey");let O=V(t(_),2*v,"hashedSecretKey"),K=c(O.slice(0,v)),T=O.slice(v,2*v),x=u(K);return{head:K,prefix:T,scalar:x}}function g(_){let{head:v,prefix:O,scalar:K}=l(_),T=s.multiply(K),x=T.toBytes();return{head:v,prefix:O,scalar:K,point:T,pointBytes:x}}function p(_){return g(_).pointBytes}function d(_=Uint8Array.of(),...v){let O=Ct(...v);return u(t(f(O,V(_,void 0,"context"),!!n)))}function S(_,v,O={}){_=V(_,void 0,"message"),n&&(_=n(_));let{prefix:K,scalar:T,pointBytes:x}=g(v),m=d(O.context,K,_),y=s.multiply(m).toBytes(),A=d(O.context,y,x,_),I=i.create(m+A*T);if(!i.isValid(I))throw new Error("sign failed: invalid s");let L=Ct(y,i.toBytes(I));return V(L,w.signature,"result")}let h={zip215:!0};function b(_,v,O,K=h){let{context:T,zip215:x}=K,m=w.signature;_=V(_,m,"signature"),v=V(v,void 0,"message"),O=V(O,w.publicKey,"publicKey"),x!==void 0&&Qt(x,"zip215"),n&&(v=n(v));let y=m/2,A=_.subarray(0,y),I=Vt(_.subarray(y,m)),L,E,C;try{L=e.fromBytes(O,x),E=e.fromBytes(A,x),C=s.multiplyUnsafe(I)}catch{return!1}if(!x&&L.isSmallOrder())return!1;let R=d(T,E.toBytes(),L.toBytes(),v);return E.add(L.multiplyUnsafe(R)).subtract(C).clearCofactor().is0()}let B=o.BYTES,w={secretKey:B,publicKey:B,signature:2*B,seed:B};function D(_=a(w.seed)){return V(_,w.seed,"seed")}function N(_){return Se(_)&&_.length===i.BYTES}function M(_,v){try{return!!e.fromBytes(_,v)}catch{return!1}}let k={getExtendedPublicKey:g,randomSecretKey:D,isValidSecretKey:N,isValidPublicKey:M,toMontgomery(_){let{y:v}=e.fromBytes(_),O=w.publicKey,K=O===32;if(!K&&O!==57)throw new Error("only defined for 25519 and 448");let T=K?o.div(mt+v,mt-v):o.div(v-mt,v+mt);return o.toBytes(T)},toMontgomerySecret(_){let v=w.secretKey;V(_,v);let O=t(_.subarray(0,v));return c(O).subarray(0,v)}};return Object.freeze({keygen:or(D,p),getPublicKey:p,sign:S,verify:b,utils:k,Point:e,lengths:w})}var qr=BigInt(0),ir=BigInt(1),In=BigInt(2);function oh(e){return qt(e,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...e})}function Ac(e){let t=oh(e),{P:r,type:n,adjustScalarBytes:s,powPminus2:o,randomBytes:i}=t,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");let c=i||ue,f=a?255:448,u=a?32:56,l=BigInt(a?9:5),g=BigInt(a?121665:39081),p=a?In**BigInt(254):In**BigInt(447),d=a?BigInt(8)*In**BigInt(251)-ir:BigInt(4)*In**BigInt(445)-ir,S=p+d+ir,h=m=>ot(m,r),b=B(l);function B(m){return Mr(h(m),u)}function w(m){let y=_e(V(m,u,"uCoordinate"));return a&&(y[31]&=127),h(Vt(y))}function D(m){return Vt(s(_e(V(m,u,"scalar"))))}function N(m,y){let A=O(w(y),D(m));if(A===qr)throw new Error("invalid private or public key received");return B(A)}function M(m){return N(m,b)}let k=M,_=N;function v(m,y,A){let I=h(m*(y-A));return y=h(y-I),A=h(A+I),{x_2:y,x_3:A}}function O(m,y){de("u",m,qr,r),de("scalar",y,p,S);let A=y,I=m,L=ir,E=qr,C=m,R=ir,P=qr;for(let $=BigInt(f-1);$>=qr;$--){let q=A>>$&ir;P^=q,{x_2:L,x_3:C}=v(P,L,C),{x_2:E,x_3:R}=v(P,E,R),P=q;let G=L+E,tt=h(G*G),ct=L-E,j=h(ct*ct),ft=tt-j,ze=C+R,un=C-R,Ar=h(un*G),fa=h(ze*ct),la=Ar+fa,ha=Ar-fa;C=h(la*la),R=h(I*h(ha*ha)),L=h(tt*j),E=h(ft*(tt+h(g*ft)))}({x_2:L,x_3:C}=v(P,L,C)),{x_2:E,x_3:R}=v(P,E,R);let F=o(E);return h(L*F)}let K={secretKey:u,publicKey:u,seed:u},T=(m=c(u))=>(V(m,K.seed,"seed"),m),x={randomSecretKey:T};return Object.freeze({keygen:or(T,k),getSharedSecret:_,getPublicKey:k,scalarMult:N,scalarMultBase:M,utils:x,GuBytes:b.slice(),lengths:K})}var ih=BigInt(1),Bc=BigInt(2),ah=BigInt(3),ch=BigInt(5),uh=BigInt(8),Cn=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),fh={p:Cn,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:uh,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Lc(e){let t=BigInt(10),r=BigInt(20),n=BigInt(40),s=BigInt(80),o=Cn,a=e*e%o*e%o,c=rt(a,Bc,o)*a%o,f=rt(c,ih,o)*e%o,u=rt(f,ch,o)*f%o,l=rt(u,t,o)*u%o,g=rt(l,r,o)*l%o,p=rt(g,n,o)*g%o,d=rt(p,s,o)*p%o,S=rt(d,s,o)*p%o,h=rt(S,t,o)*u%o;return{pow_p_5_8:rt(h,Bc,o)*e%o,b2:a}}function Ic(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}var _c=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function lh(e,t){let r=Cn,n=ot(t*t*t,r),s=ot(n*n*t,r),o=Lc(e*s).pow_p_5_8,i=ot(e*n*o,r),a=ot(t*i*i,r),c=i,f=ot(i*_c,r),u=a===e,l=a===ot(-e,r),g=a===ot(-e*_c,r);return u&&(i=c),(l||g)&&(i=f),pc(i,r)&&(i=ot(-i,r)),{isValid:u||l,value:i}}var hh=Sc(fh,{uvRatio:lh});function dh(e){return vc(hh,ec,Object.assign({adjustScalarBytes:Ic},e))}var Cc=dh({});var zr=(()=>{let e=Cn;return Ac({P:e,type:"x25519",powPminus2:t=>{let{pow_p_5_8:r,b2:n}=Lc(t);return ot(rt(r,ah,e)*n,e)},adjustScalarBytes:Ic})})();var $r=class extends Error{constructor(t="An error occurred while verifying a message"){super(t),this.name="VerificationError"}},Tn=class extends Error{constructor(t="Missing Web Crypto API"){super(t),this.name="WebCryptoMissingError"}};var Tc={get(e=globalThis){let t=e.crypto;if(t?.subtle==null)throw new Tn("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};var Pt=Tc;var Dn=32;var mo,ph=(async()=>{try{return await Pt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function mh(e,t,r){if(e.buffer instanceof ArrayBuffer){let n=await Pt.get().subtle.importKey("raw",e.buffer,{name:"Ed25519"},!1,["verify"]);return await Pt.get().subtle.verify({name:"Ed25519"},n,t,r instanceof Uint8Array?r:r.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function yh(e,t,r){return Cc.verify(t,r instanceof Uint8Array?r:r.subarray(),e)}async function Dc(e,t,r){return mo==null&&(mo=await ph),mo?mh(e,t,r):yh(e,t,r)}function Rn(e){return e==null?!1:typeof e.then=="function"&&typeof e.catch=="function"&&typeof e.finally=="function"}var Pn=class{type="Ed25519";raw;constructor(t){this.raw=yo(t,Dn)}toMultihash(){return Ut.digest(ce(this))}toCID(){return lt.createV1(114,this.toMultihash())}toString(){return at.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:ht(this.raw,t.raw)}verify(t,r,n){n?.signal?.throwIfAborted();let s=Dc(this.raw,r,t);return Rn(s)?s.then(o=>(n?.signal?.throwIfAborted(),o)):s}};function go(e){return e=yo(e,Dn),new Pn(e)}function yo(e,t){if(e=Uint8Array.from(e??[]),e.length!==t)throw new et(`Key must be a Uint8Array of length ${t}, got ${e.length}`);return e}var bh=Math.pow(2,7),xh=Math.pow(2,14),wh=Math.pow(2,21),bo=Math.pow(2,28),xo=Math.pow(2,35),wo=Math.pow(2,42),Eo=Math.pow(2,49),X=128,St=127;function vt(e){if(e<bh)return 1;if(e<xh)return 2;if(e<wh)return 3;if(e<bo)return 4;if(e<xo)return 5;if(e<wo)return 6;if(e<Eo)return 7;if(Number.MAX_SAFE_INTEGER!=null&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function ar(e,t,r=0){switch(vt(e)){case 8:t[r++]=e&255|X,e/=128;case 7:t[r++]=e&255|X,e/=128;case 6:t[r++]=e&255|X,e/=128;case 5:t[r++]=e&255|X,e/=128;case 4:t[r++]=e&255|X,e>>>=7;case 3:t[r++]=e&255|X,e>>>=7;case 2:t[r++]=e&255|X,e>>>=7;case 1:{t[r++]=e&255,e>>>=7;break}default:throw new Error("unreachable")}return t}function Eh(e,t,r=0){switch(vt(e)){case 8:t.set(r++,e&255|X),e/=128;case 7:t.set(r++,e&255|X),e/=128;case 6:t.set(r++,e&255|X),e/=128;case 5:t.set(r++,e&255|X),e/=128;case 4:t.set(r++,e&255|X),e>>>=7;case 3:t.set(r++,e&255|X),e>>>=7;case 2:t.set(r++,e&255|X),e>>>=7;case 1:{t.set(r++,e&255),e>>>=7;break}default:throw new Error("unreachable")}return t}function So(e,t){let r=e[t],n=0;if(n+=r&St,r<X||(r=e[t+1],n+=(r&St)<<7,r<X)||(r=e[t+2],n+=(r&St)<<14,r<X)||(r=e[t+3],n+=(r&St)<<21,r<X)||(r=e[t+4],n+=(r&St)*bo,r<X)||(r=e[t+5],n+=(r&St)*xo,r<X)||(r=e[t+6],n+=(r&St)*wo,r<X)||(r=e[t+7],n+=(r&St)*Eo,r<X))return n;throw new RangeError("Could not decode varint")}function Sh(e,t){let r=e.get(t),n=0;if(n+=r&St,r<X||(r=e.get(t+1),n+=(r&St)<<7,r<X)||(r=e.get(t+2),n+=(r&St)<<14,r<X)||(r=e.get(t+3),n+=(r&St)<<21,r<X)||(r=e.get(t+4),n+=(r&St)*bo,r<X)||(r=e.get(t+5),n+=(r&St)*xo,r<X)||(r=e.get(t+6),n+=(r&St)*wo,r<X)||(r=e.get(t+7),n+=(r&St)*Eo,r<X))return n;throw new RangeError("Could not decode varint")}function Pc(e,t,r=0){return t==null&&(t=bt(vt(e))),t instanceof Uint8Array?ar(e,t,r):Eh(e,t,r)}function Te(e,t=0){return e instanceof Uint8Array?So(e,t):Sh(e,t)}var Ao=new Float32Array([-0]),me=new Uint8Array(Ao.buffer);function Oc(e,t,r){Ao[0]=e,t[r]=me[0],t[r+1]=me[1],t[r+2]=me[2],t[r+3]=me[3]}function Uc(e,t){return me[0]=e[t],me[1]=e[t+1],me[2]=e[t+2],me[3]=e[t+3],Ao[0]}var Bo=new Float64Array([-0]),At=new Uint8Array(Bo.buffer);function Kc(e,t,r){Bo[0]=e,t[r]=At[0],t[r+1]=At[1],t[r+2]=At[2],t[r+3]=At[3],t[r+4]=At[4],t[r+5]=At[5],t[r+6]=At[6],t[r+7]=At[7]}function Nc(e,t){return At[0]=e[t],At[1]=e[t+1],At[2]=e[t+2],At[3]=e[t+3],At[4]=e[t+4],At[5]=e[t+5],At[6]=e[t+6],At[7]=e[t+7],Bo[0]}var vh=BigInt(Number.MAX_SAFE_INTEGER),Ah=BigInt(Number.MIN_SAFE_INTEGER),Tt=class e{lo;hi;constructor(t,r){this.lo=t|0,this.hi=r|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){let r=~this.lo+1>>>0,n=~this.hi>>>0;return r===0&&(n=n+1>>>0),-(r+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let r=~this.lo+1>>>0,n=~this.hi>>>0;return r===0&&(n=n+1>>>0),-(BigInt(r)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){let t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){let t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){let t=this.lo,r=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?r===0?t<16384?t<128?1:2:t<2097152?3:4:r<16384?r<128?5:6:r<2097152?7:8:n<128?9:10}static fromBigInt(t){if(t===0n)return De;if(t<vh&&t>Ah)return this.fromNumber(Number(t));let r=t<0n;r&&(t=-t);let n=t>>32n,s=t-(n<<32n);return r&&(n=~n|0n,s=~s|0n,++s>Mc&&(s=0n,++n>Mc&&(n=0n))),new e(Number(s),Number(n))}static fromNumber(t){if(t===0)return De;let r=t<0;r&&(t=-t);let n=t>>>0,s=(t-n)/4294967296>>>0;return r&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new e(n,s)}static from(t){return typeof t=="number"?e.fromNumber(t):typeof t=="bigint"?e.fromBigInt(t):typeof t=="string"?e.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new e(t.low>>>0,t.high>>>0):De}},De=new Tt(0,0);De.toBigInt=function(){return 0n};De.zzEncode=De.zzDecode=function(){return this};De.length=function(){return 1};var Mc=4294967296n;function kc(e){let t=0,r=0;for(let n=0;n<e.length;++n)r=e.charCodeAt(n),r<128?t+=1:r<2048?t+=2:(r&64512)===55296&&(e.charCodeAt(n+1)&64512)===56320?(++n,t+=4):t+=3;return t}function Hc(e,t,r){if(r-t<1)return"";let s,o=[],i=0,a;for(;t<r;)a=e[t++],a<128?o[i++]=a:a>191&&a<224?o[i++]=(a&31)<<6|e[t++]&63:a>239&&a<365?(a=((a&7)<<18|(e[t++]&63)<<12|(e[t++]&63)<<6|e[t++]&63)-65536,o[i++]=55296+(a>>10),o[i++]=56320+(a&1023)):o[i++]=(a&15)<<12|(e[t++]&63)<<6|e[t++]&63,i>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,o)),i=0);return s!=null?(i>0&&s.push(String.fromCharCode.apply(String,o.slice(0,i))),s.join("")):String.fromCharCode.apply(String,o.slice(0,i))}function _o(e,t,r){let n=r,s,o;for(let i=0;i<e.length;++i)s=e.charCodeAt(i),s<128?t[r++]=s:s<2048?(t[r++]=s>>6|192,t[r++]=s&63|128):(s&64512)===55296&&((o=e.charCodeAt(i+1))&64512)===56320?(s=65536+((s&1023)<<10)+(o&1023),++i,t[r++]=s>>18|240,t[r++]=s>>12&63|128,t[r++]=s>>6&63|128,t[r++]=s&63|128):(t[r++]=s>>12|224,t[r++]=s>>6&63|128,t[r++]=s&63|128);return r-n}function Mt(e,t){return RangeError(`index out of range: ${e.pos} + ${t??1} > ${e.len}`)}function On(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}var Lo=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(t){this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,Mt(this,10);return t}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Mt(this,4);return On(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Mt(this,4);return On(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Mt(this,4);let t=Uc(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw Mt(this,4);let t=Nc(this.buf,this.pos);return this.pos+=8,t}bytes(){let t=this.uint32(),r=this.pos,n=this.pos+t;if(n>this.len)throw Mt(this,t);return this.pos+=t,r===n?new Uint8Array(0):this.buf.subarray(r,n)}string(){let t=this.bytes();return Hc(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw Mt(this,t);this.pos+=t}else do if(this.pos>=this.len)throw Mt(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){let t=new Tt(0,0),r=0;if(this.len-this.pos>4){for(;r<4;++r)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<r*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;r=0}else{for(;r<3;++r){if(this.pos>=this.len)throw Mt(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<r*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<r*7)>>>0,t}if(this.len-this.pos>4){for(;r<5;++r)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<r*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;r<5;++r){if(this.pos>=this.len)throw Mt(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<r*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Mt(this,8);let t=On(this.buf,this.pos+=4),r=On(this.buf,this.pos+=4);return new Tt(t,r)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let t=So(this.buf,this.pos);return this.pos+=vt(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function Io(e){return new Lo(e instanceof Uint8Array?e:e.subarray())}function Re(e,t,r){let n=Io(e);return t.decode(n,void 0,r)}function Co(e){let t=e??8192,r=t>>>1,n,s=t;return function(i){if(i<1||i>r)return bt(i);s+i>t&&(n=bt(t),s=0);let a=n.subarray(s,s+=i);return(s&7)!==0&&(s=(s|7)+1),a}}var Pe=class{fn;len;next;val;constructor(t,r,n){this.fn=t,this.len=r,this.next=void 0,this.val=n}};function To(){}var Ro=class{head;tail;len;next;constructor(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}},Bh=Co();function _h(e){return globalThis.Buffer!=null?bt(e):Bh(e)}var Fr=class{len;head;tail;states;constructor(){this.len=0,this.head=new Pe(To,0,0),this.tail=this.head,this.states=null}_push(t,r,n){return this.tail=this.tail.next=new Pe(t,r,n),this.len+=r,this}uint32(t){return this.len+=(this.tail=this.tail.next=new Po((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(Un,10,Tt.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){let r=Tt.fromBigInt(t);return this._push(Un,r.length(),r)}uint64Number(t){return this._push(ar,vt(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){let r=Tt.fromBigInt(t).zzEncode();return this._push(Un,r.length(),r)}sint64Number(t){let r=Tt.fromNumber(t).zzEncode();return this._push(Un,r.length(),r)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(Do,1,t?1:0)}fixed32(t){return this._push(Wr,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){let r=Tt.fromBigInt(t);return this._push(Wr,4,r.lo)._push(Wr,4,r.hi)}fixed64Number(t){let r=Tt.fromNumber(t);return this._push(Wr,4,r.lo)._push(Wr,4,r.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(Oc,4,t)}double(t){return this._push(Kc,8,t)}bytes(t){let r=t.length>>>0;return r===0?this._push(Do,1,0):this.uint32(r)._push(Ih,r,t)}string(t){let r=kc(t);return r!==0?this.uint32(r)._push(_o,r,t):this._push(Do,1,0)}fork(){return this.states=new Ro(this),this.head=this.tail=new Pe(To,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Pe(To,0,0),this.len=0),this}ldelim(){let t=this.head,r=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=t.next,this.tail=r,this.len+=n),this}finish(){let t=this.head.next,r=_h(this.len),n=0;for(;t!=null;)t.fn(t.val,r,n),n+=t.len,t=t.next;return r}};function Do(e,t,r){t[r]=e&255}function Lh(e,t,r){for(;e>127;)t[r++]=e&127|128,e>>>=7;t[r]=e}var Po=class extends Pe{next;constructor(t,r){super(Lh,t,r),this.next=void 0}};function Un(e,t,r){for(;e.hi!==0;)t[r++]=e.lo&127|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[r++]=e.lo&127|128,e.lo=e.lo>>>7;t[r++]=e.lo}function Wr(e,t,r){t[r]=e&255,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24}function Ih(e,t,r){t.set(e,r)}globalThis.Buffer!=null&&(Fr.prototype.bytes=function(e){let t=e.length>>>0;return this.uint32(t),t>0&&this._push(Ch,t,e),this},Fr.prototype.string=function(e){let t=globalThis.Buffer.byteLength(e);return this.uint32(t),t>0&&this._push(Th,t,e),this});function Ch(e,t,r){t.set(e,r)}function Th(e,t,r){e.length<40?_o(e,t,r):t.utf8Write!=null?t.utf8Write(e,r):t.set(Y(e),r)}function Oo(){return new Fr}function Oe(e,t){let r=Oo();return t.encode(e,r,{lengthDelimited:!1}),r.finish()}var cr;(function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"})(cr||(cr={}));function Kn(e,t,r,n){return{name:e,type:t,encode:r,decode:n}}function Uo(e){function t(s){if(e[s.toString()]==null)throw new Error("Invalid enum value");return e[s]}let r=function(o,i){let a=t(o);i.int32(a)},n=function(o){let i=o.int32();return t(i)};return Kn("enum",cr.VARINT,r,n)}function Ue(e,t){return Kn("message",cr.LENGTH_DELIMITED,e,t)}var Gr=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"};var ut;(function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.secp256k1="secp256k1",e.ECDSA="ECDSA"})(ut||(ut={}));var Ko;(function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.secp256k1=2]="secp256k1",e[e.ECDSA=3]="ECDSA"})(Ko||(Ko={}));(function(e){e.codec=()=>Uo(Ko)})(ut||(ut={}));var zt;(function(e){let t;e.codec=()=>(t==null&&(t=Ue((r,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),r.Type!=null&&(n.uint32(8),ut.codec().encode(r.Type,n)),r.Data!=null&&(n.uint32(18),n.bytes(r.Data)),s.lengthDelimited!==!1&&n.ldelim()},(r,n,s={})=>{let o={},i=n==null?r.len:r.pos+n;for(;r.pos<i;){let a=r.uint32();switch(a>>>3){case 1:{o.Type=ut.codec().decode(r);break}case 2:{o.Data=r.bytes();break}default:{r.skipType(a&7);break}}}return o})),t),e.encode=r=>Oe(r,e.codec()),e.decode=(r,n)=>Re(r,e.codec(),n)})(zt||(zt={}));var No;(function(e){let t;e.codec=()=>(t==null&&(t=Ue((r,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),r.Type!=null&&(n.uint32(8),ut.codec().encode(r.Type,n)),r.Data!=null&&(n.uint32(18),n.bytes(r.Data)),s.lengthDelimited!==!1&&n.ldelim()},(r,n,s={})=>{let o={},i=n==null?r.len:r.pos+n;for(;r.pos<i;){let a=r.uint32();switch(a>>>3){case 1:{o.Type=ut.codec().decode(r);break}case 2:{o.Data=r.bytes();break}default:{r.skipType(a&7);break}}}return o})),t),e.encode=r=>Oe(r,e.codec()),e.decode=(r,n)=>Re(r,e.codec(),n)})(No||(No={}));var Zr={};_t(Zr,{MAX_RSA_KEY_SIZE:()=>Mo,generateRSAKeyPair:()=>Fc,jwkToJWKKeyPair:()=>Gc,jwkToPkcs1:()=>Oh,jwkToPkix:()=>qo,jwkToRSAPrivateKey:()=>Fo,pkcs1MessageToJwk:()=>Ho,pkcs1MessageToRSAPrivateKey:()=>zo,pkcs1ToJwk:()=>Ph,pkcs1ToRSAPrivateKey:()=>Wc,pkixMessageToJwk:()=>Vo,pkixMessageToRSAPublicKey:()=>Wo,pkixToJwk:()=>Uh,pkixToRSAPublicKey:()=>$o});var ur=class{type="RSA";jwk;_raw;_multihash;constructor(t,r){this.jwk=t,this._multihash=r}get raw(){return this._raw==null&&(this._raw=Zr.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return lt.createV1(114,this._multihash)}toString(){return at.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:ht(this.raw,t.raw)}verify(t,r,n){return $c(this.jwk,r,t,n)}},jr=class{type="RSA";jwk;_raw;publicKey;constructor(t,r){this.jwk=t,this.publicKey=r}get raw(){return this._raw==null&&(this._raw=Zr.jwkToPkcs1(this.jwk)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:ht(this.raw,t.raw)}sign(t,r){return zc(this.jwk,t,r)}};var Mo=8192,ko=18,Dh=1062,Rh=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function Ph(e){let t=Gt(e);return Ho(t)}function Ho(e){return{n:z(e[1],"base64url"),e:z(e[2],"base64url"),d:z(e[3],"base64url"),p:z(e[4],"base64url"),q:z(e[5],"base64url"),dp:z(e[6],"base64url"),dq:z(e[7],"base64url"),qi:z(e[8],"base64url"),kty:"RSA"}}function Oh(e){if(e.n==null||e.e==null||e.d==null||e.p==null||e.q==null||e.dp==null||e.dq==null||e.qi==null)throw new et("JWK was missing components");return ae([It(Uint8Array.from([0])),It(Y(e.n,"base64url")),It(Y(e.e,"base64url")),It(Y(e.d,"base64url")),It(Y(e.p,"base64url")),It(Y(e.q,"base64url")),It(Y(e.dp,"base64url")),It(Y(e.dq,"base64url")),It(Y(e.qi,"base64url"))]).subarray()}function Uh(e){let t=Gt(e,{offset:0});return Vo(t)}function Vo(e){let t=Gt(e[1],{offset:0});return{kty:"RSA",n:z(t[0],"base64url"),e:z(t[1],"base64url")}}function qo(e){if(e.n==null||e.e==null)throw new et("JWK was missing components");return ae([Rh,Sn(ae([It(Y(e.n,"base64url")),It(Y(e.e,"base64url"))]))]).subarray()}function Wc(e){let t=Gt(e);return zo(t)}function zo(e){let t=Ho(e);return Fo(t)}function $o(e,t){if(e.byteLength>=Dh)throw new We("Key size is too large");let r=Gt(e,{offset:0});return Wo(r,e,t)}function Wo(e,t,r){let n=Vo(e);if(r==null){let s=Ht(zt.encode({Type:ut.RSA,Data:t}));r=Ot(ko,s)}return new ur(n,r)}function Fo(e){if(Zc(e)>Mo)throw new et("Key size is too large");let t=Gc(e),r=Ht(zt.encode({Type:ut.RSA,Data:qo(t.publicKey)})),n=Ot(ko,r);return new jr(t.privateKey,new ur(t.publicKey,n))}async function Fc(e){if(e>Mo)throw new et("Key size is too large");let t=await jc(e),r=Ht(zt.encode({Type:ut.RSA,Data:qo(t.publicKey)})),n=Ot(ko,r);return new jr(t.privateKey,new ur(t.publicKey,n))}function Gc(e){if(e==null)throw new et("Missing key parameter");return{privateKey:e,publicKey:{kty:e.kty,n:e.n,e:e.e}}}async function jc(e,t){let r=await Pt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);t?.signal?.throwIfAborted();let n=await Kh(r,t);return{privateKey:n[0],publicKey:n[1]}}async function zc(e,t,r){let n=await Pt.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);r?.signal?.throwIfAborted();let s=await Pt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return r?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function $c(e,t,r,n){let s=await Pt.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let o=await Pt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,t,r instanceof Uint8Array?r:r.subarray());return n?.signal?.throwIfAborted(),o}async function Kh(e,t){if(e.privateKey==null||e.publicKey==null)throw new et("Private and public key are required");let r=await Promise.all([Pt.get().subtle.exportKey("jwk",e.privateKey),Pt.get().subtle.exportKey("jwk",e.publicKey)]);return t?.signal?.throwIfAborted(),r}function Zc(e){if(e.kty!=="RSA")throw new et("invalid key type");if(e.n==null)throw new et("invalid key modulus");return Y(e.n,"base64url").length*8}var Nn=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(t,r){if(ve(t),V(r,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,s=new Uint8Array(n);s.set(r.length>n?t.create().update(r).digest():r);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=t.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),Kt(s)}update(t){return Je(this),this.iHash.update(t),this}digestInto(t){Je(this),V(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||=Object.create(Object.getPrototypeOf(this),{});let{oHash:r,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=o,t.blockLen=i,t.outputLen=a,t.oHash=r._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},fr=(e,t,r)=>new Nn(e,t).update(r).digest();fr.create=(e,t)=>new Nn(e,t);var Yc=(e,t)=>(e+(e>=0?t:-t)/Xc)/t;function Nh(e,t,r){let[[n,s],[o,i]]=t,a=Yc(i*e,r),c=Yc(-s*e,r),f=e-a*n-c*o,u=-a*s-c*i,l=f<Jt,g=u<Jt;l&&(f=-f),g&&(u=-u);let p=kr(Math.ceil(so(r)/2))+lr;if(f<Jt||f>=p||u<Jt||u>=p)throw new Error("splitScalar (endomorphism): failed, k="+e);return{k1neg:l,k1:f,k2neg:g,k2:u}}function jo(e){if(!["compact","recovered","der"].includes(e))throw new Error('Signature format must be "compact", "recovered", or "der"');return e}function Go(e,t){let r={};for(let n of Object.keys(t))r[n]=e[n]===void 0?t[n]:e[n];return Qt(r.lowS,"lowS"),Qt(r.prehash,"prehash"),r.format!==void 0&&jo(r.format),r}var Zo=class extends Error{constructor(t=""){super(t)}},ye={Err:Zo,_tlv:{encode:(e,t)=>{let{Err:r}=ye;if(e<0||e>256)throw new r("tlv.encode: wrong tag");if(t.length&1)throw new r("tlv.encode: unpadded data");let n=t.length/2,s=Nr(n);if(s.length/2&128)throw new r("tlv.encode: long form length too big");let o=n>127?Nr(s.length/2|128):"";return Nr(e)+o+s+t},decode(e,t){let{Err:r}=ye,n=0;if(e<0||e>256)throw new r("tlv.encode: wrong tag");if(t.length<2||t[n++]!==e)throw new r("tlv.decode: wrong tlv");let s=t[n++],o=!!(s&128),i=0;if(!o)i=s;else{let c=s&127;if(!c)throw new r("tlv.decode(long): indefinite length not supported");if(c>4)throw new r("tlv.decode(long): byte length is too big");let f=t.subarray(n,n+c);if(f.length!==c)throw new r("tlv.decode: length bytes not complete");if(f[0]===0)throw new r("tlv.decode(long): zero leftmost byte");for(let u of f)i=i<<8|u;if(n+=c,i<128)throw new r("tlv.decode(long): not minimal encoding")}let a=t.subarray(n,n+i);if(a.length!==i)throw new r("tlv.decode: wrong value length");return{v:a,l:t.subarray(n+i)}}},_int:{encode(e){let{Err:t}=ye;if(e<Jt)throw new t("integer: negative integers are not allowed");let r=Nr(e);if(Number.parseInt(r[0],16)&8&&(r="00"+r),r.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return r},decode(e){let{Err:t}=ye;if(e[0]&128)throw new t("invalid signature integer: negative");if(e[0]===0&&!(e[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return tr(e)}},toSig(e){let{Err:t,_int:r,_tlv:n}=ye,s=V(e,void 0,"signature"),{v:o,l:i}=n.decode(48,s);if(i.length)throw new t("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,o),{v:f,l:u}=n.decode(2,c);if(u.length)throw new t("invalid signature: left bytes after parsing");return{r:r.decode(a),s:r.decode(f)}},hexFromSig(e){let{_tlv:t,_int:r}=ye,n=t.encode(2,r.encode(e.r)),s=t.encode(2,r.encode(e.s)),o=n+s;return t.encode(48,o)}},Jt=BigInt(0),lr=BigInt(1),Xc=BigInt(2),Mn=BigInt(3),Mh=BigInt(4);function Qc(e,t={}){let r=Ln("weierstrass",e,t),{Fp:n,Fn:s}=r,o=r.CURVE,{h:i,n:a}=o;qt(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=t;if(c&&(!n.is0(o.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let f=tu(n,s);function u(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function l(T,x,m){let{x:y,y:A}=x.toAffine(),I=n.toBytes(y);if(Qt(m,"isCompressed"),m){u();let L=!n.isOdd(A);return Ct(Jc(L),I)}else return Ct(Uint8Array.of(4),I,n.toBytes(A))}function g(T){V(T,void 0,"Point");let{publicKey:x,publicKeyUncompressed:m}=f,y=T.length,A=T[0],I=T.subarray(1);if(y===x&&(A===2||A===3)){let L=n.fromBytes(I);if(!n.isValid(L))throw new Error("bad point: is not on curve, wrong x");let E=S(L),C;try{C=n.sqrt(E)}catch(F){let $=F instanceof Error?": "+F.message:"";throw new Error("bad point: is not on curve, sqrt error"+$)}u();let R=n.isOdd(C);return(A&1)===1!==R&&(C=n.neg(C)),{x:L,y:C}}else if(y===m&&A===4){let L=n.BYTES,E=n.fromBytes(I.subarray(0,L)),C=n.fromBytes(I.subarray(L,L*2));if(!h(E,C))throw new Error("bad point: is not on curve");return{x:E,y:C}}else throw new Error(`bad point: got length ${y}, expected compressed=${x} or uncompressed=${m}`)}let p=t.toBytes||l,d=t.fromBytes||g;function S(T){let x=n.sqr(T),m=n.mul(x,T);return n.add(n.add(m,n.mul(T,o.a)),o.b)}function h(T,x){let m=n.sqr(x),y=S(T);return n.eql(m,y)}if(!h(o.Gx,o.Gy))throw new Error("bad curve params: generator point");let b=n.mul(n.pow(o.a,Mn),Mh),B=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(b,B)))throw new Error("bad curve params: a or b");function w(T,x,m=!1){if(!n.isValid(x)||m&&n.is0(x))throw new Error(`bad point coordinate ${T}`);return x}function D(T){if(!(T instanceof v))throw new Error("Weierstrass Point expected")}function N(T){if(!c||!c.basises)throw new Error("no endo");return Nh(T,c.basises,s.ORDER)}let M=er((T,x)=>{let{X:m,Y:y,Z:A}=T;if(n.eql(A,n.ONE))return{x:m,y};let I=T.is0();x==null&&(x=I?n.ONE:n.inv(A));let L=n.mul(m,x),E=n.mul(y,x),C=n.mul(A,x);if(I)return{x:n.ZERO,y:n.ZERO};if(!n.eql(C,n.ONE))throw new Error("invZ was invalid");return{x:L,y:E}}),k=er(T=>{if(T.is0()){if(t.allowInfinityPoint&&!n.is0(T.Y))return;throw new Error("bad point: ZERO")}let{x,y:m}=T.toAffine();if(!n.isValid(x)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!h(x,m))throw new Error("bad point: equation left != right");if(!T.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function _(T,x,m,y,A){return m=new v(n.mul(m.X,T),m.Y,m.Z),x=Vr(y,x),m=Vr(A,m),x.add(m)}class v{static BASE=new v(o.Gx,o.Gy,n.ONE);static ZERO=new v(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(x,m,y){this.X=w("x",x),this.Y=w("y",m,!0),this.Z=w("z",y),Object.freeze(this)}static CURVE(){return o}static fromAffine(x){let{x:m,y}=x||{};if(!x||!n.isValid(m)||!n.isValid(y))throw new Error("invalid affine point");if(x instanceof v)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(y)?v.ZERO:new v(m,y,n.ONE)}static fromBytes(x){let m=v.fromAffine(d(V(x,void 0,"point")));return m.assertValidity(),m}static fromHex(x){return v.fromBytes(Yt(x))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(x=8,m=!0){return K.createCache(this,x),m||this.multiply(Mn),this}assertValidity(){k(this)}hasEvenY(){let{y:x}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(x)}equals(x){D(x);let{X:m,Y:y,Z:A}=this,{X:I,Y:L,Z:E}=x,C=n.eql(n.mul(m,E),n.mul(I,A)),R=n.eql(n.mul(y,E),n.mul(L,A));return C&&R}negate(){return new v(this.X,n.neg(this.Y),this.Z)}double(){let{a:x,b:m}=o,y=n.mul(m,Mn),{X:A,Y:I,Z:L}=this,E=n.ZERO,C=n.ZERO,R=n.ZERO,P=n.mul(A,A),F=n.mul(I,I),$=n.mul(L,L),q=n.mul(A,I);return q=n.add(q,q),R=n.mul(A,L),R=n.add(R,R),E=n.mul(x,R),C=n.mul(y,$),C=n.add(E,C),E=n.sub(F,C),C=n.add(F,C),C=n.mul(E,C),E=n.mul(q,E),R=n.mul(y,R),$=n.mul(x,$),q=n.sub(P,$),q=n.mul(x,q),q=n.add(q,R),R=n.add(P,P),P=n.add(R,P),P=n.add(P,$),P=n.mul(P,q),C=n.add(C,P),$=n.mul(I,L),$=n.add($,$),P=n.mul($,q),E=n.sub(E,P),R=n.mul($,F),R=n.add(R,R),R=n.add(R,R),new v(E,C,R)}add(x){D(x);let{X:m,Y:y,Z:A}=this,{X:I,Y:L,Z:E}=x,C=n.ZERO,R=n.ZERO,P=n.ZERO,F=o.a,$=n.mul(o.b,Mn),q=n.mul(m,I),G=n.mul(y,L),tt=n.mul(A,E),ct=n.add(m,y),j=n.add(I,L);ct=n.mul(ct,j),j=n.add(q,G),ct=n.sub(ct,j),j=n.add(m,A);let ft=n.add(I,E);return j=n.mul(j,ft),ft=n.add(q,tt),j=n.sub(j,ft),ft=n.add(y,A),C=n.add(L,E),ft=n.mul(ft,C),C=n.add(G,tt),ft=n.sub(ft,C),P=n.mul(F,j),C=n.mul($,tt),P=n.add(C,P),C=n.sub(G,P),P=n.add(G,P),R=n.mul(C,P),G=n.add(q,q),G=n.add(G,q),tt=n.mul(F,tt),j=n.mul($,j),G=n.add(G,tt),tt=n.sub(q,tt),tt=n.mul(F,tt),j=n.add(j,tt),q=n.mul(G,j),R=n.add(R,q),q=n.mul(ft,j),C=n.mul(ct,C),C=n.sub(C,q),q=n.mul(ct,G),P=n.mul(ft,P),P=n.add(P,q),new v(C,R,P)}subtract(x){return this.add(x.negate())}is0(){return this.equals(v.ZERO)}multiply(x){let{endo:m}=t;if(!s.isValidNot0(x))throw new Error("invalid scalar: out of range");let y,A,I=L=>K.cached(this,L,E=>Ce(v,E));if(m){let{k1neg:L,k1:E,k2neg:C,k2:R}=N(x),{p:P,f:F}=I(E),{p:$,f:q}=I(R);A=F.add(q),y=_(m.beta,P,$,L,C)}else{let{p:L,f:E}=I(x);y=L,A=E}return Ce(v,[y,A])[0]}multiplyUnsafe(x){let{endo:m}=t,y=this;if(!s.isValid(x))throw new Error("invalid scalar: out of range");if(x===Jt||y.is0())return v.ZERO;if(x===lr)return y;if(K.hasCache(this))return this.multiply(x);if(m){let{k1neg:A,k1:I,k2neg:L,k2:E}=N(x),{p1:C,p2:R}=Ec(v,y,I,E);return _(m.beta,C,R,A,L)}else return K.unsafe(y,x)}toAffine(x){return M(this,x)}isTorsionFree(){let{isTorsionFree:x}=t;return i===lr?!0:x?x(v,this):K.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:x}=t;return i===lr?this:x?x(v,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(x=!0){return Qt(x,"isCompressed"),this.assertValidity(),p(v,this,x)}toHex(x=!0){return Zt(this.toBytes(x))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let O=s.BITS,K=new sr(v,t.endo?Math.ceil(O/2):O);return v.BASE.precompute(8),v}function Jc(e){return Uint8Array.of(e?2:3)}function tu(e,t){return{secretKey:t.BYTES,publicKey:1+e.BYTES,publicKeyUncompressed:1+2*e.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function kh(e,t={}){let{Fn:r}=e,n=t.randomBytes||ue,s=Object.assign(tu(e.Fp,r),{seed:co(r.ORDER)});function o(p){try{let d=r.fromBytes(p);return r.isValidNot0(d)}catch{return!1}}function i(p,d){let{publicKey:S,publicKeyUncompressed:h}=s;try{let b=p.length;return d===!0&&b!==S||d===!1&&b!==h?!1:!!e.fromBytes(p)}catch{return!1}}function a(p=n(s.seed)){return uo(V(p,s.seed,"seed"),r.ORDER)}function c(p,d=!0){return e.BASE.multiply(r.fromBytes(p)).toBytes(d)}function f(p){let{secretKey:d,publicKey:S,publicKeyUncompressed:h}=s;if(!Se(p)||"_lengths"in r&&r._lengths||d===S)return;let b=V(p,void 0,"key").length;return b===S||b===h}function u(p,d,S=!0){if(f(p)===!0)throw new Error("first arg must be private key");if(f(d)===!1)throw new Error("second arg must be public key");let h=r.fromBytes(p);return e.fromBytes(d).multiply(h).toBytes(S)}let l={isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a},g=or(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:u,keygen:g,Point:e,utils:l,lengths:s})}function eu(e,t,r={}){ve(t),qt(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),r=Object.assign({},r);let n=r.randomBytes||ue,s=r.hmac||((m,y)=>fr(t,m,y)),{Fp:o,Fn:i}=e,{ORDER:a,BITS:c}=i,{keygen:f,getPublicKey:u,getSharedSecret:l,utils:g,lengths:p}=kh(e,r),d={prehash:!0,lowS:typeof r.lowS=="boolean"?r.lowS:!0,format:"compact",extraEntropy:!1},S=a*Xc<o.ORDER;function h(m){let y=a>>lr;return m>y}function b(m,y){if(!i.isValidNot0(y))throw new Error(`invalid signature ${m}: out of range 1..Point.Fn.ORDER`);return y}function B(){if(S)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(m,y){jo(y);let A=p.signature,I=y==="compact"?A:y==="recovered"?A+1:void 0;return V(m,I)}class D{r;s;recovery;constructor(y,A,I){if(this.r=b("r",y),this.s=b("s",A),I!=null){if(B(),![0,1,2,3].includes(I))throw new Error("invalid recovery id");this.recovery=I}Object.freeze(this)}static fromBytes(y,A=d.format){w(y,A);let I;if(A==="der"){let{r:R,s:P}=ye.toSig(V(y));return new D(R,P)}A==="recovered"&&(I=y[0],A="compact",y=y.subarray(1));let L=p.signature/2,E=y.subarray(0,L),C=y.subarray(L,L*2);return new D(i.fromBytes(E),i.fromBytes(C),I)}static fromHex(y,A){return this.fromBytes(Yt(y),A)}assertRecovery(){let{recovery:y}=this;if(y==null)throw new Error("invalid recovery id: must be present");return y}addRecoveryBit(y){return new D(this.r,this.s,y)}recoverPublicKey(y){let{r:A,s:I}=this,L=this.assertRecovery(),E=L===2||L===3?A+a:A;if(!o.isValid(E))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let C=o.toBytes(E),R=e.fromBytes(Ct(Jc((L&1)===0),C)),P=i.inv(E),F=M(V(y,void 0,"msgHash")),$=i.create(-F*P),q=i.create(I*P),G=e.BASE.multiplyUnsafe($).add(R.multiplyUnsafe(q));if(G.is0())throw new Error("invalid recovery: point at infinify");return G.assertValidity(),G}hasHighS(){return h(this.s)}toBytes(y=d.format){if(jo(y),y==="der")return Yt(ye.hexFromSig(this));let{r:A,s:I}=this,L=i.toBytes(A),E=i.toBytes(I);return y==="recovered"?(B(),Ct(Uint8Array.of(this.assertRecovery()),L,E)):Ct(L,E)}toHex(y){return Zt(this.toBytes(y))}}let N=r.bits2int||function(y){if(y.length>8192)throw new Error("input is too large");let A=tr(y),I=y.length*8-c;return I>0?A>>BigInt(I):A},M=r.bits2int_modN||function(y){return i.create(N(y))},k=kr(c);function _(m){return de("num < 2^"+c,m,Jt,k),i.toBytes(m)}function v(m,y){return V(m,void 0,"message"),y?V(t(m),void 0,"prehashed message"):m}function O(m,y,A){let{lowS:I,prehash:L,extraEntropy:E}=Go(A,d);m=v(m,L);let C=M(m),R=i.fromBytes(y);if(!i.isValidNot0(R))throw new Error("invalid private key");let P=[_(R),_(C)];if(E!=null&&E!==!1){let G=E===!0?n(p.secretKey):E;P.push(V(G,void 0,"extraEntropy"))}let F=Ct(...P),$=C;function q(G){let tt=N(G);if(!i.isValidNot0(tt))return;let ct=i.inv(tt),j=e.BASE.multiply(tt).toAffine(),ft=i.create(j.x);if(ft===Jt)return;let ze=i.create(ct*i.create($+ft*R));if(ze===Jt)return;let un=(j.x===ft?0:2)|Number(j.y&lr),Ar=ze;return I&&h(ze)&&(Ar=i.neg(ze),un^=1),new D(ft,Ar,S?void 0:un)}return{seed:F,k2sig:q}}function K(m,y,A={}){let{seed:I,k2sig:L}=O(m,y,A);return sc(t.outputLen,i.BYTES,s)(I,L).toBytes(A.format)}function T(m,y,A,I={}){let{lowS:L,prehash:E,format:C}=Go(I,d);if(A=V(A,void 0,"publicKey"),y=v(y,E),!Se(m)){let R=m instanceof D?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+R)}w(m,C);try{let R=D.fromBytes(m,C),P=e.fromBytes(A);if(L&&R.hasHighS())return!1;let{r:F,s:$}=R,q=M(y),G=i.inv($),tt=i.create(q*G),ct=i.create(F*G),j=e.BASE.multiplyUnsafe(tt).add(P.multiplyUnsafe(ct));return j.is0()?!1:i.create(j.x)===F}catch{return!1}}function x(m,y,A={}){let{prehash:I}=Go(A,d);return y=v(y,I),D.fromBytes(m,"recovered").recoverPublicKey(y).toBytes()}return Object.freeze({keygen:f,getPublicKey:u,getSharedSecret:l,utils:g,lengths:p,Point:e,sign:K,verify:T,recoverPublicKey:x,Signature:D,hash:t})}var Xo={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Hh={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var ru=BigInt(2);function Vh(e){let t=Xo.p,r=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),f=e*e*e%t,u=f*f*e%t,l=rt(u,r,t)*u%t,g=rt(l,r,t)*u%t,p=rt(g,ru,t)*f%t,d=rt(p,s,t)*p%t,S=rt(d,o,t)*d%t,h=rt(S,a,t)*S%t,b=rt(h,c,t)*h%t,B=rt(b,a,t)*S%t,w=rt(B,r,t)*u%t,D=rt(w,i,t)*d%t,N=rt(D,n,t)*f%t,M=rt(N,ru,t);if(!Yo.eql(Yo.sqr(M),e))throw new Error("Cannot find square root");return M}var Yo=rr(Xo.p,{sqrt:Vh}),qh=Qc(Xo,{Fp:Yo,endo:Hh}),hr=eu(qh,Ht);function nu(e,t,r,n){let s=Dr.digest(r instanceof Uint8Array?r:r.subarray());if(Rn(s))return s.then(({digest:o})=>(n?.signal?.throwIfAborted(),hr.verify(t,o,e,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new $r(String(o))});try{return n?.signal?.throwIfAborted(),hr.verify(t,s.digest,e,{prehash:!1,format:"der"})}catch(o){throw new $r(String(o))}}var kn=class{type="secp256k1";raw;_key;constructor(t){this._key=ou(t),this.raw=su(this._key)}toMultihash(){return Ut.digest(ce(this))}toCID(){return lt.createV1(114,this.toMultihash())}toString(){return at.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:ht(this.raw,t.raw)}verify(t,r,n){return nu(this._key,r,t,n)}};function Qo(e){return new kn(e)}function su(e){return hr.Point.fromBytes(e).toBytes()}function ou(e){try{return hr.Point.fromBytes(e),e}catch(t){throw new We(String(t))}}function Yr(e,t){let{Type:r,Data:n}=zt.decode(e),s=n??new Uint8Array;switch(r){case ut.RSA:return $o(s,t);case ut.Ed25519:return go(s);case ut.secp256k1:return Qo(s);case ut.ECDSA:return Gs(s);default:throw new xe}}function iu(e){let{Type:t,Data:r}=zt.decode(e.digest),n=r??new Uint8Array;switch(t){case ut.Ed25519:return go(n);case ut.secp256k1:return Qo(n);case ut.ECDSA:return Gs(n);default:throw new xe}}function ce(e){return zt.encode({Type:ut[e.type],Data:e.raw})}var au=Symbol.for("nodejs.util.inspect.custom"),zh=114,Xr=class{type;multihash;publicKey;string;constructor(t){this.type=t.type,this.multihash=t.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[bs]=!0;toString(){return this.string==null&&(this.string=at.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return lt.createV1(zh,this.multihash)}toJSON(){return this.toString()}equals(t){if(t==null)return!1;if(t instanceof Uint8Array)return ht(this.multihash.bytes,t);if(typeof t=="string")return this.toString()===t;if(t?.toMultihash()?.bytes!=null)return ht(this.multihash.bytes,t.toMultihash().bytes);throw new Error("not valid Id")}[au](){return`PeerId(${this.toString()})`}},Qr=class extends Xr{type="RSA";publicKey;constructor(t){super({...t,type:"RSA"}),this.publicKey=t.publicKey}},Jr=class extends Xr{type="Ed25519";publicKey;constructor(t){super({...t,type:"Ed25519"}),this.publicKey=t.publicKey}},tn=class extends Xr{type="secp256k1";publicKey;constructor(t){super({...t,type:"secp256k1"}),this.publicKey=t.publicKey}},$h=2336,en=class{type="url";multihash;publicKey;url;constructor(t){this.url=t.toString(),this.multihash=Ut.digest(Y(this.url))}[au](){return`PeerId(${this.url})`}[bs]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return lt.createV1($h,this.toMultihash())}toJSON(){return this.toString()}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=z(t)),t.toString()===this.toString())}};var Wh=114,cu=2336;function uu(e,t){let r;if(e.charAt(0)==="1"||e.charAt(0)==="Q")r=Xe(at.decode(`z${e}`));else{if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return Fh(lt.parse(e));if(t==null)throw new et('Please pass a multibase decoder for strings that do not start with "1" or "Q"');r=Xe(t.decode(e))}return fu(r)}function Jo(e){if(e.type==="Ed25519")return new Jr({multihash:e.toCID().multihash,publicKey:e});if(e.type==="secp256k1")return new tn({multihash:e.toCID().multihash,publicKey:e});if(e.type==="RSA")return new Qr({multihash:e.toCID().multihash,publicKey:e});throw new xe}function fu(e){if(jh(e))return new Qr({multihash:e});if(Gh(e))try{let t=iu(e);if(t.type==="Ed25519")return new Jr({multihash:e,publicKey:t});if(t.type==="secp256k1")return new tn({multihash:e,publicKey:t})}catch{let r=z(e.digest);return new en(new URL(r))}throw new pn("Supplied PeerID Multihash is invalid")}function Fh(e){if(e?.multihash==null||e.version==null||e.version===1&&e.code!==Wh&&e.code!==cu)throw new dn("Supplied PeerID CID is invalid");if(e.code===cu){let t=z(e.multihash.digest);return new en(new URL(t))}return fu(e.multihash)}function Gh(e){return e.code===Ut.code}function jh(e){return e.code===Dr.code}function lu(e){let t=e.getComponents(),r={},n=0;if(t[n]?.name==="ip6zone"&&(r.zone=`${t[n].value}`,n++),t[n].name==="ip4"||t[n].name==="ip6"||t[n].name==="dns"||t[n].name==="dns4"||t[n].name==="dns6"?(r.type=t[n].name,r.host=t[n].value,n++):t[n].name==="dnsaddr"&&(r.type=t[n].name,r.host=`_dnsaddr.${t[n].value}`,n++),(t[n]?.name==="tcp"||t[n]?.name==="udp")&&(r.protocol=t[n].name==="tcp"?"tcp":"udp",r.port=parseInt(`${t[n].value}`),n++),t[n]?.name==="ipcidr"&&(r.type==="ip4"?r.cidr=parseInt(`${t[n].value}`):r.type==="ip6"&&(r.cidr=`${t[n].value}`),n++),r.type==null||r.host==null)throw new et(`Multiaddr ${e} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return t[n]?.name==="tls"&&t[n+1]?.name==="sni"&&(r.sni=t[n+1].value,n+=2),r}var Hn=class{index=0;input="";new(t){return this.index=0,this.input=t,this}readAtomically(t){let r=this.index,n=t();return n===void 0&&(this.index=r),n}parseWith(t){let r=t();if(this.index===this.input.length)return r}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{let r=this.readChar();if(r===t)return r})}readSeparator(t,r,n){return this.readAtomically(()=>{if(!(r>0&&this.readGivenChar(t)===void 0))return n()})}readNumber(t,r,n,s){return this.readAtomically(()=>{let o=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",f=2**(8*s)-1;for(;;){let u=this.readAtomically(()=>{let l=this.readChar();if(l===void 0)return;let g=Number.parseInt(l,t);if(!Number.isNaN(g))return g});if(u===void 0)break;if(o*=t,o+=u,o>f||(i+=1,r!==void 0&&i>r))return}if(i!==0)return!n&&c&&i>1?void 0:o})}readIPv4Addr(){return this.readAtomically(()=>{let t=new Uint8Array(4);for(let r=0;r<t.length;r++){let n=this.readSeparator(".",r,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;t[r]=n}return t})}readIPv6Addr(){let t=r=>{for(let n=0;n<r.length/2;n++){let s=n*2;if(n<r.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],[s+4,!0]}let o=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(o===void 0)return[s,!1];r[s]=o>>8,r[s+1]=o&255}return[r.length,!1]};return this.readAtomically(()=>{let r=new Uint8Array(16),[n,s]=t(r);if(n===16)return r;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let o=new Uint8Array(14),i=16-(n+2),[a]=t(o.subarray(0,i));return r.set(o.subarray(0,a),16-a),r})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var Zh=45,Yh=15,Vn=new Hn;function hu(e){if(!(e.length>Yh))return Vn.new(e).parseWith(()=>Vn.readIPv4Addr())}function du(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>Zh))return Vn.new(e).parseWith(()=>Vn.readIPv6Addr())}function qn(e){return!!hu(e)}function pu(e){return!!du(e)}function zn(){let e={};return e.promise=new Promise((t,r)=>{e.resolve=t,e.reject=r}),e}var $n=class{buffer;mask;top;btm;next;constructor(t){if(!(t>0)||(t-1&t)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){let t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}},dr=class{size;hwm;head;tail;constructor(t={}){this.hwm=t.splitLimit??16,this.head=new $n(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){let r=this.head;this.head=r.next=new $n(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){let r=this.tail.next;this.tail.next=null,this.tail=r,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}};var ti=class extends Error{type;code;constructor(t,r){super(t??"The operation was aborted"),this.type="aborted",this.code=r??"ABORT_ERR"}};function Wn(e={}){return Xh(r=>{let n=r.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},e)}function Xh(e,t){t=t??{};let r=t.onEnd,n=new dr,s,o,i,a=zn(),c=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((h,b)=>{o=B=>{o=null,n.push(B);try{h(e(n))}catch(w){b(w)}return s}}):e(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=zn()})}},f=h=>o!=null?o(h):(n.push(h),s),u=h=>(n=new dr,o!=null?o({error:h}):(n.push({error:h}),s)),l=h=>{if(i)return s;if(t?.objectMode!==!0&&h?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return f({done:!1,value:h})},g=h=>i?s:(i=!0,h!=null?u(h):f({done:!0})),p=()=>(n=new dr,g(),{done:!0}),d=h=>(g(h),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:p,throw:d,push:l,end:g,get readableLength(){return n.size},onEmpty:async h=>{let b=h?.signal;if(b?.throwIfAborted(),n.isEmpty())return;let B,w;b!=null&&(B=new Promise((D,N)=>{w=()=>{N(new ti)},b.addEventListener("abort",w)}));try{await Promise.race([a.promise,B])}finally{w!=null&&b!=null&&b?.removeEventListener("abort",w)}}},r==null)return s;let S=s;return s={[Symbol.asyncIterator](){return this},next(){return S.next()},throw(h){return S.throw(h),r!=null&&(r(h),r=void 0),{done:!0}},return(){return S.return(),r!=null&&(r(),r=void 0),{done:!0}},push:l,end(h){return S.end(h),r!=null&&(r(h),r=void 0),s},get readableLength(){return S.readableLength},onEmpty:h=>S.onEmpty(h)},s}var ei=class extends Error{constructor(t){super(t),this.name="TimeoutError"}},ri=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}},mu=e=>globalThis.DOMException===void 0?new ri(e):new DOMException(e),yu=e=>{let t=e.reason===void 0?mu("This operation was aborted."):e.reason;return t instanceof Error?t:mu(t)};function ni(e,t){let{milliseconds:r,fallback:n,message:s,customTimers:o={setTimeout,clearTimeout}}=t,i,a,f=new Promise((u,l)=>{if(typeof r!="number"||Math.sign(r)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${r}\``);if(t.signal){let{signal:p}=t;p.aborted&&l(yu(p)),a=()=>{l(yu(p))},p.addEventListener("abort",a,{once:!0})}if(r===Number.POSITIVE_INFINITY){e.then(u,l);return}let g=new ei;i=o.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(p){l(p)}return}typeof e.cancel=="function"&&e.cancel(),s===!1?u():s instanceof Error?l(s):(g.message=s??`Promise timed out after ${r} milliseconds`,l(g))},r),(async()=>{try{u(await e)}catch(p){l(p)}})()}).finally(()=>{f.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)});return f.clear=()=>{o.clearTimeout.call(void 0,i),i=void 0},f}var Qh=e=>{let t=e.addEventListener||e.on||e.addListener,r=e.removeEventListener||e.off||e.removeListener;if(!t||!r)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:r.bind(e)}};function Jh(e,t,r){let n,s=new Promise((o,i)=>{if(r={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...r},!(r.count>=0&&(r.count===Number.POSITIVE_INFINITY||Number.isInteger(r.count))))throw new TypeError("The `count` option should be at least 0 or more");r.signal?.throwIfAborted();let a=[t].flat(),c=[],{addListener:f,removeListener:u}=Qh(e),l=async(...p)=>{let d=r.multiArgs?p:p[0];if(r.filter)try{if(!await r.filter(d))return}catch(S){n(),i(S);return}c.push(d),r.count===c.length&&(n(),o(c))},g=(...p)=>{n(),i(r.rejectionMultiArgs?p:p[0])};n=()=>{for(let p of a)u(p,l);for(let p of r.rejectionEvents)a.includes(p)||u(p,g)};for(let p of a)f(p,l);for(let p of r.rejectionEvents)a.includes(p)||f(p,g);r.signal&&r.signal.addEventListener("abort",()=>{g(r.signal.reason)},{once:!0}),r.resolveImmediately&&o(c)});if(s.cancel=n,typeof r.timeout=="number"){let o=ni(s,{milliseconds:r.timeout});return o.cancel=()=>{n(),o.clear()},o}return s}function ge(e,t,r){typeof r=="function"&&(r={filter:r}),r={...r,count:1,resolveImmediately:!1};let n=Jh(e,t,r),s=n.then(o=>o[0]);return s.cancel=n.cancel,s}var Ke=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"},Fn=class extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"};function td(e){return e.reason}async function te(e,t,r){if(t==null)return e;let n=r?.translateError??td;if(t.aborted)return e.catch(()=>{}),Promise.reject(n(t));let s;try{return await Promise.race([e,new Promise((o,i)=>{s=()=>{i(n(t))},t.addEventListener("abort",s)})])}finally{s!=null&&t.removeEventListener("abort",s)}}var ed=Math.pow(2,20)*4,$t=class extends Ge{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;constructor(t){super(),this.status="open",this.log=t.log,this.direction=t.direction??"outbound",this.inactivityTimeout=t.inactivityTimeout??12e4,this.maxReadBufferLength=t.maxReadBufferLength??ed,this.maxWriteBufferLength=t.maxWriteBufferLength,this.maxMessageSize=t.maxMessageSize,this.readBuffer=new Z,this.writeBuffer=new Z,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);let r=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue())};this.addEventListener("drain",r)}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;let t=Wn(),r=o=>{t.push(o.data)};this.addEventListener("message",r);let n=o=>{t.end(o.error)};this.addEventListener("close",n);let s=()=>{t.end()};this.addEventListener("remoteCloseWrite",s);try{yield*t}finally{this.removeEventListener("message",r),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",s)}}isReadable(){return this.status==="open"}send(t){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new be(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",t.byteLength),this.writeBuffer.append(t),this.processSendQueue()}abort(t){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",t),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(t)}catch(r){this.log("failed to send reset to remote - %e",r)}this.dispatchEvent(new yn(t))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new be("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new be("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(t){if(this.readStatus==="closed"||this.readStatus==="closing")throw new be(`Cannot push data onto a stream that is ${this.readStatus}`);if(t.byteLength!==0){if(this.readBuffer.append(t),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(t){if(t.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(t),this.dispatchReadBuffer()}}addEventListener(...t){super.addEventListener.apply(this,t),t[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");let t=new hn;this.dispatchEvent(new gn(t))}onTransportClosed(t){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),t!=null?this.abort(t):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Fe))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let t=!0,r=this.writeBuffer.byteLength,n=0;for(;this.writeBuffer.byteLength>0;){let s=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(s===0){t=!1;break}let o=this.writeBuffer.sublist(0,s),i=new Z(o);this.writeBuffer.consume(o.byteLength);let a=this.sendData(o);if(t=a.canSendMore,n+=a.sentBytes,a.sentBytes!==i.byteLength&&(i.consume(a.sentBytes),this.writeBuffer.prepend(i)),!t)break}return t||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,r,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),t}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}let t=this.readBuffer.sublist();this.readBuffer.consume(t.byteLength),this.dispatchEvent(new mn(t))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new Br(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new Br(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};var Gn=class extends $t{remoteAddr;metricPrefix;metrics;constructor(t){super(t),this.metricPrefix=t.metricPrefix??"",this.metrics=t.metrics,this.remoteAddr=t.remoteAddr,this.addEventListener("close",r=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),r.error!=null?r.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):r.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(t){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await ge(this,"idle",{...t,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await ge(this,"drain",{...t,rejectionEvents:["close"]})),await this.sendClose(t),this.onTransportClosed())}};function gu(e){return e==null?!1:typeof e.then=="function"&&typeof e.catch=="function"&&typeof e.finally=="function"}var jn=class extends Ge{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(t,r){super(),this.maConn=t,this.protocol=r.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=t.log.newScope(r.name),this.streamOptions=r.streamOptions,this.maxEarlyStreams=r.maxEarlyStreams??10,this.metrics=r.metrics;let n=i=>{try{this.onData(i.data)}catch(a){this.abort(a),this.maConn.abort(a)}};this.maConn.addEventListener("message",n);let s=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(i=>{i.onMuxerDrain()})};this.maConn.addEventListener("drain",s);let o=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",o)}send(t){let r=this.maConn.send(t);return r===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),r}async close(t){this.status==="closed"||this.status==="closing"||(this.status="closing",await te(Promise.all([...this.streams].map(async r=>{await r.close(t)})),t?.signal),this.status="closed")}abort(t){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(r=>{r.abort(t)}),this.status="closed")}onTransportClosed(t){this.status="closing";try{[...this.streams].forEach(r=>{r.onTransportClosed(t)})}catch(r){this.abort(r)}this.status="closed"}async createStream(t){if(this.status!=="open")throw new ln;let r=this.onCreateStream({...this.streamOptions,...t});return gu(r)&&(r=await r),this.streams.push(r),this.cleanUpStream(r),r}onRemoteStream(t){if(this.streams.push(t),this.cleanUpStream(t),this.listenerCount("stream")===0){this.earlyStreams.push(t),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new Fn(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:t})}cleanUpStream(t){let r=n=>{let s=this.streams.findIndex(o=>o===t);s!==-1&&this.streams.splice(s,1),n.error!=null?n.local?this.metrics?.increment({[`${t.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${t.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${t.direction}_stream_end`]:!0})};t.addEventListener("close",r),this.metrics?.increment({[`${t.direction}_stream`]:!0})}addEventListener(...t){super.addEventListener.apply(this,t),t[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(r=>{this.safeDispatchEvent("stream",{detail:r})}),this.earlyStreams=[]})}};var Zn=class extends $t{id;protocol;constructor(t){super(t),this.id=t.id,this.protocol=t.protocol??""}async close(t){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await ge(this,"idle",{...t,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await ge(this,"drain",{...t,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(t),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(t){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(t),this.readStatus="closed",this.log("closed readable end gracefully"))}};var wt=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},ee=class extends Error{static name="ValidationError";name="ValidationError"},Yn=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},Xn=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function oi(e){return t=>z(t,e)}function ii(e){return t=>Y(t,e)}function pr(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function Ne(e){let t=new ArrayBuffer(2);return new DataView(t).setUint16(0,typeof e=="string"?parseInt(e):e),new Uint8Array(t)}function bu(e){let t=e.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);let r=Y(t[0],"base32"),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=Ne(n);return Dt([r,s],r.length+s.length)}function xu(e){let t=e.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);let r=ie.decode(`b${t[0]}`),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=Ne(n);return Dt([r,s],r.length+s.length)}function ai(e){let t=e.subarray(0,e.length-2),r=e.subarray(e.length-2),n=z(t,"base32"),s=pr(r);return`${n}:${s}`}var ci=function(e){e=e.toString().trim();let t=new Uint8Array(4);return e.split(/\./g).forEach((r,n)=>{let s=parseInt(r,10);if(isNaN(s)||s<0||s>255)throw new wt("Invalid byte value in IP address");t[n]=s}),t},wu=function(e){let t=0;e=e.toString().trim();let r=e.split(":",8),n;for(n=0;n<r.length;n++){let o=qn(r[n]),i;o&&(i=ci(r[n]),r[n]=z(i.subarray(0,2),"base16")),i!=null&&++n<8&&r.splice(n,0,z(i.subarray(2,4),"base16"))}if(r[0]==="")for(;r.length<8;)r.unshift("0");else if(r[r.length-1]==="")for(;r.length<8;)r.push("0");else if(r.length<8){for(n=0;n<r.length&&r[n]!=="";n++);let o=[n,1];for(n=9-r.length;n>0;n--)o.push("0");r.splice.apply(r,o)}let s=new Uint8Array(t+16);for(n=0;n<r.length;n++){r[n]===""&&(r[n]="0");let o=parseInt(r[n],16);if(isNaN(o)||o<0||o>65535)throw new wt("Invalid byte value in IP address");s[t++]=o>>8&255,s[t++]=o&255}return s},Eu=function(e){if(e.byteLength!==4)throw new wt("IPv4 address was incorrect length");let t=[];for(let r=0;r<e.byteLength;r++)t.push(e[r]);return t.join(".")},Su=function(e){if(e.byteLength!==16)throw new wt("IPv6 address was incorrect length");let t=[];for(let n=0;n<e.byteLength;n+=2){let s=e[n],o=e[n+1],i=`${s.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`;t.push(i)}let r=t.join(":");try{let n=new URL(`http://[${r}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new wt(`Invalid IPv6 address "${r}"`)}};function vu(e){try{let t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new wt(`Invalid IPv6 address "${e}"`)}}var si=Object.values(Ee).map(e=>e.decoder),rd=(function(){let e=si[0].or(si[1]);return si.slice(2).forEach(t=>e=e.or(t)),e})();function Au(e){return rd.decode(e)}function Bu(e){return t=>e.encoder.encode(t)}function nd(e){if(parseInt(e).toString()!==e)throw new ee("Value must be an integer")}function sd(e){if(e<0)throw new ee("Value must be a positive integer, or zero")}function od(e){return t=>{if(t>e)throw new ee(`Value must be smaller than or equal to ${e}`)}}function id(...e){return t=>{for(let r of e)r(t)}}var rn=id(nd,sd,od(65535));var yt=-1,ui=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(t){let r;if(typeof t=="string"?r=this.protocolsByName.get(t):r=this.protocolsByCode.get(t),r==null)throw new Xn(`Protocol ${t} was unknown`);return r}addProtocol(t){this.protocolsByCode.set(t.code,t),this.protocolsByName.set(t.name,t),t.aliases?.forEach(r=>{this.protocolsByName.set(r,t)})}removeProtocol(t){let r=this.protocolsByCode.get(t);r!=null&&(this.protocolsByCode.delete(r.code),this.protocolsByName.delete(r.name),r.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},re=new ui,Ed=[{code:4,name:"ip4",size:32,valueToBytes:ci,bytesToValue:Eu,validate:e=>{if(!qn(e))throw new ee(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Ne,bytesToValue:pr,validate:rn},{code:273,name:"udp",size:16,valueToBytes:Ne,bytesToValue:pr,validate:rn},{code:33,name:"dccp",size:16,valueToBytes:Ne,bytesToValue:pr,validate:rn},{code:41,name:"ip6",size:128,valueToBytes:wu,bytesToValue:Su,stringToValue:vu,validate:e=>{if(!pu(e))throw new ee(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:yt},{code:43,name:"ipcidr",size:8,bytesToValue:oi("base10"),valueToBytes:ii("base10")},{code:53,name:"dns",size:yt},{code:54,name:"dns4",size:yt},{code:55,name:"dns6",size:yt},{code:56,name:"dnsaddr",size:yt},{code:132,name:"sctp",size:16,valueToBytes:Ne,bytesToValue:pr,validate:rn},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:yt,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:yt,bytesToValue:oi("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?ii("base58btc")(e):lt.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:ai,valueToBytes:bu},{code:445,name:"onion3",size:296,bytesToValue:ai,valueToBytes:xu},{code:446,name:"garlic64",size:yt},{code:447,name:"garlic32",size:yt},{code:448,name:"tls"},{code:449,name:"sni",size:yt},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:yt,bytesToValue:Bu(Os),valueToBytes:Au},{code:480,name:"http"},{code:481,name:"http-path",size:yt,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:yt}];Ed.forEach(e=>{re.addProtocol(e)});function _u(e){let t=[],r=0;for(;r<e.length;){let n=Te(e,r),s=re.getProtocol(n),o=vt(n),i=Sd(s,e,r+o),a=0;i>0&&s.size===yt&&(a=vt(i));let c=o+a+i,f={code:n,name:s.name,bytes:e.subarray(r,r+c)};if(i>0){let u=r+o+a,l=e.subarray(u,u+i);f.value=s.bytesToValue?.(l)??z(l)}t.push(f),r+=c}return t}function Lu(e){let t=0,r=[];for(let n of e){if(n.bytes==null){let s=re.getProtocol(n.code),o=vt(n.code),i,a=0,c=0;n.value!=null&&(i=s.valueToBytes?.(n.value)??Y(n.value),a=i.byteLength,s.size===yt&&(c=vt(a)));let f=new Uint8Array(o+c+a),u=0;ar(n.code,f,u),u+=o,i!=null&&(s.size===yt&&(ar(a,f,u),u+=c),f.set(i,u)),n.bytes=f}r.push(n.bytes),t+=n.bytes.byteLength}return Dt(r,t)}function Iu(e){if(e.charAt(0)!=="/")throw new wt('String multiaddr must start with "/"');let t=[],r="protocol",n="",s="";for(let o=1;o<e.length;o++){let i=e.charAt(o);i!=="/"&&(r==="protocol"?s+=e.charAt(o):n+=e.charAt(o));let a=o===e.length-1;if(i==="/"||a){let c=re.getProtocol(s);if(r==="protocol"){if(c.size==null||c.size===0){t.push({code:c.code,name:c.name}),n="",s="",r="protocol";continue}else if(a)throw new wt(`Component ${s} was missing value`);r="value"}else if(r==="value"){let f={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new wt(`Component ${s} was missing value`);f.value=c.stringToValue?.(n)??n}t.push(f),n="",s="",r="protocol"}}}if(s!==""&&n!=="")throw new wt("Incomplete multiaddr");return t}function Cu(e){return`/${e.flatMap(t=>{if(t.value==null)return t.name;let r=re.getProtocol(t.code);if(r==null)throw new wt(`Unknown protocol code ${t.code}`);return[t.name,r.valueToString?.(t.value)??t.value]}).join("/")}`}function Sd(e,t,r){return e.size==null||e.size===0?0:e.size>0?e.size/8:Te(t,r)}var vd=Symbol.for("nodejs.util.inspect.custom"),Li=Symbol.for("@multiformats/multiaddr");function Ad(e){if(e==null&&(e="/"),Tu(e))return e.getComponents();if(e instanceof Uint8Array)return _u(e);if(typeof e=="string")return e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),e===""&&(e="/"),Iu(e);if(Array.isArray(e))return e;throw new wt("Must be a string, Uint8Array, Component[], or another Multiaddr")}var _i=class e{[Li]=!0;#t;#e;#r;constructor(t="/",r={}){this.#t=Ad(t),r.validate!==!1&&Bd(this)}get bytes(){return this.#r==null&&(this.#r=Lu(this.#t)),this.#r}toString(){return this.#e==null&&(this.#e=Cu(this.#t)),this.#e}toJSON(){return this.toString()}getComponents(){return[...this.#t.map(t=>({...t}))]}encapsulate(t){let r=new e(t);return new e([...this.#t,...r.getComponents()],{validate:!1})}decapsulate(t){let r=t.toString(),n=this.toString(),s=n.lastIndexOf(r);if(s<0)throw new Yn(`Address ${this.toString()} does not contain subaddress: ${r}`);return new e(n.slice(0,s),{validate:!1})}decapsulateCode(t){let r;for(let n=this.#t.length-1;n>-1;n--)if(this.#t[n].code===t){r=n;break}return new e(this.#t.slice(0,r),{validate:!1})}equals(t){return ht(this.bytes,t.bytes)}[vd](){return`Multiaddr(${this.toString()})`}};function Bd(e){e.getComponents().forEach(t=>{let r=re.getProtocol(t.code);t.value!=null&&r.validate?.(t.value)})}function Tu(e){return!!e?.[Li]}var _d=4194304,rs=class extends Error{static name="UnwrappedError";name="UnwrappedError"},nn=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Ci=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Ti=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Ld(e){return typeof e?.closeRead=="function"}function Id(e){return typeof e?.close=="function"}function Ii(e){return Ld(e)?e.readStatus==="closing"||e.readStatus==="closed":Id(e)?e.status!=="open":!1}function Cd(e){return e?.addEventListener!=null&&e?.removeEventListener!=null&&e?.send!=null&&e?.push!=null&&e?.log!=null}function Td(e,t){let r=t?.maxBufferSize??_d,n=new Z,s,o=!1;if(!Cd(e))throw new et("Argument should be a Stream or a Multiaddr");let i=u=>{if(n.append(u.data),n.byteLength>r){let l=n.byteLength;n.consume(n.byteLength),s?.reject(new Error(`Read buffer overflow - ${l} > ${r}`))}s?.resolve()};e.addEventListener("message",i);let a=u=>{u.error!=null?s?.reject(u.error):s?.resolve()};e.addEventListener("close",a);let c=()=>{s?.resolve()};e.addEventListener("remoteCloseWrite",c);let f={readBuffer:n,async read(u){if(o===!0)throw new rs("Stream was unwrapped");if(Ii(e)){if(u?.bytes==null)return null;if(n.byteLength<u.bytes)throw e.log.error("closed after reading %d/%d bytes",n.byteLength,u.bytes),new Ke(`Unexpected EOF - stream closed after reading ${n.byteLength}/${u.bytes} bytes`)}let l=u?.bytes??1;for(s=Promise.withResolvers();;){if(n.byteLength>=l){s.resolve();break}if(await te(s.promise,u?.signal),Ii(e)){if(n.byteLength===0&&u?.bytes==null)return null;break}s=Promise.withResolvers()}let g=u?.bytes??n.byteLength;if(n.byteLength<g){if(Ii(e))throw e.log.error("closed while reading %d/%d bytes",n.byteLength,g),new Ke(`Unexpected EOF - stream closed while reading ${n.byteLength}/${g} bytes`);return f.read(u)}let p=n.sublist(0,g);return n.consume(g),p},async write(u,l){if(o===!0)throw new rs("Stream was unwrapped");e.send(u)||await ge(e,"drain",{signal:l?.signal,rejectionEvents:["close"]})},unwrap(){return o||(o=!0,e.removeEventListener("message",i),e.removeEventListener("close",a),e.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(e.log("stream unwrapped with %d unread bytes",n.byteLength),e.push(n))),e}};return f}function Di(e,t={}){let r=Td(e,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=vt(t.maxDataLength));let n=t?.lengthDecoder??Te,s=t?.lengthEncoder??Pc;return{async read(i){let a=-1,c=new Z;for(;;){let u=await r.read({...i,bytes:1});if(u==null)break;c.append(u);try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new nn("Invalid message length");if(t?.maxLengthLength!=null&&c.byteLength>t.maxLengthLength)throw new Ti(`Message length length too long - ${c.byteLength} > ${t.maxLengthLength}`);if(a>-1)break}if(t?.maxDataLength!=null&&a>t.maxDataLength)throw new Ci(`Message length too long - ${a} > ${t.maxDataLength}`);let f=await r.read({...i,bytes:a});if(f==null)throw e.log.error("tried to read %d bytes but the stream closed",a),new Ke(`Unexpected EOF - tried to read ${a} bytes but the stream closed`);if(f.byteLength!==a)throw e.log.error("read %d/%d bytes before the stream closed",f.byteLength,a),new Ke(`Unexpected EOF - read ${f.byteLength}/${a} bytes before the stream closed`);return f},async write(i,a){await r.write(new Z(s(i.byteLength),i),a)},async writeV(i,a){let c=new Z(...i.flatMap(f=>[s(f.byteLength),f]));await r.write(c,a)},unwrap(){return r.unwrap()}}}var Dd=1024*1024*4,Rd=1024*1024*4,ns=class{buffer;maxBufferSize;lengthDecoder;maxDataLength;encodingLength;constructor(t={}){this.buffer=new Z,this.maxBufferSize=t.maxBufferSize??Dd,this.maxDataLength=t.maxDataLength??Rd,this.lengthDecoder=t.lengthDecoder??Te,this.encodingLength=t.encodingLength??vt}*decode(t){if(this.buffer.append(t),this.buffer.byteLength>this.maxBufferSize)throw new et(`Buffer length limit exceeded - ${this.buffer.byteLength}/${this.maxBufferSize}`);for(;;){let r;try{r=this.lengthDecoder(this.buffer)}catch(o){if(o instanceof RangeError)break;throw o}if(r<0||r>this.maxDataLength)throw new nn("Invalid message length");let n=this.encodingLength(r),s=n+r;if(this.buffer.byteLength>=s){let o=this.buffer.sublist(n,s);this.buffer.consume(s),o.byteLength>0&&(yield o)}else break}}};var br=!!globalThis.process?.env?.DUMP_SESSION_KEYS,Ri=16;function Pd(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function ss(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function os(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function gt(e,t,r=""){let n=Pd(e),s=e?.length,o=t!==void 0;if(!n||o&&s!==t){let i=r&&`"${r}" `,a=o?` of length ${t}`:"",c=n?`length=${s}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function Pi(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Du(e,t){gt(e,void 0,"output");let r=t.outputLen;if(e.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}function ne(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function se(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Od(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}var Ud=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Ru(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function Pu(e,t){if(e.length!==t.length)return!1;let r=0;for(let n=0;n<e.length;n++)r|=e[n]^t[n];return r===0}var Oi=(e,t)=>{function r(n,...s){if(gt(n,void 0,"key"),!Ud)throw new Error("Non little-endian hardware is not yet supported");if(e.nonceLength!==void 0){let u=s[0];gt(u,e.varSizeNonce?void 0:e.nonceLength,"nonce")}let o=e.tagLength;o&&s[1]!==void 0&&gt(s[1],void 0,"AAD");let i=t(n,...s),a=(u,l)=>{if(l!==void 0){if(u!==2)throw new Error("cipher output not supported");gt(l,void 0,"output")}},c=!1;return{encrypt(u,l){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,gt(u),a(i.encrypt.length,l),i.encrypt(u,l)},decrypt(u,l){if(gt(u),o&&u.length<o)throw new Error('"ciphertext" expected length bigger than tagLength='+o);return a(i.decrypt.length,l),i.decrypt(u,l)}}}return Object.assign(r,e),r};function Ui(e,t,r=!0){if(t===void 0)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(r&&!Kd(t))throw new Error("invalid output, must be aligned");return t}function Ou(e,t,r){ss(r);let n=new Uint8Array(16),s=Od(n);return s.setBigUint64(0,BigInt(t),r),s.setBigUint64(8,BigInt(e),r),n}function Kd(e){return e.byteOffset%4===0}function xr(e){return Uint8Array.from(e)}var Ku=e=>Uint8Array.from(e.split(""),t=>t.charCodeAt(0)),Nd=Ku("expand 16-byte k"),Md=Ku("expand 32-byte k"),kd=ne(Nd),Hd=ne(Md);function U(e,t){return e<<t|e>>>32-t}function Ki(e){return e.byteOffset%4===0}var is=64,Vd=16,Nu=2**32-1,Uu=Uint32Array.of();function qd(e,t,r,n,s,o,i,a){let c=s.length,f=new Uint8Array(is),u=ne(f),l=Ki(s)&&Ki(o),g=l?ne(s):Uu,p=l?ne(o):Uu;for(let d=0;d<c;i++){if(e(t,r,n,u,i,a),i>=Nu)throw new Error("arx: counter overflow");let S=Math.min(is,c-d);if(l&&S===is){let h=d/4;if(d%4!==0)throw new Error("arx: invalid block position");for(let b=0,B;b<Vd;b++)B=h+b,p[B]=g[B]^u[b];d+=is;continue}for(let h=0,b;h<S;h++)b=d+h,o[b]=s[b]^f[h];d+=S}}function Ni(e,t){let{allowShortKeys:r,extendNonceFn:n,counterLength:s,counterRight:o,rounds:i}=Ru({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return os(s),os(i),ss(o),ss(r),(a,c,f,u,l=0)=>{gt(a,void 0,"key"),gt(c,void 0,"nonce"),gt(f,void 0,"data");let g=f.length;if(u===void 0&&(u=new Uint8Array(g)),gt(u,void 0,"output"),os(l),l<0||l>=Nu)throw new Error("arx: counter overflow");if(u.length<g)throw new Error(`arx: output (${u.length}) is shorter than data (${g})`);let p=[],d=a.length,S,h;if(d===32)p.push(S=xr(a)),h=Hd;else if(d===16&&r)S=new Uint8Array(32),S.set(a),S.set(a,16),h=kd,p.push(S);else throw gt(a,32,"arx key"),new Error("invalid key size");Ki(c)||p.push(c=xr(c));let b=ne(S);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(h,b,ne(c.subarray(0,16)),b),c=c.subarray(16)}let B=16-s;if(B!==c.length)throw new Error(`arx: nonce must be ${B} or 16 bytes`);if(B!==12){let D=new Uint8Array(12);D.set(c,o?0:12-c.length),c=D,p.push(c)}let w=ne(c);return qd(e,h,b,w,f,u,l,i),se(...p),u}}function Et(e,t){return e[t++]&255|(e[t++]&255)<<8}var Mi=class{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(t){t=xr(gt(t,32,"key"));let r=Et(t,0),n=Et(t,2),s=Et(t,4),o=Et(t,6),i=Et(t,8),a=Et(t,10),c=Et(t,12),f=Et(t,14);this.r[0]=r&8191,this.r[1]=(r>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|f<<8)&8191,this.r[9]=f>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Et(t,16+2*u)}process(t,r,n=!1){let s=n?0:2048,{h:o,r:i}=this,a=i[0],c=i[1],f=i[2],u=i[3],l=i[4],g=i[5],p=i[6],d=i[7],S=i[8],h=i[9],b=Et(t,r+0),B=Et(t,r+2),w=Et(t,r+4),D=Et(t,r+6),N=Et(t,r+8),M=Et(t,r+10),k=Et(t,r+12),_=Et(t,r+14),v=o[0]+(b&8191),O=o[1]+((b>>>13|B<<3)&8191),K=o[2]+((B>>>10|w<<6)&8191),T=o[3]+((w>>>7|D<<9)&8191),x=o[4]+((D>>>4|N<<12)&8191),m=o[5]+(N>>>1&8191),y=o[6]+((N>>>14|M<<2)&8191),A=o[7]+((M>>>11|k<<5)&8191),I=o[8]+((k>>>8|_<<8)&8191),L=o[9]+(_>>>5|s),E=0,C=E+v*a+O*(5*h)+K*(5*S)+T*(5*d)+x*(5*p);E=C>>>13,C&=8191,C+=m*(5*g)+y*(5*l)+A*(5*u)+I*(5*f)+L*(5*c),E+=C>>>13,C&=8191;let R=E+v*c+O*a+K*(5*h)+T*(5*S)+x*(5*d);E=R>>>13,R&=8191,R+=m*(5*p)+y*(5*g)+A*(5*l)+I*(5*u)+L*(5*f),E+=R>>>13,R&=8191;let P=E+v*f+O*c+K*a+T*(5*h)+x*(5*S);E=P>>>13,P&=8191,P+=m*(5*d)+y*(5*p)+A*(5*g)+I*(5*l)+L*(5*u),E+=P>>>13,P&=8191;let F=E+v*u+O*f+K*c+T*a+x*(5*h);E=F>>>13,F&=8191,F+=m*(5*S)+y*(5*d)+A*(5*p)+I*(5*g)+L*(5*l),E+=F>>>13,F&=8191;let $=E+v*l+O*u+K*f+T*c+x*a;E=$>>>13,$&=8191,$+=m*(5*h)+y*(5*S)+A*(5*d)+I*(5*p)+L*(5*g),E+=$>>>13,$&=8191;let q=E+v*g+O*l+K*u+T*f+x*c;E=q>>>13,q&=8191,q+=m*a+y*(5*h)+A*(5*S)+I*(5*d)+L*(5*p),E+=q>>>13,q&=8191;let G=E+v*p+O*g+K*l+T*u+x*f;E=G>>>13,G&=8191,G+=m*c+y*a+A*(5*h)+I*(5*S)+L*(5*d),E+=G>>>13,G&=8191;let tt=E+v*d+O*p+K*g+T*l+x*u;E=tt>>>13,tt&=8191,tt+=m*f+y*c+A*a+I*(5*h)+L*(5*S),E+=tt>>>13,tt&=8191;let ct=E+v*S+O*d+K*p+T*g+x*l;E=ct>>>13,ct&=8191,ct+=m*u+y*f+A*c+I*a+L*(5*h),E+=ct>>>13,ct&=8191;let j=E+v*h+O*S+K*d+T*p+x*g;E=j>>>13,j&=8191,j+=m*l+y*u+A*f+I*c+L*a,E+=j>>>13,j&=8191,E=(E<<2)+E|0,E=E+C|0,C=E&8191,E=E>>>13,R+=E,o[0]=C,o[1]=R,o[2]=P,o[3]=F,o[4]=$,o[5]=q,o[6]=G,o[7]=tt,o[8]=ct,o[9]=j}finalize(){let{h:t,pad:r}=this,n=new Uint16Array(10),s=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=s,s=t[a]>>>13,t[a]&=8191;t[0]+=s*5,s=t[0]>>>13,t[0]&=8191,t[1]+=s,s=t[1]>>>13,t[1]&=8191,t[2]+=s,n[0]=t[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=t[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let o=(s^1)-1;for(let a=0;a<10;a++)n[a]&=o;o=~o;for(let a=0;a<10;a++)t[a]=t[a]&o|n[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let i=t[0]+r[0];t[0]=i&65535;for(let a=1;a<8;a++)i=(t[a]+r[a]|0)+(i>>>16)|0,t[a]=i&65535;se(n)}update(t){Pi(this),gt(t),t=xr(t);let{buffer:r,blockLen:n}=this,s=t.length;for(let o=0;o<s;){let i=Math.min(n-this.pos,s-o);if(i===n){for(;n<=s-o;o+=n)this.process(t,o);continue}r.set(t.subarray(o,o+i),this.pos),this.pos+=i,o+=i,this.pos===n&&(this.process(r,0,!1),this.pos=0)}return this}destroy(){se(this.h,this.r,this.buffer,this.pad)}digestInto(t){Pi(this),Du(t,this),this.finished=!0;let{buffer:r,h:n}=this,{pos:s}=this;if(s){for(r[s++]=1;s<16;s++)r[s]=0;this.process(r,0,!0)}this.finalize();let o=0;for(let i=0;i<8;i++)t[o++]=n[i]>>>0,t[o++]=n[i]>>>8;return t}digest(){let{buffer:t,outputLen:r}=this;this.digestInto(t);let n=t.slice(0,r);return this.destroy(),n}};function zd(e){let t=(n,s)=>e(s).update(n).digest(),r=e(new Uint8Array(32));return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=n=>e(n),t}var Mu=zd(e=>new Mi(e));function Vu(e,t,r,n,s,o=20){let i=e[0],a=e[1],c=e[2],f=e[3],u=t[0],l=t[1],g=t[2],p=t[3],d=t[4],S=t[5],h=t[6],b=t[7],B=s,w=r[0],D=r[1],N=r[2],M=i,k=a,_=c,v=f,O=u,K=l,T=g,x=p,m=d,y=S,A=h,I=b,L=B,E=w,C=D,R=N;for(let F=0;F<o;F+=2)M=M+O|0,L=U(L^M,16),m=m+L|0,O=U(O^m,12),M=M+O|0,L=U(L^M,8),m=m+L|0,O=U(O^m,7),k=k+K|0,E=U(E^k,16),y=y+E|0,K=U(K^y,12),k=k+K|0,E=U(E^k,8),y=y+E|0,K=U(K^y,7),_=_+T|0,C=U(C^_,16),A=A+C|0,T=U(T^A,12),_=_+T|0,C=U(C^_,8),A=A+C|0,T=U(T^A,7),v=v+x|0,R=U(R^v,16),I=I+R|0,x=U(x^I,12),v=v+x|0,R=U(R^v,8),I=I+R|0,x=U(x^I,7),M=M+K|0,R=U(R^M,16),A=A+R|0,K=U(K^A,12),M=M+K|0,R=U(R^M,8),A=A+R|0,K=U(K^A,7),k=k+T|0,L=U(L^k,16),I=I+L|0,T=U(T^I,12),k=k+T|0,L=U(L^k,8),I=I+L|0,T=U(T^I,7),_=_+x|0,E=U(E^_,16),m=m+E|0,x=U(x^m,12),_=_+x|0,E=U(E^_,8),m=m+E|0,x=U(x^m,7),v=v+O|0,C=U(C^v,16),y=y+C|0,O=U(O^y,12),v=v+O|0,C=U(C^v,8),y=y+C|0,O=U(O^y,7);let P=0;n[P++]=i+M|0,n[P++]=a+k|0,n[P++]=c+_|0,n[P++]=f+v|0,n[P++]=u+O|0,n[P++]=l+K|0,n[P++]=g+T|0,n[P++]=p+x|0,n[P++]=d+m|0,n[P++]=S+y|0,n[P++]=h+A|0,n[P++]=b+I|0,n[P++]=B+L|0,n[P++]=w+E|0,n[P++]=D+C|0,n[P++]=N+R|0}function $d(e,t,r,n){let s=e[0],o=e[1],i=e[2],a=e[3],c=t[0],f=t[1],u=t[2],l=t[3],g=t[4],p=t[5],d=t[6],S=t[7],h=r[0],b=r[1],B=r[2],w=r[3];for(let N=0;N<20;N+=2)s=s+c|0,h=U(h^s,16),g=g+h|0,c=U(c^g,12),s=s+c|0,h=U(h^s,8),g=g+h|0,c=U(c^g,7),o=o+f|0,b=U(b^o,16),p=p+b|0,f=U(f^p,12),o=o+f|0,b=U(b^o,8),p=p+b|0,f=U(f^p,7),i=i+u|0,B=U(B^i,16),d=d+B|0,u=U(u^d,12),i=i+u|0,B=U(B^i,8),d=d+B|0,u=U(u^d,7),a=a+l|0,w=U(w^a,16),S=S+w|0,l=U(l^S,12),a=a+l|0,w=U(w^a,8),S=S+w|0,l=U(l^S,7),s=s+f|0,w=U(w^s,16),d=d+w|0,f=U(f^d,12),s=s+f|0,w=U(w^s,8),d=d+w|0,f=U(f^d,7),o=o+u|0,h=U(h^o,16),S=S+h|0,u=U(u^S,12),o=o+u|0,h=U(h^o,8),S=S+h|0,u=U(u^S,7),i=i+l|0,b=U(b^i,16),g=g+b|0,l=U(l^g,12),i=i+l|0,b=U(b^i,8),g=g+b|0,l=U(l^g,7),a=a+c|0,B=U(B^a,16),p=p+B|0,c=U(c^p,12),a=a+c|0,B=U(B^a,8),p=p+B|0,c=U(c^p,7);let D=0;n[D++]=s,n[D++]=o,n[D++]=i,n[D++]=a,n[D++]=h,n[D++]=b,n[D++]=B,n[D++]=w}var Wd=Ni(Vu,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Fd=Ni(Vu,{counterRight:!1,counterLength:8,extendNonceFn:$d,allowShortKeys:!1});var Gd=new Uint8Array(16),ku=(e,t)=>{e.update(t);let r=t.length%16;r&&e.update(Gd.subarray(r))},jd=new Uint8Array(32);function Hu(e,t,r,n,s){s!==void 0&&gt(s,void 0,"AAD");let o=e(t,r,jd),i=Ou(n.length,s?s.length:0,!0),a=Mu.create(o);s&&ku(a,s),ku(a,n),a.update(i);let c=a.digest();return se(o,i),c}var qu=e=>(t,r,n)=>({encrypt(o,i){let a=o.length;i=Ui(a+16,i,!1),i.set(o);let c=i.subarray(0,-16);e(t,r,c,c,1);let f=Hu(e,t,r,c,n);return i.set(f,a),se(f),i},decrypt(o,i){i=Ui(o.length-16,i,!1);let a=o.subarray(0,-16),c=o.subarray(-16),f=Hu(e,t,r,a,n);if(!Pu(c,f))throw new Error("invalid tag");return i.set(o.subarray(0,-16)),e(t,r,i,i,1),se(f),i}}),ki=Oi({blockSize:64,nonceLength:12,tagLength:16},qu(Wd)),Tw=Oi({blockSize:64,nonceLength:24,tagLength:16},qu(Fd));function $u(e,t,r){return ve(e),r===void 0&&(r=new Uint8Array(e.outputLen)),fr(e,r,t)}var Hi=Uint8Array.of(0),zu=Uint8Array.of();function Wu(e,t,r,n=32){ve(e),Rt(n,"length");let s=e.outputLen;if(n>255*s)throw new Error("Length must be <= 255*HashLen");let o=Math.ceil(n/s);r===void 0?r=zu:V(r,void 0,"info");let i=new Uint8Array(o*s),a=fr.create(e,t),c=a._cloneInto(),f=new Uint8Array(a.outputLen);for(let u=0;u<o;u++)Hi[0]=u+1,c.update(u===0?zu:f).update(r).update(Hi).digestInto(f),i.set(f,s*u),a._cloneInto(c);return a.destroy(),c.destroy(),Kt(f,Hi),i.slice(0,n)}var Vi={hashSHA256(e){return Ht(e.subarray())},getHKDF(e,t){let r=$u(Ht,t,e),s=Wu(Ht,r,void 0,96),o=s.subarray(0,32),i=s.subarray(32,64),a=s.subarray(64,96);return[o,i,a]},generateX25519KeyPair(){let e=zr.utils.randomSecretKey();return{publicKey:zr.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed(e){return{publicKey:zr.getPublicKey(e),privateKey:e}},generateX25519SharedKey(e,t){return zr.getSharedSecret(e.subarray(),t.subarray())},chaCha20Poly1305Encrypt(e,t,r,n){return ki(n,t,r).encrypt(e.subarray())},chaCha20Poly1305Decrypt(e,t,r,n,s){return ki(n,t,r).decrypt(e.subarray(),s)}};var Fu=Vi;function Gu(e){return{generateKeypair:e.generateX25519KeyPair,dh:(t,r)=>e.generateX25519SharedKey(t.privateKey,r).subarray(0,32),encrypt:e.chaCha20Poly1305Encrypt,decrypt:e.chaCha20Poly1305Decrypt,hash:e.hashSHA256,hkdf:e.getHKDF}}var wr=e=>{let t=bt(2);return t[0]=e>>8,t[1]=e,t};wr.bytes=2;var Er=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");if(e instanceof Uint8Array){let t=0;return t+=e[0]<<8,t+=e[1],t}return e.getUint16(0)};Er.bytes=2;function ju(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function qi(e,t){!t.enabled||!br||(e?(t(`LOCAL_STATIC_PUBLIC_KEY ${z(e.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${z(e.privateKey,"hex")}`)):t("Missing local static keys."))}function zi(e,t){!t.enabled||!br||(e?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${z(e.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${z(e.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function Zu(e,t){!t.enabled||!br||t(e?`REMOTE_STATIC_PUBLIC_KEY ${z(e.subarray(),"hex")}`:"Missing remote static public key.")}function $i(e,t){!t.enabled||!br||t(e?`REMOTE_EPHEMERAL_PUBLIC_KEY ${z(e.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Wi(e,t,r){!r.enabled||!br||(r(`CIPHER_STATE_1 ${e.n.getUint64()} ${e.k&&z(e.k,"hex")}`),r(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&z(t.k,"hex")}`))}var Sr=class e extends Error{code;constructor(t="Invalid crypto exchange"){super(t),this.code=e.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var Zd=0,Yd=4294967295,Xd="Cipherstate has reached maximum n, a new handshake must be performed",as=class{n;bytes;view;constructor(t=Zd){this.n=t,this.bytes=dt(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>Yd)throw new Error(Xd)}};var He=dt(0),vr=class{k;n;crypto;constructor(t,r=void 0,n=0){this.crypto=t,this.k=r,this.n=new as(n)}hasKey(){return!!this.k}encryptWithAd(t,r){if(!this.hasKey())return r;this.n.assertValue();let n=this.crypto.encrypt(r,this.n.getBytes(),t,this.k);return this.n.increment(),n}decryptWithAd(t,r,n){if(!this.hasKey())return r;this.n.assertValue();let s=this.crypto.decrypt(r,this.n.getBytes(),t,this.k,n);return this.n.increment(),s}},Fi=class{cs;ck;h;crypto;constructor(t,r){this.crypto=t;let n=Y(r,"utf-8");this.h=Qd(t,n),this.ck=this.h,this.cs=new vr(t)}mixKey(t){let[r,n]=this.crypto.hkdf(this.ck,t);this.ck=r,this.cs=new vr(this.crypto,n)}mixHash(t){this.h=this.crypto.hash(new Z(this.h,t))}encryptAndHash(t){let r=this.cs.encryptWithAd(this.h,t);return this.mixHash(r),r}decryptAndHash(t){let r=this.cs.decryptWithAd(this.h,t);return this.mixHash(t),r}split(){let[t,r]=this.crypto.hkdf(this.ck,He);return[new vr(this.crypto,t),new vr(this.crypto,r)]}},Gi=class{ss;s;e;rs;re;initiator;crypto;constructor(t){let{crypto:r,protocolName:n,prologue:s,initiator:o,s:i,e:a,rs:c,re:f}=t;this.crypto=r,this.ss=new Fi(r,n),this.ss.mixHash(s),this.initiator=o,this.s=i,this.e=a,this.rs=c,this.re=f}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let t=this.crypto.generateKeypair();return this.ss.mixHash(t.publicKey),this.e=t,t.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(t,r=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(t.byteLength<r+32)throw new Error("message is not long enough");this.re=t.sublist(r,r+32),this.ss.mixHash(this.re)}readS(t,r=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(t.byteLength<r+n)throw new Error("message is not long enough");let s=t.sublist(r,r+n);return this.rs=this.ss.decryptAndHash(s),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},sn=class extends Gi{writeMessageA(t){return new Z(this.writeE(),this.ss.encryptAndHash(t))}writeMessageB(t){let r=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new Z(r,n,this.ss.encryptAndHash(t))}writeMessageC(t){let r=this.writeS();return this.writeSE(),new Z(r,this.ss.encryptAndHash(t))}readMessageA(t){try{return this.readE(t),this.ss.decryptAndHash(t.sublist(32))}catch(r){throw new Sr(`handshake stage 0 validation fail: ${r.message}`)}}readMessageB(t){try{this.readE(t),this.readEE();let r=this.readS(t,32);return this.readES(),this.ss.decryptAndHash(t.sublist(32+r))}catch(r){throw new Sr(`handshake stage 1 validation fail: ${r.message}`)}}readMessageC(t){try{let r=this.readS(t);return this.readSE(),this.ss.decryptAndHash(t.sublist(r))}catch(r){throw new Sr(`handshake stage 2 validation fail: ${r.message}`)}}};function Qd(e,t){if(t.length<=32){let r=dt(32);return r.set(t),r}else return e.hash(t)}var cs;(function(e){let t;e.codec=()=>(t==null&&(t=Ue((r,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),r.webtransportCerthashes!=null)for(let o of r.webtransportCerthashes)n.uint32(10),n.bytes(o);if(r.streamMuxers!=null)for(let o of r.streamMuxers)n.uint32(18),n.string(o);s.lengthDelimited!==!1&&n.ldelim()},(r,n,s={})=>{let o={webtransportCerthashes:[],streamMuxers:[]},i=n==null?r.len:r.pos+n;for(;r.pos<i;){let a=r.uint32();switch(a>>>3){case 1:{if(s.limits?.webtransportCerthashes!=null&&o.webtransportCerthashes.length===s.limits.webtransportCerthashes)throw new Gr('Decode error - map field "webtransportCerthashes" had too many elements');o.webtransportCerthashes.push(r.bytes());break}case 2:{if(s.limits?.streamMuxers!=null&&o.streamMuxers.length===s.limits.streamMuxers)throw new Gr('Decode error - map field "streamMuxers" had too many elements');o.streamMuxers.push(r.string());break}default:{r.skipType(a&7);break}}}return o})),t),e.encode=r=>Oe(r,e.codec()),e.decode=(r,n)=>Re(r,e.codec(),n)})(cs||(cs={}));var on;(function(e){let t;e.codec=()=>(t==null&&(t=Ue((r,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),r.identityKey!=null&&r.identityKey.byteLength>0&&(n.uint32(10),n.bytes(r.identityKey)),r.identitySig!=null&&r.identitySig.byteLength>0&&(n.uint32(18),n.bytes(r.identitySig)),r.extensions!=null&&(n.uint32(34),cs.codec().encode(r.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(r,n,s={})=>{let o={identityKey:dt(0),identitySig:dt(0)},i=n==null?r.len:r.pos+n;for(;r.pos<i;){let a=r.uint32();switch(a>>>3){case 1:{o.identityKey=r.bytes();break}case 2:{o.identitySig=r.bytes();break}case 4:{o.extensions=cs.codec().decode(r,r.uint32(),{limits:s.limits?.extensions});break}default:{r.skipType(a&7);break}}}return o})),t),e.encode=r=>Oe(r,e.codec()),e.decode=(r,n)=>Re(r,e.codec(),n)})(on||(on={}));async function Zi(e,t,r){let n=await e.sign(Xu(t));return on.encode({identityKey:ce(e.publicKey),identitySig:n,extensions:r})}async function Yi(e,t,r){try{let n=on.decode(e),s=Yr(n.identityKey);if(r?.equals(s)===!1)throw new Error(`Payload identity key ${s} does not match expected remote identity key ${r}`);if(!t)throw new Error("Remote static does not exist");let o=Xu(t);if(!await s.verify(o,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new fn(n.message)}}function Xu(e){let t=Y("noise-libp2p-static-key:");return e instanceof Uint8Array?Dt([t,e],t.length+e.length):(e.prepend(t),e)}var ji=class extends $t{stream;handshake;metrics;decoder;constructor(t,r,n){super({log:t.log,inactivityTimeout:t.inactivityTimeout,maxReadBufferLength:t.maxReadBufferLength,direction:t.direction}),this.stream=t,this.handshake=r,this.metrics=n,this.decoder=new ns({lengthDecoder:Er,maxBufferSize:16*1024*1024,encodingLength:()=>2});let s=c=>{try{for(let f of this.decoder.decode(c.data))this.onData(this.decrypt(f))}catch(f){this.abort(f)}};this.stream.addEventListener("message",s);let o=c=>{c.error!=null?c.local===!0?this.abort(c.error):this.onRemoteReset():this.onTransportClosed()};this.stream.addEventListener("close",o);let i=()=>{this.safeDispatchEvent("drain")};this.stream.addEventListener("drain",i);let a=()=>{this.onRemoteCloseWrite()};this.stream.addEventListener("remoteCloseWrite",a)}encrypt(t){let r=new Z;for(let n=0;n<t.byteLength;n+=65519){let s=n+65519;s>t.byteLength&&(s=t.byteLength);let o;t instanceof Uint8Array?o=this.handshake.encrypt(t.subarray(n,s)):o=this.handshake.encrypt(t.sublist(n,s)),this.metrics?.encryptedPackets.increment(),r.append(wr(o.byteLength)),r.append(o)}return r}decrypt(t){let r=new Z;for(let n=0;n<t.byteLength;n+=65535){let s=n+65535;if(s>t.byteLength&&(s=t.byteLength),s-Ri<n)throw new Error("Invalid chunk");let o;t instanceof Uint8Array?o=t.subarray(n,s):o=t.sublist(n,s);let i=t.subarray(n,s-Ri);try{let a=this.handshake.decrypt(o,i);this.metrics?.decryptedPackets.increment(),r.append(a)}catch(a){throw this.metrics?.decryptErrors.increment(),a}}return r}close(t){return this.stream.close(t)}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}sendReset(t){this.stream.abort(t)}sendData(t){return{sentBytes:t.byteLength,canSendMore:this.stream.send(this.encrypt(t))}}};function Xi(e,t,r){return new ji(e,t,r)}async function Qu(e,t){let{log:r,connection:n,crypto:s,privateKey:o,prologue:i,s:a,remoteIdentityKey:c,extensions:f}=e,u=await Zi(o,a.publicKey,f),l=new sn({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:i,s:a});qi(l.s,r),r.trace("Stage 0 - Initiator starting to send first message."),await n.write(l.writeMessageA(He),t),r.trace("Stage 0 - Initiator finished sending first message."),zi(l.e,r),r.trace("Stage 1 - Initiator waiting to receive first message from responder...");let g=l.readMessageB(await n.read(t));r.trace("Stage 1 - Initiator received the message."),$i(l.re,r),Zu(l.rs,r),r.trace("Initiator going to check remote's signature...");let p=await Yi(g,l.rs,c);r.trace("All good with the signature!"),r.trace("Stage 2 - Initiator sending third handshake message."),await n.write(l.writeMessageC(u),t),r.trace("Stage 2 - Initiator sent message with signed payload.");let[d,S]=l.ss.split();return Wi(d,S,r),{payload:p,encrypt:h=>d.encryptWithAd(He,h),decrypt:(h,b)=>S.decryptWithAd(He,h,b)}}async function Ju(e,t){let{log:r,connection:n,crypto:s,privateKey:o,prologue:i,s:a,remoteIdentityKey:c,extensions:f}=e,u=await Zi(o,a.publicKey,f),l=new sn({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:i,s:a});qi(l.s,r),r.trace("Stage 0 - Responder waiting to receive first message."),l.readMessageA(await n.read(t)),r.trace("Stage 0 - Responder received first message."),$i(l.re,r),r.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(l.writeMessageB(u),t),r.trace("Stage 1 - Responder sent the second handshake message with signed payload."),zi(l.e,r),r.trace("Stage 2 - Responder waiting for third handshake message...");let g=l.readMessageC(await n.read(t));r.trace("Stage 2 - Responder received the message, finished handshake.");let p=await Yi(g,l.rs,c),[d,S]=l.ss.split();return Wi(d,S,r),{payload:p,encrypt:h=>S.encryptWithAd(He,h),decrypt:(h,b)=>d.decryptWithAd(He,h,b)}}var us=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;log;constructor(t,r={}){let{staticNoiseKey:n,extensions:s,crypto:o,prologueBytes:i}=r,{metrics:a}=t;this.components=t,this.log=t.logger.forComponent("libp2p:noise");let c=o??Fu;this.crypto=Gu(c),this.extensions={webtransportCerthashes:[],...s},this.metrics=a?ju(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=i??dt(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[bn]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(t,r){let n=t.log?.newScope("noise")??this.log,s=Di(t,{lengthEncoder:wr,lengthDecoder:Er,maxDataLength:65535}),o=await this.performHandshakeInitiator(s,this.components.privateKey,n,r?.remotePeer?.publicKey,r),i=Yr(o.payload.identityKey);return{connection:Xi(s.unwrap(),o,this.metrics),remoteExtensions:o.payload.extensions,remotePeer:Jo(i),streamMuxer:r?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}getStreamMuxer(t){if(t==null||t.length===0)return;let r=this.components.upgrader.getStreamMuxers();if(r!=null)for(let n of t){let s=r.get(n);if(s!=null)return s}if(t.length)throw new $e("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(t,r){let n=t.log?.newScope("noise")??this.log,s=Di(t,{lengthEncoder:wr,lengthDecoder:Er,maxDataLength:65535}),o=await this.performHandshakeResponder(s,this.components.privateKey,n,r?.remotePeer?.publicKey,r),i=Yr(o.payload.identityKey);return{connection:Xi(s.unwrap(),o,this.metrics),remoteExtensions:o.payload.extensions,remotePeer:Jo(i),streamMuxer:r?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(t,r,n,s,o){let i,a=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await Qu({connection:t,privateKey:r,remoteIdentityKey:s,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return i}async performHandshakeResponder(t,r,n,s,o){let i,a=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await Ju({connection:t,privateKey:r,remoteIdentityKey:s,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return i}};function tf(e={}){return t=>new us(t,e)}var nt=e=>({match:t=>{let r=t[0];return r==null||r.code!==e||r.value!=null?!1:t.slice(1)}}),H=(e,t)=>({match:r=>{let n=r[0];return n?.code!==e||n.value==null||t!=null&&n.value!==t?!1:r.slice(1)}}),ef=e=>({match:t=>e.match(t)===!1?t:!1}),W=e=>({match:t=>{let r=e.match(t);return r===!1?t:r}}),Bt=(...e)=>({match:t=>{let r;for(let n of e){let s=n.match(t);s!==!1&&(r==null||s.length<r.length)&&(r=s)}return r??!1}}),Q=(...e)=>({match:t=>{for(let r of e){let n=r.match(t);if(n===!1)return!1;t=n}return t}});function st(...e){function t(s){if(s==null)return!1;let o=s.getComponents();for(let i of e){let a=i.match(o);if(a===!1)return!1;o=a}return o}function r(s){return t(s)!==!1}function n(s){let o=t(s);return o===!1?!1:o.length===0}return{matchers:e,matches:r,exactMatch:n}}var Jd=H(421),t2=st(Jd),ls=H(54),hs=H(55),ds=H(56),Ji=H(53),e2=st(ls,W(H(421))),r2=st(hs,W(H(421))),n2=st(ds,W(H(421))),s2=st(Bt(Ji,ds,ls,hs),W(H(421))),rf=Q(H(4),W(H(43))),nf=Q(W(H(42)),H(41),W(H(43))),ta=Bt(rf,nf),Ve=Bt(ta,Ji,ls,hs,ds),o2=st(Bt(ta,Q(Bt(Ji,ds,ls,hs),W(H(421))))),i2=st(rf),a2=st(nf),c2=st(ta),ea=Q(Ve,H(6)),cn=Q(Ve,H(273)),u2=st(Q(ea,W(H(421)))),f2=st(cn),ra=Q(cn,nt(460),W(H(421))),ps=Q(cn,nt(461),W(H(421))),tp=Bt(ra,ps),l2=st(ra),h2=st(ps),Qi=Bt(Ve,ea,cn,ra,ps),sf=Bt(Q(Qi,nt(477),W(H(421)))),d2=st(sf),of=Bt(Q(Qi,nt(478),W(H(421))),Q(Qi,nt(448),W(H(449)),nt(477),W(H(421)))),p2=st(of),af=Q(cn,nt(280),W(H(466)),W(H(466)),W(H(421))),m2=st(af),cf=Q(ps,nt(465),W(H(466)),W(H(466)),W(H(421))),ms=st(cf),fs=Bt(sf,of,Q(ea,W(H(421))),Q(tp,W(H(421))),Q(Ve,W(H(421))),af,cf,H(421)),y2=st(fs),ep=Q(W(fs),nt(290),ef(nt(281)),W(H(421))),g2=st(ep),rp=Bt(Q(fs,nt(290),nt(281),W(H(421))),Q(fs,nt(281),W(H(421))),Q(nt(281),W(H(421)))),b2=st(rp),np=Bt(Q(Ve,H(6),nt(480),W(H(421))),Q(Ve,nt(480),W(H(421)))),x2=st(np),sp=Q(Ve,Bt(Q(H(6,"443"),nt(480)),Q(H(6),nt(443)),Q(H(6),nt(448),nt(480)),Q(nt(448),nt(480)),nt(448),nt(443)),W(H(421))),w2=st(sp),op=Bt(Q(H(777),W(H(421)))),E2=st(op),ip=Bt(Q(H(400),W(H(421)))),S2=st(ip);var qe=class extends Event{type;detail;constructor(t,r){super(t),this.type=t,this.detail=r}};function na(e){throw new Error("Not implemented")}var sa=class extends Zn{writer;reader;constructor(t){super(t),this.writer=t.stream.writable.getWriter(),this.reader=t.stream.readable.getReader(),this.writer.closed.then(()=>{this.log("writer closed gracefully")}).catch(r=>{r.message.includes("STOP_SENDING")||r.message.includes("StopSending")?this.onRemoteCloseRead():r.message.includes("RESET_STREAM")||r.message.includes("Reset")?this.onRemoteReset():this.log("writer close promise rejected - %e",r)}),this.readData()}readData(){Promise.resolve().then(async()=>{for(;;){let t=await this.reader.read();if(t.value!=null&&this.onData(t.value),t.done){this.log("remote closed write"),this.onRemoteCloseWrite();return}if(this.readStatus==="paused")break}}).catch(t=>{this.abort(t)}).finally(()=>{this.reader.releaseLock()})}sendData(t){for(let n of t)this.writer.write(n).catch(s=>{this.abort(s)});if(this.log.trace("desired size after sending %d bytes is %d bytes",t.byteLength,this.writer.desiredSize),this.writer.desiredSize==null)return{sentBytes:t.byteLength,canSendMore:!1};let r=this.writer.desiredSize>0;return r||this.writer.ready.then(()=>{this.safeDispatchEvent("drain")},n=>{this.abort(n)}),{sentBytes:t.byteLength,canSendMore:r}}sendReset(t){this.writer.abort(t).catch(r=>{this.log.error("error aborting writer - %e",r)})}async sendCloseWrite(t){this.log("sendCloseWrite closing writer"),await te(this.writer.close().catch(()=>{}),t?.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(t){this.log("sendCloseRead cancelling reader"),await te(this.reader.cancel(),t?.signal),this.log("sendCloseRead cancelled reader")}sendPause(){}sendResume(){this.readData()}};function oa(e,t,r,n,s){return new sa({...s,stream:e,id:t,direction:r,log:n.newScope(`${r}:${t}`),protocol:""})}var uf="/webtransport",ia=class extends jn{webTransport;streamIDCounter;reader;constructor(t,r){super(r,{protocol:uf,name:"muxer"}),this.webTransport=t,this.streamIDCounter=0,this.reader=this.webTransport.incomingBidirectionalStreams.getReader(),Promise.resolve().then(async()=>{for(;;){let{done:n,value:s}=await this.reader.read();if(n||s==null)break;this.onRemoteStream(oa(s,String(this.streamIDCounter++),"inbound",this.log,this.streamOptions))}}).catch(n=>{this.log.error("could not create a new stream - %e",n)})}async onCreateStream(t){let r=await this.webTransport.createBidirectionalStream();return t?.signal?.throwIfAborted(),oa(r,String(this.streamIDCounter++),"outbound",this.log,t)}onData(){}sendReset(){this.webTransport.close()}};function ff(e){return{protocol:uf,createStreamMuxer(t){return new ia(e,t)}}}var aa=class extends Gn{cleanUpWTSession;constructor(t){super(t),this.cleanUpWTSession=t.cleanUpWTSession}sendData(t){return{sentBytes:t.byteLength,canSendMore:!0}}sendReset(){this.cleanUpWTSession("abort")}async sendClose(t){this.cleanUpWTSession("close"),t?.signal?.throwIfAborted()}sendPause(){}sendResume(){}},lf=e=>new aa(e);function hf(e,t){return t.filter(n=>!!e.find(s=>ht(n,s))).length===t.length}var ap=Object.values(Ee).map(e=>e.decoder).reduce((e,t)=>e.or(t));function cp(e){return Ft.decode(ap.decode(e))}function ca(e){if(!ms.matches(e))throw new _r("Invalid multiaddr, was not a WebTransport address");let t=[],r;for(let o of e.getComponents())o.name==="certhash"&&t.push(cp(o.value??"")),o.name==="p2p"&&r==null&&(r=uu(o.value??""));if(r==null)throw new _r("Remote peer must be present in multiaddr");let n=lu(e),s=n.host;return n.type==="ip6"&&s.includes(":")&&(s=`[${s}]`),{url:`https://${s}:${n.port}`,certhashes:t,remotePeer:r}}var ys=class extends $t{writer;reader;constructor(t){super(t),this.writer=t.stream.writable.getWriter(),this.reader=t.stream.readable.getReader(),Promise.resolve().then(async()=>{for(;;){let{done:r,value:n}=await this.reader.read();if(n!=null&&this.onData(n),r)break}}).catch(r=>{this.abort(r)})}async close(t){await te(this.writer.close(),t?.signal)}sendData(t){return this.writer.write(t.subarray()).catch(r=>{this.abort(r)}),{sentBytes:t.byteLength,canSendMore:!0}}sendReset(t){this.writer.abort(t).catch(r=>{this.log.error("could not send reset - %e",r)})}sendPause(){}sendResume(){}};var df=globalThis.WebTransport;var ua=class{log;components;config;metrics;constructor(t,r={}){this.log=t.logger.forComponent("libp2p:webtransport"),this.components=t,this.config={...r,certificates:r.certificates??[]},t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}[Symbol.toStringTag]="@libp2p/webtransport";[pa]=!0;[bn]=["@libp2p/transport"];async dial(t,r){r.signal.throwIfAborted(),this.log("dialing %s",t),r=r??{};let{url:n,certhashes:s,remotePeer:o}=ca(t),i,a,c=()=>{},f=!1,u=!1,l=!1;try{this.metrics?.dialerEvents.increment({pending:!0});let g=new df(`${n}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:s.map(p=>({algorithm:"sha-256",value:p.digest}))});if(c=p=>{if(!f)try{this.metrics?.dialerEvents.increment({[p]:!0}),g.close()}catch(d){this.log.error("error closing wt session",d)}finally{a!=null&&(a.timeline.close=Date.now()),f=!0}},i=()=>{c(u?"noise_timeout":"ready_timeout")},r.signal.addEventListener("abort",i,{once:!0}),this.log("wait for session to be ready"),r.onProgress?.(new qe("webtransport:wait-for-session")),await Promise.race([g.closed,g.ready]),this.log("session became ready"),u=!0,this.metrics?.dialerEvents.increment({ready:!0}),g.closed.catch(p=>{this.log.error("error on remote wt session close",p)}).finally(()=>{c("remote_close")}),this.metrics?.dialerEvents.increment({open:!0}),a=lf({remoteAddr:t,cleanUpWTSession:c,direction:"outbound",log:this.components.logger.forComponent("libp2p:webtransport:connection")}),l=await this.authenticateWebTransport({wt:g,maConn:a,remotePeer:o,certhashes:s,...r}),!l)throw new $e("Failed to authenticate webtransport");return await r.upgrader.upgradeOutbound(a,{...r,skipEncryption:!0,remotePeer:o,muxerFactory:ff(g),skipProtection:!0})}catch(g){throw this.log.error("caught wt session err",g),c(l?"upgrade_error":u?"noise_error":"ready_error"),g}finally{i!=null&&r.signal?.removeEventListener("abort",i)}}async authenticateWebTransport({wt:t,maConn:r,remotePeer:n,certhashes:s,onProgress:o,signal:i}){o?.(new qe("webtransport:open-authentication-stream"));let a=await t.createBidirectionalStream();i?.throwIfAborted();let c=new ys({stream:a,log:r.log.newScope("muxer")}),f=tf()(this.components);o?.(new qe("webtransport:secure-outbound-connection"));let{remoteExtensions:u}=await f.secureOutbound(c,{signal:i,remotePeer:n,skipStreamMuxerNegotiation:!0});if(o?.(new qe("webtransport:close-authentication-stream")),await c.close({signal:i}),!hf(u?.webtransportCerthashes??[],s.map(l=>l.bytes)))throw new et("Our certhashes are not a subset of the remote's reported certhashes");return!0}createListener(t){return na(this.components,{...t,certificates:this.config.certificates})}listenFilter(){return[]}dialFilter(t){return globalThis.WebTransport==null?[]:t.filter(r=>{if(!ms.exactMatch(r))return!1;let{url:n,certhashes:s}=ca(r);return n!=null&&s.length>0})}};function up(e={}){return t=>new ua(t,e)}return bf(fp);})();
//! TODO unclear how to add backpressure here?
/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/abstract/montgomery.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
return Libp2PWebtransport}));
//# sourceMappingURL=index.min.js.map
